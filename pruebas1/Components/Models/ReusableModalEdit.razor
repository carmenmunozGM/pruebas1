@using Microsoft.AspNetCore.Components.Web
@inject IJSRuntime JSRuntime
@using pruebas1.Components.Models



@if (Show)
{
    <div class="reusable-modal-container" @onclick="HandleOutsideClick">
        <div class="modal-content" @onclick:stopPropagation="true">

            <!-- Encabezado -->
            <div class="reusable-modal-header">
                <h2 class="modal-title">
                    Editar @(FormType == FormTypes.Evento ? "Evento" :
                                    FormType == FormTypes.Tarea ? "Tarea Operativa" :
                                    "Tarea Administrativa")
            </h2>
            <span class="close-button" @onclick="CloseModal">&times;</span>
        </div>

            <!-- Cuerpo -->
            <div class="reusable-modal-body-wrapper">
                <div class="form-section">

                    <!-- Campo título -->
                    <div class="form-group-span-2">
                        <label>Título</label>
                        <input type="text" class="form-control" placeholder="Ej: Revisión semanal" @bind="Titulo" />
                    </div>

                    <!-- Campo descripción -->
                    <div class="form-group-span-2">
                        <label>Descripción</label>
                        <textarea class="form-control tall-textarea" placeholder="Detalles o notas..." @bind="Descripcion"></textarea>
                    </div>

                    <!-- Subtareas -->
                    <div class="form-group-span-2 @(FormType == FormTypes.Evento ? "disabled-group" : "")">
                        <label>Subtareas</label>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Agregar sub-tarea" @bind="NuevaSubtarea" @onkeydown="HandleEnter" disabled="@(FormType == FormTypes.Evento)" />
                            <button class="btn btn-secondary" @onclick="AgregarSubtarea" disabled="@(FormType == FormTypes.Evento)">Añadir</button>
                        </div>

                        <ul class="todo-list">
                        @foreach (var st in Subtasks)
                            {
                                <li>
                                    <span>@st</span>
                                    <button class="delete-button" @onclick="() => EliminarSubtarea(st)">🗑️</button>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button class="btn btn-danger" @onclick="CloseModal">Cancelar</button>
                <button class="btn btn-success" @onclick="GuardarCambios">Guardar Cambios</button>
            </div>
        </div>
    </div>
}

@code {
    // En ReusableModalEdit.razor
    [Parameter] public FormTypes FormType { get; set; }
    // 🧩 Parámetros de entrada (se llenan desde el componente padre)
    [Parameter] public bool Show { get; set; }
    [Parameter] public EventCallback<bool> ShowChanged { get; set; }

    [Parameter] public string Titulo { get; set; } = "";
    [Parameter] public string Descripcion { get; set; } = "";
    [Parameter] public List<string> Subtasks { get; set; } = new();


    // Eventos de salida al padre
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }

    private string NuevaSubtarea = "";

    // 🟢 Agregar una subtarea
    private void AgregarSubtarea()
    {
        if (!string.IsNullOrWhiteSpace(NuevaSubtarea))
        {
            Subtasks.Add(NuevaSubtarea);
            NuevaSubtarea = "";
        }
    }

    // 🔴 Eliminar una subtarea
    private void EliminarSubtarea(string subtarea)
    {
        Subtasks.Remove(subtarea);
    }

    // ⌨️ Enter agrega subtarea
    private void HandleEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") AgregarSubtarea();
    }

    // ✅ Guardar cambios
    private async Task GuardarCambios()
    {
        await JSRuntime.InvokeVoidAsync("Swal.fire", new
        {
            title = "Cambios guardados",
            text = "La tarea se actualizó correctamente.",
            icon = "success",
            confirmButtonText = "OK"
        });

        await OnSave.InvokeAsync();
        await CerrarAsync();
    }

    // ❌ Cerrar modal
    private async Task CerrarAsync()
    {
        await ShowChanged.InvokeAsync(false);
        await OnClose.InvokeAsync();
    }

    private async Task HandleOutsideClick()
    {
        await CerrarAsync();
    }

    private async Task CloseModal()
    {
        await CerrarAsync();
    }

    public enum FormTypes
    {
        Evento,
        Tarea,
        Administrativa
    }
}
<style>
    .reusable-modal-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 600px;
    max-width: 90%;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.reusable-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    margin-bottom: 10px;
}

.close-button {
    cursor: pointer;
    font-size: 22px;
}

.todo-list {
    list-style: none;
    padding: 0;
    margin: 8px 0;
}

.todo-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f4f4f4;
    border-radius: 6px;
    padding: 5px 10px;
    margin-bottom: 5px;
}

.disabled-group {
    opacity: 0.6;
    pointer-events: none;
}

</style>