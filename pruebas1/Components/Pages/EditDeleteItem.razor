@using pruebas1.Components.Models
@using pruebas1.Servicios
@inject AgendaService AgendaService

<div class="ed-actions">
    <button type="button" class="ed-btn edit" @onclick="AbrirEditar">✏️</button>
    <button type="button" class="ed-btn delete" @onclick="Eliminar">🗑️</button>
</div>

@if (MostrarModal)
{
    <div class="ed-overlay">
        <div class="ed-modal" @onclick:stopPropagation="true">
            <h3>Editar @Tipo</h3>

            <input @bind="EditModel.Titulo" placeholder="Título" />
            <textarea @bind="EditModel.Descripcion" placeholder="Descripción"></textarea>

            <input type="datetime-local"
                   @bind-value="EditModel.FechaInicio"
                   @bind-value:format="yyyy-MM-ddTHH:mm" />

            <input type="datetime-local"
                   @bind-value="EditModel.FechaFin"
                   @bind-value:format="yyyy-MM-ddTHH:mm" />

            <div class="ed-footer">
                <button @onclick="Guardar">Guardar</button>
                <button @onclick="Cerrar">Cancelar</button>
            </div>
        </div>
    </div>
}

@code {

    [Parameter] public EditableItemModel EditModel { get; set; } = new();
    [Parameter] public ItemTipo Tipo { get; set; }

    [Parameter] public EventCallback OnUpdated { get; set; }
    [Parameter] public EventCallback OnDeleted { get; set; }

    bool MostrarModal;

    void AbrirEditar()
    {
        Console.WriteLine("🧨 ABRIR MODAL");
        MostrarModal = true;
    }

    void Cerrar() => MostrarModal = false;

    async Task Guardar()
    {
        Console.WriteLine($"✏️ GUARDAR {Tipo} ID={EditModel.Id}");

        if (Tipo == ItemTipo.Evento)
            await AgendaService.EditarEventoAsync(EditModel.Id, EditModel);
        else
            await AgendaService.EditarTareaAsync(EditModel.Id, EditModel);

        MostrarModal = false;
        await OnUpdated.InvokeAsync();
    }

    async Task Eliminar()
    {
        Console.WriteLine($"🗑️ ELIMINAR {Tipo} ID={EditModel.Id}");

        if (Tipo == ItemTipo.Evento)
            await AgendaService.EliminarEventoAsync(EditModel.Id);
        else
            await AgendaService.EliminarTareaAsync(EditModel.Id);

        await OnDeleted.InvokeAsync();
    }
}
