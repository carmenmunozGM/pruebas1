@page "/dia2"
@using System.Linq
@using System.Globalization
@inject NavigationManager navigate
@using Microsoft.AspNetCore.Components.Web
@using pruebas1.Components.DTOs
@using pruebas1.Entidades
@using pruebas1.Components
@using pruebas1.Servicios
@using System.Diagnostics;
@inject IJSRuntime JSRuntime
@using System.Text.Json
@inject OrdenTrabajoService OrdenTrabajoService
@inject OrdenTramiteService OrdenTramiteService
@inject AutoevaluacionService AutoevaluacionService
@inject HttpClient Http
@inject AgendaService AgendaService
@inject LoginService LoginService
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


<div class="agenda-container">
    <div class="top-bar-container">
        <div class="fecha-header">
            <button class="calendar-btn" @onclick="DiaAnterior"><i class="bi bi-arrow-left-circle"></i></button>
            <span class="fecha-texto">@FechaFormateada</span>
            <button class="calendar-btn" @onclick="DiaSiguiente"><i class="bi bi-arrow-right-circle"></i></button>

            <div class="calendar-wrapper">
                <button class="calendar-btn" @onclick="AbrirCalendario">📅</button>

                @if (MostrarModal)
                {
                    <div class="modal-popover" @onclick:stopPropagation="true">
                        <div class="calendar-header">
                            <button class="calendar-btn" @onclick="MesAnterior"><i class="bi bi-chevron-left"></i></button>
                            <strong>@MesActual.ToString("MMMM yyyy", new CultureInfo("es-ES"))</strong>
                            <button class="calendar-btn" @onclick="MesSiguiente"><i class="bi bi-chevron-right"></i></button>
                        </div>

                        <div class="calendar-grid">
                            @foreach (var dia in DiasSemana)
                            {
                                <div class="calendar-week-day"><strong>@dia</strong></div>
                            }
                            @foreach (var day in DiasDelCalendario)
                            {
                                <div class="calendar-day @(day.Month != MesActual.Month ? "calendar-other-month" : "") @(day.Date == DateTime.Now.Date ? "calendar-today" : "")"
                                     @onclick="() => SeleccionarFecha(day)">
                                    @day.Day
                                </div>
                            }
                        </div>

                        <div style="margin-top:10px; text-align:center;">
                            <button class="calendar-btn" @onclick="CerrarCalendario">✖ Cerrar</button>
                        </div>
                    </div>
                }
            </div>

        </div>

    </div>


    <div class="modal-button-container">
        <ReusableModal OnSave="RefrescarTareas" />

    </div>

    @if (FechaSeleccionada.DayOfWeek == DayOfWeek.Sunday)
    {
        <div class="col-12 text-center">
            <div class="alert alert-warning shadow-sm">
                Día no laboral – @FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"))
            </div>
        </div>
    }
    else
    {
        @if (Categories.FirstOrDefault(c => c.Name.Trim() == "Tareas") is CategoryModel tareasCat)
        {
            <div class="card block-card @tareasCat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(tareasCat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@tareasCat.Icon @tareasCat.Name</h3>
                    </div>
                    <div class="header-right">
                        @if (AllCompleted(tareasCat))
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            <span class="badge pendiente">@RemainingCount(tareasCat) pendiente(s)</span>
                        }
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(tareasCat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!tareasCat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll @(tareasCat.IsCollapsed ? "collapsed" : "")">
                        <ul class="subtask-list">


                            @foreach (var st in tareasCat.Subtasks)
                            {
                                <li class="subtask-item">
                                    <div class="subtask-label @(st.IsDone && tareasCat.Name != "Autoevaluación" ? "done" : "")">

                                        <!-- Checkbox -->
                                        <input type="checkbox"
                                               checked="@st.IsDone"
                                               @onchange="(e)   => ToggleSubtaskAsync(st, e)" />


                                        <!-- Icono y tipo -->
                                        <span>@(!string.IsNullOrEmpty(st.Icon) ? st.Icon : (st.Tipo == "Evento" ? "📅" : "📝"))</span>
                                        <span style="color:@(st.Tipo == "Evento" ? "red" : "blue");">

                                        </span>

                                        <!-- Título -->
                                        <span class="subtask-text">@st.Title</span>

                                        <!-- Descripción -->
                                        @if (!string.IsNullOrEmpty(st.Descripcion))
                                        {
                                            <span class="subtask-desc"> - @st.Descripcion</span>
                                        }

                                        <!-- Fechas y hora (solo para eventos) -->
                                        @if (st.Tipo == "Evento")
                                        {
                                            <span class="evento-fecha">
                                                @if (st.FechaInicio.HasValue)
                                                {
                                                    @($"{st.FechaInicio.Value:dd/MM/yyyy}")
                                                }
                                                @if (st.HoraInicio.HasValue)
                                                {
                                                    @($" {st.HoraInicio.Value:hh\\:mm}")
                                                }
                                            </span>
                                        }



                                        <!-- Prioridad (solo para tareas) -->
                                        @if (st.Tipo == "Tarea")
                                        {
                                            <span class="tarea-prioridad">
                                                @(st.Prioridad switch
                                                {
                                                    1 => "🔥 Alta",
                                                    2 => "⚠️ Media",
                                                    3 => "🟢 Baja",
                                                    _ => ""
                                                })
                        </span>
                                                }


                                        <!-- Estado hecho -->
                                        @if (st.IsDone)
                                        {
                                            <small class="done-text">Hecho</small>
                                        }

                                        <!-- Botones acciones solo si categoría es Tareas -->
                                        @if (tareasCat.Name.Trim() == "Tareas")
                                        {
                                            <div class="subtask-actions">
                                                <button class="icon-btn view" title="Ver detalles" @onclick="() => OpenViewModal(st)">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <EditDeleteItem EditModel="ConvertToEditable(st)"
                                                                Tipo="@(st.Tipo == "Evento" ? Models.ItemTipo.Evento : Models.ItemTipo.Tarea)"
                                                                OnUpdated="RecargarVista"
                                                                OnDeleted="RecargarVista" />


                                            </div>

                                        }
                                    </div>
                                    @if (st.Subtasks.Any())
                                    {
                                        <div class="table-wrapper block-scroll">
                                            <ul class="subtask-list">
                                                @foreach (var s2 in st.Subtasks)
                                                {
                                                    <li class="subtask-item">
                                                        <div class="subtask-label @(s2.IsDone ? "done" : "")">
                                                            <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(tareasCat, st, s2)" />
                                                            <span class="subtask-text">@($"{s2.Title}")</span>
                                                            <div class="subtask-actions">
                                                                <EditDeleteItem EditModel="ConvertToEditable(st)"
                                                                                Tipo="@(st.Tipo == "Evento" ? Models.ItemTipo.Evento : Models.ItemTipo.Tarea)"
                                                                                OnUpdated="RecargarVista"
                                                                                OnDeleted="RecargarVista" />


                                                            </div>
                                                        </div>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }


        @if (Categories.FirstOrDefault(c => c.Name.Trim() == "Órdenes de Trabajo") is CategoryModel otCat)
        {
            <div class="card block-card naranja-melocoton">
                <div class="block-header" @onclick="() => ToggleCollapse(otCat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@otCat.Icon Órdenes de Trabajo</h3>
                    </div>
                    <div class="header-right">
                        <span class="badge pendiente">@((OrdenesParaMostrar ?? Enumerable.Empty<OrdenTrabajoModel>()).Count()) orden(es)</span>
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(otCat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!otCat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll">
                        <div class="ordenes-workboard">
                            @if (OrdenesParaMostrar != null && OrdenesParaMostrar.Any())
                            {
                                <div class="columns-container block-scroll">



                                    <!-- 🔴 Columna 1: Vencidas -->
                                    <div class="column column-expired block-scroll">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Vencido).OrderBy(o => o.FechaProgramada))
                                        {
                                            @if (ot.Tipo == TipoOrden.Tramite)
                                            {
                                                <span class="badge badge-tramite">Trámite</span>
                                            }

                                            <div class="ot-card ot-expired">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.NumeroOrden</div>
                                                    <div class="ot-date">@ot.FechaProgramada.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-expired">Vencida</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => VerOrden(ot)">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <!-- 🟡 Columna 2: Próximas -->
                                    <div class="column column-soon block-scroll">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Proximo).OrderBy(o => o.FechaProgramada))
                                        {
                                            <div class="ot-card ot-soon">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.NumeroOrden</div>
                                                    <div class="ot-date">@ot.FechaProgramada.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-soon">Próx.</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => VerOrden(ot)">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </button>
                                                </div>

                                            </div>
                                        }
                                    </div>

                                    <!-- 🟢 Columna 3: Normales -->
                                    <div class="column column-normal block-scroll">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Hoy).OrderBy(o => o.FechaProgramada))
                                        {
                                            <div class="ot-card ot-normal">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.NumeroOrden</div>
                                                    <div class="ot-date">@ot.FechaProgramada.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-normal">Hoy</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => VerOrden(ot)">

                                                        <i class="bi bi-eye-fill"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                </div>
                            }
                            else
                            {
                                <div class="no-ordenes">No hay órdenes para mostrar</div>
                            }
                        </div>
                    </div>
                }
            </div>
            <br />
        }

        @foreach (var cat in Categories.Where(c =>
            c.Name.Trim() != "Órdenes de Trabajo" &&
            c.Name.Trim() != "Tareas" &&
            c.Name.Trim() != "Autoevaluación" &&
            c.Name.Trim() != "Servicio a Cliente"))

        {
            <div class="card block-card @cat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(cat)">

                    <div class="header-left">
                        <h3 class="categoria-titulo">@cat.Icon @cat.Name</h3>
                    </div>
                    <div class="header-right">
                        @if (AllCompleted(cat))
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            <span class="badge pendiente">@RemainingCount(cat) pendiente(s)</span>
                        }
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(cat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!cat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll @(cat.IsCollapsed ? "collapsed" : "")">
                        <ul class="subtask-list">
                            @foreach (var st in cat.Subtasks)
                            {
                                <li class="subtask-item">
                                    <div class="subtask-label @(st.IsDone && cat.Name != "Autoevaluación" ? "done" : "")">

                                        else if (cat.Name.Trim() != "Órdenes de Trabajo")
                                        {


                                        <input type="checkbox"
                                               checked="@st.IsDone"
                                               @onchange="(e) => ToggleSubtaskAsync(st, e)" />

                                        }

                                        <span class="subtask-text">@st.Title</span>

                                        @if (st.IsDone)
                                        {
                                            <small class="done-text">Hecho</small>
                                        }

                                        @if (cat.Name.Trim() == "Tareas")
                                        {
                                            <div class="subtask-actions">
                                                <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(cat, st)">
                                                    <i class="bi bi-calendar"></i>
                                                </button>
                                                <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditModal(cat, st)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button>🗑️</button>

                                            </div>
                                        }
                                    </div>

                                    @if ((cat.Name.Trim() == "Tareas" || cat.Name.Trim() == "Servicio a Cliente") && st.Subtasks.Any())
                                    {
                                        <div class="table-wrapper block-scroll">
                                            @if (cat.Name.Trim() == "Servicio a Cliente")
                                            {
                                                <table class="subtask-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Actividad</th>
                                                            <th>Hecho</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var s2 in st.Subtasks)
                                                        {
                                                            <tr>
                                                                <td>@s2.Title</td>
                                                                <td>
                                                                    <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(cat, st, s2)" />
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            }
                                            else
                                            {
                                                <ul class="subtask-list">
                                                    @foreach (var s2 in st.Subtasks)
                                                    {
                                                        <li class="subtask-item">
                                                            <div class="subtask-label @(s2.IsDone ? "done" : "")">
                                                                <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(cat, st, s2)" />
                                                                <span class="subtask-text">@($"{s2.Title}")</span>
                                                                <div class="subtask-actions">
                                                                    <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(cat, st)">
                                                                        <i class="bi bi-calendar"></i>
                                                                    </button>
                                                                    <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditInnerModal(cat, st, s2)">
                                                                        <i class="bi bi-pencil"></i>
                                                                    </button>
                                                                    <button>🗑️</button>

                                                                </div>
                                                            </div>
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }


        var autoevalDia = AutoevaluacionesDelDia
        .Where(a => a.Fecha.Date == FechaSeleccionada.Date)
        .ToList();

        var autoevalCompletadas = autoevalDia.Any() && autoevalDia.All(a => a.Realizado);
        var autoevalMesVacia = !AutoevaluacionesDelDia.Any();

        var autoevalPendientes = autoevalDia.Count(a => !a.Realizado);

        @if (true)
        {
            <div class="card block-card azul-lavanda">
                <div class="block-header" @onclick="() => AutoevalCollapsed = !AutoevalCollapsed">
                    <div class="header-left">
                        <h3 class="categoria-titulo">⭐ Autoevaluación</h3>
                    </div>
                    <div class="header-right">
                        @if (autoevalCompletadas)
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            @if (autoevalCompletadas)
                            {
                                <span class="badge completado">Completado ✓</span>
                            }
                            else
                            {
                                <span class="badge pendiente">
                                    @autoevalPendientes pendiente(s)
                                </span>
                            }

                        }

                        <button class="btn btn-floating">
                            @(AutoevalCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!AutoevalCollapsed)
                {
                    <div class="card-body block-body block-scroll">

                        @if (autoevalMesVacia)
                        {
                            <div class="empty-block-message">
                                ¡No tienes autoevaluación registrada para este mes!
                            </div>
                        }
                        else
                        {
                            <ul class="subtask-list">
                                @foreach (var item in autoevalDia)
                                {
                                    <li class="subtask-item">
                                        <div class="subtask-label">
                                            <input type="checkbox"
                                                   checked="@item.Realizado"
                                                   disabled="@(FechaSeleccionada.Date != DateTime.Today)"
                                                   @onchange="(e) => ToggleAutoevaluacionDia(item, e)" />

                                            <span class="subtask-text">
                                                ⭐ @item.Actividad
                                            </span>

                                            @if (item.Realizado)
                                            {
                                                <small class="done-text">Hecho</small>
                                            }
                                        </div>
                                    </li>
                                }
                            </ul>
                        }

                    </div>


                }
            </div>

            <br />
        }

        @foreach (var cat in Categories.Where(c =>
            c.Name.Trim() == "Servicio a Cliente"))
        {
            <div class="card block-card @cat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(cat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@cat.Icon @cat.Name</h3>
                    </div>
                    <div class="header-right">
                        <span class="badge pendiente">@RemainingCount(cat) pendiente(s)</span>
                        <button class="btn btn-floating" style="font-size:0.8rem;">
                            @(cat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!cat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll">
                        <ul class="subtask-list">
                            @foreach (var st in cat.Subtasks)
                            {
                                <li class="subtask-item">
                                    <div class="subtask-label @(st.IsDone ? "done" : "")">
                                        <input type="checkbox"
                                               checked="@st.IsDone"
                                               @onchange="(e) => ToggleSubtaskAsync(st, e)" />
                                        <span class="subtask-text">@st.Title</span>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }


    }
</div>
<!-- MODAL DE MODIFICAR HSITORIAS DE FECHAS-->
@if (ShowModificarFechaModal)
{
    <div class="modal-overlay" @onclick="CerrarModificarModal">
        <div class="modal-card" @onclick:stopPropagation="true">
            <h2 class="modal-title">
                <i class="bi bi-calendar-check"></i> Modificar Fecha
            </h2>

            @if (MostrarAlerta)
            {
                <div class="alerta @TipoAlerta">
                    @MensajeAlerta
                </div>
            }

            <div class="modal-body">
                <div class="form-group">
                    <label>📅 Fecha actual</label>
                    <input type="text" class="form-control" value="@FechaActual.ToString("dd/MM/yyyy")" readonly />
                </div>

                <div class="form-group">
                    <label>🗓️ Nueva fecha</label>
                    <div class="datepicker-wrapper">
                        <DatePicker @bind-Value="NuevaFecha"
                                    CssClass="date-control" />

                    </div>
                </div>

                <div class="form-group">
                    <label>📝 Motivo del cambio <span style="color:red;">*</span></label>
                    <textarea class="form-control" rows="3" placeholder="Escribe el motivo del cambio..." @bind="Motivo"></textarea>
                </div>

                @if (HistorialCambios.Any())
                {
                    <div class="historial">
                        <h4>📜 Historial de cambios</h4>
                        <div class="historial-scroll">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Fecha anterior</th>
                                        <th>Nueva fecha</th>
                                        <th>Motivo</th>
                                        <th>Fecha de modificación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var h in HistorialCambios.OrderByDescending(x => x.FechaModificacion))
                                    {
                                        <tr>
                                            <td>@h.FechaAnterior.ToString("dd/MM/yyyy")</td>
                                            <td>@h.FechaNueva.ToString("dd/MM/yyyy")</td>
                                            <td>@h.Motivo</td>
                                            <td>@h.FechaModificacion.ToString("dd/MM/yyyy HH:mm")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>


            <div class="modal-footer">
                <button class="btn-guardar" @onclick="GuardarCambioFecha">
                    <i class="bi bi-save"></i> Guardar
                </button>
                <button class="btn-cancelar" @onclick="CerrarModificarModal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
}

<!-- MODAL DE VISUALIZACIÓN DE ORDEN (EXTRA GRANDE) -->
@if (ShowOrderModal && SelectedOrden != null)
{
    <div class="modal-container visible" @onclick="CloseOrderModal">
        <div class="modal-content" @onclick:stopPropagation="true" style="max-width:1200px; width:95%; height:92vh;">
            <div class="modal-header" style="background:#FFDAC1; color:#000;">
                <h2 class="modal-title">ORDEN-@SelectedOrden.NumeroOrden</h2>
                <span class="close-button" @onclick="CloseOrderModal">&times;</span>
            </div>

            <div class="modal-body-wrapper">
                <div class="form-section-wrapper">
                    <div class="form-section">

                        <!-- Campos de la orden -->
                        <div>
                            <label class="section-label">Número de orden</label>
                            <div>@SelectedOrden.NumeroOrden</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha de solicitud</label>
                            <div>@(SelectedOrden.FechaSolicitud?.ToString("dd/MM/yyyy") ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Autor</label>
                            <div>@(SelectedOrden.Autor ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Nombre / Razón social</label>
                            <div>@(SelectedOrden.Cliente ?? "-")</div>
                        </div>

                        <div class="form-group-span-2">
                            <label class="section-label">Objetivo</label>
                            <div>@(SelectedOrden.Objetivo ?? "-")</div>
                        </div>

                        <div class="form-group-span-2">
                            <label class="section-label">Objetivo de otros</label>
                            <div>@(SelectedOrden.ObjetivoOtro ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha programada de conclusión</label>
                            <div>@SelectedOrden.FechaProgramada.ToString("dd/MM/yyyy")</div>
                        </div>

                    </div>

                    <!-- TABLA DE TAREAS -->
                    <div style="margin-top:18px;" class="form-group-span-2">
                        <label class="section-label">Tareas</label>

                        <table class="tasks-table" style="width:100%; border-collapse:collapse;">
                            <thead style="background:#f0f0f0; text-align:left;">
                                <tr>
                                    <th style="padding:8px; width:30%;">Nombre de la tarea</th>
                                    <th style="padding:8px; width:45%;">Descripción</th>
                                    <th style="padding:8px; width:15%;">Avance</th>
                                    <th style="padding:8px; width:10%;">Ver</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in SelectedOrden.Tareas)
                                {
                                    <tr style="border-bottom:1px solid #ddd;">
                                        <td style="padding:8px;">@t.Nombre</td>

                                        <td style="padding:8px;">
                                            @{
                                                var desc = t.DescripcionAutor
                                                ?? t.DescripcionReceptor
                                                ?? "-";
                                            }
                                            @desc
                                        </td>

                                        <td style="padding:8px;">@($"{t.Valor}")</td>

                                        <td style="padding:8px; text-align:center;">
                                            <button class="btn-eye" @onclick="() => ShowTaskModal(t)">
                                                <i class="fa fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CloseOrderModal">Cerrar</button>
            </div>
        </div>
    </div>
}

<!-- MODAL DE DETALLE DE TAREA ORDENES TRABAJO -->
@if (ShowTaskDetailsModal && SelectedTask != null)
{
    <div class="modal-container visible" @onclick="CloseTaskModal">
        <div class="modal-content" @onclick:stopPropagation="true" style="max-width:500px; width:80%; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.25);">
            <div class="modal-header" style="background:#FFDAC1; color:#fff; border-top-left-radius:10px; border-top-right-radius:10px;">
                <h3 class="modal-title">Detalle de tarea - @SelectedTask.Nombre</h3>
                <span class="close-button" @onclick="CloseTaskModal">&times;</span>
            </div>

            <div class="modal-body-wrapper" style="padding:15px;">

                <div>
                    <label class="section-label">Nombre de la tarea</label>
                    <div>@SelectedTask.Nombre</div>
                </div>

                <div>
                    <label class="section-label">Descripción</label>
                    <div>
                        @{
                            var desc = SelectedTask.DescripcionAutor
                            ?? SelectedTask.DescripcionReceptor
                            ?? "-";
                        }
                        @desc
                    </div>
                </div>

                <div>
                    <label class="section-label">Observación</label>
                    <div>@(SelectedTask.Observacion ?? "-")</div>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CloseTaskModal">Cerrar</button>
            </div>
        </div>
    </div>
}

<!-- MODAL DE DETALLE DE TAREA BLOQUE TAREAS-->
@if (ShowViewModal && SelectedViewItem != null)
{
    <div class="view-overlay" @onclick="CloseViewModal">
        <div class="view-modal" @onclick:stopPropagation="true">

            <div class="view-header">
                <h3>
                    @(SelectedViewItem.Tipo == "Tarea"
                                    ? "📝 Detalles de la Tarea"
                                    : "📅 Detalles del Evento")
            </h3>
            <button class="view-close" @onclick="CloseViewModal">×</button>
        </div>

            <div class="view-body">

                <div class="view-grid">

                    <div class="view-field full">
                        <label>Título</label>
                        <p>@SelectedViewItem.Title</p>
                    </div>

                    <div class="view-field full">
                        <label>Descripción</label>
                        <p>@SelectedViewItem.Descripcion</p>
                    </div>

                    <div class="view-field">
                        <label>Tipo</label>
                        <p>@SelectedViewItem.Tipo</p>
                    </div>

                @if (!string.IsNullOrWhiteSpace(SelectedViewItem.Ubicacion))
                    {
                        <div class="view-field">
                            <label>📍 Ubicación</label>
                            <p>@SelectedViewItem.Ubicacion</p>
                        </div>
                    }

                    @if (SelectedViewItem.FechaInicio != null)
                    {
                        <div class="view-field">
                            <label>Fecha Inicio</label>
                            <p>@SelectedViewItem.FechaInicio?.ToString("dd/MM/yyyy")</p>
                        </div>
                    }

                    @if (SelectedViewItem.FechaFin != null)
                    {
                        <div class="view-field">
                            <label>Fecha Fin</label>
                            <p>@SelectedViewItem.FechaFin?.ToString("dd/MM/yyyy")</p>
                        </div>
                    }

                    @if (SelectedViewItem.HoraInicio != null)
                    {
                        <div class="view-field">
                            <label>Hora Inicio</label>
                            <p>@SelectedViewItem.HoraInicio?.ToString("HH:mm")</p>
                        </div>
                    }

                    @if (SelectedViewItem.HoraFin != null)
                    {
                        <div class="view-field">
                            <label>Hora Fin</label>
                            <p>@SelectedViewItem.HoraFin?.ToString("HH:mm")</p>
                        </div>
                    }

                <div class="view-field">
                    <label>Prioridad</label>
                    <p>
                        @(SelectedViewItem.Prioridad switch
                        {
                            1 => "🔥 Alta",
                            2 => "⚠️ Media",
                            3 => "🟢 Baja",
                            _ => "Sin prioridad"
                        })
                    </p>
                </div>

                <div class="view-field">
                    <label>Recurrencia</label>
                    <p>
                        @(SelectedViewItem.EsRecurrente
                                                ? SelectedViewItem.ReglaRecurrencia
                                                : "No recurrente")
                    </p>
                </div>

                </div>

            @if (SelectedViewItem.Participantes.Any())
                {
                    <div class="view-section">
                        <h4>👥 Participantes</h4>
                        <ul>
                            @foreach (var p in SelectedViewItem.Participantes)
                            {
                                <li>@p</li>
                            }
                        </ul>
                    </div>
                }

                @if (SelectedViewItem.Tipo == "Tarea" && SelectedViewItem.Subtasks.Any())
                {
                    <div class="view-section">
                        <h4>✔️ Subtareas</h4>
                        <ul>
                            @foreach (var s in SelectedViewItem.Subtasks)
                            {
                                <li>@s.Title</li>
                            }
                        </ul>
                    </div>
                }

            </div>

            <div class="view-footer">
                <button class="view-btn" @onclick="CloseViewModal">Cerrar</button>
            </div>

        </div>
    </div>
}

<!--MODAL DE ORDENES DE TRAMITE-->
@if (ShowTramiteModal && SelectedOrdenTramite != null)
{
    <div class="modal-container visible" @onclick="CloseTramiteModal">
        <div class="modal-content"
             @onclick:stopPropagation="true"
             style="max-width:1200px; width:95%; height:92vh;">

            <div class="modal-header" style="background:#FFDAC1; color:#000;">
                <h2 class="modal-title">
                    ORDEN DE TRÁMITE – @SelectedOrdenTramite.numeroOrden
                </h2>
                <span class="close-button" @onclick="CloseTramiteModal">&times;</span>
            </div>

            <div class="modal-body-wrapper">
                <div class="form-section-wrapper">
                    <div class="form-section">

                        <div>
                            <label class="section-label">Fecha de solicitud</label>
                            <div>@SelectedOrdenTramite.fechaSolicitud</div>
                        </div>

                        <div>
                            <label class="section-label">Solicitante</label>
                            <div>@SelectedOrdenTramite.solicitanteInterno</div>
                        </div>

                        <div>
                            <label class="section-label">Cliente</label>
                            <div>@SelectedOrdenTramite.cliente</div>
                        </div>

                        <div>
                            <label class="section-label">Nombre global</label>
                            <div>@SelectedOrdenTramite.nombreGlobal</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha conclusión</label>
                            <div>@SelectedOrdenTramite.fechaConclusionTramite</div>
                        </div>

                    </div>

                    <!-- TABLA DE TRÁMITES -->
                    <div class="form-group-span-2" style="margin-top:18px;">
                        <label class="section-label">Trámites individuales</label>

                        <table class="tasks-table" style="width:100%; border-collapse:collapse;">
                            <thead style="background:#f0f0f0;">
                                <tr>
                                    <th>Clave</th>
                                    <th>Trámite</th>
                                    <th>Encargado</th>
                                    <th>Tareas</th>
                                    <th>Detalle</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var tr in SelectedOrdenTramite.tramitesIndividuales)
                                {
                                    <tr style="border-bottom:1px solid #ddd;">
                                        <td>@tr.clave</td>
                                        <td>@tr.tramiteIndividual</td>
                                        <td>@tr.personalEncargado</td>
                                        <td style="text-align:center;">
                                            <button class="btn-eye"
                                                    @onclick="() => AbrirModalTareas(tr.idTramite)">
                                                <i class="fa fa-eye"></i>
                                            </button>
                                        </td>
                                        <td style="text-align:center;">
                                            <button class="btn-eye"
                                                    @onclick="() => AbrirModalDetalle(tr.idTramite)">
                                                <i class="fa fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CloseTramiteModal">Cerrar</button>
            </div>
        </div>
    </div>
}

@if (ShowTareasModal && TramiteSeleccionado != null)
{
    <div class="modal-container visible" @onclick="CerrarModalTareas">
        <div class="modal-content"
             @onclick:stopPropagation="true"
             style="max-width:800px; width:90%;">

            <div class="modal-header" style="background:#FFDAC1; color:#000;">
                <h3 class="modal-title">
                    Tareas – @TramiteSeleccionado.clave
                </h3>
                <span class="close-button" @onclick="CerrarModalTareas">&times;</span>
            </div>

            <div class="modal-body-wrapper">
                <table class="tasks-table" style="width:100%; border-collapse:collapse;">
                    <thead style="background:#f0f0f0;">
                        <tr>
                            <th>Clave</th>
                            <th>Tarea</th>
                            <th>Encargado</th>
                            <th>Fecha fin</th>
                            <th>Avance</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var t in TramiteSeleccionado.tareas)
                        {
                            <tr style="border-bottom:1px solid #ddd;">
                                <td>@t.claveTarea</td>
                                <td>@t.tarea</td>
                                <td>@t.encargadoTarea</td>
                                <td>@t.fechaConclusion</td>
                                <td>@t.avance</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CerrarModalTareas">Cerrar</button>
            </div>
        </div>
    </div>
}

@if (ShowDetalleModal && TramiteSeleccionado != null)
{
    <div class="modal-container visible" @onclick="CerrarModalDetalle">
        <div class="modal-content"
             @onclick:stopPropagation="true"
             style="max-width:500px; width:80%; border-radius:10px;">

            <div class="modal-header" style="background:#FFDAC1; color:#000;">
                <h3 class="modal-title">
                    Detalle Trámite – @TramiteSeleccionado.clave
                </h3>
                <span class="close-button" @onclick="CerrarModalDetalle">&times;</span>
            </div>

            <div class="modal-body-wrapper" style="padding:15px;">

                <div>
                    <label class="section-label">Encargado</label>
                    <div>@TramiteSeleccionado.personalEncargado</div>
                </div>

                <div>
                    <label class="section-label">Dependencia</label>
                    <div>@TramiteSeleccionado.dependencia</div>
                </div>

                <div>
                    <label class="section-label">Estado</label>
                    <div>@TramiteSeleccionado.estadoTramite</div>
                </div>

                <div>
                    <label class="section-label">Observación</label>
                    <div>@TramiteSeleccionado.observacion</div>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CerrarModalDetalle">Cerrar</button>
            </div>
        </div>
    </div>
}




@code {

    // ---- FECHAS Y CALENDARIO ----
    private DateTime FechaSeleccionada { get; set; } = DateTime.Now.Date;
    private DateTime MesActual { get; set; } = DateTime.Now.Date;
    private bool MostrarModal { get; set; } = false;
    private string[] DiasSemana = { "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom" };
    private IEnumerable<DateTime> DiasDelCalendario { get; set; } = Enumerable.Empty<DateTime>();
    private string FechaFormateada => FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"));
    // Variables del modalde eliminar (aseguradas como nullable)
    private bool MostrarDialogoEliminar = false;
    private SubtaskModel? SubtaskAEliminar = null;
    private CategoryModel? CategoriaDeSubtask = null;
    private List<AutoevaluacionDTO> AutoevaluacionDelDia { get; set; } = new();
    private bool AutoevalCollapsed { get; set; } = false;
    //VARIABLES DE ORDES DE TRAMITE
    private bool ShowTramiteModal { get; set; }
    private OrdenTramiteDTO? SelectedOrdenTramite { get; set; }

    // ---- PARA AGENDA ----
    private List<TareaApi> TareasDelDia = new();
    private List<CategoryModel> Categories { get; set; } = new();
    private int currentAgendaId;
    private List<CategoryModel> MasterCategories = new();
    private List<OrdenTrabajoModel> OrdenesParaMostrar = new();

    private bool ShowTaskDetailsModal = false;
    private TareaOrdenModel? SelectedTask;
    private ViewAgendaItem? SelectedViewItem;


    //AUTOEVALUACION
    private List<AutoevaluacionDiaModel> AutoevaluacionesDelDia = new();
    private void ShowTaskModal(TareaOrdenModel task)
    {
        SelectedTask = task;
        ShowTaskDetailsModal = true;
    }
    void VerTarea(TareaApiDto t)
    {
        SelectedViewItem = new ViewAgendaItem
        {
            Tipo = "Tarea",
            Title = t.titulo,
            Descripcion = t.descripcion,

            Prioridad = t.idPrioridad,
            EsRecurrente = t.esRecurrente,
            ReglaRecurrencia = t.reglaRecurrencia ?? "",
            FechaInicio = t.fechaInicio,
            FechaFin = t.fechaFin,
            Subtasks = t.subTareas?.Select(st => new SubtaskModel
            {
                Title = st.titulo,

                IsDone = st.completada,
                Tipo = "SubTarea"
            }).ToList() ?? new List<SubtaskModel>()
        };

        ShowViewModal = true;
    }
    void VerEvento(EventoApiDTO e)
    {
        SelectedViewItem = new ViewAgendaItem
        {
            Tipo = "Evento",
            Title = e.titulo,
            Descripcion = e.descripcion,
            FechaInicio = e.fechaInicio,
            FechaFin = e.fechaFin,
            Ubicacion = e.ubicacion,
            Prioridad = e.idPrioridad,
            EsRecurrente = e.esRecurrente,
            ReglaRecurrencia = e.reglaRecurrencia ?? "",

            // ✅ Transformamos la lista de participantes de la API a lista de nombres
            Participantes = e.participantes?.Select(p => p.nombreEmpleado).ToList() ?? new List<string>()
        };
        ShowViewModal = true;
    }


    private void CloseTaskModal()
    {
        ShowTaskDetailsModal = false;
        SelectedTask = null;
    }
    EditableItemModel ConvertToEditable(SubtaskModel st)
    {
        return new EditableItemModel
        {
            Id = st.ApiId,
            IdAgenda = st.IdAgenda,
            Titulo = st.Title,
            Descripcion = st.Descripcion,
            FechaInicio = st.FechaInicio ?? DateTime.Now,
            FechaFin = st.FechaFin ?? DateTime.Now,
            EsRecurrente = false,
            ReglaRecurrencia = null,
            IdPrioridad = st.Prioridad,
            Ubicacion = st.Ubicacion,
            IdsParticipantes = st.Participantes
                .Select(p => int.TryParse(p, out var id) ? id : 0)
                .Where(id => id > 0)
                .ToList(),
            SubTareas = st.Subtasks?.Select(s => s.Title).ToList() ?? new()
        };
    }

    async Task ToggleTareaApi(TareaApi t)
    {
        t.completada = !t.completada;
        await Http.PutAsJsonAsync($"tareas/editar/{t.id}", t);
    }

    void OpenModificarDesdeApi(TareaApi t) { }
    void OpenEditDesdeApi(TareaApi t) { }

    async Task DeleteTareaApi(TareaApi t)
    {
        await Http.DeleteAsync($"tareas/eliminar/{t.id}");
        await CargarTareas();
    }

    async Task CargarTareas()
    {
        TareasDelDia = await AgendaService.ObtenerTareasApi(3);
        StateHasChanged();
    }

    async Task ToggleSubTareaApi(TareaApi tarea, SubTareaApi s)
    {
        s.completada = !s.completada;
        await Http.PutAsJsonAsync($"tareas/editar/{tarea.id}", tarea);
    }

    async Task DeleteInnerSubTareaApi(TareaApi tarea, SubTareaApi s)
    {
        tarea.subTareas.Remove(s);
        await Http.PutAsJsonAsync($"tareas/editar/{tarea.id}", tarea);
    }

    //MODAL DE ORDENES DE TRAMITE COMPLETAMENTE
    // ESTADOS
    bool ShowTareasModal;
    bool ShowDetalleModal;

    TramiteIndividualDTO? TramiteSeleccionado;

    // MÉTODOS
    async Task AbrirModalTareas(int idTramite)
    {
        TramiteSeleccionado =
            await OrdenTramiteService.GetTramiteDetalle(idTramite);

        ShowTareasModal = true;
    }

    async Task AbrirModalDetalle(int idTramite)
    {
        TramiteSeleccionado =
            await OrdenTramiteService.GetTramiteDetalle(idTramite);

        ShowDetalleModal = true;
    }

    void CerrarModalTareas()
    {
        ShowTareasModal = false;
        TramiteSeleccionado = null;
    }

    void CerrarModalDetalle()
    {
        ShowDetalleModal = false;
        TramiteSeleccionado = null;
    }

    //MODAL DE VER TAREAS O EVENTOS
    private bool ShowViewModal { get; set; } = false;


    private void OpenViewModal(SubtaskModel st)
    {
        SelectedViewItem = new ViewAgendaItem
        {
            Tipo = st.Tipo,
            Title = st.Title,
            Descripcion = st.Descripcion,
            FechaInicio = st.FechaInicio,
            FechaFin = st.FechaFin,
            HoraInicio = st.HoraInicio,
            HoraFin = st.HoraFin,
            Ubicacion = st.Ubicacion,
            Prioridad = st.Prioridad,
            EsRecurrente = st.EsRecurrente,         // si lo tienes en tu modelo
            ReglaRecurrencia = st.ReglaRecurrencia, // si lo tienes en tu modelo
            Participantes = st.Participantes,
            Subtasks = st.Subtasks ?? new List<SubtaskModel>()
        };

        ShowViewModal = true;
    }

    // ESTE SIRVE PARA EL CHECK DE TAREAS
    private async Task ToggleSubtaskAsync(SubtaskModel st, ChangeEventArgs e)
    {
        bool nuevoEstado = (bool)e.Value;
        bool estadoAnterior = st.IsDone;

        st.IsDone = nuevoEstado;

        bool ok = false;

        if (st.Tipo == "Tarea")
        {
            ok = await AgendaService.CambiarEstadoTareaAsync(st.ApiId, nuevoEstado);
        }
        else if (st.Tipo == "Evento")
        {
            ok = await AgendaService.CambiarEstadoEventoAsync(st.ApiId, nuevoEstado);
        }
        else if (st.Tipo == "SubTarea")
        {
            ok = await AgendaService.CambiarEstadoSubtareaAsync(st.ApiId, nuevoEstado);
        }

        if (!ok)
        {
            // 🔴 rollback si falla API
            st.IsDone = estadoAnterior;
        }
    }

    private void CloseViewModal()
    {
        SelectedViewItem = null;
        ShowViewModal = false;
    }
    //autoevaluacion de hoy
    bool EsAutoevaluacionHoy(SubtaskModel st)
    {
        return st.Tipo == "Autoevaluacion"
            && st.FechaConclusion.Date == FechaSeleccionada.Date;
    }

    // ---- MODAL FECHA / MOTIVO ----
    private bool ShowModificarFechaModal = false;
    private DateTime FechaActual { get; set; } = DateTime.Now;
    private DateTime? NuevaFecha { get; set; } = DateTime.Now;
    private string Motivo { get; set; } = string.Empty;
    private List<HistorialFechaCambio> HistorialCambios { get; set; } = new();
    private List<TareaCreada> tareasAdministrativas = new();
    private bool MostrarAlerta = false;
    private string MensajeAlerta = string.Empty;
    private string TipoAlerta = "exito";

    private void OpenModificarModal(CategoryModel cat, SubtaskModel st)
    {
        FechaActual = st?.FechaConclusion != default ? st.FechaConclusion : DateTime.Now;
        NuevaFecha = FechaActual;
        Motivo = string.Empty;
        HistorialCambios = GetPropertyValue(st, "HistorialFechas") as List<HistorialFechaCambio> ?? new List<HistorialFechaCambio>();
        MostrarAlerta = false;
        ShowModificarFechaModal = true;
    }

    private void GuardarCambioFecha()
    {
        if (string.IsNullOrWhiteSpace(Motivo))
        {
            MostrarAlerta = true;
            TipoAlerta = "error";
            MensajeAlerta = "El motivo del cambio es obligatorio.";
            return;
        }

        HistorialCambios.Add(new HistorialFechaCambio
        {
            FechaAnterior = FechaActual,
            FechaNueva = NuevaFecha ?? DateTime.Now,
            Motivo = Motivo,
            FechaModificacion = DateTime.Now
        });

        FechaActual = NuevaFecha ?? DateTime.Now;
        MostrarAlerta = true;
        TipoAlerta = "exito";
        MensajeAlerta = "¡Fecha modificada correctamente!";
        StateHasChanged();
    }

    private void CerrarModificarModal() => ShowModificarFechaModal = false;

    private object? GetPropertyValue(object? obj, string propName)
    {
        if (obj == null) return null;
        try
        {
            var prop = obj.GetType().GetProperty(propName);
            if (prop != null) return prop.GetValue(obj);
        }
        catch { }
        return null;
    }

    public class HistorialFechaCambio
    {
        public DateTime FechaAnterior { get; set; }
        public DateTime FechaNueva { get; set; }
        public string Motivo { get; set; } = string.Empty;
        public DateTime FechaModificacion { get; set; } = DateTime.Now;
    }

    void ToggleCollapse(CategoryModel cat) => cat.IsCollapsed = !cat.IsCollapsed;

    class CategoryModel
    {
        public string Name { get; set; }
        public List<SubtaskModel> Subtasks { get; set; } = new();
        public string ColorClass { get; set; } = "pastel-blue";
        public bool IsCollapsed { get; set; } = false;
        public string Icon { get; set; }
    }




    class AutoevaluacionDiaModel
    {
        public int IdRegistro { get; set; }
        public string Actividad { get; set; } = "";
        public bool Realizado { get; set; }
        public DateTime Fecha { get; set; }
        public string Icon { get; set; } = "⭐";
    }

    private async Task ToggleAutoevaluacionDia(
    AutoevaluacionDiaModel item,
    ChangeEventArgs e)
    {

        if (FechaSeleccionada.Date != DateTime.Today)
            return;
        bool nuevoValor =
            e.Value is bool b ? b :
            e.Value is string s && (s == "true" || s == "on");


        item.Realizado = nuevoValor;

        try
        {
            await AutoevaluacionService.MarcarRegistroRealizadoAsync(
                item.IdRegistro,   // ✅ ID REAL
                nuevoValor
            );
        }
        catch
        {

            item.Realizado = !nuevoValor;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarTareasPorFecha();
        GenerarDiasCalendario();
        await PrepararOrdenesVisuales();
        await InitializeMasterCategoriesAsync();
    }
    async Task RecargarVista()
    {
        await InitializeMasterCategoriesAsync();
        StateHasChanged();
    }


    string GetIcon(string title) => title switch
    {
        "Órdenes de Trabajo" => "🧾",
        "Tareas " => "🗂️",
        "Autoevaluación" => "⭐",
        "Servicio a Cliente" => "🏢",
        _ => "📋"
    };

    private async Task InitializeMasterCategoriesAsync()
    {
        if (LoginService.AgendaActual != null)
            currentAgendaId = LoginService.AgendaActual.Value;
        else
        {
            var usuario = LoginService.obtenerUsuarioLogueado();
            if (usuario.IdAgendasAsignadas?.Count > 0)
            {
                currentAgendaId = usuario.IdAgendasAsignadas[0];
                LoginService.SetAgendaActual(currentAgendaId);
            }
            else
                currentAgendaId = 0;
        }

        MasterCategories = new();
        var tareasApi = await AgendaService.ObtenerTareasApi(currentAgendaId);
        var eventosApi = await AgendaService.ObtenerEventos(currentAgendaId);
        var autoevaluacionesApi = await AutoevaluacionService.ObtenerAutoevaluacion();

        var tareasCategory = new CategoryModel
        {
            Name = "Tareas",
            ColorClass = "rosa-administrativa",
            Icon = "📝",
            Subtasks = tareasApi.Select(t => new SubtaskModel
            {

                ApiId = t.id,
                IdAgenda = t.idAgenda,
                Title = t.titulo,
                Descripcion = t.descripcion,      // Asegúrate de traer la descripción
                IsDone = t.completada,
                Tipo = "Tarea",
                Prioridad = t.idPrioridad,
                EsRecurrente = t.esRecurrente,   // 🔹 Esto estaba faltando
                ReglaRecurrencia = t.reglaRecurrencia ?? "", // 🔹 Esto estaba faltando
                FechaInicio = t.fechaInicio,
                FechaFin = t.fechaFin,
                HoraInicio = string.IsNullOrWhiteSpace(t.horaInicio) ? null : TimeOnly.Parse(t.horaInicio),
                Subtasks = t.subTareas?.Select(st => new SubtaskModel
                {
                    Title = st.titulo,

                    IsDone = st.completada,
                    Tipo = "SubTarea",
                }).ToList() ?? new List<SubtaskModel>()
            }).ToList()
        };

        foreach (var ev in eventosApi)
        {
            tareasCategory.Subtasks.Add(new SubtaskModel
            {
                ApiId = ev.id,
                IdAgenda = ev.idAgenda,
                Title = ev.titulo,
                Descripcion = ev.descripcion,
                IsDone = false,
                Tipo = "Evento",
                Icon = "📅",
                FechaInicio = ev.fechaInicio,
                FechaFin = ev.fechaFin,
                HoraInicio = TimeOnly.FromDateTime(ev.fechaInicio),
                HoraFin = TimeOnly.FromDateTime(ev.fechaFin),
                Autor = ev.idAgenda.ToString(),
                Ubicacion = ev.ubicacion,
                Prioridad = ev.idPrioridad,
                EsRecurrente = ev.esRecurrente,
                ReglaRecurrencia = ev.reglaRecurrencia ?? "",
                Participantes = ev.participantes?.Select(p => p.nombreEmpleado).ToList() ?? new List<string>(),
                Subtasks = new()
            });
        }

        // =========================
        // CATEGORÍA: AUTOEVALUACIÓN
        // =========================
        var autoevaluacionCategory = new CategoryModel
        {
            Name = "Autoevaluación",
            ColorClass = "azul-lavanda",
            Icon = "⭐",
        };



        AutoevaluacionesDelDia.Clear();

        foreach (var bloque in autoevaluacionesApi)
        {
            foreach (var tarea in bloque.Tareas)
            {
                foreach (var registro in tarea.Registros)
                {
                    AutoevaluacionesDelDia.Add(new AutoevaluacionDiaModel
                    {
                        IdRegistro = registro.IdRegistro,
                        Actividad = tarea.Tarea,
                        Realizado = registro.Realizado,
                        Fecha = registro.Fecha.ToDateTime(TimeOnly.MinValue),
                        Icon = "⭐"
                    });
                }
            }
        }




        // =========================
        // AGREGAR CATEGORÍAS
        // =========================
        MasterCategories.Add(tareasCategory);
        MasterCategories.Add(new CategoryModel
        {
            Name = "Órdenes de Trabajo",
            ColorClass = "naranja-melocoton",
            Icon = "🔧",
            Subtasks = new()
        });
        MasterCategories.Add(autoevaluacionCategory);
        MasterCategories.Add(new CategoryModel
        {
            Name = "Servicio a Cliente",
            ColorClass = "azul-morado",
            Icon = "🤝",
            Subtasks = new()
        });

        foreach (var c in MasterCategories)
            c.Icon = GetIcon(c.Name);

        CargarTareasPorFecha();
    }

    private async Task CargarTareasPorFecha()
    {
        Categories = MasterCategories.Select(c =>
        {
            bool esOrdenes = c.Name?.Trim() == "Órdenes de Trabajo";

            var subtasksFiltradas = c.Subtasks
                .Where(st => esOrdenes || (st.FechaFin ?? st.FechaConclusion).Date == FechaSeleccionada.Date)
                .Select(st => CloneSubtask(st))
                .ToList();

            return new CategoryModel
            {
                Name = c.Name,
                ColorClass = c.ColorClass,
                Icon = c.Icon,
                Subtasks = subtasksFiltradas
            };
        }).ToList();

        await PrepararOrdenesVisuales();
    }


    private SubtaskModel CloneSubtask(SubtaskModel st)
    {
        return new SubtaskModel
        {
            Id = st.Id,
            Title = st.Title,
            Descripcion = st.Descripcion,
            IsDone = st.IsDone,
            Tipo = st.Tipo,
            Icon = st.Icon,
            FechaInicio = st.FechaInicio,
            FechaFin = st.FechaFin,
            FechaConclusion = st.FechaConclusion,
            FechaSolicitud = st.FechaSolicitud,
            HoraInicio = st.HoraInicio,
            HoraFin = st.HoraFin,
            Autor = st.Autor,
            Cliente = st.Cliente,
            Objetivo = st.Objetivo,
            ObjetivosOtros = st.ObjetivosOtros,
            Prioridad = st.Prioridad,
            Ubicacion = st.Ubicacion,
            Participantes = st.Participantes,

            Subtasks = st.Subtasks?.Select(s => CloneSubtask(s)).ToList() ?? new List<SubtaskModel>()
        };
    }

    // ---- ORDENES ----
    private OrdenTrabajoModel ConvertirOrdenSimple(OrdenTrabajoDTO api, OrdenStatus status) => new()
    {
        Id = api.id,
        // 🔥 NUEVO
        NumeroOrden = api.strClave,
        FechaSolicitud = api.dteFechaSolicitud == DateTime.MinValue ? null : api.dteFechaSolicitud,
        FechaProgramada = api.fechaFinal,
        Autor = api.nombreCompleto ?? string.Empty,
        Cliente = api.nombreCliente ?? string.Empty,
        Objetivo = api.strValor ?? string.Empty,
        ObjetivoOtro = api.strObjetivoOtro ?? string.Empty,
        Status = status,
        Tareas = new List<TareaOrdenModel>()
    };


    //---
    private OrdenTrabajoModel ConvertirTramiteSimple(
     OrdenTramiteDTO t,
     OrdenStatus status)
    {
        return new OrdenTrabajoModel
        {
            IdOrdenTramite = t.idOrden,   // 🔥 ESTE ES EL ID REAL
            NumeroOrden = t.numeroOrden,
            FechaProgramada = DateTime.TryParse(t.fechaSolicitud, out var f) ? f : DateTime.Now,
            Status = status,
            Tipo = TipoOrden.Tramite
        };
    }



    private OrdenTrabajoModel ConvertirOrdenDetalle(OrdenTrabajoDTO api) => new()
    {
        Id = api.id,
        NumeroOrden = api.strClave,
        FechaSolicitud = api.dteFechaSolicitud == DateTime.MinValue ? null : api.dteFechaSolicitud,
        FechaProgramada = api.fechaFinal,
        Autor = api.nombreCompleto ?? string.Empty,
        Cliente = api.nombreCliente ?? string.Empty,
        Objetivo = api.strValor ?? string.Empty,
        ObjetivoOtro = api.strObjetivoOtro ?? string.Empty,
        Status = OrdenStatus.Hoy,
        Tareas = api.tareas?.Select(t => new TareaOrdenModel
        {
            Nombre = t.strNombreTarea,
            DescripcionAutor = t.strDescripcionAutor,
            DescripcionReceptor = t.strDescripcionReceptor,
            Valor = t.avance,
            Observacion = t.strObservacion,
        }).ToList() ?? new List<TareaOrdenModel>()
    };

    private OrdenStatus ConvertirEstadoDesdeString(string estado) => estado switch
    {
        "Vencido" => OrdenStatus.Vencido,
        "Proximo" => OrdenStatus.Proximo,
        "Hoy" => OrdenStatus.Hoy,
        _ => OrdenStatus.Hoy
    };

    /*private async Task PrepararOrdenesVisuales()
    {
        OrdenesParaMostrar = new List<OrdenTrabajoModel>();
        try
        {
            var vencidas = await OrdenTrabajoService.GetOrdenesVencidas();
            var proximas = await OrdenTrabajoService.GetOrdenesProximas();
            var hoy = await OrdenTrabajoService.GetOrdenesHoy();

            if (vencidas != null) OrdenesParaMostrar.AddRange(vencidas.Select(v => ConvertirOrdenSimple(v, OrdenStatus.Vencido)));
            if (proximas != null) OrdenesParaMostrar.AddRange(proximas.Select(p => ConvertirOrdenSimple(p, OrdenStatus.Proximo)));
            if (hoy != null) OrdenesParaMostrar.AddRange(hoy.Select(h => ConvertirOrdenSimple(h, OrdenStatus.Hoy)));
        }
        catch (Exception ex) { Console.WriteLine("ERROR PrepararOrdenesVisuales: " + ex.Message); }

        var otCat = Categories.FirstOrDefault(c => c.Name?.Trim() == "Órdenes de Trabajo");
        if (otCat != null) otCat.IsCollapsed = false;

        StateHasChanged();
    }*/

    private async Task PrepararOrdenesVisuales()
    {
        OrdenesParaMostrar = new();

        try
        {
            // 🔵 ORDENES DE TRABAJO
            var vencidasOT = await OrdenTrabajoService.GetOrdenesVencidas();
            var proximasOT = await OrdenTrabajoService.GetOrdenesProximas();
            var hoyOT = await OrdenTrabajoService.GetOrdenesHoy();

            if (vencidasOT != null)
            {
                OrdenesParaMostrar.AddRange(
                    vencidasOT.Select(o =>
                    {
                        var orden = ConvertirOrdenSimple(o, OrdenStatus.Vencido);
                        orden.Tipo = TipoOrden.Trabajo;
                        return orden;
                    })
                );
            }

            if (proximasOT != null)
            {
                OrdenesParaMostrar.AddRange(
                    proximasOT.Select(o =>
                    {
                        var orden = ConvertirOrdenSimple(o, OrdenStatus.Proximo);
                        orden.Tipo = TipoOrden.Trabajo;
                        return orden;
                    })
                );
            }

            if (hoyOT != null)
            {
                OrdenesParaMostrar.AddRange(
                    hoyOT.Select(o =>
                    {
                        var orden = ConvertirOrdenSimple(o, OrdenStatus.Hoy);
                        orden.Tipo = TipoOrden.Trabajo;
                        return orden;
                    })
                );
            }


            // 🟣 ORDENES DE TRÁMITE
            var vencidasTR = await OrdenTramiteService.GetVencidas();
            var proximasTR = await OrdenTramiteService.GetProximas();
            var hoyTR = await OrdenTramiteService.GetHoy();

            if (vencidasTR != null)
                OrdenesParaMostrar.AddRange(
                    vencidasTR.Select(t => ConvertirTramiteSimple(t, OrdenStatus.Vencido))
                );

            if (proximasTR != null)
                OrdenesParaMostrar.AddRange(
                    proximasTR.Select(t => ConvertirTramiteSimple(t, OrdenStatus.Proximo))
                );

            if (hoyTR != null)
                OrdenesParaMostrar.AddRange(
                    hoyTR.Select(t => ConvertirTramiteSimple(t, OrdenStatus.Hoy))
                );

        }
        catch (Exception ex)
        {
            Console.WriteLine("ERROR PrepararOrdenesVisuales: " + ex.Message);
        }

        var cat = Categories.FirstOrDefault(c => c.Name.Trim() == "Órdenes de Trabajo");
        if (cat != null) cat.IsCollapsed = false;

        StateHasChanged();
    }
    /*private async Task VerOrden(int idOrden)
    {
        try
        {
            var url = $"https://redgm.site:9096/ordenTrabajo/ordenTrabajo/orden/{idOrden}";
            var apiOrden =
                await Http.GetFromJsonAsync<OrdenTrabajoDTO>(url);

            if (apiOrden != null)
            {
                SelectedOrden = ConvertirOrdenDetalle(apiOrden);
                ShowOrderModal = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("ERROR VerOrden(id): " + ex.Message);
        }
    }*/
    private async Task VerOrdenTrabajo(int idOrden)
    {
        try
        {
            var url = $"https://redgm.site:9096/ordenTrabajo/ordenTrabajo/orden/{idOrden}";
            var apiOrden = await Http.GetFromJsonAsync<OrdenTrabajoDTO>(url);

            if (apiOrden != null)
            {
                SelectedOrden = ConvertirOrdenDetalle(apiOrden);
                ShowOrderModal = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("ERROR VerOrdenTrabajo: " + ex.Message);
        }
    }

    private async Task VerOrden(OrdenTrabajoModel ot)
    {
        if (ot == null) return;

        Console.WriteLine($"👁️ Click -> Tipo:{ot.Tipo} | OT:{ot.Id} | TR:{ot.IdOrdenTramite}");

        if (ot.Tipo == TipoOrden.Tramite)
        {
            await VerOrdenTramiteSeguro(ot);
        }
        else
        {
            await VerOrdenTrabajo(ot.Id);
        }
    }






    private bool ShowOrderModal { get; set; } = false;
    private OrdenTrabajoModel? SelectedOrden { get; set; }
    //MODALO PARA ORDENES DE TRAMITE
    /*private async Task VerOrdenTramite(int idOrden)
    {
        try
        {
            var url = $"https://redgm.site/ordenTramite/orden/{idOrden}";
            SelectedOrdenTramite =
                await Http.GetFromJsonAsync<OrdenTramiteDTO>(url);

            if (SelectedOrdenTramite != null)
            {
                ShowTramiteModal = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("ERROR VerOrdenTramite: " + ex.Message);
        }
    }*/
    private async Task VerOrdenTramiteSeguro(OrdenTrabajoModel ot)
    {
        // 🔥 ABRIR MODAL SIEMPRE
        SelectedOrdenTramite = new OrdenTramiteDTO
        {
            numeroOrden = ot.NumeroOrden,
            tramitesIndividuales = new()
        };

        ShowTramiteModal = true;
        StateHasChanged();

        // 🚀 INTENTAR TRAER DETALLE REAL
        if (!ot.IdOrdenTramite.HasValue)
            return;

        try
        {
            var orden = await OrdenTramiteService.GetDetalle(ot.IdOrdenTramite.Value);

            if (orden != null)
            {
                SelectedOrdenTramite = orden;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("❌ ERROR API Trámite: " + ex.Message);
        }
    }



    private void CloseTramiteModal()
    {
        SelectedOrdenTramite = null;
        ShowTramiteModal = false;
    }
    private void OpenOrderModal(OrdenTrabajoModel orden) { SelectedOrden = orden; ShowOrderModal = true; StateHasChanged(); }
    private void CloseOrderModal() { SelectedOrden = null; ShowOrderModal = false; }

    // ---- CALENDARIO ----
    private void DiaAnterior() { FechaSeleccionada = FechaSeleccionada.AddDays(-1); CargarTareasPorFecha(); GenerarDiasCalendario(); }
    private void DiaSiguiente() { FechaSeleccionada = FechaSeleccionada.AddDays(1); CargarTareasPorFecha(); GenerarDiasCalendario(); }
    private void AbrirCalendario() => MostrarModal = true;
    private void CerrarCalendario() => MostrarModal = false;
    private void MesAnterior() { MesActual = MesActual.AddMonths(-1); GenerarDiasCalendario(); }
    private void MesSiguiente() { MesActual = MesActual.AddMonths(1); GenerarDiasCalendario(); }
    private void SeleccionarFecha(DateTime nuevaFecha) { FechaSeleccionada = nuevaFecha; CerrarCalendario(); CargarTareasPorFecha(); }

    private void GenerarDiasCalendario()
    {
        var primerDiaDelMes = new DateTime(MesActual.Year, MesActual.Month, 1);
        int offset = ((int)primerDiaDelMes.DayOfWeek + 6) % 7;
        DiasDelCalendario = Enumerable.Range(0, 42).Select(i => primerDiaDelMes.AddDays(i - offset));
    }

    // ---- TAREAS ----


    void ToggleInnerSubtask(CategoryModel cat, SubtaskModel parent, SubtaskModel inner)
    {
        inner.IsDone = !inner.IsDone;
        parent.IsDone = parent.Subtasks.All(x => x.IsDone);
    }

    bool AllCompleted(CategoryModel cat) => cat.Subtasks != null && cat.Subtasks.Any() && cat.Subtasks.All(st => st.IsDone && (st.Subtasks == null || st.Subtasks.All(s2 => s2.IsDone)));

    int RemainingCount(CategoryModel cat)
    {
        if (cat.Subtasks == null) return 0;
        int count = 0;
        foreach (var st in cat.Subtasks)
        {
            if (!st.IsDone) count++;
            if (st.Subtasks != null) count += st.Subtasks.Count(s => !s.IsDone);
        }
        return count;
    }

    void MarkAll(CategoryModel cat, bool done)
    {
        foreach (var st in cat.Subtasks)
        {
            st.IsDone = done;
            if (st.Subtasks != null) st.Subtasks.ForEach(s2 => s2.IsDone = done);
        }
    }

    void EditSubtask(CategoryModel cat, SubtaskModel st) { Console.WriteLine($"Editar actividad: {st.Title} en {cat.Name}"); }
    void EditInnerSubtask(CategoryModel cat, SubtaskModel parent, SubtaskModel inner) { Console.WriteLine($"Editar subtarea: {inner.Title} en {parent.Title}"); }

    void OpenEditModal(CategoryModel cat, SubtaskModel st) { }
    void OpenEditInnerModal(CategoryModel cat, SubtaskModel parent, SubtaskModel inner) { }
    void CheckSave() { }

    private async Task RefrescarTareas(TareaCreada t)
    {
        await InitializeMasterCategoriesAsync();
        StateHasChanged();
    }
}