@page "/dia2"
@using System.Linq
@using System.Globalization
@inject NavigationManager navigate
@using Microsoft.AspNetCore.Components.Web
@using Newtonsoft.Json
@using pruebas1.Components.DTOs
@using pruebas1.Entidades
@using pruebas1.Components
@using pruebas1.Servicios
@using System.Diagnostics;
@inject IJSRuntime JSRuntime
@inject IJSRuntime JS
@inject HttpClient Http
@using System.Text.Json
@inject IJSRuntime JSRuntime
@inject OrdenTrabajoService OrdenTrabajoService
@inject OrdenTramiteService OrdenTramiteService
@inject AutoevaluacionService AutoevaluacionService
@inject HttpClient Http
@inject AgendaService AgendaService
@inject LoginService LoginService
@inject CalendarioService CalendarioService
@inject SalasEmService SalasService
@inject ReglasRecurrenciaServices ReglasService
@inject ServicioClienteService ServicioClienteService
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<br />
<br />
<br />
  

<div class="agenda-container">
    <div class="top-bar-container">
        <div class="fecha-header">
            <button class="calendar-btn" @onclick="DiaAnterior">
                <i class="bi bi-arrow-left-circle"></i>
            </button>

            <span class="fecha-texto">@FechaFormateada</span>

            <button class="calendar-btn" @onclick="DiaSiguiente">
                <i class="bi bi-arrow-right-circle"></i>
            </button>

            <button class="calendar-btn" @onclick="AbrirCalendario">📅</button>
  
        </div>
  

        @if (MostrarModal)
        {
            <div class="modal-overlay" @onclick="CerrarCalendario">
                <div class="calendar-popover" @onclick:stopPropagation="true">
                    <div class="calendar-header">
                        <button class="calendar-btn" @onclick="MesAnterior">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <strong>@MesActual.ToString("MMMM yyyy", new CultureInfo("es-ES"))</strong>
                        <button class="calendar-btn" @onclick="MesSiguiente">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>

                    <div class="calendar-grid">
                        @foreach (var dia in DiasSemana)
                        {
                            <div class="calendar-week-day"><strong>@dia</strong></div>
                        }
                        @foreach (var day in DiasDelCalendario)
                        {
                            <div class="calendar-day @(day.Month != MesActual.Month ? "calendar-other-month" : "") @(day.Date == DateTime.Now.Date ? "calendar-today" : "")"
                                 @onclick="() => SeleccionarFecha(day)">
                                @day.Day
                            </div>
                        }
                    </div>

                    <div class="calendar-footer">
                        <button class="calendar-btn" @onclick="CerrarCalendario">✖ Cerrar</button>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="text-start">
        <button class="btn-sm refresh-glow"
                @onclick="RefreshData"
                disabled="@isRefreshing">
            @if (isRefreshing)
            {
                <span class="spinner-border spinner-border-sm text-light"></span>
            }
            else
            {
                <span> 🔄 Actualizar</span>
            }
        </button>
    </div>

    <style>
        .refresh-glow {
            background-color: #BDEAF9;
            color: black;
            border: none;
            border-radius: 10px;
            padding: 5px 30px;
            transform: translateY(102px);
            font-weight: 600;
            font-size: 1rem;
            min-width: 32px;
            height: 32px;
            box-shadow: 0 0 8px rgba(183, 183, 183);
            transition: box-shadow 0.25s ease-in-out, background-color 0.25s ease-in-out;
        }

            .refresh-glow:hover,
            .refresh-glow:focus,
            .refresh-glow:active {
                transform: translateY(102px);
            }


        .rotate-icon {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

       
    </style>
    @if (!EsDiaNoLaboral)
    {
        <div class="modal-button-container">
            <ReusableModal OnSave="RefrescarTareas" />
           
        </div>
    }
    @if (EsDiaNoLaboral)
    {
        <div class="dia-inhabil-container">
            <div class="dia-inhabil-card">
                <div class="icono">⛔</div>

                <h2>Día inhábil</h2>

                <h4>
                    @FechaSeleccionada.ToString(
                    "dddd, dd MMMM yyyy",
                                new CultureInfo("es-ES"))
            </h4>

            <p class="descripcion">
                @(DiaNoLaboralActual?.Descripcion
                                ?? DiaNoLaboralActual?.Nombre
                                ?? "No laborable")
            </p>

                <span class="badge-inhabil">
                    @(DiaNoLaboralActual?.Tipo ?? "No laboral")
                </span>
            </div>
        </div>
        }
         
    else
    {
          
   

        @if (Categories.FirstOrDefault(c => c.Name.Trim() == "Tareas") is CategoryModel tareasCat)
        {
            <div class="card block-card @tareasCat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(tareasCat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@tareasCat.Icon @tareasCat.Name</h3>
                    </div>
                    <div class="header-right">
                        @if (AllCompleted(tareasCat))
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            <span class="badge pendiente">@RemainingCount(tareasCat) pendiente(s)</span>
                        }
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(tareasCat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!tareasCat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll @(tareasCat.IsCollapsed ? "collapsed" : "")">
                        <ul class="subtask-list">
                            @foreach (var st in tareasCat.Subtasks)
                            {
                                <li class="subtask-item" @key="st.Id">
                                    <div class="subtask-label @(st.IsDone && tareasCat.Name != "Autoevaluación" ? "done" : "")">

                                        @* --- 1. CHECKBOX (SIEMPRE VISIBLE PARA TAREAS Y EVENTOS PROPIOS) --- *@
                                        @if (st.Tipo == "Tarea" || st.EsEventoMio)
                                        {
                                            <input type="checkbox"
                                                   @bind="st.IsDone"
                                                   @bind:after="() => st.Subtasks.Any() ? ToggleParentSubtaskAsync(st) : ToggleSubtaskAsync(st)" />
                                        }

                                        @* --- 2. ICONO, TÍTULO Y BADGE DE INVITADO --- *@
                                        <span>@(!string.IsNullOrEmpty(st.Icon) ? st.Icon : (st.Tipo == "Evento" ? "📅" : "🗒️"))</span>
                                        <span class="subtask-text">@st.Title</span>

                                        @if (st.IsDone)
                                        {
                                            <small class="done-text">Hecho</small>
                                        }

                                        @if (st.EsInvitado)
                                        {
                                            <span class="badge-compartido" title="Evento al que fuiste invitado">👥</span>
                                        }

                                        @* --- 3. FECHAS Y PRIORIDAD --- *@
                                        @if (st.Tipo == "Evento" && st.FechaInicio.HasValue)
                                        {
                                            <span class="evento-fecha">
                                                @($"{st.FechaInicio.Value:dd/MM/yyyy}")
                                                @(st.HoraInicio.HasValue ? $" {st.HoraInicio.Value:HH\\:mm}" : "")
                                            </span>
                                        }

                                        @if (st.Tipo == "Tarea")
                                        {
                                            <span class="tarea-prioridad prioridad-@st.Prioridad">
                                                <span class="prioridad-dot"></span>
                                                @(st.Prioridad switch { 1 => "Alta", 2 => "Media", 3 => "Baja", _ => "" })
                                            </span>
                                        }

                                        @* --- 4. ACCIONES (LÓGICA DE OCULTAMIENTO DINÁMICO) --- *@
                                        @if (tareasCat.Name.Trim() == "Tareas")
                                        {
                                            <div class="subtask-actions">
                                                @* "Ver" siempre disponible *@
                                                <button class="icon-btn view" title="Ver detalles" @onclick="() => OpenViewModal(st)">
                                                    <i class="bi bi-eye"></i>
                                                </button>

                                                @* SOLO se muestran Editar y Eliminar si NO está marcado como IsDone *@
                                                @if (!st.IsDone)
                                                {
                                                    @if (st.Tipo == "Tarea" || st.EsEventoMio)
                                                    {
                                                        <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditModal(st)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="icon-btn delete" title="Eliminar" @onclick="() => EliminarSubtask(st)">
                                                            <i class="bi bi-trash3"></i>
                                                        </button>
                                                    }
                                                }
                                            </div>
                                        }
                                    </div>

                                    @* --- 5. SUBTAREAS / EVENTOS RELACIONADOS (RESTAURADO) --- *@
                                    @if (st.Subtasks != null && st.Subtasks.Any())
                                    {
                                        <div class="table-wrapper block-scroll">
                                            <ul class="subtask-list">
                                                @foreach (var s2 in st.Subtasks)
                                                {
                                                    <li class="subtask-item">
                                                        <div class="subtask-label @(s2.IsDone ? "done" : "")">
                                                            <input type="checkbox"
                                                                   @bind="s2.IsDone"
                                                                   @bind:after="() => ToggleInnerSubtask(tareasCat, st, s2)" />
                                                            <span class="subtask-text">@s2.Title</span>
                                                        </div>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }


        @if (Categories.FirstOrDefault(c => c.Name.Trim() == "Órdenes de Trabajo") is CategoryModel otCat)
        {
            <div class="card block-card naranja-melocoton">
                <div class="block-header" @onclick="() => ToggleCollapse(otCat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@otCat.Icon Órdenes de Trabajo</h3>
                    </div>
                    <div class="header-right">
                        <span class="badge pendiente">@((OrdenesParaMostrar ?? Enumerable.Empty<OrdenTrabajoModel>()).Count()) orden(es)</span>
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(otCat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!otCat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll">
                        <div class="ordenes-workboard">
                            @if (OrdenesParaMostrar != null && OrdenesParaMostrar.Any())
                            {
                                <div class="columns-container block-scroll">
                                    <!-- 🔴 Columna 1: Vencidas -->
                                    <div class="column column-expired block-scroll">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Vencido).OrderBy(o => o.FechaProgramada))
                                        {
                                            <div class="ot-card ot-expired">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.NumeroOrden</div>
                                                    <div class="ot-date">@ot.FechaProgramada.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-expired">Vencida</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => VerOrden(ot)">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <!-- 🟡 Columna 2: Próximas -->
                                    <div class="column column-soon block-scroll">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Proximo).OrderBy(o => o.FechaProgramada))
                                        {
                                            <div class="ot-card ot-soon">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.NumeroOrden</div>
                                                    <div class="ot-date">@ot.FechaProgramada.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-soon">Próx.</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => VerOrden(ot)">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </button>
                                                </div>

                                            </div>
                                        }
                                    </div>

                                    <!-- 🟢 Columna 3: Normales -->
                                    <div class="column column-normal block-scroll">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Hoy).OrderBy(o => o.FechaProgramada))
                                        {
                                            <div class="ot-card ot-normal">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.NumeroOrden</div>
                                                    <div class="ot-date">@ot.FechaProgramada.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-normal">Hoy</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => VerOrden(ot)">

                                                        <i class="bi bi-eye-fill"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                </div>
                            }
                            else
                            {
                                <div class="no-ordenes">No hay órdenes para mostrar. ¡Esto es preocupante! ⚠️</div>
                            }
                        </div>
                    </div>
                }
            </div>
            <br />
        }
        @foreach (var cat in Categories.Where(c =>
            c.Name.Trim() != "Órdenes de Trabajo" &&
            c.Name.Trim() != "Tareas" &&
            c.Name.Trim() != "Autoevaluación" &&
            c.Name.Trim() != "Servicio a Cliente"))

        {
            <div class="card block-card @cat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(cat)">

                    <div class="header-left">
                        <h3 class="categoria-titulo">@cat.Icon @cat.Name</h3>
                    </div>
                    <div class="header-right">
                        @if (AllCompleted(cat))
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            <span class="badge pendiente">@RemainingCount(cat) pendiente(s)</span>
                        }
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(cat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!cat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll @(cat.IsCollapsed ? "collapsed" : "")">
                        <ul class="subtask-list">
                            @foreach (var st in cat.Subtasks)
                            {
                                <li class="subtask-item">
                                    <div class="subtask-label @(st.IsDone && cat.Name != "Autoevaluación" ? "done" : "")">

                                        else if (cat.Name.Trim() != "Órdenes de Trabajo")
                                        {

                                        @* 
                                        <input type="checkbox"
                                               @bind="st.IsDone"
                                               @bind:after="() => ToggleSubtaskAsync(st)"
                                               disabled="@(st.Tipo == "Tarea" && st.Subtasks.Any(s => !s.IsDone))" /> *@

                                        }

                                        <span class="subtask-text">@st.Title</span>

                                        @if (st.IsDone)
                                        {
                                            <small class="done-text">Hecho</small>
                                        }

                                        @if (cat.Name.Trim() == "Tareas")
                                        {
                                            <div class="subtask-actions">
                                                <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(cat, st)">
                                                    <i class="bi bi-calendar"></i>
                                                </button>
                                                <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditModal(cat, st)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button>🗑️</button>

                                            </div>
                                        }
                                    </div>

                                    @if ((cat.Name.Trim() == "Tareas" || cat.Name.Trim() == "Servicio a Cliente") && st.Subtasks.Any())
                                    {
                                        <div class="table-wrapper block-scroll">
                                            @if (cat.Name.Trim() == "Servicio a Cliente")
                                            {
                                                <table class="subtask-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Actividad</th>
                                                            <th>Hecho</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var s2 in st.Subtasks)
                                                        {
                                                            <tr>
                                                                <td>@s2.Title</td>
                                                                <td>
                                                                    <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(cat, st, s2)" />
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            }
                                            else
                                            {
                                                <ul class="subtask-list">
                                                    @foreach (var s2 in st.Subtasks)
                                                    {
                                                        <li class="subtask-item">
                                                            <div class="subtask-label @(s2.IsDone ? "done" : "")">
                                                                <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(cat, st, s2)" />
                                                                <span class="subtask-text">@($"{s2.Title}")</span>
                                                                <div class="subtask-actions">
                                                                    <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(cat, st)">
                                                                        <i class="bi bi-calendar"></i>
                                                                    </button>
                                                                    <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditInnerModal(cat, st, s2)">
                                                                        <i class="bi bi-pencil"></i>
                                                                    </button>
                                                                    <button>🗑️</button>

                                                                </div>
                                                            </div>
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }

        // 1. Filtramos las actividades que corresponden al día seleccionado
        var autoevalDia = AutoevaluacionesDelDia
        .Where(a => a.Fecha.Date == FechaSeleccionada.Date)
        .ToList();

        // 2. Determinamos si el bloque está vacío para el día seleccionado
        // Si no hay ninguna actividad programada para esa fecha específica, mostramos el mensaje.
        var mostrarMensajeRegistro = !autoevalDia.Any();

        // 3. (Opcional) Saber si todas las del día están listas
        var autoevalCompletadas = autoevalDia.Any() && autoevalDia.All(a => a.Realizado);


        var autoevalPendientes = autoevalDia.Count(a => !a.Realizado);

        @if (true)
        {
            <div class="card block-card azul-lavanda">
                <div class="block-header" @onclick="() => AutoevalCollapsed = !AutoevalCollapsed">
                    <div class="header-left">
                        <h3 class="categoria-titulo">⭐ Autoevaluación</h3>
                    </div>
                    <div class="header-right">
                        @if (autoevalCompletadas)
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            @if (autoevalCompletadas)
                            {
                                <span class="badge completado">Completado ✓</span>
                            }
                            else
                            {
                                <span class="badge pendiente">
                                    @autoevalPendientes pendiente(s)
                                </span>
                            }

                        }

                        <button class="btn btn-floating">
                            @(AutoevalCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!AutoevalCollapsed)
                {
                    <div class="card-body block-body block-scroll">

                        @if (mostrarMensajeRegistro)
                        {
                            <div class="empty-block-message">
                                ¡No tienes tareas programadas para hoy! Registra tu autoevaluación mensual en el apartado "Autoevaluación"
                            </div>
                        }
                        else
                        {
                            <ul class="subtask-list">
                                @foreach (var item in autoevalDia)
                                {
                                    <li class="subtask-item">
                                        <div class="subtask-label">
                                            <input type="checkbox"
                                                   checked="@item.Realizado"
                                                   disabled="@(FechaSeleccionada.Date != DateTime.Today)"
                                                   @onchange="(e) => ToggleAutoevaluacionDia(item, e)" />

                                            <span class="subtask-text">
                                                ⭐ @item.Actividad
                                            </span>

                                            @if (item.Realizado)
                                            {
                                                <small class="done-text">Hecho</small>
                                            }
                                        </div>
                                    </li>
                                }
                            </ul>
                        }

                    </div>


                }
            </div>

            <br />
        }

        @foreach (var cat in Categories.Where(c =>
            c.Name.Trim() == "Servicio a Cliente"))
        {
            <div class="card block-card @cat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(cat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@cat.Icon @cat.Name</h3>
                    </div>
                    <div class="header-right">
                        <span class="badge pendiente">@RemainingCount(cat) pendiente(s)</span>
                        <button class="btn btn-floating" style="font-size:0.8rem;">
                            @(cat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!cat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll">
                        <ul class="subtask-list">
                            @foreach (var st in cat.Subtasks)
                            {
                                <li class="subtask-item">
                                    <div class="subtask-label @(st.IsDone ? "done" : "")">

                                        <input type="checkbox"
                                               @bind="st.IsDone"
                                               @bind:after="() => st.Subtasks.Any() ? ToggleParentSubtaskAsync(st) : ToggleSubtaskAsync(st)" />
                                        <span class="subtask-text">@st.Title</span>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }


    }
</div>

<!-- MODAL DE MODIFICAR HSITORIAS DE FECHAS -->
@if (ShowModificarFechaModal)
{
    <div class="modal-overlay" @onclick="CerrarModificarModal">
        <div class="modal-card" @onclick:stopPropagation="true">
            <h2 class="modal-title">
                <i class="bi bi-calendar-check"></i> Modificar Fecha
            </h2>

            @if (MostrarAlerta)
            {
                <div class="alerta @TipoAlerta">
                    @MensajeAlerta
                </div>
            }

            <div class="modal-body">
                <div class="form-group">
                    <label>📅 Fecha actual</label>
                    <input type="text" class="form-control" value="@FechaActual.ToString("dd/MM/yyyy")" readonly />
                </div>

                <div class="form-group">
                    <label>🗓️ Nueva fecha</label>
                    <div class="datepicker-wrapper">
                        <DatePicker @bind-Value="NuevaFecha"
                                    CssClass="date-control" />
                    </div>
                </div>

                <div class="form-group">
                    <label>📝 Motivo del cambio <span style="color:red;">*</span></label>
                    <textarea class="form-control" rows="3" placeholder="Escribe el motivo del cambio..." @bind="Motivo"></textarea>
                </div>

                @if (HistorialCambios.Any())
                {
                    <div class="historial">
                        <h4>📜 Historial de cambios</h4>
                        <div class="historial-scroll">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Fecha anterior</th>
                                        <th>Nueva fecha</th>
                                        <th>Motivo</th>
                                        <th>Fecha de modificación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var h in HistorialCambios.OrderByDescending(x => x.FechaModificacion))
                                    {
                                        <tr>
                                            <td>@h.FechaAnterior.ToString("dd/MM/yyyy")</td>
                                            <td>@h.FechaNueva.ToString("dd/MM/yyyy")</td>
                                            <td>@h.Motivo</td>
                                            <td>@h.FechaModificacion.ToString("dd/MM/yyyy HH:mm")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>


            <div class="modal-footer">
                <button class="btn-guardar" @onclick="GuardarCambioFecha">
                    <i class="bi bi-save"></i> Guardar
                </button>
                <button class="btn-cancelar" @onclick="CerrarModificarModal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
}

<!-- MODAL DE VISUALIZACIÓN DE ORDEN (EXTRA GRANDE) -->
@if (ShowOrderModal && SelectedOrden != null)
{
    <div class="modal-container visible" @onclick="CloseOrderModal">
        <div class="modal-content" @onclick:stopPropagation="true" style="max-width:1200px; width:95%; height:92vh;">
            <div class="modal-header" style="background:#FFDAC1; color:#000;">
                <h2 class="modal-title">ORDEN-@SelectedOrden.NumeroOrden</h2>
                <span class="close-button" @onclick="CloseOrderModal">&times;</span>
            </div>

            <div class="modal-body-wrapper">
                <div class="form-section-wrapper">
                    <div class="form-section">

                        <!-- Campos de la orden -->
                        <div>
                            <label class="section-label">Número de orden</label>
                            <div>@SelectedOrden.NumeroOrden</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha de solicitud</label>
                            <div>@(SelectedOrden.FechaSolicitud?.ToString("dd/MM/yyyy") ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Autor</label>
                            <div>@(SelectedOrden.Autor ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Nombre / Razón social</label>
                            <div>@(SelectedOrden.Cliente ?? "-")</div>
                        </div>

                        <div class="form-group-span-2">
                            <label class="section-label">Objetivo</label>
                            <div>@(SelectedOrden.Objetivo ?? "-")</div>
                        </div>

                        <div class="form-group-span-2">
                            <label class="section-label">Objetivo de otros</label>
                            <div>@(SelectedOrden.ObjetivoOtro ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha programada de conclusión</label>
                            <div>@SelectedOrden.FechaProgramada.ToString("dd/MM/yyyy")</div>
                        </div>

                    </div>

                    <!-- TABLA DE TAREAS -->
                    <div style="margin-top:18px;" class="form-group-span-2">
                        <label class="section-label">Tareas</label>

                        <table class="tasks-table" style="width:100%; border-collapse:collapse;">
                            <thead style="background:#f0f0f0; text-align:left;">
                                <tr>
                                    <th style="padding:8px; width:30%;">Nombre de la tarea</th>
                                    <th style="padding:8px; width:45%;">Descripción</th>
                                    <th style="padding:8px; width:15%;">Avance</th>
                                    <th style="padding:8px; width:10%;">Ver</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in SelectedOrden.Tareas)
                                {
                                    <tr style="border-bottom:1px solid #ddd;">
                                        <td style="padding:8px;">@t.Nombre</td>

                                        <td style="padding:8px;">
                                            @{
                                                var desc = t.DescripcionAutor
                                                ?? t.DescripcionReceptor
                                                ?? "-";
                                            }
                                            @desc
                                        </td>

                                        <td style="padding:8px;">@($"{t.Valor}")</td>

                                        <td style="padding:8px; text-align:center;">
                                            <button class="btn-eye" @onclick="() => ShowTaskModal(t)">
                                                <i class="fa fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CloseOrderModal">Cerrar</button>
            </div>
        </div>
    </div>
}

<!-- MODAL DE DETALLE DE TAREA ORDENES TRABAJO -->
@if (ShowTaskDetailsModal && SelectedTask != null)
{
    <div class="modal-container visible" @onclick="CloseTaskModal">
        <div class="modal-content" @onclick:stopPropagation="true" style="max-width:500px; width:80%; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.25);">
            <div class="modal-header" style="background:#FFDAC1; color:#fff; border-top-left-radius:10px; border-top-right-radius:10px;">
                <h3 class="modal-title">Detalle de tarea - @SelectedTask.Nombre</h3>
                <span class="close-button" @onclick="CloseTaskModal">&times;</span>
            </div>

            <div class="modal-body-wrapper" style="padding:15px;">

                <div>
                    <label class="section-label">Nombre de la tarea</label>
                    <div>@SelectedTask.Nombre</div>
                </div>

                <div>
                    <label class="section-label">Descripción</label>
                    <div>
                        @{
                            var desc = SelectedTask.DescripcionAutor
                            ?? SelectedTask.DescripcionReceptor
                            ?? "-";
                        }
                        @desc
                    </div>
                </div>

                <div>
                    <label class="section-label">Observación</label>
                    <div>@(SelectedTask.Observacion ?? "-")</div>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CloseTaskModal">Cerrar</button>
            </div>
        </div>
    </div>
}

<!-- MODAL DE DETALLE DE TAREA BLOQUE TAREAS-->
@if (ShowViewModal && SelectedViewItem != null)
{
    <div class="view-overlay" @onclick="CloseViewModal">
        <div class="bento-modal @SelectedViewItem.Tipo.ToLower()" @onclick:stopPropagation="true">

            <div class="bento-header">
                <div class="header-info">
                    <span class="type-tag">@SelectedViewItem.Tipo</span>
                    <h3>🏷️ @SelectedViewItem.Title</h3>
                </div>
                <button class="bento-close" @onclick="CloseViewModal">✕</button>
            </div>

            <div class="bento-grid">
                <div class="bento-item description">
                    <label>📝 Descripción</label>
                    <p>@(string.IsNullOrEmpty(SelectedViewItem.Descripcion) ? "Sin descripción detallada disponible." : SelectedViewItem.Descripcion)</p>
                </div>

                <div class="bento-item status-box">
                    <div class="mini-block">
                        <label>⚡Prioridad</label>
                        <span class="prio-label @(prioridadesLookup.ContainsKey(SelectedViewItem.Prioridad) ? prioridadesLookup[SelectedViewItem.Prioridad] : "Baja")">
                            @(prioridadesLookup.ContainsKey(SelectedViewItem.Prioridad) ? prioridadesLookup[SelectedViewItem.Prioridad] : "Baja")
                        </span>
                    </div>
                    <div class="mini-block">
                        <label>Planificación</label>
                        <div class="time-row">
                            <span><strong>🗓️Inicia:</strong> @SelectedViewItem.FechaInicio?.ToString("dd/MM/yyyy")</span>
                            @if (SelectedViewItem.Tipo == "Evento")
                            {
                                <small>🕒@SelectedViewItem.HoraInicio?.ToString("HH:mm")</small>
                            }
                        </div>
                        <div class="time-row">
                            <span><strong>🗓️Termina:</strong> @SelectedViewItem.FechaFin?.ToString("dd/MM/yyyy")</span>
                            @if (SelectedViewItem.Tipo == "Evento")
                            {
                                <small>🕒@SelectedViewItem.HoraFin?.ToString("HH:mm")</small>
                            }
                        </div>
                    </div>
                </div>

                @if (SelectedViewItem.Tipo == "Evento")
                {
                    <div class="bento-item location-box">
                        <label>📍 Ubicación</label>
                        <p>@SelectedViewItem.Ubicacion</p>
                    </div>

                    <div class="bento-item creator-box">
                        <label>👑 Organizado por</label>
                        <p>@SelectedViewItem.NombreCreador</p>
                    </div>
                }

                @if (SelectedViewItem.Participantes?.Any() == true)
                {
                    <div class="bento-item people-box full-width">
                        <label>👥 Equipo de Trabajo</label>
                        <div class="names-grid">
                            @foreach (var p in SelectedViewItem.Participantes)
                            {
                                <span class="full-name-tag">📌 @p</span>
                            }
                        </div>
                    </div>
                }

                @if (SelectedViewItem.Tipo == "Tarea" && SelectedViewItem.Subtasks?.Any() == true)
                {
                    <div class="bento-item tasks-box full-width">
                        <label> ✅Subtareas asociadas</label>
                        <div class="subtasks-grid">
                            @foreach (var s in SelectedViewItem.Subtasks)
                            {
                                <div class="subtask-card">  @s.Title</div>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="bento-footer">
                <button class="bento-btn" @onclick="CloseViewModal">Cerrar</button>
            </div>
        </div>
    </div>
}

<!--MODAL DE ORDENES DE TRAMITE-->
@if (ShowTramiteModal && SelectedOrdenTramite != null)
{
    <div class="modal-container visible" @onclick="CloseTramiteModal">
        <div class="modal-content"
             @onclick:stopPropagation="true"
             style="max-width:1200px; width:95%; height:92vh;">

            <div class="modal-header" style="background:#FFDAC1; color:#000;">
                <h2 class="modal-title">
                    ORDEN DE TRÁMITE – @SelectedOrdenTramite.numeroOrden
                </h2>
                <span class="close-button" @onclick="CloseTramiteModal">&times;</span>
            </div>

            <div class="modal-body-wrapper">
                <div class="form-section-wrapper">
                    <div class="form-section">

                        <div>
                            <label class="section-label">Fecha de solicitud</label>
                            <div>@SelectedOrdenTramite.fechaSolicitud</div>
                        </div>

                        <div>
                            <label class="section-label">Solicitante</label>
                            <div>@SelectedOrdenTramite.solicitanteInterno</div>
                        </div>

                        <div>
                            <label class="section-label">Cliente</label>
                            <div>@SelectedOrdenTramite.cliente</div>
                        </div>

                        <div>
                            <label class="section-label">Nombre global</label>
                            <div>@SelectedOrdenTramite.nombreGlobal</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha conclusión</label>
                            <div>@SelectedOrdenTramite.fechaConclusionTramite</div>
                        </div>

                    </div>

                    <!-- TABLA DE TRÁMITES -->
                    <div class="form-group-span-2" style="margin-top:18px;">
                        <label class="section-label">Trámites individuales</label>

                        <table class="tasks-table" style="width:100%; border-collapse:collapse;">
                            <thead style="background:#f0f0f0;">
                                <tr>
                                    <th>Clave</th>
                                    <th>Trámite</th>
                                    <th>Encargado</th>
                                    <th>Tareas</th>
                                    <th>Detalle</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var tr in SelectedOrdenTramite.tramitesIndividuales)
                                {
                                    <tr style="border-bottom:1px solid #ddd;">
                                        <td>@tr.clave</td>
                                        <td>@tr.tramiteIndividual</td>
                                        <td>@tr.personalEncargado</td>
                                        <td style="text-align:center;">
                                            <button class="btn-eye"
                                                    @onclick="() => AbrirModalTareas(tr.idTramite)">
                                                <i class="fa fa-eye"></i>
                                            </button>
                                        </td>
                                        <td style="text-align:center;">
                                            <button class="btn-eye"
                                                    @onclick="() => AbrirModalDetalle(tr.idTramite)">
                                                <i class="fa fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CloseTramiteModal">Cerrar</button>
            </div>
        </div>
    </div>
}

@if (ShowTareasModal && TramiteSeleccionado != null)
{
    <div class="modal-container visible" @onclick="CerrarModalTareas">
        <div class="modal-content"
             @onclick:stopPropagation="true"
             style="max-width:800px; width:90%;">

            <div class="modal-header" style="background:#FFDAC1; color:#000;">
                <h3 class="modal-title">
                    Tareas – @TramiteSeleccionado.clave
                </h3>
                <span class="close-button" @onclick="CerrarModalTareas">&times;</span>
            </div>

            <div class="modal-body-wrapper">
                <table class="tasks-table" style="width:100%; border-collapse:collapse;">
                    <thead style="background:#f0f0f0;">
                        <tr>
                            <th>Clave</th>
                            <th>Tarea</th>
                            <th>Encargado</th>
                            <th>Fecha fin</th>
                            <th>Avance</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var t in TramiteSeleccionado.tareas)
                        {
                            <tr style="border-bottom:1px solid #ddd;">
                                <td>@t.claveTarea</td>
                                <td>@t.tarea</td>
                                <td>@t.encargadoTarea</td>
                                <td>@t.fechaConclusion</td>
                                <td>@t.avance</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CerrarModalTareas">Cerrar</button>
            </div>
        </div>
    </div>
}

@if (ShowDetalleModal && TramiteSeleccionado != null)
{
    <div class="modal-container visible" @onclick="CerrarModalDetalle">
        <div class="modal-content"
             @onclick:stopPropagation="true"
             style="max-width:500px; width:80%; border-radius:10px;">

            <div class="modal-header" style="background:#FFDAC1; color:#000;">
                <h3 class="modal-title">
                    Detalle Trámite – @TramiteSeleccionado.clave
                </h3>
                <span class="close-button" @onclick="CerrarModalDetalle">&times;</span>
            </div>

            <div class="modal-body-wrapper" style="padding:15px;">

                <div>
                    <label class="section-label">Encargado</label>
                    <div>@TramiteSeleccionado.personalEncargado</div>
                </div>

                <div>
                    <label class="section-label">Dependencia</label>
                    <div>@TramiteSeleccionado.dependencia</div>
                </div>

                <div>
                    <label class="section-label">Estado</label>
                    <div>@TramiteSeleccionado.estadoTramite</div>
                </div>

                <div>
                    <label class="section-label">Observación</label>
                    <div>@TramiteSeleccionado.observacion</div>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CerrarModalDetalle">Cerrar</button>
            </div>
        </div>
    </div>
}

<!--MODAAL PARA EDITAR-->
@if (ShowEditModal && EditItem != null)
{
    <div class="modern-modal-overlay">
        <div class="modern-modal-container shadow-lg">

            <div class="modern-modal-header @(EditItem.Tipo == "Evento" ? "header-evento" : "header-tarea")">
                <div class="header-info">
                    <span class="type-badge">@EditItem.Tipo.ToUpper()</span>
                    <h3 class="modal-title">Editar Registro</h3>
                </div>
                <button type="button" class="modern-close-btn" @onclick="() => ShowEditModal = false">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modern-modal-content">
                <div class="modern-form-grid">

                    <div class="form-main-column">
                        <div class="modern-field">
                            <label><i class="bi bi-fonts"></i> Título del @EditItem.Tipo</label>
                            <input @bind="EditItem.Titulo" placeholder="Ej: Reunión de presupuesto" class="modern-input" />
                        </div>

                        <div class="modern-field">
                            <label><i class="bi bi-justify-left"></i> Descripción detallada</label>
                            <textarea @bind="EditItem.Descripcion" rows="3" placeholder="Añade notas adicionales..." class="modern-input"></textarea>
                        </div>

                        @if (EditItem.Tipo == "Tarea")
                        {
                            <div class="modern-field">
                                <label><i class="bi bi-list-check"></i> Checklist de Subtareas</label>
                                <div class="modern-input-group">
                                    <input @bind="nuevaSubtareaTexto" placeholder="¿Qué sigue?" class="modern-input" />
                                    <button type="button" class="add-inner-btn" @onclick="AgregarSubtarea">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                                <div class="modern-subtask-list">
                                    @foreach (var sub in EditItem.Subtareas)
                                    {
                                        <div class="modern-subtask-item" @key="sub">
                                            <span>@sub.Titulo</span>
                                            <button type="button" @onclick="() => EliminarSubtarea(sub)" class="btn-basura">🗑️</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (EditItem.Tipo == "Evento")
                        {
                            <div class="modern-field">
                                <label>📍 Ubicación / Sala</label>
                                <select class="form-select"
                                        value="@EditItem.Ubicacion"
                                        @onchange="OnUbicacionChanged">
                                    <option value="">Seleccione...</option>
                                    @foreach (var s in salasLookup)
                                    {
                                        <option value="@s.Value">@s.Value</option>
                                    }
                                    <option value="-1">Otro...</option>
                                </select>

                                @if (mostrarOtraUbicacion)
                                {
                                    <input class="form-control mt-2"
                                           placeholder="Escribe la ubicación personalizada"
                                           @bind="ubicacionOtra" />
                                }
                            </div>
                            <div class="modern-field">
                                <label><i class="bi bi-people"></i> Invitados / Participantes</label>
                                <div class="autocomplete-container" style="position: relative;">

                                    <div class="chips-container">
                                        @if (EditItem?.Participantes != null)
                                        {
                                            @foreach (var p in EditItem.Participantes)
                                            {
                                                <div class="chip">
                                                    @p.Nombre @(p.ClavePersonal > 0 ? $"({p.ClavePersonal})" : "")
                                                    <span class="chip-remove" @onclick="() => QuitarParticipante(p)">×</span>
                                                </div>
                                            }
                                        }

                                        <input type="text"
                                               class="chip-input"
                                               placeholder="Escribe nombre o número..."
                                               value="@searchText"
                                               @oninput="FiltrarEmpleados" />
                                    </div>

                                    @if (mostrarLista && empleadosFiltrados?.Count > 0)
                                    {
                                        <ul class="autocomplete-list shadow-lg"
                                            style="position: absolute;
                                   top: 100%;
                                   left: 0;
                                   width: 100%;
                                   z-index: 9999;
                                   background-color: white;
                                   border: 1px solid #dee2e6;
                                   border-radius: 8px;
                                   margin-top: 5px;
                                   max-height: 250px;
                                   overflow-y: auto;
                                   box-shadow: 0px 8px 16px rgba(0,0,0,0.15);
                                   list-style: none;
                                   padding: 0;">

                                            @foreach (var emp in empleadosFiltrados)
                                            {
                                                <li @onclick="() => SeleccionarParticipante(emp)"
                                                    style="padding: 10px 15px;
                                               border-bottom: 1px solid #f8f9fa;
                                               cursor: pointer;
                                               transition: background 0.2s;">

                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <strong>@emp.Nombre</strong>
                                                        <span class="badge bg-light text-dark">@emp.ClavePersonal</span>
                                                    </div>
                                                    <small class="text-muted" style="display: block;">@emp.Puesto — @emp.Area</small>
                                                </li>
                                            }
                                        </ul>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <div class="form-side-column">
                        <div class="modern-field">
                            <label>⚡ Prioridad</label>
                            <select class="form-select" @bind="EditItem.Prioridad">
                                @foreach (var p in prioridadesLookup)
                                {
                                    <option value="@p.Key">@p.Value</option>
                                }
                            </select>
                        </div>

                        <div class="modern-field">
                            <label>📅 Fecha Inicio</label>
                            <DatePicker Value="EditItem.FechaInicio"
                                        ValueChanged="OnFechaInicioChanged"
                                        CssClass="modern-input" />

                        </div>
                        <div class="modern-field">
                            <label>🏁 Fecha Fin</label>
                            <DatePicker Value="EditItem.FechaFin"
                                        ValueChanged="OnFechaFinChanged"
                                        CssClass="modern-input" />
                        </div>

                        @if (EditItem.Tipo == "Evento")
                        {
                            <div class="modern-row">
                                <div class="modern-field">
                                    <label>⏰ Inicio</label>
                                    <TimePickerList Value="EditItem.HoraInicio"
                                                    ValueChanged="@(v => OnHoraInicioChanged(v))" />
                                </div>
                                <div class="modern-field">
                                    <label>⏰ Fin</label>
                                    <TimePickerList Value="EditItem.HoraFin"
                                                    ValueChanged="@(v => OnHoraFinChanged(v))" />
                                </div>
                            </div>
                        }

                        <div class="modern-field">
                            <label>🔄 Recurrencia</label>
                            <select class="modern-input"
                                    @bind-value="EditItem.ReglaRecurrencia"
                                    @bind-value:event="onchange">
                                <option value="">No se repite</option>
                                @foreach (var f in frecuenciaLookup)
                                {
                                    <option value="@f.Value">@f.Value</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modern-modal-footer">
                <button class="m-btn btn-primary" @onclick="HandleSave">


                    <i class="bi bi-cloud-check"></i> Guardar Información
                </button>
                <button class="m-btn btn-ghost" @onclick="() => ShowEditModal = false">Cancelar</button>
            </div>
        </div>
    </div>
}


@code {

    // ---- FECHAS Y CALENDARIO ----
    private DateTime FechaSeleccionada { get; set; } = DateTime.Now.Date;
    private DateTime MesActual { get; set; } = DateTime.Now.Date;
    private bool MostrarModal { get; set; } = false;
    private string[] DiasSemana = { "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom" };
    private IEnumerable<DateTime> DiasDelCalendario { get; set; } = Enumerable.Empty<DateTime>();
    private string FechaFormateada => FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"));
    // Variables del modalde eliminar (aseguradas como nullable)
    private bool MostrarDialogoEliminar = false;
    private SubtaskModel? SubtaskAEliminar = null;
    private CategoryModel? CategoriaDeSubtask = null;
    private List<AutoevaluacionDTO> AutoevaluacionDelDia { get; set; } = new();
    private bool AutoevalCollapsed { get; set; } = false;
    //VARIABLES DE ORDES DE TRAMITE
    private bool ShowTramiteModal { get; set; }
    private OrdenTramiteDTO? SelectedOrdenTramite { get; set; }
    // ---- PARA AGENDA ----
    private List<TareaApi> TareasDelDia = new();
    private List<CategoryModel> Categories { get; set; } = new();
    private int currentAgendaId;
    private List<CategoryModel> MasterCategories = new();
    private List<OrdenTrabajoModel> OrdenesParaMostrar = new();
    private List<AutoevaluacionDiaModel> AutoevaluacionesDelDia = new();
    private int usuarioActualId;
    private bool ShowTaskDetailsModal = false;
    private TareaOrdenModel? SelectedTask;
    private ViewAgendaItem? SelectedViewItem;
    private List<string> erroresFormulario = new();
    private Dictionary<int, string> salasLookup = new();
    private Dictionary<int, string> prioridadesLookup = new();
    private Dictionary<int, string> frecuenciaLookup = new();
    // ---- DÍAS INHÁBILES ----
    private List<DiaNoLaboralDto> DiasNoLaborales = new();
    private DiaNoLaboralDto? DiaNoLaboralActual;
    private bool EsDiaNoLaboral => DiaNoLaboralActual != null;
    //-----PARA EDITAR----
    private bool ShowEditModal = false;
    private EditAgendaItemModel? EditItem;
    string ubicacionOtra = "";
    private string nuevoParticipante = "";
    private string nuevaSubtareaTexto = "";
    bool mostrarOtraUbicacion = false;
    //MODAL DE ORDENES DE TRAMITE COMPLETAMENTE
    bool ShowTareasModal;
    bool ShowDetalleModal;
    TramiteIndividualDTO? TramiteSeleccionado;
    private bool ShowOrderModal { get; set; } = false;
    private OrdenTrabajoModel? SelectedOrden { get; set; }
    // ---- MODAL FECHA / MOTIVO ----
    private bool ShowModificarFechaModal = false;
    private DateTime FechaActual { get; set; } = DateTime.Now;
    private DateTime? NuevaFecha { get; set; } = DateTime.Now;
    private string Motivo { get; set; } = string.Empty;
    private List<HistorialFechaCambio> HistorialCambios { get; set; } = new();
    private List<TareaCreada> tareasAdministrativas = new();
    private bool MostrarAlerta = false;
    private string MensajeAlerta = string.Empty;
    private string TipoAlerta = "exito";

    private async Task VerificarDiaNoLaboralAsync()
    {
        DiaNoLaboralActual = null;


        if (FechaSeleccionada.DayOfWeek == DayOfWeek.Sunday)
        {
            DiaNoLaboralActual = new()
            {
                Nombre = "Domingo",
                Descripcion = "No se labora los domingos",
                Tipo = "No laboral",
                Fecha = FechaSeleccionada
            };

            return;
        }


        DiasNoLaborales = await CalendarioService.ObtenerDiasNoLaborales(
            FechaSeleccionada.Year,
            FechaSeleccionada.Month
        );

        DiaNoLaboralActual = DiasNoLaborales.FirstOrDefault(d =>
            d.DiaInhabil.Date == FechaSeleccionada.Date ||
            d.Fecha.Date == FechaSeleccionada.Date
        );
    }

    private void ShowTaskModal(TareaOrdenModel task)
    {
        SelectedTask = task;
        ShowTaskDetailsModal = true;
    }
    void VerTarea(TareaApiDto t)
    {
        SelectedViewItem = new ViewAgendaItem
        {
            Tipo = "Tarea",
            Title = t.titulo,
            Descripcion = t.descripcion,
            Prioridad = t.idPrioridad,
            EsRecurrente = t.esRecurrente,
            ReglaRecurrencia = t.reglaRecurrencia ?? "",
            FechaInicio = t.fechaInicio,
            FechaFin = t.fechaFin,
            Subtasks = t.subTareas?.Select(st => new SubtaskModel
            {
                Title = st.titulo,

                IsDone = st.completada,
                Tipo = "SubTarea"
            }).ToList() ?? new List<SubtaskModel>()
        };

        ShowViewModal = true;
    }
    void VerEvento(EventoApiDTO e)
    {
        bool esMio = e.creadorId == usuarioActualId;
        bool soyInvitado = !esMio &&
            e.participantes.Any(p => p.idEmpleado == usuarioActualId);

        SelectedViewItem = new ViewAgendaItem
        {
            Tipo = "Evento",
            Title = e.titulo,
            Descripcion = e.descripcion,

            FechaInicio = e.fechaInicio.Date,
            FechaFin = e.fechaFin.Date,
            HoraInicio = TimeOnly.FromDateTime(e.fechaInicio),
            HoraFin = TimeOnly.FromDateTime(e.fechaFin),
            Ubicacion = e.ubicacion,
            Prioridad = e.idPrioridad,
            EsRecurrente = e.esRecurrente,
            ReglaRecurrencia = e.reglaRecurrencia ?? "Sin regla",
            Participantes = e.participantes?.Select(p => p.nombreEmpleado).ToList() ?? new(),
            EsEventoMio = esMio,
            EsInvitado = soyInvitado,
            NombreCreador = e.nombreCreador
        };

        ShowViewModal = true;
    }


    private void CloseTaskModal()
    {
        ShowTaskDetailsModal = false;
        SelectedTask = null;
    }

    async Task ToggleTareaApi(TareaApi t)
    {
        t.completada = !t.completada;


        await Http.PutAsJsonAsync($"tareas/editar/{t.id}", t);
    }

    void OpenModificarDesdeApi(TareaApi t) { }
    void OpenEditDesdeApi(TareaApi t) { }

    async Task DeleteTareaApi(TareaApi t)
    {
        await Http.DeleteAsync($"tareas/eliminar/{t.id}");
        await CargarTareas();
    }

    async Task CargarTareas()
    {
        TareasDelDia = await AgendaService.ObtenerTareasApi(3);
        StateHasChanged();
    }

    async Task ToggleSubTareaApi(TareaApi tarea, SubTareaApi s)
    {
        s.completada = !s.completada;
        await Http.PutAsJsonAsync($"tareas/editar/{tarea.id}", tarea);
    }

    async Task DeleteInnerSubTareaApi(TareaApi tarea, SubTareaApi s)
    {
        tarea.subTareas.Remove(s);
        await Http.PutAsJsonAsync($"tareas/editar/{tarea.id}", tarea);
    }
    async Task AbrirModalTareas(int idTramite)
    {
        TramiteSeleccionado =
            await OrdenTramiteService.GetTramiteDetalle(idTramite);

        ShowTareasModal = true;
    }

    async Task AbrirModalDetalle(int idTramite)
    {
        TramiteSeleccionado =
            await OrdenTramiteService.GetTramiteDetalle(idTramite);

        ShowDetalleModal = true;
    }

    void CerrarModalTareas()
    {
        ShowTareasModal = false;
        TramiteSeleccionado = null;
    }

    void CerrarModalDetalle()
    {
        ShowDetalleModal = false;
        TramiteSeleccionado = null;
    }
    private bool ShowViewModal { get; set; } = false;

    private async Task OpenViewModal(SubtaskModel st)
    {
        if (st.Tipo == "Tarea")
        {
            var t = await AgendaService.ObtenerTareaDetalle(st.ApiId);
            if (t == null) return;

            SelectedViewItem = new ViewAgendaItem
            {
                Tipo = "Tarea",
                Title = t.titulo,
                Descripcion = t.descripcion,
                Prioridad = t.idPrioridad,
                EsRecurrente = t.esRecurrente,
                ReglaRecurrencia = t.reglaRecurrencia ?? "",
                FechaInicio = t.fechaInicio,
                FechaFin = t.fechaFin,
                Subtasks = t.subTareas?.Select(s => new SubtaskModel
                {
                    Title = s.titulo,
                    IsDone = s.completada
                }).ToList() ?? new()
            };
        }
        else 
        {
            var e = await AgendaService.ObtenerEventoDetalle(st.ApiId);
            if (e == null) return;
            bool esMio = e.creadorId == usuarioActualId;
            bool soyInvitado = !esMio &&
                e.participantes.Any(p => p.idEmpleado == usuarioActualId);

            SelectedViewItem = new ViewAgendaItem
            {
                Tipo = "Evento",
                Title = e.titulo,
                Descripcion = e.descripcion,


                FechaInicio = e.fechaInicio.Date,
                FechaFin = e.fechaFin.Date,


                HoraInicio = TimeOnly.FromDateTime(e.fechaInicio),
                HoraFin = TimeOnly.FromDateTime(e.fechaFin),


                Ubicacion = e.idSala.HasValue
                && e.idSala.Value > 0
                && salasLookup.ContainsKey(e.idSala.Value)
                    ? salasLookup[e.idSala.Value]
                    : e.ubicacion,
                Prioridad = e.idPrioridad,
                EsRecurrente = e.esRecurrente,
                ReglaRecurrencia = e.esRecurrente
                    && int.TryParse(e.reglaRecurrencia, out int freqId)
                    && frecuenciaLookup.ContainsKey(freqId)
                        ? frecuenciaLookup[freqId]
            : "No recurrente",
                CreadorId = e.creadorId,
                NombreCreador = e.nombreCreador,
                Participantes = e.participantes?
              .Select(p => p.nombreEmpleado)
              .ToList() ?? new(),
                EsEventoMio = esMio,
                EsInvitado = soyInvitado
            };
        }


        ShowViewModal = true;
    }
    private void CloseViewModal()
    {
        SelectedViewItem = null;
        ShowViewModal = false;
    }

    bool EsAutoevaluacionHoy(SubtaskModel st)
    {
        return st.Tipo == "Autoevaluacion"
            && st.FechaConclusion.Date == FechaSeleccionada.Date;
    }

    private void OpenModificarModal(CategoryModel cat, SubtaskModel st)
    {
        FechaActual = st?.FechaConclusion != default ? st.FechaConclusion : DateTime.Now;
        NuevaFecha = FechaActual;
        Motivo = string.Empty;
        HistorialCambios = GetPropertyValue(st, "HistorialFechas") as List<HistorialFechaCambio> ?? new List<HistorialFechaCambio>();
        MostrarAlerta = false;
        ShowModificarFechaModal = true;
    }


    private void GuardarCambioFecha()
    {
        if (string.IsNullOrWhiteSpace(Motivo))
        {
            MostrarAlerta = true;
            TipoAlerta = "error";
            MensajeAlerta = "El motivo del cambio es obligatorio.";
            return;
        }

        HistorialCambios.Add(new HistorialFechaCambio
        {
            FechaAnterior = FechaActual,
            FechaNueva = NuevaFecha ?? DateTime.Now,
            Motivo = Motivo,
            FechaModificacion = DateTime.Now
        });

        FechaActual = NuevaFecha ?? DateTime.Now;
        MostrarAlerta = true;
        TipoAlerta = "exito";
        MensajeAlerta = "¡Fecha modificada correctamente!";
        StateHasChanged();
    }

    private void CerrarModificarModal() => ShowModificarFechaModal = false;

    private object? GetPropertyValue(object? obj, string propName)
    {
        if (obj == null) return null;
        try
        {
            var prop = obj.GetType().GetProperty(propName);
            if (prop != null) return prop.GetValue(obj);
        }
        catch { }
        return null;
    }
    private async Task ToggleSubtaskAsync(SubtaskModel st)
    {
        // 1. Llamada a la API según el tipo
        bool ok = st.Tipo == "Evento"
            ? await AgendaService.CambiarEstadoEventoAsync(st.ApiId, st.IsDone)
            : await AgendaService.CambiarEstadoTareaAsync(st.ApiId, st.IsDone);

        if (ok)
        {
            // 2. Sincronizamos la fecha en el objeto actual para que el filtro no lo oculte
            st.FechaCompletada = st.IsDone ? DateTime.Now : null;

            // 3. Sincronizar con MasterCategories (para que persista al cambiar de día)
            foreach (var cat in MasterCategories)
            {
                var task = cat.Subtasks.FirstOrDefault(x => x.ApiId == st.ApiId);
                if (task != null)
                {
                    task.IsDone = st.IsDone;
                    task.FechaCompletada = st.FechaCompletada;
                    break;
                }
            }
        }
        else
        {
            // Si la API falla, regresamos el checkbox a su estado anterior
            st.IsDone = !st.IsDone;
        }

        // 4. Una sola llamada para refrescar lo que se ve en pantalla
        await CargarTareasPorFecha();
    }
    private async Task ToggleParentSubtaskAsync(SubtaskModel parent)
    {
        await AgendaService.CambiarEstadoTareaAsync(parent.ApiId, parent.IsDone);

        foreach (var sub in parent.Subtasks)
        {
            sub.IsDone = parent.IsDone;
            await AgendaService.CambiarEstadoSubtareaAsync(sub.ApiId, sub.IsDone);

            // 🔹 Registrar FechaCompletado solo si es tarea y se marcó como completa
            if (sub.Tipo == "Tarea")
                sub.FechaCompletada = sub.IsDone ? FechaSeleccionada.Date : null;
        }

        var masterParent = MasterCategories.SelectMany(c => c.Subtasks)
                           .FirstOrDefault(x => x.ApiId == parent.ApiId);
        if (masterParent != null)
        {
            masterParent.IsDone = parent.IsDone;
            foreach (var ms in masterParent.Subtasks)
            {
                ms.IsDone = parent.IsDone;
                if (ms.Tipo == "Tarea")
                    ms.FechaCompletada = parent.IsDone ? FechaSeleccionada.Date : null;
            }
        }

        await CargarTareasPorFecha();
    }


    private async Task ToggleInnerSubtask(CategoryModel category, SubtaskModel parent, SubtaskModel subtask)
    {
        await AgendaService.CambiarEstadoSubtareaAsync(subtask.ApiId, subtask.IsDone);

        // 🔹 Registrar FechaCompletado
        if (subtask.Tipo == "Tarea")
            subtask.FechaCompletada= subtask.IsDone ? FechaSeleccionada.Date : null;

        bool todosCompletos = parent.Subtasks.All(s => s.IsDone);

        if (parent.IsDone != todosCompletos)
        {
            parent.IsDone = todosCompletos;
            await AgendaService.CambiarEstadoTareaAsync(parent.ApiId, parent.IsDone);
        }

        var masterParent = MasterCategories.SelectMany(c => c.Subtasks)
                           .FirstOrDefault(x => x.ApiId == parent.ApiId);
        if (masterParent != null)
        {
            masterParent.IsDone = parent.IsDone;
            var masterSub = masterParent.Subtasks.FirstOrDefault(s => s.ApiId == subtask.ApiId);
            if (masterSub != null)
            {
                masterSub.IsDone = subtask.IsDone;
                if (masterSub.Tipo == "Tarea")
                    masterSub.FechaCompletada = subtask.IsDone ? FechaSeleccionada.Date : null;
            }
        }

        StateHasChanged();
    }

    public class HistorialFechaCambio
    {
        public DateTime FechaAnterior { get; set; }
        public DateTime FechaNueva { get; set; }
        public string Motivo { get; set; } = string.Empty;
        public DateTime FechaModificacion { get; set; } = DateTime.Now;
    }

    void ToggleCollapse(CategoryModel cat) => cat.IsCollapsed = !cat.IsCollapsed;

    class CategoryModel
    {
        public string Name { get; set; }
        public List<SubtaskModel> Subtasks { get; set; } = new();
        public string ColorClass { get; set; } = "pastel-blue";
        public bool IsCollapsed { get; set; } = false;
        public string Icon { get; set; }
    }
    class AutoevaluacionDiaModel
    {
        public int IdRegistro { get; set; }
        public string Actividad { get; set; } = "";
        public bool Realizado { get; set; }
        public DateTime Fecha { get; set; }
        public string Icon { get; set; } = "⭐";
    }

    private async Task ToggleAutoevaluacionDia(
    AutoevaluacionDiaModel item,
    ChangeEventArgs e)
    {

        if (FechaSeleccionada.Date != DateTime.Today)
            return;
        bool nuevoValor =
            e.Value is bool b ? b :
            e.Value is string s && (s == "true" || s == "on");


        item.Realizado = nuevoValor;

        try
        {
            await AutoevaluacionService.MarcarRegistroRealizadoAsync(
                item.IdRegistro,   
                nuevoValor
            );
        }
        catch
        {

            item.Realizado = !nuevoValor;
        }
    }

    protected override async Task OnInitializedAsync()
    {
      
        var usuario = LoginService.obtenerUsuarioLogueado();
        if (usuario != null)
        {
            usuarioActualId = usuario.IdUsuario;
            Debug.WriteLine($"👤 usuarioActualId (IdUsuario) = {usuarioActualId}");
        }
        var salas = await SalasService.GetSalas();

        salasLookup = salas.ToDictionary(
            s => s.Id,
            s => s.Salas
        );

   
        var prioridades = await ReglasService.GetPrioridad();
        prioridadesLookup = prioridades.ToDictionary(
            p => p.Id,
            p => p.Titulo
        );

        var frecuencias = await ReglasService.GetFrecuencia();
        frecuenciaLookup = frecuencias.ToDictionary(
            f => f.Id,
            f => f.Nombre
        );
        try
        {
            using var client = new HttpClient();
            var json = await client.GetStringAsync("https://redgm.site:9096/empleado");
            todosLosEmpleados = JsonConvert.DeserializeObject<List<EmpleadoDTO>>(json) ?? new();
            ActualizarDatosParticipantesExistentes();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando empleados: {ex.Message}");
        }
        await VerificarDiaNoLaboralAsync();

        await InitializeMasterCategoriesAsync();
        await CargarTareasPorFecha();
        await PrepararOrdenesVisuales();

        GenerarDiasCalendario();
    }

    async Task RecargarVista()
    {
        await InitializeMasterCategoriesAsync();
        StateHasChanged();
    }


    string GetIcon(string title) => title switch
    {
        "Órdenes de Trabajo" => "🧾",
        "Tareas " => "🗂️",
        "Autoevaluación" => "⭐",
        "Servicio a Cliente" => "🏢",
        _ => "📋"
    };

    private async Task InitializeMasterCategoriesAsync()
    {
        
        var usuarioLogueado = LoginService.obtenerUsuarioLogueado();
        usuarioActualId = usuarioLogueado.IdUsuario;

        if (LoginService.AgendaActual != null)
            currentAgendaId = LoginService.AgendaActual.Value;
        else
        {
            var usuario = LoginService.obtenerUsuarioLogueado();
            if (usuario.IdAgendasAsignadas?.Count > 0)
            {
                currentAgendaId = usuario.IdAgendasAsignadas[0];
                LoginService.SetAgendaActual(currentAgendaId);
            }
            else
                currentAgendaId = 0;
        }

        MasterCategories = new();

        var tareasApi = await AgendaService.ObtenerTareasApi(currentAgendaId);
        var eventosApi = await AgendaService.ObtenerEventosPorEmpleado();
      

        var autoevaluacionesApi = await AutoevaluacionService.ObtenerAutoevaluacion();

        var tareasCategory = new CategoryModel
        {
            Name = "Tareas",
            ColorClass = "rosa-administrativa",
            Icon = "📝",
            Subtasks = tareasApi.Select(t => new SubtaskModel
            {
                ApiId = t.id,
                IdAgenda = t.idAgenda,
                Title = t.titulo,
                Descripcion = t.descripcion ?? "",   
                IsDone = t.completada,
                FechaCompletada = t.fechaCompletada,
                Tipo = "Tarea",
                Prioridad = t.idPrioridad,
                EsRecurrente = t.esRecurrente,
                ReglaRecurrencia = t.reglaRecurrencia ?? "",
                FechaInicio = t.fechaInicio,
                FechaFin = t.fechaFin,
                FechaPendiente = t.completada ? null : t.fechaFin,
                HoraInicio = string.IsNullOrWhiteSpace(t.horaInicio)
                    ? null
                    : TimeOnly.Parse(t.horaInicio),

                Subtasks = t.subTareas?.Select(st => new SubtaskModel
                {
                    ApiId = st.id,
                    Title = st.titulo,
                    IsDone = st.completada,
                    Tipo = "SubTarea",
                    FechaPendiente = null
                }).ToList() ?? new()
            }).ToList()
        };


        foreach (var ev in eventosApi)
        {
            Console.Error.WriteLine($"DEBUG EVENTO: {ev.titulo} | CreadorDB: {ev.creadorId} | MiID: {usuarioActualId}");
            bool esMio = ev.creadorId == usuarioActualId;
            bool soyInvitada = !esMio &&
                ev.participantes.Any(p => p.idEmpleado == usuarioActualId);
            
            tareasCategory.Subtasks.Add(new SubtaskModel
            {
                ApiId = ev.id,
                IdAgenda = ev.idAgenda,
                Title = ev.titulo,
                Descripcion = ev.descripcion ?? "",
                IsDone = ev.completada,
                FechaCompletada = ev.fechaCompletada,
                FechaPendiente = ev.completada ? ev.fechaFin.Date : null,
                Tipo = "Evento",
                EsEventoMio = esMio,
                // EsInvitado = soyInvitada,
                EsInvitado = !esMio && ev.participantes.Any(p => p.idEmpleado == usuarioActualId),
                NombreCreador = ev.nombreCreador,
                Icon = "📅",
                FechaInicio = ev.fechaInicio,
                FechaFin = ev.fechaFin,
                HoraInicio = TimeOnly.FromDateTime(ev.fechaInicio),
                HoraFin = TimeOnly.FromDateTime(ev.fechaFin),
                Autor = ev.idAgenda.ToString(),
                Ubicacion = ev.ubicacion ?? "",
                Prioridad = ev.idPrioridad,
                EsRecurrente = ev.esRecurrente,
                ReglaRecurrencia = ev.reglaRecurrencia ?? "", 
                //EsInvitado = ev.participantes.Any(p => p.idEmpleado == usuarioActualId),
                Participantes = ev.participantes?.Select(p => p.nombreEmpleado).ToList() ?? new List<string>(),

                Subtasks = new()
            });

        }

        var autoevaluacionCategory = new CategoryModel
        {
            Name = "Autoevaluación",
            ColorClass = "azul-lavanda",
            Icon = "⭐",
        };



        AutoevaluacionesDelDia.Clear();

        foreach (var bloque in autoevaluacionesApi)
        {
            foreach (var tarea in bloque.Tareas)
            {
                foreach (var registro in tarea.Registros)
                {
                    AutoevaluacionesDelDia.Add(new AutoevaluacionDiaModel
                    {
                        IdRegistro = registro.IdRegistro,
                        Actividad = tarea.Tarea,
                        Realizado = registro.Realizado,
                        Fecha = registro.Fecha.ToDateTime(TimeOnly.MinValue),
                        Icon = "⭐"
                    });
                }
            }
        }
      
        MasterCategories.Add(tareasCategory);

        
        MasterCategories.Add(new CategoryModel
        {
            Name = "Órdenes de Trabajo",
            ColorClass = "naranja-melocoton",
            Icon = "🔧",
            Subtasks = new()
            });
        MasterCategories.Add(autoevaluacionCategory);
     
        var servicioClienteCategory = new CategoryModel
        {
            Name = "Servicio a Cliente",
            ColorClass = "azul-morado",
            Icon = "🤝",
            Subtasks = new()
        };

        List<ServicioClienteAgendaDTO> servicioClienteAgenda = new();

        try
        {
            servicioClienteAgenda =
                await ServicioClienteService.ObtenerAgendaServicioCliente();
        }
        catch (Exception ex)
        {
            Console.WriteLine("ERROR Servicio Cliente: " + ex.Message);
        }

       foreach (var sc in servicioClienteAgenda)
{
    servicioClienteCategory.Subtasks.Add(new SubtaskModel
    {
        ApiId = sc.IdHorasProgramaTrabajo,
        Title = $"{sc.NombreEmpresa} – {sc.NombreServicio} – {sc.NombreActividad}",

        Descripcion = $"{sc.NombreServicio} – {sc.NombreEmpresa}",
        Tipo = "ServicioCliente",
        FechaInicio = sc.FechaAsignacion.Date,
        FechaFin = sc.FechaConclusion.Date,
        IsDone = sc.Completada ?? false,
                FechaCompletada = sc.Completada == true
            ? sc.FechaCompletada
            : null,
        Icon = "🤝",
        Prioridad = 0,
        Subtasks = new()
    });
}

MasterCategories.Add(servicioClienteCategory);




        foreach (var c in MasterCategories)
            c.Icon = GetIcon(c.Name);

        CargarTareasPorFecha();
    }
    private void OnHoraInicioChanged(TimeOnly value)
    {
        EditItem.HoraInicio = value;
    }

    private void OnHoraFinChanged(TimeOnly value)
    {
        EditItem.HoraFin = value;
    }
    // --- MÉTODOS DE EDICIÓN ---
    private async Task OpenEditModal(SubtaskModel st)
    {
        if (st == null) return;

        // 1. Limpieza y preparación base
        searchText = "";
        mostrarLista = false;
        ubicacionOtra = "";
        mostrarOtraUbicacion = false;

        if (!PuedeEditarEliminar(st)) return;

        // 2. Cargamos el modelo base (Titulo, fechas, etc.)
        EditItem = ConvertToEditModel(st);

        // 3. REGLA DE ORO: Si es Tarea, ignoramos lo que traía 'st' y traemos el detalle fresco
        if (st.Tipo == "Tarea")
        {
            var tareaCompleta = await AgendaService.ObtenerTareaDetalle(st.ApiId);
            if (tareaCompleta != null)
            {
                // Sobrescribimos la lista para asegurarnos de tener los IDs (486, 487...)
                EditItem.Subtareas = tareaCompleta.subTareas?.Select(s => new EditableSubtask
                {
                    Id = s.id,
                    Titulo = s.titulo
                }).ToList() ?? new List<EditableSubtask>();
            }
        }
        else if (st.Tipo == "Evento")
        {
            // ... (Tu lógica de evento está bien)
        }

        ShowEditModal = true;
        StateHasChanged();
    }
    private EditAgendaItemModel ConvertToEditModel(SubtaskModel st)
    {
        var model = new EditAgendaItemModel
        {
            ApiId = st.ApiId,
            IdAgenda = st.IdAgenda,
            Tipo = st.Tipo,
            Titulo = st.Title,
            Descripcion = st.Descripcion ?? "",
            FechaInicio = st.FechaInicio ?? DateTime.Now,
            FechaFin = st.FechaFin ?? DateTime.Now,
            HoraInicio = st.HoraInicio ?? new TimeOnly(0, 0),
            HoraFin = st.HoraFin ?? new TimeOnly(0, 0),
            Prioridad = st.Prioridad,
            Ubicacion = st.Ubicacion ?? "",
            ReglaRecurrencia = st.ReglaRecurrencia ?? "",
            // Deja esto vacío si es Tarea, ya que OpenEditModal lo llenará con ObtenerTareaDetalle
            Subtareas = new List<EditableSubtask>()
        };

        // ... (resto del mapeo de participantes)
        return model;
    }
    private void OnUbicacionChanged(ChangeEventArgs e)
    {
        var selectedValue = e.Value?.ToString();
        EditItem.Ubicacion = selectedValue;

        if (selectedValue == "-1")
        {
            mostrarOtraUbicacion = true;
          
            if (string.IsNullOrEmpty(ubicacionOtra)) ubicacionOtra = "";
        }
        else
        {
            mostrarOtraUbicacion = false;
            ubicacionOtra = "";
        }
    }
    
    private async Task HandleSave()
{
    if (EditItem == null) return;
    var fInicio = EditItem.FechaInicio.Date.Add(EditItem.HoraInicio.ToTimeSpan());
    var fFin = EditItem.FechaFin.Date.Add(EditItem.HoraFin.ToTimeSpan());

    try
    {
        HttpResponseMessage res;

            if (EditItem.Tipo == "Tarea")
            {
                var dtoTarea = new
                {
                    titulo = EditItem.Titulo,
                    descripcion = EditItem.Descripcion,
                    fechaInicio = fInicio,
                    fechaFin = fFin,
                    idPrioridad = EditItem.Prioridad,
                    esRecurrente = !string.IsNullOrEmpty(EditItem.ReglaRecurrencia) && EditItem.ReglaRecurrencia != "No se repite",
                    reglaRecurrencia = EditItem.ReglaRecurrencia,
                    // PROCESAMIENTO DINÁMICO DE SUBTAREAS:
                    subTareas = EditItem.Subtareas.Select(s =>
                    {
                        if (s.Id.HasValue && s.Id > 0)
                            return (object)new { id = s.Id.Value, titulo = s.Titulo }; // Existente
                        else
                            return (object)new { titulo = s.Titulo }; // Nueva (Sin ID)
                    }).ToList()
                };

                res = await Http.PutAsJsonAsync($"https://redgm.site:9096/tareas/editar/{EditItem.ApiId}", dtoTarea);
            }
        else 
        {
                int? idSalaFinal = null;
                string? ubicacionFinal = null;

            if (EditItem.Ubicacion == "-1")
            {
                idSalaFinal = null;
                ubicacionFinal = ubicacionOtra; 
            }
            else
            {
                
                var sala = salasLookup.FirstOrDefault(s => s.Value == EditItem.Ubicacion);
                    
                    if (sala.Key > 0)
                    {
                        idSalaFinal = sala.Key;
                        ubicacionFinal = null; 
                    }
                    else
                    {
                        idSalaFinal = null;
                        ubicacionFinal = "";
                    }
            }

            var dtoEvento = new
            {
                titulo = EditItem.Titulo,
                descripcion = EditItem.Descripcion,
                fechaInicio = fInicio.ToString("yyyy-MM-ddTHH:mm:ss"),
                fechaFin = fFin.ToString("yyyy-MM-ddTHH:mm:ss"),
                esRecurrente = !string.IsNullOrEmpty(EditItem.ReglaRecurrencia) && EditItem.ReglaRecurrencia != "No se repite",
                reglaRecurrencia = EditItem.ReglaRecurrencia,
                idPrioridad = EditItem.Prioridad,
                idSala = idSalaFinal,
                ubicacion = ubicacionFinal,
                idsParticipantes = EditItem.Participantes?.Select(p => p.Id).Where(id => id > 0).ToList() ?? new List<int>()
            };

            res = await Http.PutAsJsonAsync($"https://redgm.site:9096/eventos/{EditItem.ApiId}", dtoEvento);
        }
        if (res.IsSuccessStatusCode)
        {
            ShowEditModal = false; 
            await JS.InvokeVoidAsync("Swal.fire", "¡Éxito!", "Se actualizó correctamente.", "success");
            await InitializeMasterCategoriesAsync();
            StateHasChanged();
        }
        else
        {
            var errorBody = await res.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("Swal.fire", "Error", "No se pudo guardar: " + errorBody, "error");
        }
    }
    catch (Exception ex)
    {
        await JS.InvokeVoidAsync("Swal.fire", "Error de conexión", ex.Message, "error");
    }
}
    private async Task EliminarSubtask(SubtaskModel st)
    {
        var result = await JS.InvokeAsync<object>("Swal.fire", new
        {
            title = "¿Estás seguro?",
            text = $"Vas a eliminar la {st.Tipo}: '{st.Title}'",
            icon = "warning",
            showCancelButton = true,
            confirmButtonColor = "#d33",
            cancelButtonColor = "#3085d6",
            confirmButtonText = "Sí, eliminar",
            cancelButtonText = "Cancelar"
        });
        bool confirmado = await JS.InvokeAsync<bool>("eval", "Swal.fire({ title: '¿Eliminar?', text: 'No podrás revertir esto', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Sí, borrar' }).then((result) => result.isConfirmed)");

        if (confirmado)
        {
            try
            {
                string url = st.Tipo == "Tarea"
                    ? $"https://redgm.site:9096/tareas/eliminar/{st.ApiId}"
                    : $"https://redgm.site:9096/eventos/{st.ApiId}";

                var response = await Http.DeleteAsync(url);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("Swal.fire", "¡Eliminado!", $"{st.Tipo} eliminada correctamente.", "success");

                    await InitializeMasterCategoriesAsync();
                    StateHasChanged();
                }
                else
                {
               
                    await JS.InvokeVoidAsync("Swal.fire", "Error", "No se pudo eliminar. Código: " + response.StatusCode, "error");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("Swal.fire", "Error de conexión", ex.Message, "error");
            }
        }
    }
    private string searchText = "";
    private bool mostrarLista = false;
    private List<EmpleadoDTO> empleadosFiltrados = new();
    private List<EmpleadoDTO> todosLosEmpleados = new();
    private void ActualizarDatosParticipantesExistentes()
    {
        if (EditItem?.Participantes != null && todosLosEmpleados.Any())
        {
            foreach (var p in EditItem.Participantes)
            {
                var original = todosLosEmpleados.FirstOrDefault(x => x.Id == p.Id);
                if (original != null)
                {
                    p.ClavePersonal = original.ClavePersonal;
                    p.Puesto = original.Puesto;
                    p.Area = original.Area;
                }
            }
        }
    }
    private void FiltrarEmpleados(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";

        if (string.IsNullOrWhiteSpace(searchText))
        {
            mostrarLista = false;
            return;
        }
        var busqueda = searchText.Trim().ToLower();
        empleadosFiltrados = todosLosEmpleados
            .Where(x => (x.Nombre.ToLower().Contains(busqueda) ||
                         x.ClavePersonal.ToString().Contains(busqueda)) &&
                         !EditItem.Participantes.Any(p => p.Id == x.Id))
            .Take(10)
            .ToList();

        mostrarLista = empleadosFiltrados.Any();
    }
    private void SeleccionarParticipante(EmpleadoDTO emp)
    {
        if (EditItem != null)
        {
            if (EditItem.Participantes == null) EditItem.Participantes = new List<EmpleadoDTO>();

            if (!EditItem.Participantes.Any(x => x.Id == emp.Id))
            {
                EditItem.Participantes.Add(emp);
            }
        }

        searchText = "";
        mostrarLista = false;
        StateHasChanged(); 
    }
    private void QuitarParticipante(EmpleadoDTO emp)
    {
        EditItem?.Participantes.Remove(emp);
        StateHasChanged();
    }
    void AgregarSubtarea()
    {
        if (string.IsNullOrWhiteSpace(nuevaSubtareaTexto)) return;

        // Asegúrate de que NO estás haciendo EditItem.Subtareas = new List...
        if (EditItem.Subtareas == null) EditItem.Subtareas = new List<EditableSubtask>();

        EditItem.Subtareas.Add(new EditableSubtask
        {
            Id = null, // Es nueva, no lleva ID
            Titulo = nuevaSubtareaTexto
        });

        nuevaSubtareaTexto = "";
        StateHasChanged();
    }
    void EliminarSubtarea(EditableSubtask sub)
    {
        if (EditItem.Subtareas.Contains(sub))
        {
            EditItem.Subtareas.Remove(sub);
            StateHasChanged();
        }
    }
    private void OnFechaInicioChanged(DateTime? value)
    {
        if (value.HasValue) EditItem.FechaInicio = value.Value;
    }

    private void OnFechaFinChanged(DateTime? value)
    {
        if (value.HasValue) EditItem.FechaFin = value.Value;
    }
    private void OnHoraInicioChanged(TimeOnly? value)
    {
        if (value.HasValue)
        {
            EditItem.HoraInicio = value.Value;
        }
    }

    private void OnHoraFinChanged(TimeOnly? value)
    {
        if (value.HasValue)
        {
            EditItem.HoraFin = value.Value;
        }
    }
    private async Task CargarTareasPorFecha()
    {
        Console.WriteLine(">>>> EJECUTANDO FILTRO - Fecha Vista: " + FechaSeleccionada.ToShortDateString());
        if (MasterCategories == null) return;

        var fechaVista = FechaSeleccionada.Date;
        var hoyReal = DateTime.Today;

        Categories = MasterCategories.Select(c =>
        {
            var subtasksFiltradas = (c.Subtasks ?? new List<SubtaskModel>()).Where(st =>
            {
                if (st == null) return false;

             
                if (st.Tipo == "Evento")
                {
                    if (!st.FechaInicio.HasValue || !st.FechaFin.HasValue) return false;
                    return fechaVista >= st.FechaInicio.Value.Date && fechaVista <= st.FechaFin.Value.Date;
                }

                if (!st.FechaInicio.HasValue) return false;
                var inicio = st.FechaInicio.Value.Date;

                if (st.IsDone)
                {
                    // Solo mostrar si se completó el mismo día que estamos viendo
                    return st.FechaCompletada.HasValue &&
                           st.FechaCompletada.Value.Date == fechaVista.Date;
                }
                
                else
                {
                    // Pendiente: desde inicio hasta HOY
                    return fechaVista >= inicio && fechaVista <= hoyReal;
                }
            }).ToList();

            return new CategoryModel
            {
                Name = c.Name,
                ColorClass = c.ColorClass,
                Icon = c.Icon,
                IsCollapsed = c.IsCollapsed,
                Subtasks = subtasksFiltradas
            };
        }).ToList();

        StateHasChanged();
    }
    
    private SubtaskModel CloneSubtask(SubtaskModel st)
    {
        return new SubtaskModel
        {
            ApiId = st.ApiId,
            IdAgenda = st.IdAgenda, 
            Title = st.Title,
            Descripcion = st.Descripcion,
            IsDone = st.IsDone,      
            Tipo = st.Tipo,
            Prioridad = st.Prioridad,
            FechaInicio = st.FechaInicio,
            FechaFin = st.FechaFin,
            FechaPendiente = st.FechaPendiente,
            HoraInicio = st.HoraInicio,
            HoraFin = st.HoraFin,    
            Icon = st.Icon,          
            EsInvitado = st.EsInvitado,
            EsEventoMio = st.EsEventoMio,
            NombreCreador = st.NombreCreador,
            Participantes = st.Participantes?.ToList() ?? new(),
            Subtasks = st.Subtasks?.Select(s => CloneSubtask(s)).ToList() ?? new()

        };
    }

    private OrdenTrabajoModel ConvertirOrdenSimple(OrdenTrabajoDTO api, OrdenStatus status) => new()
    {
        Id = api.id,
       
        NumeroOrden = api.strClave,
        FechaSolicitud = api.dteFechaSolicitud == DateTime.MinValue ? null : api.dteFechaSolicitud,
        FechaProgramada = api.fechaFinal,
        Autor = api.nombreCompleto ?? string.Empty,
        Cliente = api.nombreCliente ?? string.Empty,
        Objetivo = api.strValor ?? string.Empty,
        ObjetivoOtro = api.strObjetivoOtro ?? string.Empty,
        Status = status,
        Tareas = new List<TareaOrdenModel>()
    };
    private OrdenTrabajoModel ConvertirTramiteSimple(
     OrdenTramiteDTO t,
     OrdenStatus status)
    {
        return new OrdenTrabajoModel
        {
            IdOrdenTramite = t.idOrden,   
            NumeroOrden = t.numeroOrden,
            FechaProgramada = DateTime.TryParse(t.fechaConclusionTramite, out var f) ? f : DateTime.Now,
            Status = status,
            Tipo = TipoOrden.Tramite
        };
    }
    private OrdenTrabajoModel ConvertirOrdenDetalle(OrdenTrabajoDTO api) => new()
    {
        Id = api.id,
        NumeroOrden = api.strClave,
        FechaSolicitud = api.dteFechaSolicitud == DateTime.MinValue ? null : api.dteFechaSolicitud,
        FechaProgramada = api.fechaFinal,
        Autor = api.nombreCompleto ?? string.Empty,
        Cliente = api.nombreCliente ?? string.Empty,
        Objetivo = api.strValor ?? string.Empty,
        ObjetivoOtro = api.strObjetivoOtro ?? string.Empty,
        Status = OrdenStatus.Hoy,
        Tareas = api.tareas?.Select(t => new TareaOrdenModel
        {
            Nombre = t.strNombreTarea,
            DescripcionAutor = t.strDescripcionAutor,
            DescripcionReceptor = t.strDescripcionReceptor,
            Valor = t.avance,
            Observacion = t.strObservacion,
        }).ToList() ?? new List<TareaOrdenModel>()
    };

    private OrdenStatus ConvertirEstadoDesdeString(string estado) => estado switch
    {
        "Vencido" => OrdenStatus.Vencido,
        "Proximo" => OrdenStatus.Proximo,
        "Hoy" => OrdenStatus.Hoy,
        _ => OrdenStatus.Hoy
    };
    private async Task PrepararOrdenesVisuales()
    {
        OrdenesParaMostrar = new();

        try
        {
            var vencidasOT = await OrdenTrabajoService.GetOrdenesVencidas();
            var proximasOT = await OrdenTrabajoService.GetOrdenesProximas();
            var hoyOT = await OrdenTrabajoService.GetOrdenesHoy();

            if (vencidasOT != null)
            {
                OrdenesParaMostrar.AddRange(
                    vencidasOT.Select(o =>
                    {
                        var orden = ConvertirOrdenSimple(o, OrdenStatus.Vencido);
                        orden.Tipo = TipoOrden.Trabajo;
                        return orden;
                    })
                );
            }

            if (proximasOT != null)
            {
                OrdenesParaMostrar.AddRange(
                    proximasOT.Select(o =>
                    {
                        var orden = ConvertirOrdenSimple(o, OrdenStatus.Proximo);
                        orden.Tipo = TipoOrden.Trabajo;
                        return orden;
                    })
                );
            }

            if (hoyOT != null)
            {
                OrdenesParaMostrar.AddRange(
                    hoyOT.Select(o =>
                    {
                        var orden = ConvertirOrdenSimple(o, OrdenStatus.Hoy);
                        orden.Tipo = TipoOrden.Trabajo;
                        return orden;
                    })
                );
            }
            var vencidasTR = await OrdenTramiteService.GetVencidas();
            var proximasTR = await OrdenTramiteService.GetProximas();
            var hoyTR = await OrdenTramiteService.GetHoy();

            if (vencidasTR != null)
                OrdenesParaMostrar.AddRange(
                    vencidasTR.Select(t => ConvertirTramiteSimple(t, OrdenStatus.Vencido))
                );

            if (proximasTR != null)
                OrdenesParaMostrar.AddRange(
                    proximasTR.Select(t => ConvertirTramiteSimple(t, OrdenStatus.Proximo))
                );

            if (hoyTR != null)
                OrdenesParaMostrar.AddRange(
                    hoyTR.Select(t => ConvertirTramiteSimple(t, OrdenStatus.Hoy))
                );

        }
        catch (Exception ex)
        {
            Console.WriteLine("ERROR PrepararOrdenesVisuales: " + ex.Message);
        }

        var cat = Categories.FirstOrDefault(c => c.Name.Trim() == "Órdenes de Trabajo");
        if (cat != null) cat.IsCollapsed = false;

        StateHasChanged();
    }
  
    private async Task VerOrdenTrabajo(int idOrden)
    {
        try
        {
            var url = $"https://redgm.site:9096/ordenTrabajo/ordenTrabajo/orden/{idOrden}";
            var apiOrden = await Http.GetFromJsonAsync<OrdenTrabajoDTO>(url);

            if (apiOrden != null)
            {
                SelectedOrden = ConvertirOrdenDetalle(apiOrden);
                ShowOrderModal = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("ERROR VerOrdenTrabajo: " + ex.Message);
        }
    }

    private async Task VerOrden(OrdenTrabajoModel ot)
    {
        if (ot == null) return;
        if (ot.Tipo == TipoOrden.Tramite)
        {
            await VerOrdenTramiteSeguro(ot);
        }
        else
        {
            await VerOrdenTrabajo(ot.Id);
        }
    }
    
    private async Task VerOrdenTramiteSeguro(OrdenTrabajoModel ot)
    {
        SelectedOrdenTramite = new OrdenTramiteDTO
        {
            numeroOrden = ot.NumeroOrden,
            tramitesIndividuales = new()
        };

        ShowTramiteModal = true;
        StateHasChanged();
        if (!ot.IdOrdenTramite.HasValue)
            return;

        try
        {
            var orden = await OrdenTramiteService.GetDetalle(ot.IdOrdenTramite.Value);

            if (orden != null)
            {
                SelectedOrdenTramite = orden;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("❌ ERROR API Trámite: " + ex.Message);
        }
    }
    private void CloseTramiteModal()
    {
        SelectedOrdenTramite = null;
        ShowTramiteModal = false;
    }
    private void OpenOrderModal(OrdenTrabajoModel orden) { SelectedOrden = orden; ShowOrderModal = true; StateHasChanged(); }
    private void CloseOrderModal() { SelectedOrden = null; ShowOrderModal = false; }

    // ---- CALENDARIO ----
    private void AbrirCalendario() => MostrarModal = true;
    private void CerrarCalendario() => MostrarModal = false;
    private void MesAnterior() { MesActual = MesActual.AddMonths(-1); GenerarDiasCalendario(); }
    private void MesSiguiente() { MesActual = MesActual.AddMonths(1); GenerarDiasCalendario(); }

    private async Task DiaSiguiente()
    {
        FechaSeleccionada = FechaSeleccionada.AddDays(1);
        await VerificarDiaNoLaboralAsync();
        await CargarTareasPorFecha();
        GenerarDiasCalendario();
    }

    private async Task DiaAnterior()
    {
        FechaSeleccionada = FechaSeleccionada.AddDays(-1);
        await VerificarDiaNoLaboralAsync();
        await CargarTareasPorFecha();
        GenerarDiasCalendario();
    }
    private async Task SeleccionarFecha(DateTime nuevaFecha)
    {
        FechaSeleccionada = nuevaFecha;
        CerrarCalendario();
        await VerificarDiaNoLaboralAsync();

        if (!EsDiaNoLaboral)
            await CargarTareasPorFecha();
    }
    private void GenerarDiasCalendario()
    {
        var primerDiaDelMes = new DateTime(MesActual.Year, MesActual.Month, 1);
        int offset = ((int)primerDiaDelMes.DayOfWeek + 6) % 7;
        DiasDelCalendario = Enumerable.Range(0, 42).Select(i => primerDiaDelMes.AddDays(i - offset));
    }
    bool AllCompleted(CategoryModel cat) => cat.Subtasks != null && cat.Subtasks.Any() && cat.Subtasks.All(st => st.IsDone && (st.Subtasks == null || st.Subtasks.All(s2 => s2.IsDone)));

    int RemainingCount(CategoryModel cat)
    {
        if (cat.Subtasks == null) return 0;
        int count = 0;
        foreach (var st in cat.Subtasks)
        {
            if (!st.IsDone) count++;
            if (st.Subtasks != null) count += st.Subtasks.Count(s => !s.IsDone);
        }
        return count;
    }

    void MarkAll(CategoryModel cat, bool done)
    {
        foreach (var st in cat.Subtasks)
        {
            st.IsDone = done;
            if (st.Subtasks != null) st.Subtasks.ForEach(s2 => s2.IsDone = done);
        }
    }

    void EditSubtask(CategoryModel cat, SubtaskModel st) { Console.WriteLine($"Editar actividad: {st.Title} en {cat.Name}"); }
    void EditInnerSubtask(CategoryModel cat, SubtaskModel parent, SubtaskModel inner) { Console.WriteLine($"Editar subtarea: {inner.Title} en {parent.Title}"); }

    void OpenEditModal(CategoryModel cat, SubtaskModel st) { }
    void OpenEditInnerModal(CategoryModel cat, SubtaskModel parent, SubtaskModel inner) { }
    void CheckSave() { }

    private async Task RefrescarTareas(TareaCreada t)
    {
        await InitializeMasterCategoriesAsync();
        StateHasChanged();
    }
    private async Task FinalizarEventoForzado(SubtaskModel st, object? checkedValue)
    {
        bool nuevoEstado = checkedValue is bool b && b;

        st.IsDone = nuevoEstado;

        foreach (var cat in MasterCategories)
        {
            var itemEnMaestro = cat.Subtasks.FirstOrDefault(x => x.ApiId == st.ApiId && x.Tipo == st.Tipo);
            if (itemEnMaestro != null)
            {
                itemEnMaestro.IsDone = nuevoEstado;
               
                itemEnMaestro.FechaPendiente = nuevoEstado ? st.FechaInicio?.Date : null;
                break;
            }
        }

        bool ok = st.Tipo == "Evento"
            ? await AgendaService.CambiarEstadoEventoAsync(st.ApiId, nuevoEstado)
            : await AgendaService.CambiarEstadoTareaAsync(st.ApiId, nuevoEstado);

        if (!ok)
        {
           
            st.IsDone = !nuevoEstado;
            var revertirMaestro = MasterCategories.SelectMany(c => c.Subtasks)
                                  .FirstOrDefault(x => x.ApiId == st.ApiId && x.Tipo == st.Tipo);
            if (revertirMaestro != null) revertirMaestro.IsDone = !nuevoEstado;
        }
        await CargarTareasPorFecha();
    }
    public bool PuedeEditar { get; set; }

    private bool PuedeEditarEliminar(SubtaskModel st)
    {
        if (st.Tipo == "Tarea")
            return true;
        return st.Tipo == "Evento" && st.EsEventoMio;
    }

    private bool isRefreshing = false;

    private async Task RefreshData()
    {
        if (isRefreshing) return;

        try
        {
            isRefreshing = true;

            // 1. Volvemos a verificar si es día festivo/domingo
            await VerificarDiaNoLaboralAsync();

            // 2. Recargamos todas las categorías desde la API (MasterCategories)
            await InitializeMasterCategoriesAsync();

            // 3. Aplicamos los filtros de la fecha seleccionada
            await CargarTareasPorFecha();

            // 4. Actualizamos órdenes de trabajo si existen
            await PrepararOrdenesVisuales();

            StateHasChanged(); // Forzamos el renderizado
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error al refrescar: {ex.Message}");
        }
        finally
        {
            isRefreshing = false;
        }
    }
}


<style>
    :root {
        --modal-bg: #ffffff;
        --primary-color: #1E7E34;
        --accent-evento: #8b5cf6;
        --text-main: #1e293b;
        --text-muted: #64748b;
        --input-border: #e2e8f0;
        --input-focus: #4f46e5;
        --bg-soft: #f8fafc;
        --primary-cancelar: #C42B1C;
    }

    /* Contenedor Principal con desenfoque de fondo */
    .modern-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        animation: fadeIn 0.2s ease-out;
    }

    .modern-modal-container {
        background: var(--modal-bg);
        width: 95%;
        max-width: 850px;
        max-height: 90vh;
        border-radius: 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(255,255,255,0.2);
    }

    /* Header Estilizado */
    .modern-modal-header {
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
    }

    .header-tarea {
        background: linear-gradient(135deg, #FFD1DC, #FFD1DC);
    }

    .header-evento {
        background: linear-gradient(135deg, #FFD1DC, #FFD1DC);
    }

    .type-badge {
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .modal-title {
        margin-top: 5px;
        font-weight: 700;
        font-size: 1.25rem;
    }

    .modern-close-btn {
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        transition: 0.3s;
    }

        .modern-close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

    /* Cuerpo y Grid */
    .modern-modal-content {
        padding: 30px;
        overflow-y: auto;
        background: var(--bg-soft);
    }

    .modern-form-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 30px;
    }

    @@media (max-width: 768px) {
        .modern-form-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Campos de Formulario */
    .modern-field {
        margin-bottom: 20px;
    }

        .modern-field label {
            display: block;
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

    .modern-input {
        width: 100%;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid var(--input-border);
        background: white;
        font-size: 0.95rem;
        transition: all 0.2s;
    }

        .modern-input:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

    /* Grupos de entrada (Tags y Subtareas) */
    .modern-input-group {
        display: flex;
        gap: 8px;
    }

    .add-inner-btn {
        background: #FFECEC;
        color: black;
        border: none;
        border-radius: 10px;
        padding: 0 15px;
        cursor: pointer;
    }

    /* Tags y Subtareas */
    .modern-tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }

    .modern-tag {
        background: #e2e8f0;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

        .modern-tag i {
            cursor: pointer;
            color: #ef4444;
        }

    .modern-subtask-list {
        margin-top: 12px;
        background: white;
        border-radius: 12px;
        border: 1px solid var(--input-border);
    }

    .modern-subtask-item {
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #f1f5f9;
    }

        .modern-subtask-item:last-child {
            border-bottom: none;
        }

    /* Footer */
    .modern-modal-footer {
        padding: 20px 30px;
        background: white;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        border-top: 1px solid #f1f5f9;
    }

    .m-btn {
        padding: 10px 24px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        border: none;
    }

    .btn-ghost {
        background: var(--primary-cancelar);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(255, 77, 77);
    }

    .btn-basura {
        background: #ffff;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(19, 83, 48);
    }


    .modern-row {
        display: flex;
        gap: 15px;
    }

        .modern-row .modern-field {
            flex: 1;
        }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
