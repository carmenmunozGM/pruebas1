@page "/dia2"
@using System.Linq
@using System.Globalization
@inject NavigationManager navigate
@using Microsoft.AspNetCore.Components.Web
@using pruebas1.Components.DTOs
@using pruebas1.Entidades
@using pruebas1.Components
@using pruebas1.Servicios
@inject HttpClient Http
@inject AgendaService AgendaService
@inject LoginService LoginService
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="agenda-container">
    <div class="top-bar-container">
        <div class="fecha-header">
            <button class="calendar-btn" @onclick="DiaAnterior"><i class="bi bi-arrow-left-circle"></i></button>
            <span class="fecha-texto">@FechaFormateada</span>
            <button class="calendar-btn" @onclick="DiaSiguiente"><i class="bi bi-arrow-right-circle"></i></button>

            <div class="calendar-wrapper">
                <button class="calendar-btn" @onclick="AbrirCalendario">📅</button>

                @if (MostrarModal)
                {
                    <div class="modal-popover" @onclick:stopPropagation="true">
                        <div class="calendar-header">
                            <button class="calendar-btn" @onclick="MesAnterior"><i class="bi bi-chevron-left"></i></button>
                            <strong>@MesActual.ToString("MMMM yyyy", new CultureInfo("es-ES"))</strong>
                            <button class="calendar-btn" @onclick="MesSiguiente"><i class="bi bi-chevron-right"></i></button>
                        </div>

                        <div class="calendar-grid">
                            @foreach (var dia in DiasSemana)
                            {
                                <div class="calendar-week-day"><strong>@dia</strong></div>
                            }
                            @foreach (var day in DiasDelCalendario)
                            {
                                <div class="calendar-day @(day.Month != MesActual.Month ? "calendar-other-month" : "") @(day.Date == DateTime.Now.Date ? "calendar-today" : "")"
                                     @onclick="() => SeleccionarFecha(day)">
                                    @day.Day
                                </div>
                            }
                        </div>

                        <div style="margin-top:10px; text-align:center;">
                            <button class="calendar-btn" @onclick="CerrarCalendario">✖ Cerrar</button>
                        </div>
                    </div>
                }
            </div>

        </div>

    </div>


    <div class="modal-button-container">
        <ReusableModal OnSave="RefrescarTareas" />

    </div>

    @if (FechaSeleccionada.DayOfWeek == DayOfWeek.Sunday)
    {
        <div class="col-12 text-center">
            <div class="alert alert-warning shadow-sm">
                Día no laboral – @FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"))
            </div>
        </div>
    }
    else
    {
        @if (Categories.FirstOrDefault(c => c.Name.Trim() == "Tareas") is CategoryModel tareasCat)
        {
            <div class="card block-card @tareasCat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(tareasCat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@tareasCat.Icon @tareasCat.Name</h3>
                    </div>
                    <div class="header-right">
                        @if (AllCompleted(tareasCat))
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            <span class="badge pendiente">@RemainingCount(tareasCat) pendiente(s)</span>
                        }
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(tareasCat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!tareasCat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll @(tareasCat.IsCollapsed ? "collapsed" : "")">
                        <ul class="subtask-list">
                            @foreach (var st in tareasCat.Subtasks)
                            {
                                <li class="subtask-item">
                                    <div class="subtask-label @(st.IsDone && tareasCat.Name != "Autoevaluación" ? "done" : "")">
                                        <input type="checkbox" checked="@st.IsDone" @onchange="(e) => ToggleSubtask(tareasCat, st)" />
                                        @if (st.Tipo == "Evento")
                                        {
                                            <span class="tag-evento">📅 </span>
                                        }
                                        else
                                        {
                                            <span class="tag-tarea">📝 </span>
                                        }

                                        <span class="subtask-text">@st.Title</span>
                                        @if (st.IsDone)
                                        {
                                            <small class="done-text">Hecho</small>
                                        }
                                        @if (tareasCat.Name.Trim() == "Tareas")
                                        {
                                            <div class="subtask-actions">
                                                <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(tareasCat, st)">
                                                    <i class="bi bi-calendar"></i>
                                                </button>
                                                <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditModal(tareasCat, st)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="icon-btn delete" title="Eliminar" @onclick="() => DeleteSubtask(tareasCat, st)">
                                                    <i class="bi bi-trash3"></i>
                                                </button>
                                            </div>
                                        }

                                    </div>

                                    @if (st.Subtasks.Any())
                                    {
                                        <div class="table-wrapper block-scroll">
                                            <ul class="subtask-list">
                                                @foreach (var s2 in st.Subtasks)
                                                {
                                                    <li class="subtask-item">
                                                        <div class="subtask-label @(s2.IsDone ? "done" : "")">
                                                            <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(tareasCat, st, s2)" />
                                                            <span class="subtask-text">@($"{s2.Title}")</span>
                                                            <div class="subtask-actions">
                                                                <button class="icon-btn delete" title="Eliminar" @onclick="() => DeleteInnerSubtask(tareasCat, st, s2)">
                                                                    <i class="bi bi-trash3"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }

        @if (Categories.FirstOrDefault(c => c.Name.Trim() == "Órdenes de Trabajo") is CategoryModel otCat)
        {
            <div class="card block-card naranja-melocoton">
                <div class="block-header" @onclick="() => ToggleCollapse(otCat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@otCat.Icon Órdenes de Trabajo</h3>
                    </div>
                    <div class="header-right">
                        <span class="badge pendiente">@((OrdenesParaMostrar ?? Enumerable.Empty<OrdenTrabajoModel>()).Count()) orden(es)</span>
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(otCat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!otCat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll">
                        <div class="ordenes-workboard">
                            @if (OrdenesParaMostrar != null && OrdenesParaMostrar.Any())
                            {
                                <div class="columns-container block-scroll">

                                    <!-- 🔴 Columna 1: Vencidas -->
                                    <div class="column column-expired block-scroll">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Vencida).OrderBy(o => o.FechaConclusion))
                                        {
                                            <div class="ot-card ot-expired">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.Numero</div>
                                                    <div class="ot-date">@ot.FechaConclusion.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-expired">Vencida</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => OpenOrderModal(ot)">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <!-- 🟡 Columna 2: Próximas -->
                                    <div class="column column-soon block-scroll">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Proxima).OrderBy(o => o.FechaConclusion))
                                        {
                                            <div class="ot-card ot-soon">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.Numero</div>
                                                    <div class="ot-date">@ot.FechaConclusion.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-soon">Próx.</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => OpenOrderModal(ot)">
                                                    </button>
                                                </div>
                                                <i class="bi bi-eye-fill"></i>
                                            </div>
                                        }
                                    </div>

                                    <!-- 🟢 Columna 3: Normales -->
                                    <div class="column column-normal block-scroll">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Normal).OrderBy(o => o.FechaConclusion))
                                        {
                                            <div class="ot-card ot-normal">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.Numero</div>
                                                    <div class="ot-date">@ot.FechaConclusion.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-normal">Hoy</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => OpenOrderModal(ot)">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                </div>
                            }
                            else
                            {
                                <div class="no-ordenes">No hay órdenes para mostrar</div>
                            }
                        </div>
                    </div>
                }
            </div>
            <br />
        }

        @foreach (var cat in Categories.Where(c => c.Name.Trim() != "Órdenes de Trabajo" && c.Name.Trim() != "Tareas"))
        {
            <div class="card block-card @cat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(cat)">

                    <div class="header-left">
                        <h3 class="categoria-titulo">@cat.Icon @cat.Name</h3>
                    </div>
                    <div class="header-right">
                        @if (AllCompleted(cat))
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            <span class="badge pendiente">@RemainingCount(cat) pendiente(s)</span>
                        }
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(cat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!cat.IsCollapsed)
                {
                    <div class="card-body block-body block-scroll @(cat.IsCollapsed ? "collapsed" : "")">
                        <ul class="subtask-list">
                            @foreach (var st in cat.Subtasks)
                            {
                                <li class="subtask-item">
                                    <div class="subtask-label @(st.IsDone && cat.Name != "Autoevaluación" ? "done" : "")">
                                        @if (cat.Name.Trim() == "Autoevaluación")
                                        {
                                            <select @bind="st.Estado" class="auto-select">
                                                <option value="">--</option>
                                                <option value="No realicé">No realicé</option>
                                                <option value="Sí realicé">Sí realicé</option>
                                                <option value="Día inhábil">Día inhábil</option>
                                                <option value="Permiso">Permiso</option>
                                                <option value="Falta">Falta</option>
                                                <option value="Vacaciones">Vacaciones</option>
                                                <option value="Incapacidad">Incapacidad</option>
                                            </select>
                                        }
                                        else if (cat.Name.Trim() != "Órdenes de Trabajo")
                                        {
                                            <input type="checkbox" checked="@st.IsDone" @onchange="(e) => ToggleSubtask(cat, st)" />
                                        }

                                        <span class="subtask-text">@st.Title</span>

                                        @if (st.IsDone)
                                        {
                                            <small class="done-text">Hecho</small>
                                        }

                                        @if (cat.Name.Trim() == "Tareas")
                                        {
                                            <div class="subtask-actions">
                                                <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(cat, st)">
                                                    <i class="bi bi-calendar"></i>
                                                </button>
                                                <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditModal(cat, st)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="icon-btn delete" title="Eliminar" @onclick="() => DeleteSubtask(cat, st)">
                                                    <i class="bi bi-trash3"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    @if ((cat.Name.Trim() == "Tareas" || cat.Name.Trim() == "Servicio a Cliente") && st.Subtasks.Any())
                                    {
                                        <div class="table-wrapper block-scroll">
                                            @if (cat.Name.Trim() == "Servicio a Cliente")
                                            {
                                                <table class="subtask-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Actividad</th>
                                                            <th>Hecho</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var s2 in st.Subtasks)
                                                        {
                                                            <tr>
                                                                <td>@s2.Title</td>
                                                                <td>
                                                                    <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(cat, st, s2)" />
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            }
                                            else
                                            {
                                                <ul class="subtask-list">
                                                    @foreach (var s2 in st.Subtasks)
                                                    {
                                                        <li class="subtask-item">
                                                            <div class="subtask-label @(s2.IsDone ? "done" : "")">
                                                                <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(cat, st, s2)" />
                                                                <span class="subtask-text">@($"{s2.Title}")</span>
                                                                <div class="subtask-actions">
                                                                    <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(cat, st)">
                                                                        <i class="bi bi-calendar"></i>
                                                                    </button>
                                                                    <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditInnerModal(cat, st, s2)">
                                                                        <i class="bi bi-pencil"></i>
                                                                    </button>
                                                                    <button class="icon-btn delete" title="Eliminar" @onclick="() => DeleteInnerSubtask(cat, st, s2)">
                                                                        <i class="bi bi-trash3"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }
    }
</div>

<!-- MODAL DE VISUALIZACIÓN DE ORDEN (EXTRA GRANDE) -->
@if (ShowModificarFechaModal)
{
    <div class="modal-overlay" @onclick="CerrarModificarModal">
        <div class="modal-card" @onclick:stopPropagation="true">
            <h2 class="modal-title">
                <i class="bi bi-calendar-check"></i> Modificar Fecha
            </h2>

            @if (MostrarAlerta)
            {
                <div class="alerta @TipoAlerta">
                    @MensajeAlerta
                </div>
            }

            <div class="modal-body">
                <div class="form-group">
                    <label>📅 Fecha actual</label>
                    <input type="text" class="form-control" value="@FechaActual.ToString("dd/MM/yyyy")" readonly />
                </div>

                <div class="form-group">
                    <label>🗓️ Nueva fecha</label>
                    <div class="datepicker-wrapper">
                        <DatePicker @bind-Value="NuevaFecha"
                                    CssClass="date-control" />

                    </div>
                </div>

                <div class="form-group">
                    <label>📝 Motivo del cambio <span style="color:red;">*</span></label>
                    <textarea class="form-control" rows="3" placeholder="Escribe el motivo del cambio..." @bind="Motivo"></textarea>
                </div>

                @if (HistorialCambios.Any())
                {
                    <div class="historial">
                        <h4>📜 Historial de cambios</h4>
                        <div class="historial-scroll">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Fecha anterior</th>
                                        <th>Nueva fecha</th>
                                        <th>Motivo</th>
                                        <th>Fecha de modificación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var h in HistorialCambios.OrderByDescending(x => x.FechaModificacion))
                                    {
                                        <tr>
                                            <td>@h.FechaAnterior.ToString("dd/MM/yyyy")</td>
                                            <td>@h.FechaNueva.ToString("dd/MM/yyyy")</td>
                                            <td>@h.Motivo</td>
                                            <td>@h.FechaModificacion.ToString("dd/MM/yyyy HH:mm")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>


            <div class="modal-footer">
                <button class="btn-guardar" @onclick="GuardarCambioFecha">
                    <i class="bi bi-save"></i> Guardar
                </button>
                <button class="btn-cancelar" @onclick="CerrarModificarModal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
}

<!-- MODAL DE VISUALIZACIÓN DE ORDEN (EXTRA GRANDE) -->
@if (ShowOrderModal && SelectedOrden != null)
{
    <div class="modal-container visible" @onclick="CloseOrderModal">
        <div class="modal-content" @onclick:stopPropagation="true" style="max-width:1200px; width:95%; height:92vh;">
            <div class="modal-header" style="background:#2b2b3a; color:#fff;">
                <h2 class="modal-title">Orden - @SelectedOrden.Numero</h2>
                <span class="close-button" @onclick="CloseOrderModal">&times;</span>
            </div>

            <div class="modal-body-wrapper">
                <div class="form-section-wrapper">
                    <div class="form-section">
                        <div>
                            <label class="section-label">Número de orden</label>
                            <div>@SelectedOrden.Numero</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha de solicitud</label>
                            <div>@(SelectedOrden.FechaSolicitud?.ToString("dd/MM/yyyy") ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Autor</label>
                            <div>@(SelectedOrden.Autor ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Nombre / Razón social</label>
                            <div>@(SelectedOrden.Cliente ?? "-")</div>
                        </div>

                        <div class="form-group-span-2">
                            <label class="section-label">Objetivo</label>
                            <div>@(SelectedOrden.Objetivo ?? "-")</div>
                        </div>

                        <div class="form-group-span-2">
                            <label class="section-label">Objetivos de otros</label>
                            <div>@(SelectedOrden.ObjetivosOtros ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha programada de conclusión</label>
                            <div>@(SelectedOrden.FechaConclusion.ToString("dd/MM/yyyy"))</div>
                        </div>
                    </div>

                    <div style="margin-top:18px;" class="form-group-span-2">
                        <label class="section-label">Tareas</label>

                        <!-- Tabla minimalista estilo A (sin líneas) -->
                        <div class="tasks-table-minimal">
                            <div class="tasks-row tasks-header">
                                <div class="col-name">Nombre de la tarea</div>
                                <div class="col-desc">Descripción</div>
                                <div class="col-adv">Avance</div>
                            </div>

                            @foreach (var t in SelectedOrden?.Subtasks ?? Enumerable.Empty<TareaOrdenModel>())
                            {
                                <div class="tasks-row">
                                    <div class="col-name">@t.Title</div>
                                    <div class="col-desc">@(!string.IsNullOrEmpty(t.Description) ? t.Description : "-")</div>
                                    <div class="col-adv">@($"{t.ProgressPercent}%")</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CloseOrderModal">Cerrar</button>
            </div>
        </div>
    </div>
}



@code {

    // ---- FECHAS Y CALENDARIO ----
    private DateTime FechaSeleccionada { get; set; } = DateTime.Now.Date;
    private DateTime MesActual { get; set; } = DateTime.Now.Date;
    private bool MostrarModal { get; set; } = false;
    private string[] DiasSemana = { "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom" };
    private IEnumerable<DateTime> DiasDelCalendario { get; set; } = Enumerable.Empty<DateTime>();
    private string FechaFormateada => FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"));
    //---- PARA AGENDA

    // Si ya tienes Categories / MasterCategories, usa el que corresponda.
    // Lista de tareas cargadas desde la API
    private List<TareaApi> TareasDelDia = new();
    //public List<Entidades.EventoApi> Eventos { get; set; } = new();

    private List<CategoryModel> Categories { get; set; } = new();
    private int currentAgendaId =1; // <- usa el idAgenda que necesites (puede ser variable)
    //-- NOSE PARA QUE SIRVE A1
    // ---- DATOS / INICIALIZACIÓN ----
    private List<CategoryModel> MasterCategories = new();
    // Lista de órdenes (separada y limpia)
    private List<OrdenTrabajoModel> OrdenesParaMostrar = new();
    // ---- MODELOS PARA EL BLOQUE DE ÓRDENES (D1) ----
    public class TareaOrdenModel
    {
        public string Title { get; set; }
        public string Description { get; set; }
        public int ProgressPercent { get; set; } = 0;
    }

    public class OrdenTrabajoModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Numero { get; set; }
        public DateTime FechaConclusion { get; set; } = DateTime.Today;
        public DateTime? FechaSolicitud { get; set; }
        public string Autor { get; set; }
        public string Cliente { get; set; }
        public string Objetivo { get; set; }
        public string ObjetivosOtros { get; set; }
        public List<TareaOrdenModel> Subtasks { get; set; } = new();
        public OrdenStatus Status { get; set; } = OrdenStatus.Normal;
    }

    async Task ToggleTareaApi(TareaApi t)
    {
        t.completada = !t.completada;
        await Http.PutAsJsonAsync($"tareas/editar/{t.id}", t);
    }

    void OpenModificarDesdeApi(TareaApi t)
    {
        // Abre modal con datos reales
    }

    void OpenEditDesdeApi(TareaApi t)
    {
        // Abre edición
    }

    async Task DeleteTareaApi(TareaApi t)
    {
        await Http.DeleteAsync($"tareas/eliminar/{t.id}");
        await CargarTareas();
    }

    async Task CargarTareas()
    {
        TareasDelDia = await AgendaService.ObtenerTareasApi(3);
        //Eventos = await AgendaService.ObtenerEventosApi(3);

        StateHasChanged();
    }

    async Task ToggleSubTareaApi(TareaApi tarea, SubTareaApi s)
    {
        s.completada = !s.completada;
        await Http.PutAsJsonAsync($"tareas/editar/{tarea.id}", tarea);
    }

    async Task DeleteInnerSubTareaApi(TareaApi tarea, SubTareaApi s)
    {
        tarea.subTareas.Remove(s);
        await Http.PutAsJsonAsync($"tareas/editar/{tarea.id}", tarea);
    }


    //inicia DEL MODAL fechasmotivo

    private bool ShowModificarFechaModal = false;
    private DateTime FechaActual { get; set; } = DateTime.Now;
    private DateTime? NuevaFecha { get; set; } = DateTime.Now;
    private string Motivo { get; set; } = string.Empty;

    private List<HistorialFechaCambio> HistorialCambios { get; set; } = new();
    private List<TareaCreada> tareasAdministrativas = new();
    // alertas
    private bool MostrarAlerta = false;
    private string MensajeAlerta = string.Empty;
    private string TipoAlerta = "exito"; // "exito" o "error"

    private void OpenModificarModal(CategoryModel cat, SubtaskModel st)
    {
        FechaActual = st?.FechaConclusion != default ? st.FechaConclusion : DateTime.Now;
        NuevaFecha = FechaActual;
        Motivo = string.Empty;

        // si la subtarea tiene historial
        var hist = GetPropertyValue(st, "HistorialFechas") as List<HistorialFechaCambio>;
        HistorialCambios = hist ?? new List<HistorialFechaCambio>();

        MostrarAlerta = false;
        ShowModificarFechaModal = true;
    }

    private void GuardarCambioFecha()
    {
        if (string.IsNullOrWhiteSpace(Motivo))
        {
            MostrarAlerta = true;
            TipoAlerta = "error";
            MensajeAlerta = "El motivo del cambio es obligatorio.";
            return;
        }

        HistorialCambios.Add(new HistorialFechaCambio
        {
            FechaAnterior = FechaActual,
            FechaNueva = NuevaFecha ?? DateTime.Now,
            Motivo = Motivo,
            FechaModificacion = DateTime.Now
        });

        FechaActual = NuevaFecha ?? DateTime.Now; ;

        MostrarAlerta = true;
        TipoAlerta = "exito";
        MensajeAlerta = "¡Fecha modificada correctamente!";


        StateHasChanged();
    }

    private void CerrarModificarModal()
    {
        ShowModificarFechaModal = false;
    }

    private object? GetPropertyValue(object? obj, string propName)
    {
        if (obj == null) return null;
        try
        {
            var prop = obj.GetType().GetProperty(propName);
            if (prop != null) return prop.GetValue(obj);
        }
        catch { }
        return null;
    }

    public class HistorialFechaCambio
    {
        public DateTime FechaAnterior { get; set; }
        public DateTime FechaNueva { get; set; }
        public string Motivo { get; set; } = string.Empty;
        public DateTime FechaModificacion { get; set; } = DateTime.Now;
    }

    //TERMINA EL MODADAL DE MODIFCAR FECHA

    void ToggleCollapse(CategoryModel cat)
    {
        cat.IsCollapsed = !cat.IsCollapsed;
    }

    // ---- MODELOS QUE YA TENÍAS (mantengo para compatibilidad) ----
    /* class SubtaskModel
     {
         public string Id { get; set; } = Guid.NewGuid().ToString();
     public string Title { get; set; }
     public string Descripcion { get; set; }

     public bool IsDone { get; set; }
     public string Estado { get; set; } = "";   // <-- NUEVA PROPIEDAD
     public string Tipo { get; set; }  // 👈 "Evento" o "Tarea"
     public List<SubtaskModel> Subtasks { get; set; } = new();


     // Campos opcionales (si se usaran)
     public DateTime FechaConclusion { get; set; } = DateTime.Now.Date;
     public DateTime? FechaSolicitud { get; set; } = null;
     public string Autor { get; set; } = null;
     public string Cliente { get; set; } = null;
     public string Objetivo { get; set; } = null;
     public string ObjetivosOtros { get; set; } = null;
     public string Description { get; set; } = null;
     public int ProgressPercent { get; set; } = 0;
     }*/

    class CategoryModel
    {
        public string Name { get; set; }
        public List<SubtaskModel> Subtasks { get; set; } = new();
        public string ColorClass { get; set; } = "pastel-blue";
        public bool IsCollapsed { get; set; } = false;
        public string Icon { get; set; }
    }

    /*private void AgregarTarea(ReusableModal.TareaCreada nueva)
    {
        var categoria = Categories.FirstOrDefault(c => c.Name.Trim() == "Tareas");

        if (categoria != null)
        {
            var nuevaSubtask = new SubtaskModel
            {
                Title = nueva.Titulo,
                IsDone = false,
                // 👇 Guardamos si es evento o tarea
                Tipo = nueva.IsEvento ? "Evento" : "Tarea",
                Subtasks = nueva.Subtareas
                    .Select(s => new SubtaskModel { Title = s, IsDone = false })
                    .ToList()
            };

            categoria.Subtasks.Add(nuevaSubtask);
        }

        StateHasChanged();
    }*/


    protected override void OnInitialized()
    {
        /*InitializeMasterCategories();*/
        CargarTareasPorFecha();
        GenerarDiasCalendario();
        PrepararOrdenesVisuales();
    }
    protected override async Task OnInitializedAsync()
    {
        await InitializeMasterCategoriesAsync();
    }

    string GetIcon(string title) => title switch
    {
        "Órdenes de Trabajo" => "🧾",
        "Tareas " => "🗂️",
        "Autoevaluación" => "⭐",
        "Servicio a Cliente" => "🏢",
        _ => "📋"
    };

    /*private void InitializeMasterCategoriesAsync()
    {

        // Trae las tareas desde la API por agenda
        var tareas = await AgendaService.ObtenerTareasApi(3); // agenda actual
        MasterCategories = new();

        MasterCategories = new List<CategoryModel>
        {
            new CategoryModel { Name = "Tareas",ColorClass= "rosa-administrativa", Subtasks = new List<SubtaskModel>
                {
                    new SubtaskModel{ Title = "Me aseguré de que el área y la estación de insumos de TI esté limpia, ordenada y funcional.", Subtasks = new List<SubtaskModel>{ new SubtaskModel{ Title="Detalle 1"}, new SubtaskModel{ Title="Detalle 2" } } },
                    new SubtaskModel{ Title = "Di seguimiento en tiempo y forma al control de suscripciones de las que es responsable TI." },
                    new SubtaskModel{ Title = "Di seguimiento a la recepción de facturas de acuerdo con las solicitudes de pago y las entregue a Administración." },
                    new SubtaskModel{ Title = "Programé las citas inteligentemente y comunique al área y/o responsable del trabajo. " },
                }
            },
            new CategoryModel {
                Name = "Órdenes de Trabajo",
                ColorClass= "naranja-melocoton",
                Subtasks = new List<SubtaskModel>() // no la usamos como fuente principal
            },
            new CategoryModel { Name = "Autoevaluación",ColorClass= "azul-lavanda", Subtasks = new List<SubtaskModel>
                {
                    new SubtaskModel{ Title = "Me aseguré de que el área y la estación de insumos de TI esté limpia, ordenada y funcional." },
                    new SubtaskModel{ Title = "Di seguimiento en tiempo y forma al control de suscripciones de las que es responsable TI." },
                    new SubtaskModel{ Title = "Elaboré y compartí al área de Administración las solicitudes de pago del activo fijo de las que es responsable TI." }
                }
            },
              new CategoryModel { Name = "Servicio a Cliente", ColorClass= "azul-morado", Subtasks = new List<SubtaskModel>
                {
                   new SubtaskModel{ Title = "1658 Casas y desarrollos VITA SAPI de CV", Subtasks = new List<SubtaskModel>{ new SubtaskModel{ Title="Acordar con Lic.Gerardo cuando dara el informe"}, new SubtaskModel{ Title="Solicitar a TI descargar de CFDIS" } } },
                   new SubtaskModel{ Title = "1235 Construcciones y desarrollo nelsan SA de CV", Subtasks = new List<SubtaskModel>{ new SubtaskModel{ Title="Asegurar la recepción de documentos enviados por el Lic.Gerardo"}, new SubtaskModel{ Title="Visita a empresa(para revisar póliza,dudas del mes con Gerardo o Paola)" } } }
                }
            },
        };

        foreach (var category in MasterCategories)
        {
            category.Icon = GetIcon(category.Name);
        }
    }*/
    // ---------------------------
    // ======== AQUI: CARGA DINÁMICA SOLO DEL BLOQUE TAREAS ========
    private async Task InitializeMasterCategoriesAsync()
    {
        MasterCategories = new();

        // Trae tareas desde tu endpoint. AgendaService.ObtenerTareasApi debe llamar a:
        // GET https://redgm.site:9096/tareas?idAgenda=3
        var tareasApi = await AgendaService.ObtenerTareasApi(currentAgendaId);
        //var eventosApi = await AgendaService.ObtenerEventosApi(currentAgendaId);

        var tareasCategory = new CategoryModel
        {
            Name = "Tareas",
            ColorClass = "rosa-administrativa",
            Icon = "📝",
            Subtasks = tareasApi.Select(t => new SubtaskModel
            {
                Title = t.titulo,
                Descripcion = t.descripcion ?? string.Empty,
                IsDone = t.completada,
                Tipo = "Tarea",
                FechaInicio = t.fechaInicio,
                FechaFin = t.fechaFin,
                // guardamos el id del objeto API en Autor para usar luego si queremos actualizar
                Autor = t.id.ToString(),
                Subtasks = t.subTareas?.Select(st => new SubtaskModel
                {
                    Title = st.titulo,
                    IsDone = st.completada,
                    Tipo = "SubTarea",
                    // guardamos ids para persistir si se requiere
                    Autor = t.id.ToString(),    // id tarea padre
                    Cliente = st.id.ToString()  // id subtarea
                }).ToList() ?? new List<SubtaskModel>()
            }).ToList()
        };
        // 🔥🔥🔥 AÑADIR EVENTOS AL MISMO BLOQUE DE “Tareas”
        /*tareasCategory.Subtasks.AddRange(
            eventosApi.Select(ev => new SubtaskModel
            {
                Title = ev.titulo,
                Descripcion = ev.descripcion ?? string.Empty,
                IsDone = ev.completada,
                Tipo = "Evento",   // MUY IMPORTANTE
                FechaInicio = ev.fechaInicio,
                FechaFin = ev.fechaFin,
                Autor = ev.id.ToString(),
                Subtasks = new List<SubtaskModel>() // los eventos no tienen subtareas
            })
        );*/

        // Añadimos el bloque dinámico y mantenemos los demás bloques estáticos como tenías
        MasterCategories.Add(tareasCategory);

        MasterCategories.Add(new CategoryModel { Name = "Órdenes de Trabajo", ColorClass = "naranja-melocoton", Icon = "🔧", Subtasks = new List<SubtaskModel>() });
        MasterCategories.Add(new CategoryModel { Name = "Autoevaluación", ColorClass = "azul-lavanda", Icon = "📊", Subtasks = new List<SubtaskModel>() });
        MasterCategories.Add(new CategoryModel { Name = "Servicio a Cliente", ColorClass = "azul-morado", Icon = "🤝", Subtasks = new List<SubtaskModel>() });

        // Asignar iconos si hace falta
        foreach (var category in MasterCategories)
            category.Icon = GetIcon(category.Name);

        // Después de poblar MasterCategories, actualizamos Categories (las que usa el UI)
        CargarTareasPorFecha();
    }


    private void CargarTareasPorFecha()
    {
        Categories = MasterCategories.Select(c => new CategoryModel
        {
            Name = c.Name,
            ColorClass = c.ColorClass,
            Icon = c.Icon,
            Subtasks = c.Subtasks.Select(st => new SubtaskModel
            {
                Id = Guid.NewGuid().ToString(),
                Title = st.Title,
                IsDone = st.IsDone,
                Subtasks = st.Subtasks?.Select(s => new SubtaskModel { Title = s.Title, Description = s.Description, ProgressPercent = s.ProgressPercent }).ToList() ?? new List<SubtaskModel>(),
                FechaConclusion = st.FechaConclusion,
                FechaSolicitud = st.FechaSolicitud,
                Autor = st.Autor,
                Cliente = st.Cliente,
                Objetivo = st.Objetivo,
                ObjetivosOtros = st.ObjetivosOtros
            }).ToList()
        }).ToList();

        // Recalcula la lista de órdenes (si las traes desde backend deberías poblarla aquí)
        PrepararOrdenesVisuales();
    }

    private void PrepararOrdenesVisuales()
    {
        // Si tienes backend sustituye este bloque por la carga real.
        // Aquí creamos ejemplos para que lo veas en funcionamiento
        OrdenesParaMostrar = new List<OrdenTrabajoModel>
        {
            new OrdenTrabajoModel {
                Numero = "ORD-13537",
                FechaSolicitud = new DateTime(2025,8,27),
                Autor = "Nadia Vainey Ramirez Carmona",
                Cliente = "Grupo Mendez Asesores de Negocios SC",
                Objetivo = "799 trabajos especiales de tecnologías de la información",
                ObjetivosOtros = "equis",
                FechaConclusion = new DateTime(2025,9,17),
                Subtasks = new List<TareaOrdenModel> {
                    new TareaOrdenModel { Title = "Entrega del formato de control de inducciones", Description = "Al recibir esta inducción estuvo bien", ProgressPercent = 100 }
                }
            },
            new OrdenTrabajoModel {
                Numero = "ORD-13683",
                FechaSolicitud = new DateTime(2025,10,1),
                Autor = "Laura Gómez",
                Cliente = "Empresa Demo",
                Objetivo = "Instalación de red",
                FechaConclusion = DateTime.Today.AddDays(20),
                Subtasks = new List<TareaOrdenModel> {
                    new TareaOrdenModel { Title = "Instalación de switches", Description = "Programado", ProgressPercent = 20 }
                }
            },
            new OrdenTrabajoModel {
                Numero = "ORD-13296",
                FechaSolicitud = DateTime.Today.AddDays(2),
                Autor = "Miguel Ruiz",
                Cliente = "Comercial Central",
                Objetivo = "Actualización de software",
                FechaConclusion = DateTime.Today.AddDays(4),
                Subtasks = new List<TareaOrdenModel> {
                    new TareaOrdenModel { Title = "Pruebas en ambiente", Description = "En progreso", ProgressPercent = 50 }
                }
            },
            new OrdenTrabajoModel {
                Numero = "ORD-13503",
                FechaSolicitud = new DateTime(2025,9,5),
                Autor = "Carlos Pérez",
                Cliente = "Cliente Ejemplo SA",
                Objetivo = "Mantenimiento de servidores",
                FechaConclusion = DateTime.Today.AddDays(-3),
                Subtasks = new List<TareaOrdenModel> {
                    new TareaOrdenModel { Title = "Revisión de backup", Description = "Backup incompleto", ProgressPercent = 70 }
                }
            },
            // extras para mostrar llenado
            new OrdenTrabajoModel {
                Numero = "ORD-14020",
                FechaConclusion = DateTime.Today.AddDays(40),
                FechaSolicitud = DateTime.Today.AddDays(-10),
                Autor = "Sofia Martínez",
                Cliente = "Empresa Alfa",
                Objetivo = "Nueva instalación",
                Subtasks = new List<TareaOrdenModel>{ new TareaOrdenModel{ Title="Preparar infraestructura", Description="Pendiente", ProgressPercent=0 } }
            },
            new OrdenTrabajoModel {
                Numero = "ORD-12100",
                FechaConclusion = DateTime.Today.AddDays(-10),
                FechaSolicitud = DateTime.Today.AddDays(-30),
                Autor = "Luis Torres",
                Cliente = "Cliente Beta",
                Objetivo = "Soporte técnico",
                Subtasks = new List<TareaOrdenModel>{ new TareaOrdenModel{ Title="Atender incidencia", Description="Retrasado", ProgressPercent=40 } }
            }
        };

        // Calcula estados
        var hoy = DateTime.Today;
        foreach (var o in OrdenesParaMostrar)
        {
            if (o.FechaConclusion.Date < hoy) o.Status = OrdenStatus.Vencida;
            else if ((o.FechaConclusion.Date - hoy).TotalDays <= 5) o.Status = OrdenStatus.Proxima;
            else o.Status = OrdenStatus.Normal;
        }
    }

    // ---- Modal orden ----
    private bool ShowOrderModal { get; set; } = false;
    private OrdenTrabajoModel? SelectedOrden { get; set; }

    private void OpenOrderModal(OrdenTrabajoModel orden)
    {
        SelectedOrden = orden;
        ShowOrderModal = true;
        StateHasChanged();
    }

    public enum OrdenStatus
    {
        Normal,
        Proxima,
        Vencida
    }

    private void CloseOrderModal()
    {
        SelectedOrden = null;
        ShowOrderModal = false;
    }

    // ---- Calendario helpers ----
    private void DiaAnterior() { FechaSeleccionada = FechaSeleccionada.AddDays(-1); CargarTareasPorFecha(); GenerarDiasCalendario(); }
    private void DiaSiguiente() { FechaSeleccionada = FechaSeleccionada.AddDays(1); CargarTareasPorFecha(); GenerarDiasCalendario(); }
    private void AbrirCalendario() => MostrarModal = true;
    private void CerrarCalendario() => MostrarModal = false;
    private void MesAnterior() { MesActual = MesActual.AddMonths(-1); GenerarDiasCalendario(); }
    private void MesSiguiente() { MesActual = MesActual.AddMonths(1); GenerarDiasCalendario(); }
    private void SeleccionarFecha(DateTime nuevaFecha) { FechaSeleccionada = nuevaFecha; CerrarCalendario(); CargarTareasPorFecha(); }
    private void GenerarDiasCalendario()
    {
        var primerDiaDelMes = new DateTime(MesActual.Year, MesActual.Month, 1);
        int offset = ((int)primerDiaDelMes.DayOfWeek + 6) % 7;
        DiasDelCalendario = Enumerable.Range(0, 42).Select(i => primerDiaDelMes.AddDays(i - offset));
    }

    // ---- TAREAS (mantenidas) ----
    void ToggleSubtask(CategoryModel cat, SubtaskModel st)
    {
        st.IsDone = !st.IsDone;
        if (st.Subtasks != null && st.Subtasks.Any())
            st.Subtasks.ForEach(s2 => s2.IsDone = st.IsDone);
    }

    void ToggleInnerSubtask(CategoryModel cat, SubtaskModel parent, SubtaskModel inner)
    {
        inner.IsDone = !inner.IsDone;
        parent.IsDone = parent.Subtasks.All(x => x.IsDone);
    }

    bool AllCompleted(CategoryModel cat)
    {
        return cat.Subtasks != null && cat.Subtasks.Any()
            && cat.Subtasks.All(st => st.IsDone && (st.Subtasks == null || st.Subtasks.All(s2 => s2.IsDone)));
    }

    int RemainingCount(CategoryModel cat)
    {
        if (cat.Subtasks == null) return 0;
        int count = 0;
        foreach (var st in cat.Subtasks)
        {
            if (!st.IsDone) count++;
            if (st.Subtasks != null) count += st.Subtasks.Count(s => !s.IsDone);
        }
        return count;
    }
    void MarkAll(CategoryModel cat, bool done)
    {
        foreach (var st in cat.Subtasks)
        {
            st.IsDone = done;
            if (st.Subtasks != null) st.Subtasks.ForEach(s2 => s2.IsDone = done);
        }
    }
    // ---- Edit / Delete (mantengo tus handlers) ----
    void EditSubtask(CategoryModel cat, SubtaskModel st)
    {
        Console.WriteLine($"Editar actividad: {st.Title} en {cat.Name}");
    }

    void DeleteSubtask(CategoryModel cat, SubtaskModel st)
    {
        cat.Subtasks.Remove(st);
        CargarTareasPorFecha();
    }

    void EditInnerSubtask(CategoryModel cat, SubtaskModel parent, SubtaskModel inner)
    {
        Console.WriteLine($"Editar subtarea: {inner.Title} en {parent.Title}");
    }

    void DeleteInnerSubtask(CategoryModel cat, SubtaskModel parent, SubtaskModel inner)
    {
        parent.Subtasks.Remove(inner);
    }

    void OpenEditModal(CategoryModel cat, SubtaskModel st)
    {
        // abrir modal de edición si se requiere
    }

    void OpenEditInnerModal(CategoryModel cat, SubtaskModel parent, SubtaskModel inner)
    {
        // abrir modal de edición si se requiere
    }

    void CheckSave()
    {
        // guardar cambios (si implementas edición)
    }
    private async Task RefrescarTareas(TareaCreada t)
    {
        await InitializeMasterCategoriesAsync();
        StateHasChanged();
    }
}