@page "/"
@using System.Linq
@using System.Globalization
@inject NavigationManager navigate
@using Microsoft.AspNetCore.Components.Web
@using pruebas1.Entidades

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="agenda-container">
    <div class="top-bar-container">
        <div class="fecha-header">
            <button class="calendar-btn" @onclick="DiaAnterior"><i class="bi bi-arrow-left-circle"></i></button>
            <span class="fecha-texto">@FechaFormateada</span>
            <button class="calendar-btn" @onclick="DiaSiguiente"><i class="bi bi-arrow-right-circle"></i></button>

            <div class="calendar-wrapper">
                <button class="calendar-btn" @onclick="AbrirCalendario">📅</button>

                @if (MostrarModal)
                {
                    <div class="modal-popover" @onclick:stopPropagation="true">
                        <div class="calendar-header">
                            <button class="calendar-btn" @onclick="MesAnterior"><i class="bi bi-chevron-left"></i></button>
                            <strong>@MesActual.ToString("MMMM yyyy", new CultureInfo("es-ES"))</strong>
                            <button class="calendar-btn" @onclick="MesSiguiente"><i class="bi bi-chevron-right"></i></button>
                        </div>

                        <div class="calendar-grid">
                            @foreach (var dia in DiasSemana)
                            {
                                <div class="calendar-week-day"><strong>@dia</strong></div>
                            }
                            @foreach (var day in DiasDelCalendario)
                            {
                                <div class="calendar-day @(day.Month != MesActual.Month ? "calendar-other-month" : "") @(day.Date == DateTime.Now.Date ? "calendar-today" : "")"
                                     @onclick="() => SeleccionarFecha(day)">
                                    @day.Day
                                </div>
                            }
                        </div>
                        

                        <div style="margin-top:10px; text-align:center;">
                            <button class="calendar-btn" @onclick="CerrarCalendario">✖ Cerrar</button>
                        </div>
                    </div>
                }
            </div>

        </div>
       <div class="modal-button-container"> <ReusableModal OnSave="AgregarTarea" /> </div>
    </div>

    <br />

    @if (FechaSeleccionada.DayOfWeek == DayOfWeek.Sunday)
    {
        <div class="col-12 text-center">
            <div class="alert alert-warning shadow-sm">
                Día no laboral – @FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"))
            </div>
        </div>
    }
    else
    {
        @if (Categories.FirstOrDefault(c => c.Name.Trim() == "Tareas") is CategoryModel tareasCat)
        {
            <div class="card block-card @tareasCat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(tareasCat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@tareasCat.Icon @tareasCat.Name</h3>
                    </div>
                    <div class="header-right">
                        @if (AllCompleted(tareasCat))
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            <span class="badge pendiente">@RemainingCount(tareasCat) pendiente(s)</span>
                        }
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(tareasCat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!tareasCat.IsCollapsed)
                {
                    <div class="card-body block-body @(tareasCat.IsCollapsed ? "collapsed" : "")">
                        <ul class="subtask-list">
                            @foreach (var st in tareasCat.Subtasks)
                            {
                                <li class="subtask-item">
                                    <div class="subtask-label @(st.IsDone && tareasCat.Name != "Autoevaluación" ? "done" : "")">
                                        <input type="checkbox" checked="@st.IsDone" @onchange="(e) => ToggleSubtask(tareasCat, st)" />
                                        <span class="subtask-text">@st.Title</span>
                                        @if (st.IsDone)
                                        {
                                            <small class="done-text">Hecho</small>
                                        }
                                        @if (tareasCat.Name.Trim() == "Tareas")
                                        {
                                            <div class="subtask-actions">
                                                <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(tareasCat, st)">
                                                    <i class="bi bi-calendar"></i>
                                                </button>
                                                <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditModal(tareasCat, st)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="icon-btn delete" title="Eliminar" @onclick="() => DeleteSubtask(tareasCat, st)">
                                                    <i class="bi bi-trash3"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                    @if (st.Subtasks.Any())
                                    {
                                        <div class="table-wrapper">
                                            <ul class="subtask-list">
                                                @foreach (var s2 in st.Subtasks)
                                                {
                                                    <li class="subtask-item">
                                                        <div class="subtask-label @(s2.IsDone ? "done" : "")">
                                                            <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(tareasCat, st, s2)" />
                                                            <span class="subtask-text">@($"Objetivo de {s2.Title}")</span>
                                                            <div class="subtask-actions">
                                                                <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(tareasCat, st)">
                                                                    <i class="bi bi-calendar"></i>
                                                                </button>
                                                                <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditInnerModal(tareasCat, st, s2)">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>
                                                                <button class="icon-btn delete" title="Eliminar" @onclick="() => DeleteInnerSubtask(tareasCat, st, s2)">
                                                                    <i class="bi bi-trash3"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }

        @if (Categories.FirstOrDefault(c => c.Name.Trim() == "Órdenes de Trabajo") is CategoryModel otCat)
        {
            <div class="card block-card naranja-melocoton">
                <div class="block-header" @onclick="() => ToggleCollapse(otCat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@otCat.Icon Órdenes de Trabajo</h3>
                    </div>
                    <div class="header-right">
                        <span class="badge pendiente">@((OrdenesParaMostrar ?? Enumerable.Empty<OrdenTrabajoModel>()).Count()) orden(es)</span>
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(otCat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!otCat.IsCollapsed)
                {
                    <div class="card-body block-body">
                        <div class="ordenes-workboard">
                            @if (OrdenesParaMostrar != null && OrdenesParaMostrar.Any())
                            {
                                <div class="columns-container">
                                    <div class="column column-normal">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Normal).OrderBy(o => o.FechaConclusion))
                                        {
                                            <div class="ot-card">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.Numero</div>
                                                    <div class="ot-date">@ot.FechaConclusion.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => OpenOrderModal(ot)"><i class="bi bi-eye-fill"></i></button>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <div class="column column-soon">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Proxima).OrderBy(o => o.FechaConclusion))
                                        {
                                            <div class="ot-card ot-soon">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.Numero</div>
                                                    <div class="ot-date">@ot.FechaConclusion.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-soon">Próx.</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => OpenOrderModal(ot)"><i class="bi bi-eye-fill"></i></button>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <div class="column column-expired">
                                        @foreach (var ot in OrdenesParaMostrar.Where(o => o.Status == OrdenStatus.Vencida).OrderBy(o => o.FechaConclusion))
                                        {
                                            <div class="ot-card ot-expired">
                                                <div class="ot-left">
                                                    <div class="ot-number">@ot.Numero</div>
                                                    <div class="ot-date">@ot.FechaConclusion.ToString("dd/MM/yyyy")</div>
                                                </div>
                                                <div class="ot-middle">
                                                    <span class="badge badge-expired">VENCIDA</span>
                                                </div>
                                                <div class="ot-right">
                                                    <button class="icon-eye" title="Ver orden" @onclick="() => OpenOrderModal(ot)"><i class="bi bi-eye-fill"></i></button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="no-ordenes">No hay órdenes para mostrar</div>
                            }
                        </div>
                    </div>
                }
            </div>
            <br />
        }


        @foreach (var cat in Categories.Where(c => c.Name.Trim() != "Órdenes de Trabajo" && c.Name.Trim() != "Tareas"))
        {
            <div class="card block-card @cat.ColorClass">
                <div class="block-header" @onclick="() => ToggleCollapse(cat)">
                    <div class="header-left">
                        <h3 class="categoria-titulo">@cat.Icon @cat.Name</h3>
                    </div>
                    <div class="header-right">
                        @if (AllCompleted(cat))
                        {
                            <span class="badge completado">Completado ✓</span>
                        }
                        else
                        {
                            <span class="badge pendiente">@RemainingCount(cat) pendiente(s)</span>
                        }
                        <button class="btn btn-floating" style="font-size:0.8rem; padding:0.2rem 0.5rem;">
                            @(cat.IsCollapsed ? "▼" : "▲")
                        </button>
                    </div>
                </div>

                @if (!cat.IsCollapsed)
                {
                    <div class="card-body block-body @(cat.IsCollapsed ? "collapsed" : "")">
                        <ul class="subtask-list">
                            @foreach (var st in cat.Subtasks)
                            {
                                <li class="subtask-item">
                                    <div class="subtask-label @(st.IsDone && cat.Name != "Autoevaluación" ? "done" : "")">
                                        @if (cat.Name.Trim() != "Órdenes de Trabajo")
                                        {
                                            <input type="checkbox" checked="@st.IsDone" @onchange="(e) => ToggleSubtask(cat, st)" />
                                        }
                                        <span class="subtask-text">@st.Title</span>
                                        @if (st.IsDone)
                                        {
                                            <small class="done-text">Hecho</small>
                                        }
                                        @if (cat.Name.Trim() == "Tareas")
                                        {
                                            <div class="subtask-actions">
                                                <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(cat, st)">
                                                    <i class="bi bi-calendar"></i>
                                                </button>
                                                <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditModal(cat, st)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="icon-btn delete" title="Eliminar" @onclick="() => DeleteSubtask(cat, st)">
                                                    <i class="bi bi-trash3"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    @if ((cat.Name.Trim() == "Tareas" || cat.Name.Trim() == "Servicio a Cliente") && st.Subtasks.Any())
                                    {
                                        <div class="table-wrapper">
                                            @if (cat.Name.Trim() == "Servicio a Cliente")
                                            {
                                                <table class="subtask-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Actividad</th>
                                                            <th>Hecho</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var s2 in st.Subtasks)
                                                        {
                                                            <tr>
                                                                <td>@s2.Title</td>
                                                                <td>
                                                                    <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(cat, st, s2)" />
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            }
                                            else
                                            {
                                                <ul class="subtask-list">
                                                    @foreach (var s2 in st.Subtasks)
                                                    {
                                                        <li class="subtask-item">
                                                            <div class="subtask-label @(s2.IsDone ? "done" : "")">
                                                                <input type="checkbox" checked="@s2.IsDone" @onchange="(e) => ToggleInnerSubtask(cat, st, s2)" />
                                                                <span class="subtask-text">@($"Objetivo de {s2.Title}")</span>
                                                                <div class="subtask-actions">
                                                                    <button class="icon-btn edit" title="Modificar fecha" @onclick="() => OpenModificarModal(cat, st)">
                                                                        <i class="bi bi-calendar"></i>
                                                                    </button>
                                                                    <button class="icon-btn edit" title="Editar" @onclick="() => OpenEditInnerModal(cat, st, s2)">
                                                                        <i class="bi bi-pencil"></i>
                                                                    </button>
                                                                    <button class="icon-btn delete" title="Eliminar" @onclick="() => DeleteInnerSubtask(cat, st, s2)">
                                                                        <i class="bi bi-trash3"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <br />
        }
    }
</div>

@if (ShowModificarFechaModal)
{
    <div class="modal-backdrop" @onclick="BackdropClick" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;">
        <div class="modal-container" @onclick:stopPropagation>
            <h3>Modificar Fecha</h3>

            @if (HistorialCambios.Any())
            {
                <h5>Historial de Cambios</h5>
                <table class="table table-sm" style="width:100%;margin-bottom:12px;">
                    <thead>
                        <tr><th>Fecha Anterior</th><th>Nueva Fecha</th><th>Motivo</th></tr>
                    </thead>
                    <tbody>
                        @foreach (var h in HistorialCambios)
                        {
                            <tr>
                                <td>@h.FechaAnterior.ToString("dd/MM/yyyy")</td>
                                <td>@h.FechaNueva.ToString("dd/MM/yyyy")</td>
                                <td>@h.Motivo</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <div style="margin-bottom:10px;">
                <label>Fecha Actual:</label>
                <input type="text" class="form-control" value="@FechaActual.ToString("dd/MM/yyyy")" readonly />
            </div>

            <div style="margin-bottom:10px;">
                <label>Nueva Fecha:</label>
                <input type="date" class="form-control" @bind="NuevaFecha" />
            </div>

            <div style="margin-bottom:10px;">
                <label>Motivo:</label>
                <textarea class="form-control" rows="2" @bind="Motivo"></textarea>
            </div>

            <div style="display:flex;justify-content:flex-end;gap:8px;">
                <button class="btn btn-success" @onclick="GuardarCambioFecha">Guardar</button>
                <button class="btn btn-secondary" @onclick="CerrarModificarModal">Cancelar</button>
            </div>
        </div>
    </div>
}

<!-- MODAL DE VISUALIZACIÓN DE ORDEN (EXTRA GRANDE) -->
@if (ShowOrderModal && SelectedOrden != null)
{
    <div class="modal-container visible" @onclick="CloseOrderModal">
        <div class="modal-content" @onclick:stopPropagation="true" style="max-width:1200px; width:95%; height:92vh;">
            <div class="modal-header" style="background:#2b2b3a; color:#fff;">
                <h2 class="modal-title">Orden - @SelectedOrden.Numero</h2>
                <span class="close-button" @onclick="CloseOrderModal">&times;</span>
            </div>

            <div class="modal-body-wrapper">
                <div class="form-section-wrapper">
                    <div class="form-section">
                        <div>
                            <label class="section-label">Número de orden</label>
                            <div>@SelectedOrden.Numero</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha de solicitud</label>
                            <div>@(SelectedOrden.FechaSolicitud?.ToString("dd/MM/yyyy") ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Autor</label>
                            <div>@(SelectedOrden.Autor ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Nombre / Razón social</label>
                            <div>@(SelectedOrden.Cliente ?? "-")</div>
                        </div>

                        <div class="form-group-span-2">
                            <label class="section-label">Objetivo</label>
                            <div>@(SelectedOrden.Objetivo ?? "-")</div>
                        </div>

                        <div class="form-group-span-2">
                            <label class="section-label">Objetivos de otros</label>
                            <div>@(SelectedOrden.ObjetivosOtros ?? "-")</div>
                        </div>

                        <div>
                            <label class="section-label">Fecha programada de conclusión</label>
                            <div>@(SelectedOrden.FechaConclusion.ToString("dd/MM/yyyy"))</div>
                        </div>
                    </div>

                    <div style="margin-top:18px;" class="form-group-span-2">
                        <label class="section-label">Tareas</label>

                        <!-- Tabla minimalista estilo A (sin líneas) -->
                        <div class="tasks-table-minimal">
                            <div class="tasks-row tasks-header">
                                <div class="col-name">Nombre de la tarea</div>
                                <div class="col-desc">Descripción</div>
                                <div class="col-adv">Avance</div>
                            </div>

                            @foreach (var t in SelectedOrden?.Subtasks ?? Enumerable.Empty<TareaOrdenModel>())
                            {
                                <div class="tasks-row">
                                    <div class="col-name">@t.Title</div>
                                    <div class="col-desc">@(!string.IsNullOrEmpty(t.Description) ? t.Description : "-")</div>
                                    <div class="col-adv">@($"{t.ProgressPercent}%")</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn small" @onclick="CloseOrderModal">Cerrar</button>
            </div>
        </div>
    </div>
}


@code {
    // ---- FECHAS Y CALENDARIO ----
    private DateTime FechaSeleccionada { get; set; } = DateTime.Now.Date;
    private DateTime MesActual { get; set; } = DateTime.Now.Date;
    private bool MostrarModal { get; set; } = false;
    private string[] DiasSemana = { "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom" };
    private IEnumerable<DateTime> DiasDelCalendario { get; set; } = Enumerable.Empty<DateTime>();
    private string FechaFormateada => FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"));

    // ---- MODELOS PARA EL BLOQUE DE ÓRDENES (D1) ----
    public class TareaOrdenModel
    {
        public string Title { get; set; }
        public string Description { get; set; }
        public int ProgressPercent { get; set; } = 0;
    }

    public class OrdenTrabajoModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Numero { get; set; }
        public DateTime FechaConclusion { get; set; } = DateTime.Today;
        public DateTime? FechaSolicitud { get; set; }
        public string Autor { get; set; }
        public string Cliente { get; set; }
        public string Objetivo { get; set; }
        public string ObjetivosOtros { get; set; }
        public List<TareaOrdenModel> Subtasks { get; set; } = new();
        public OrdenStatus Status { get; set; } = OrdenStatus.Normal;
    }

    //inicia DEL MODAL fechasmotivo

    // controla apertura del modal
    private bool ShowModificarFechaModal = false;

    // fechas y motivo
    private DateTime FechaActual = DateTime.Now;
    private DateTime NuevaFecha = DateTime.Now;
    private string Motivo = string.Empty;

    // historial en memoria
    private List<HistorialFechaCambio> HistorialCambios { get; set; } = new();

    // si el botón llama SIN parámetros
    private void OpenModificarModal()
    {
        NuevaFecha = FechaActual;
        ShowModificarFechaModal = true;
        StateHasChanged();
    }

    // si el botón llama CON parámetros (tipado)
    private void OpenModificarModal(CategoryModel cat, SubtaskModel st)
    {
        // si la subtarea tiene fecha de conclusión la usamos
        FechaActual = st?.FechaConclusion ?? DateTime.Now;
        NuevaFecha = FechaActual;

        // intentamos cargar historial si existiera en la subtarea (propiedad opcional)
        try
        {
            var hist = GetPropertyValue(st, "HistorialFechas") as List<HistorialFechaCambio>;
            if (hist != null) HistorialCambios = hist;
            else HistorialCambios = new List<HistorialFechaCambio>();
        }
        catch
        {
            HistorialCambios = new List<HistorialFechaCambio>();
        }

        ShowModificarFechaModal = true;
        StateHasChanged();
    }

    private void CerrarModificarModal()
    {
        ShowModificarFechaModal = false;
    }

    private void BackdropClick()
    {
        // cerrar si se hace click fuera del modal
        CerrarModificarModal();
    }

    private void GuardarCambioFecha()
    {
        HistorialCambios.Add(new HistorialFechaCambio
        {
            FechaAnterior = FechaActual,
            FechaNueva = NuevaFecha,
            Motivo = Motivo ?? string.Empty
        });

        FechaActual = NuevaFecha;
        ShowModificarFechaModal = false;
    }

    // helper dinámico seguro para leer propiedades sin lanzar excepciones si no existen
    private object? GetPropertyValue(object? obj, string propName)
    {
        if (obj == null) return null;
        try
        {
            var prop = obj.GetType().GetProperty(propName);
            if (prop != null) return prop.GetValue(obj);
        }
        catch { }
        return null;
    }

    public class HistorialFechaCambio
    {
        public DateTime FechaAnterior { get; set; }
        public DateTime FechaNueva { get; set; }
        public string Motivo { get; set; } = string.Empty;
    }

    //TERMINO DEL MODAL


    void ToggleCollapse(CategoryModel cat)
    {
        cat.IsCollapsed = !cat.IsCollapsed;
    }

    // ---- MODELOS QUE YA TENÍAS (mantengo para compatibilidad) ----
    class SubtaskModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Title { get; set; }
        public bool IsDone { get; set; }
        public List<SubtaskModel> Subtasks { get; set; } = new();

        // Campos opcionales (si se usaran)
        public DateTime FechaConclusion { get; set; } = DateTime.Now.Date;
        public DateTime? FechaSolicitud { get; set; } = null;
        public string Autor { get; set; } = null;
        public string Cliente { get; set; } = null;
        public string Objetivo { get; set; } = null;
        public string ObjetivosOtros { get; set; } = null;
        public string Description { get; set; } = null;
        public int ProgressPercent { get; set; } = 0;
    }

    class CategoryModel
    {
        public string Name { get; set; }
        public List<SubtaskModel> Subtasks { get; set; } = new();
        public string ColorClass { get; set; } = "pastel-blue";
        public bool IsCollapsed { get; set; } = false;
        public string Icon { get; set; }
    }

    // ---- DATOS / INICIALIZACIÓN ----
    private List<CategoryModel> MasterCategories = new();
    private List<CategoryModel> Categories { get; set; } = new();

    // Lista de órdenes (separada y limpia)
    private List<OrdenTrabajoModel> OrdenesParaMostrar = new();

    protected override void OnInitialized()
    {
        InitializeMasterCategories();
        CargarTareasPorFecha();
        GenerarDiasCalendario();
        PrepararOrdenesVisuales();
    }

    string GetIcon(string title) => title switch
    {
        "Órdenes de Trabajo" => "🧾",
        "Tareas " => "🗂️",
        "Autoevaluación" => "⭐",
        "Servicio a Cliente" => "🏢",
        _ => "📋"
    };

    private void InitializeMasterCategories()
    {
        MasterCategories = new List<CategoryModel>
        {
            new CategoryModel { Name = "Tareas",ColorClass= "rosa-administrativa", Subtasks = new List<SubtaskModel>
                {
                    new SubtaskModel{ Title = "Me aseguré de que el área y la estación de insumos de TI esté limpia, ordenada y funcional.", Subtasks = new List<SubtaskModel>{ new SubtaskModel{ Title="Detalle 1"}, new SubtaskModel{ Title="Detalle 2" } } },
                    new SubtaskModel{ Title = "Di seguimiento en tiempo y forma al control de suscripciones de las que es responsable TI." },
                    new SubtaskModel{ Title = "Di seguimiento a la recepción de facturas de acuerdo con las solicitudes de pago y las entregue a Administración." },
                    new SubtaskModel{ Title = "Programé las citas inteligentemente y comunique al área y/o responsable del trabajo. " },
                }
            },
            new CategoryModel {
                Name = "Órdenes de Trabajo",
                ColorClass= "naranja-melocoton",
                Subtasks = new List<SubtaskModel>() // no la usamos como fuente principal
            },
            new CategoryModel { Name = "Autoevaluación",ColorClass= "azul-lavanda", Subtasks = new List<SubtaskModel>
                {
                    new SubtaskModel{ Title = "Me aseguré de que el área y la estación de insumos de TI esté limpia, ordenada y funcional." },
                    new SubtaskModel{ Title = "Di seguimiento en tiempo y forma al control de suscripciones de las que es responsable TI." },
                    new SubtaskModel{ Title = "Elaboré y compartí al área de Administración las solicitudes de pago del activo fijo de las que es responsable TI." }
                }
            },
              new CategoryModel { Name = "Servicio a Cliente", ColorClass= "azul-morado", Subtasks = new List<SubtaskModel>
                {
                   new SubtaskModel{ Title = "1658 Casas y desarrollos VITA SAPI de CV", Subtasks = new List<SubtaskModel>{ new SubtaskModel{ Title="Acordar con Lic.Gerardo cuando dara el informe"}, new SubtaskModel{ Title="Solicitar a TI descargar de CFDIS" } } },
                   new SubtaskModel{ Title = "1235 Construcciones y desarrollo nelsan SA de CV", Subtasks = new List<SubtaskModel>{ new SubtaskModel{ Title="Asegurar la recepción de documentos enviados por el Lic.Gerardo"}, new SubtaskModel{ Title="Visita a empresa(para revisar póliza,dudas del mes con Gerardo o Paola)" } } }
                }
            },
        };

        foreach (var category in MasterCategories)
        {
            category.Icon = GetIcon(category.Name);
        }
    }

    private void CargarTareasPorFecha()
    {
        Categories = MasterCategories.Select(c => new CategoryModel
        {
            Name = c.Name,
            ColorClass = c.ColorClass,
            Icon = c.Icon,
            Subtasks = c.Subtasks.Select(st => new SubtaskModel
            {
                Id = Guid.NewGuid().ToString(),
                Title = st.Title,
                IsDone = st.IsDone,
                Subtasks = st.Subtasks?.Select(s => new SubtaskModel { Title = s.Title, Description = s.Description, ProgressPercent = s.ProgressPercent }).ToList() ?? new List<SubtaskModel>(),
                FechaConclusion = st.FechaConclusion,
                FechaSolicitud = st.FechaSolicitud,
                Autor = st.Autor,
                Cliente = st.Cliente,
                Objetivo = st.Objetivo,
                ObjetivosOtros = st.ObjetivosOtros
            }).ToList()
        }).ToList();

        // Recalcula la lista de órdenes (si las traes desde backend deberías poblarla aquí)
        PrepararOrdenesVisuales();
    }

    private void PrepararOrdenesVisuales()
    {
        // Si tienes backend sustituye este bloque por la carga real.
        // Aquí creamos ejemplos para que lo veas en funcionamiento
        OrdenesParaMostrar = new List<OrdenTrabajoModel>
        {
            new OrdenTrabajoModel {
                Numero = "ORD-13537",
                FechaSolicitud = new DateTime(2025,8,27),
                Autor = "Nadia Vainey Ramirez Carmona",
                Cliente = "Grupo Mendez Asesores de Negocios SC",
                Objetivo = "799 trabajos especiales de tecnologías de la información",
                ObjetivosOtros = "equis",
                FechaConclusion = new DateTime(2025,9,17),
                Subtasks = new List<TareaOrdenModel> {
                    new TareaOrdenModel { Title = "Entrega del formato de control de inducciones", Description = "Al recibir esta inducción estuvo bien", ProgressPercent = 100 }
                }
            },
            new OrdenTrabajoModel {
                Numero = "ORD-13683",
                FechaSolicitud = new DateTime(2025,10,1),
                Autor = "Laura Gómez",
                Cliente = "Empresa Demo",
                Objetivo = "Instalación de red",
                FechaConclusion = DateTime.Today.AddDays(20),
                Subtasks = new List<TareaOrdenModel> {
                    new TareaOrdenModel { Title = "Instalación de switches", Description = "Programado", ProgressPercent = 20 }
                }
            },
            new OrdenTrabajoModel {
                Numero = "ORD-13296",
                FechaSolicitud = DateTime.Today.AddDays(2),
                Autor = "Miguel Ruiz",
                Cliente = "Comercial Central",
                Objetivo = "Actualización de software",
                FechaConclusion = DateTime.Today.AddDays(4),
                Subtasks = new List<TareaOrdenModel> {
                    new TareaOrdenModel { Title = "Pruebas en ambiente", Description = "En progreso", ProgressPercent = 50 }
                }
            },
            new OrdenTrabajoModel {
                Numero = "ORD-13503",
                FechaSolicitud = new DateTime(2025,9,5),
                Autor = "Carlos Pérez",
                Cliente = "Cliente Ejemplo SA",
                Objetivo = "Mantenimiento de servidores",
                FechaConclusion = DateTime.Today.AddDays(-3),
                Subtasks = new List<TareaOrdenModel> {
                    new TareaOrdenModel { Title = "Revisión de backup", Description = "Backup incompleto", ProgressPercent = 70 }
                }
            },
            // extras para mostrar llenado
            new OrdenTrabajoModel {
                Numero = "ORD-14020",
                FechaConclusion = DateTime.Today.AddDays(40),
                FechaSolicitud = DateTime.Today.AddDays(-10),
                Autor = "Sofia Martínez",
                Cliente = "Empresa Alfa",
                Objetivo = "Nueva instalación",
                Subtasks = new List<TareaOrdenModel>{ new TareaOrdenModel{ Title="Preparar infraestructura", Description="Pendiente", ProgressPercent=0 } }
            },
            new OrdenTrabajoModel {
                Numero = "ORD-12100",
                FechaConclusion = DateTime.Today.AddDays(-10),
                FechaSolicitud = DateTime.Today.AddDays(-30),
                Autor = "Luis Torres",
                Cliente = "Cliente Beta",
                Objetivo = "Soporte técnico",
                Subtasks = new List<TareaOrdenModel>{ new TareaOrdenModel{ Title="Atender incidencia", Description="Retrasado", ProgressPercent=40 } }
            }
        };

        // Calcula estados
        var hoy = DateTime.Today;
        foreach (var o in OrdenesParaMostrar)
        {
            if (o.FechaConclusion.Date < hoy) o.Status = OrdenStatus.Vencida;
            else if ((o.FechaConclusion.Date - hoy).TotalDays <= 5) o.Status = OrdenStatus.Proxima;
            else o.Status = OrdenStatus.Normal;
        }
    }

    // ---- Modal orden ----
    private bool ShowOrderModal { get; set; } = false;
    private OrdenTrabajoModel? SelectedOrden { get; set; }

    private void OpenOrderModal(OrdenTrabajoModel orden)
    {
        SelectedOrden = orden;
        ShowOrderModal = true;
        StateHasChanged();
    }

    public enum OrdenStatus
    {
        Normal,
        Proxima,
        Vencida
    }

    private void CloseOrderModal()
    {
        SelectedOrden = null;
        ShowOrderModal = false;
    }

    // ---- Calendario helpers ----
    private void DiaAnterior() { FechaSeleccionada = FechaSeleccionada.AddDays(-1); CargarTareasPorFecha(); GenerarDiasCalendario(); }
    private void DiaSiguiente() { FechaSeleccionada = FechaSeleccionada.AddDays(1); CargarTareasPorFecha(); GenerarDiasCalendario(); }
    private void AbrirCalendario() => MostrarModal = true;
    private void CerrarCalendario() => MostrarModal = false;
    private void MesAnterior() { MesActual = MesActual.AddMonths(-1); GenerarDiasCalendario(); }
    private void MesSiguiente() { MesActual = MesActual.AddMonths(1); GenerarDiasCalendario(); }
    private void SeleccionarFecha(DateTime nuevaFecha) { FechaSeleccionada = nuevaFecha; CerrarCalendario(); CargarTareasPorFecha(); }
    private void GenerarDiasCalendario()
    {
        var primerDiaDelMes = new DateTime(MesActual.Year, MesActual.Month, 1);
        int offset = ((int)primerDiaDelMes.DayOfWeek + 6) % 7;
        DiasDelCalendario = Enumerable.Range(0, 42).Select(i => primerDiaDelMes.AddDays(i - offset));
    }

    // ---- TAREAS (mantenidas) ----
    void ToggleSubtask(CategoryModel cat, SubtaskModel st)
    {
        st.IsDone = !st.IsDone;
        if (st.Subtasks != null && st.Subtasks.Any())
            st.Subtasks.ForEach(s2 => s2.IsDone = st.IsDone);
    }

    void ToggleInnerSubtask(CategoryModel cat, SubtaskModel parent, SubtaskModel inner)
    {
        inner.IsDone = !inner.IsDone;
        parent.IsDone = parent.Subtasks.All(x => x.IsDone);
    }

    bool AllCompleted(CategoryModel cat)
    {
        return cat.Subtasks != null && cat.Subtasks.Any()
            && cat.Subtasks.All(st => st.IsDone && (st.Subtasks == null || st.Subtasks.All(s2 => s2.IsDone)));
    }

    int RemainingCount(CategoryModel cat)
    {
        if (cat.Subtasks == null) return 0;
        int count = 0;
        foreach (var st in cat.Subtasks)
        {
            if (!st.IsDone) count++;
            if (st.Subtasks != null) count += st.Subtasks.Count(s => !s.IsDone);
        }
        return count;
    }

    void MarkAll(CategoryModel cat, bool done)
    {
        foreach (var st in cat.Subtasks)
        {
            st.IsDone = done;
            if (st.Subtasks != null) st.Subtasks.ForEach(s2 => s2.IsDone = done);
        }
    }

    // ---- Edit / Delete (mantengo tus handlers) ----
    void EditSubtask(CategoryModel cat, SubtaskModel st)
    {
        Console.WriteLine($"Editar actividad: {st.Title} en {cat.Name}");
    }

    void DeleteSubtask(CategoryModel cat, SubtaskModel st)
    {
        cat.Subtasks.Remove(st);
        CargarTareasPorFecha();
    }

    void EditInnerSubtask(CategoryModel cat, SubtaskModel parent, SubtaskModel inner)
    {
        Console.WriteLine($"Editar subtarea: {inner.Title} en {parent.Title}");
    }

    void DeleteInnerSubtask(CategoryModel cat, SubtaskModel parent, SubtaskModel inner)
    {
        parent.Subtasks.Remove(inner);
    }

    void OpenEditModal(CategoryModel cat, SubtaskModel st)
    {
        // abrir modal de edición si se requiere
    }

    void OpenEditInnerModal(CategoryModel cat, SubtaskModel parent, SubtaskModel inner)
    {
        // abrir modal de edición si se requiere
    }

    void CheckSave()
    {
        // guardar cambios (si implementas edición)
    }

    private void AgregarTarea(ReusableModal.TareaCreada nueva)
    {
        var categoria = Categories.FirstOrDefault(c => (nueva.Tipo == "Administrativa" && c.Name == "Tareas "));

        if (categoria != null)
        {
            var nuevaSubtask = new SubtaskModel
            {
                Title = nueva.Titulo,
                IsDone = false,
                Subtasks = nueva.Subtareas.Select(s => new SubtaskModel { Title = s, IsDone = false }).ToList()
            };

            categoria.Subtasks.Add(nuevaSubtask);
        }

        StateHasChanged();
    }
}