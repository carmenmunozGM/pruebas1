@page "/compete"
@using System.Globalization
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="container my-4">

    <!-- Encabezado con fecha y botones -->
    <div class="fecha-header text-center mb-4">
        <button class="calendar-btn" @onclick="DiaAnterior">
            <i class="bi bi-arrow-left-circle"></i>
        </button>

        <span class="fecha-texto">@FechaFormateada</span>

        <button class="calendar-btn" @onclick="DiaSiguiente">
            <i class="bi bi-arrow-right-circle"></i>
        </button>

        <button class="calendar-btn" @onclick="AbrirCalendario">📅</button>
        <br />
        <br />
       
    </div>

    <!-- Modal tipo popover -->
    @if (MostrarModal)
    {
        <div class="modal-popover">
            <div class="calendar-header">
                <button class="calendar-btn" @onclick="MesAnterior"><i class="bi bi-chevron-left"></i></button>
                <strong>@MesActual.ToString("MMMM yyyy", new CultureInfo("es-ES"))</strong>
                <button class="calendar-btn" @onclick="MesSiguiente"><i class="bi bi-chevron-right"></i></button>
            </div>

            <div class="calendar-grid">
                @foreach (var dia in DiasSemana)
                {
                    <div><strong>@dia</strong></div>
                }

                @foreach (var day in DiasDelCalendario)
                {
                    <div class="calendar-day @(day.Month != MesActual.Month ? "calendar-other-month" : "") @(day.Date == DateTime.Now.Date ? "calendar-today" : "")"
                         @onclick="() => SeleccionarFecha(day)">
                        @day.Day
                    </div>
                }
            </div>
            <div style="margin-top:10px; text-align:center;">
                <button class="calendar-btn" @onclick="CerrarCalendario">✖ Cerrar</button>
            </div>
        </div>
    }
   
    <!-- Bloques de la agenda -->
    <div class="row g-4">
        @if (FechaSeleccionada.DayOfWeek == DayOfWeek.Sunday)
        {
            <!-- Aviso domingo no laboral -->
            <div class="col-12 text-center">
                <div class="alert alert-warning shadow-sm">
                    Domingo no laboral – @FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"))
                </div>
            </div>
        }
        else if (!Blocks.Any())
        {
            <!-- Aviso día sin tareas -->
            <div class="col-12 text-center">
                <div class="alert alert-info shadow-sm">
                    No hubo tareas para @FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"))
                </div>
            </div>
        }
        else
        {
            <!-- Render normal de bloques -->
            @foreach (var block in Blocks)
            {
                <div class="col-md-6">
                    @if (block.EstaAbierto)
                    {
                        <!-- Bloque desplegado -->
                        <div class="block-card p-3 shadow-sm" style="background-color:@block.ColorFondo;">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="toggle-header" @onclick="() => ToggleBlock(block)">
                                    @block.Titulo <i class="bi bi-chevron-up"></i>
                                </h4>
                                <div>
                                    @if (EstaCompletado(block))
                                    {
                                        <span class="badge bg-success">Completado ✓</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">@Pendientes(block) pendiente(s)</span>
                                    }
                                </div>
                            </div>

                            <ul class="list-group mt-3">
                                @foreach (var tarea in block.Tareas)
                                {
                                    <li class="list-group-item">
                                        <input type="checkbox" class="form-check-input me-2" @bind="tarea.Completada" />
                                        <div>
                                            <span class="@(tarea.Completada ? "text-decoration-line-through" : "")"
                                                  @onclick="() => ToggleTarea(tarea)">
                                                @tarea.Nombre
                                            </span>
                                            <br />
                                            <small class="text-muted">
                                                Del @tarea.FechaInicio.ToString("dd MMM yyyy", new CultureInfo("es-ES"))
                                                al @tarea.FechaFin.ToString("dd MMM yyyy", new CultureInfo("es-ES"))
                                            </small>
                                        </div>

                                        @if (tarea.MostrarSubTareas && tarea.SubTareas.Any())
                                        {
                                            <ul class="list-group mt-2 ms-4">
                                                @foreach (var sub in tarea.SubTareas)
                                                {
                                                    <li class="list-group-item">
                                                        <input type="checkbox" class="form-check-input me-2" @bind="sub.Completada" />
                                                        <span class="@(sub.Completada ? "text-decoration-line-through" : "")">@sub.Nombre</span>
                                                    </li>
                                                }
                                            </ul>
                                        }
                                    </li>
                                }
                            </ul>

                            <div class="mt-3 d-flex justify-content-end gap-2">
                                <button class="btn btn-sm btn-outline-success" @onclick="() => MarcarTodo(block, true)">Marcar todo</button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => MarcarTodo(block, false)">Desmarcar todo</button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Bloque colapsado como barra -->
                        <div class="block-card collapsed-card shadow-sm" style="background-color:@block.ColorFondo;" @onclick="() => ToggleBlock(block)">
                            <h4 class="text-center toggle-header m-0">
                                @block.Titulo <i class="bi bi-chevron-down"></i>
                            </h4>
                        </div>
                    }
                </div>
            }
        }
    </div>

</div>


@code {
    // ----- MODELOS -----
    public class Block
    {
        public string Titulo { get; set; } = "";
        public string ColorFondo { get; set; } = "";
        public List<Tarea> Tareas { get; set; } = new();
        public bool EstaAbierto { get; set; } = true; // por defecto desplegado
    }

    public class Tarea
    {
        public string Nombre { get; set; } = "";
        public bool Completada { get; set; }
        public List<SubTarea> SubTareas { get; set; } = new();
        public bool MostrarSubTareas { get; set; }
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
    }

    public class SubTarea
    {
        public string Nombre { get; set; } = "";
        public bool Completada { get; set; }
    }

    // ----- VARIABLES -----
    private List<Block> Blocks = new();
    private DateTime FechaSeleccionada = DateTime.Today;
    private bool MostrarModal = false;
    private DateTime MesActual = DateTime.Today;

    private string FechaFormateada => FechaSeleccionada.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES"));
    private List<string> DiasSemana => new() { "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom" };

    private List<DateTime> DiasDelCalendario =>
        Enumerable.Range(0, 42)
                  .Select(i => new DateTime(MesActual.Year, MesActual.Month, 1).AddDays(-(int)new DateTime(MesActual.Year, MesActual.Month, 1).DayOfWeek + i + 1))
                  .ToList();

    // ----- MÉTODOS -----
    protected override void OnInitialized()
    {
        CargarTareasDelDia();
    }

    private void CargarTareasDelDia()
    {
        // Caso especial: Domingo no laboral
        if (FechaSeleccionada.DayOfWeek == DayOfWeek.Sunday)
        {
            Blocks = new(); // vacío
            return;
        }

        // Ejemplo: si el día es par cargamos tareas, si es impar no
        if (FechaSeleccionada.Day % 2 == 0)
        {
            Blocks = new List<Block>
            {
                new Block
                {
                    Titulo = "Tareas Administrativas",
                    ColorFondo = "#E5E4CF",
                    Tareas = new()
                    {
                        new Tarea
                        {
                            Nombre = "Di seguimiento en tiempo y forma al control de suscripciones de las que es responsable TI.",
                            FechaInicio = FechaSeleccionada,
                            FechaFin = FechaSeleccionada.AddDays(1),
                            SubTareas = new(){ new SubTarea{ Nombre="Responder clientes"} }
                        },
                        new Tarea
                        {
                            Nombre = "Actualizar reportes",
                            FechaInicio = FechaSeleccionada,
                            FechaFin = FechaSeleccionada,
                            SubTareas = new(){ new SubTarea{ Nombre="Enviar a jefe"} }
                        }
                    }
                },
                new Block
                {
                    Titulo = "Órdenes de Trabajo",
                    ColorFondo = "#D7D1DD",
                    Tareas = new()
                    {
                        new Tarea
                        {
                            Nombre = "Orden #1234",
                            FechaInicio = FechaSeleccionada,
                            FechaFin = FechaSeleccionada.AddDays(2),
                            SubTareas = new(){ new SubTarea{ Nombre="Revisar inventario"} }
                        }
                    }
                },
                new Block
                {
                    Titulo = "Tareas",
                    ColorFondo = "#A3CEC5",
                    Tareas = new()
                    {
                        new Tarea { Nombre = "Estudiar Blazor", FechaInicio = FechaSeleccionada, FechaFin = FechaSeleccionada.AddDays(3) },
                        new Tarea { Nombre = "Practicar C#", FechaInicio = FechaSeleccionada, FechaFin = FechaSeleccionada }
                    }
                },
                new Block
                {
                    Titulo = "Autoevaluación",
                    ColorFondo = "#EEDE90",
                    Tareas = new()
                    {
                        new Tarea { Nombre = "Evaluación semanal", FechaInicio = FechaSeleccionada, FechaFin = FechaSeleccionada }
                    }
                },
                new Block
                {
                    Titulo = "Servicio al Cliente",
                    ColorFondo = "#A3C4F3",
                    Tareas = new()
                    {
                        new Tarea { Nombre = "Llamar a cliente A", FechaInicio = FechaSeleccionada, FechaFin = FechaSeleccionada },
                        new Tarea { Nombre = "Dar seguimiento ticket #56", FechaInicio = FechaSeleccionada, FechaFin = FechaSeleccionada.AddDays(1) }
                    }
                }
            };
        }
        else
        {
            // Día sin tareas
            Blocks = new();
        }
    }

    // ----- LÓGICA DE COMPLETADO -----
    private bool EstaCompletado(Block block) =>
        block.Tareas.All(t => t.Completada && (t.SubTareas == null || t.SubTareas.All(s => s.Completada)));

    private int Pendientes(Block block)
    {
        int total = 0;
        foreach (var t in block.Tareas)
        {
            if (!t.Completada) total++;
            if (t.SubTareas != null)
                total += t.SubTareas.Count(s => !s.Completada);
        }
        return total;
    }

    private void MarcarTodo(Block block, bool estado)
    {
        foreach (var t in block.Tareas)
        {
            t.Completada = estado;
            if (t.SubTareas != null)
                foreach (var s in t.SubTareas) s.Completada = estado;
        }
    }

    private void ToggleTarea(Tarea tarea) => tarea.MostrarSubTareas = !tarea.MostrarSubTareas;
    private void ToggleBlock(Block block) => block.EstaAbierto = !block.EstaAbierto;

    private void DiaAnterior()
    {
        FechaSeleccionada = FechaSeleccionada.AddDays(-1);
        CargarTareasDelDia();
    }

    private void DiaSiguiente()
    {
        FechaSeleccionada = FechaSeleccionada.AddDays(1);
        CargarTareasDelDia();
    }

    private void AbrirCalendario() => MostrarModal = true;
    private void CerrarCalendario() => MostrarModal = false;

    private void MesAnterior() => MesActual = MesActual.AddMonths(-1);
    private void MesSiguiente() => MesActual = MesActual.AddMonths(1);

    private void SeleccionarFecha(DateTime fecha)
    {
        FechaSeleccionada = fecha;
        MostrarModal = false;
        CargarTareasDelDia();

        if (Blocks == null || !Blocks.Any() || Blocks.All(b => b.Tareas.Count == 0))
        {
            Blocks = new List<Block>();
        }
    }
}

<style>
    .block-card {
        border-radius: 1rem;
        min-height: 250px;
    }

    .fecha-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        font-size: 1.2rem;
        font-weight: bold;
    }

    .calendar-btn {
        border: none;
        background: none;
        font-size: 1.4rem;
        cursor: pointer;
        color: #002147;
    }

    .modal-popover {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 0.8rem;
        padding: 1rem;
        z-index: 1000;
        width: 320px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .collapsed-card {
        padding: 12px;
        min-height: 50px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .toggle-header {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        user-select: none;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        align-items: center;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        text-align: center;
    }

    .add-button {
        background-color: #28a745; /* Color verde */
        color: white;
        padding: 8px 15px; /* Reducido para hacerlo más pequeño */
        border: none;
        border-radius: 25px; /* Aumentado para esquinas más redondeadas */
        font-size: 14px; /* Reducido para que el texto sea más pequeño */
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px; /* Espacio reducido entre el ícono y el texto */
        transition: background-color 0.3s ease;
    }

        .add-button:hover {
            background-color: #218838; /* Verde más oscuro al pasar el ratón */
        }

    .button-icon {
        font-size: 16px; /* Reducido para el ícono */
    }

    .contenedor-de-fecha-y-boton {
        display: flex; /* Habilita Flexbox */
        align-items: center; /* Alinea verticalmente los elementos */
        justify-content: flex-start; /* Alinea los elementos a la izquierda */
        gap: 15px; /* Espacio entre los elementos */
        padding-left: 20px; /* Agrega un espacio a la izquierda de todo el contenedor */
    }
    .calendar-day {
        padding: 5px;
        border-radius: 5px;
        cursor: pointer;
    }

    .calendar-other-month {
        color: #bbb;
    }

    .calendar-today {
        background-color: #002147;
        color: white;
        font-weight: bold;
    }

    .subtask-label.done .subtask-text {
        text-decoration: line-through;
        opacity: 0.6;
    }
</style>
