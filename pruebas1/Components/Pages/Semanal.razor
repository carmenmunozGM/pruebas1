@page "/semanal"
@using System.Globalization
@using System.Diagnostics
@using pruebas1.Entidades
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@inject AgendaService AgendaService
@inject OrdenTrabajoService OrdenService
@inject IJSRuntime JSRuntime
@inject AutoevaluacionService AutoevaluacionService
@using System.Net.Http.Json;
@inject OrdenTramiteService OrdenTramiteService
@inject CalendarioService CalendarioService
@inject SalasEmService SalasEmService
@inject ReglasRecurrenciaServices ReglasRecurrenciaServices



<br />
<br />
<br />
<div class="agenda-container">

    <header class="agenda-header">
        <button class="btn" @onclick="PrevWeek">
            <span class="arrow">&#9664;</span> Semana anterior
        </button>

        <div class="header-center">
            <h1>Semana @WeekNumber - @MonthName @CurrentDate.Year</h1>
        </div>

        <button class="btn primary" @onclick="NextWeek">
            Semana siguiente <span class="arrow">&#9654;</span>
        </button>
    </header>
    @* <div style="color:red;font-weight:bold">
        Días inhábiles cargados: @DiasNoLaboralesMes.Count
    </div> *@

    <div class="days-grid weekly">
        @foreach (var day in Days.Where(d => d.Date.DayOfWeek != DayOfWeek.Sunday))
        {
            bool esNoLaboral = EsDiaNoLaboral(day.Date);

            <div class="day-card @(esNoLaboral ? "dia-no-laboral" : "")">

                <div class="day-header">
                    <span class="day-name">@day.Date.ToString("dddd", new CultureInfo("es-ES"))</span>
                    <span class="day-date">@day.Date.ToString("dd")</span>
                </div>
                @if (esNoLaboral)
                {
                    <div class="no-laboral-info">
                        Día no laboral
                        <br />
                        <small>@ObtenerDescripcionNoLaboral(day.Date)</small>
                    </div>
                }
                else
                {
                    <div class="blocks-list">
                        @foreach (var block in day.Blocks)
                        {
                            <div class="list-item" style="background-color:@block.Color">
                                <div class="list-title" @onclick="() => ToggleBlock(block)">
                                    <span>@block.Title</span>

                                    <span class="badge-pendientes">
                                        @PendingCount(block)

                                    </span>

                                    <span class="chev">@((block.IsExpanded ? "▼" : "►"))</span>
                                </div>

                                @if (block.IsExpanded)
                                {
                                    <ul class="subtasks">
                                        @foreach (var taskObj in block.SubTasks)
                                        {
                                            <li class="task-item">
                                                @switch (taskObj)
                                                {
                                                    case ClientServiceTask cs:
                                                        <input type="checkbox"
                                                               checked="@cs.IsCompleted"
                                                               @onchange="(e) => ToggleCompleteClient(cs, e)"
                                                               @onclick:stopPropagation />
                                                        <span class="task-name @(cs.IsCompleted ? "completed" : "")"
                                                              @onclick="() => OpenClientModal(cs)">
                                                            @cs.CompanyName
                                                        </span>
                                                        break;

                                                    case SelfAssessment sa:
                                                        <input type="checkbox"
                                                               checked="@sa.IsCompleted"
                                                               disabled="@(!IsToday(sa))"
                                                               @onchange="(e) => ToggleCompleteSelf(sa, e)"
                                                               @onclick:stopPropagation />

                                                        <span class="task-name @(sa.IsCompleted ? "completed" : "")"
                                                              @onclick="() => OpenSelfAssessmentModal(sa)">
                                                            @sa.ActivityName
                                                        </span>

                                                        break;

                                                    case BaseTask bt:
                                                        if (block.Title != "Órdenes de Trabajo")
                                                        {
                                                            <span class="task-name @(bt.IsCompleted ? "completed" : "")"
                                                                  @onclick="() => OpenTaskModal(bt, false)">
                                                                <span class="task-icon">@bt.IconoVisual</span>
                                                                @bt.Name
                                                            </span>

                                                            <div class="task-actions">
                                                                <button class="edit-btn"
                                                                        title="Editar"
                                                                        @onclick="(MouseEventArgs e) => OpenTaskModal(bt, true)"
                                                                        @onclick:stopPropagation="true">
                                                                    ✏️
                                                                </button>

                                                                <button class="delete-btn"
                                                                        title="Eliminar"
                                                                        @onclick="(MouseEventArgs e) => ConfirmDelete(bt)"
                                                                        @onclick:stopPropagation="true">
                                                                    🗑️
                                                                </button>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <span class="task-name @(bt.IsCompleted ? "completed" : "")"
                                                                  @onclick="() => AbrirDetalle(bt)">
                                                                @bt.Name
                                                            </span>

                                                        }
                                                        break;

                                                    default:
                                                        <span>Desconocido</span>
                                                        ;
                                                        break;
                                                }
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- Modal de Tarea (editar/ver) -->
@if (IsModalOpen && SelectedTaskObject != null)
{
    <div class="modal-backdrop" @onclick="CloseTaskModal"></div>

    <div class="modal-content" @onclick:stopPropagation>
        <div class="modal-header">
            <h2>@GetModalTitle()</h2>
            <button class="close-btn" @onclick="CloseTaskModal">&times;</button>
        </div>

        <div class="modal-body">
            @if (IsModalOpen && SelectedTaskObject is BaseTask bt)
            {
                <div class="modal-backdrop" @onclick="CloseTaskModal"></div>

                <div class="modal-content" @onclick:stopPropagation>
                    <div class="modal-header">
                        <h2>@(bt.EsEvento ? "📅 Detalles del Evento" : "📝 Detalles de la Tarea")</h2>
                        <button class="close-btn" @onclick="CloseTaskModal">&times;</button>
                    </div>

                    <div class="modal-body">
                        <!-- Nombre/Actividad -->
                        <div class="form-group">
                            <label>Título</label>
                            <input type="text" @bind="bt.Name" disabled="@(!IsEditMode)" />
                        </div>

                        <!-- Descripción -->
                        <div class="form-group">
                            <label>Descripción:</label>
                            <textarea @bind="bt.Description" disabled="@(!IsEditMode)"></textarea>
                        </div>

                        <!-- Prioridad -->
                        <div class="form-group">
                            <label>Prioridad:</label>

                            <select @bind="bt.IdPrioridad" disabled="@(!IsEditMode)">
                                @foreach (var p in prioridadesList)
                                {
                                    <option value="@p.Id">
                                        @($"{IconoPrioridad(p.Id)} {p.Titulo}")
                                    </option>
                                }
                            </select>

                        </div>

                        <!-- Recurrencia -->
                        <div class="form-group">
                            <label>Recurrencia:</label>
                            <select @bind="bt.Recurrence" disabled="@(!IsEditMode)">
                                @foreach (var f in frecuenciasList)
                                {
                                    <option value="@f.Nombre">@f.Nombre</option>
                                }
                            </select>

                        </div>

                        <!-- Fechas y horas -->
                        <div class="form-group inline">
                            <label>Fecha inicio</label>
                            @if (IsEditMode)
                            {
                                <DatePicker Value="bt.StartDate"
                                            ValueChanged="@(v => bt.StartDate = v ?? bt.StartDate)" />
                            }
                            else
                            {
                                <input type="text" class="read-only-field"
                                       value="@bt.StartDate.ToString("dd/MM/yyyy")" readonly />
                            }
                        </div>

                        @if (bt.EsEvento)
                        {
                            <div class="form-group inline">
                                <label>Hora inicio</label>
                                <input type="text" class="read-only-field"
                                       value="@bt.HoraInicio?.ToString("HH:mm")" readonly />
                            </div>
                        }

                        <div class="form-group inline">
                            <label>Fecha fin</label>
                            @if (IsEditMode)
                            {
                                <DatePicker Value="bt.DueDate"
                                            ValueChanged="@(v => bt.DueDate = v ?? bt.DueDate)" />
                            }
                            else
                            {
                                <input type="text" class="read-only-field"
                                       value="@bt.DueDate.ToString("dd/MM/yyyy")" readonly />
                            }
                        </div>

                        @if (bt.EsEvento)
                        {
                            <div class="form-group inline">
                                <label>Hora fin</label>
                                <input type="text" class="read-only-field"
                                       value="@bt.HoraFin?.ToString("HH:mm")" readonly />
                            </div>
                        }

                        <!-- Ubicación -->
                        @if (bt.EsEvento)
                        {
                            <div class="form-group">
                                <label>Ubicación:</label>
                                <select @bind="salaSeleccionada" disabled="@(!IsEditMode)">
                                    <option value="">-- Selecciona una ubicación --</option>

                                    @foreach (var s in salasList)
                                    {
                                        <option value="@s.Id">@s.Salas</option>
                                    }

                                    <option value="0">Otra ubicación...</option>
                                </select>
                                @if (EsOtraSala)
                                {
                                    <input type="text"
                                           placeholder="Escribe la ubicación"
                                           @bind="bt.Ubicacion"
                                           disabled="@(!IsEditMode)" />
                                }
                            </div>
                        }

                        <!-- Creador (solo eventos) -->
                        @if (bt.EsEvento)
                        {
                            <div class="form-group">
                                <label>👑 Creador del evento</label>
                                <input type="text" value="@bt.nombreCreador" readonly />
                            </div>
                        }

                        <!-- Participantes (solo eventos) -->
                        @if (bt.EsEvento && bt.Participantes.Any())
                        {
                            <div class="form-group">
                                <label>👥 Participantes</label>
                                <ul>
                                    @foreach (var p in bt.Participantes)
                                    {
                                        <li>@p</li>
                                    }
                                </ul>
                            </div>
                        }

                        <!-- Subtareas (solo tareas) -->
                        @if (!bt.EsEvento && bt.SubTasks.Any())
                        {
                            <div class="form-group">
                                <label>✔️ Subtareas</label>
                                <ul>
                                    @foreach (var st in bt.SubTasks)
                                    {
                                        <li>
                                            @st.Name @if(st.IsCompleted){
                                            <span>✔️</span>
                                        }
                                    </li>
                                }
                            </ul>
                        </div>
                    }

                </div>

                <div class="modal-footer">
                    @if (IsEditMode)
                    {
                        <button class="action-btn save" @onclick="async () => await SaveTask()">💾 Guardar</button>
                        <button class="action-btn cancel" @onclick="CancelEdit">❌ Cancelar</button>
                    }
                    else
                    {
                        <button class="action-btn save" @onclick="() => IsModalOpen = false">✔️ Cerrar</button>
                    }
                </div>
            </div>
        }

        else if (SelectedTaskObject is SelfAssessment sa)
        {
            <div class="form-group">
                <label>Actividad:</label>
                <p class="read-only-field">@sa.ActivityName</p>
            </div>
        }
    </div>

    <div class="modal-footer">
        @if (IsEditMode)
        {
            <button class="action-btn save"
                    @onclick="async () => await SaveTask()">
                💾 Guardar
            </button>

            <button class="action-btn cancel" @onclick="CancelEdit">❌ Cancelar</button>
        }
        else
        {
            <button class="action-btn save" @onclick="() => IsModalOpen = false">✔️ Cerrar</button>
        }
    </div>
</div>
}
@if (IsClientModalOpen && SelectedClientTask != null)
{
    <div class="modal-backdrop" @onclick="CloseClientModal"></div>

    <div class="modal-content" @onclick:stopPropagation>
        <div class="modal-header">
            <h2>Detalles del Cliente</h2>
            <button class="close-btn" @onclick="CloseClientModal">&times;</button>
        </div>

        <div class="modal-body">
            <div class="form-group">
                <label>Empresa</label>
                <p class="read-only-field">@SelectedClientTask.CompanyName</p>
            </div>

            <div class="form-group">
                <label>Actividad</label>
                <p class="read-only-field">@SelectedClientTask.ActivityDetail</p>
            </div>
        </div>

        <div class="modal-footer">
            <button class="action-btn save" @onclick="CloseClientModal">Cerrar</button>
        </div>
    </div>
}

<!-- Modal de Confirmación de Borrado -->
@if (ShowConfirmDelete)
{
    <div class="modal-backdrop" @onclick="() => ShowConfirmDelete = false"></div>
    <div class="confirm-modal" @onclick:stopPropagation>
        <h3>¿Eliminar tarea?</h3>
        <p>¿Estás seguro que quieres eliminar "<strong>@TaskToDelete?.Name</strong>"?</p>
        <div class="confirm-actions">
            <button class="action-btn save" @onclick="() => { ShowConfirmDelete = false; TaskToDelete = null; }">Cancelar</button>
            <button class="action-btn cancel" @onclick="() => DeleteConfirmedAsync()">Eliminar</button>
        </div>
    </div>
}
@if (IsOTModalOpen && OrdenTrabajoDetalle != null)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-content modern-modal" @onclick:stopPropagation="true">

            <!-- HEADER -->
            <div class="modal-header">
                <span class="modal-icon">📄</span>
                Orden de Trabajo
            </div>

            <!-- BODY -->
            <div class="modal-body modal-scroll">

                <!-- INFO -->
                <div class="ot-card">
                    <div class="collapsible-header">
                        Información general
                    </div>
                    <div class="collapsible-content">
                        <div class="info-grid">
                            <div><b>Número:</b> @OrdenTrabajoDetalle.strClave</div>
                            <div><b>Autor:</b> @OrdenTrabajoDetalle.nombreCompleto</div>
                            <div><b>Cliente:</b> @OrdenTrabajoDetalle.nombreCliente</div>
                            <div><b>Objetivo:</b> @OrdenTrabajoDetalle.strValor</div>
                            <div><b>Objetivo otro:</b> @OrdenTrabajoDetalle.strObjetivoOtro</div>
                            <div><b>Fecha solicitud:</b> @OrdenTrabajoDetalle.dteFechaSolicitud.ToShortDateString()</div>
                            <div><b>Fecha conclusión:</b> @OrdenTrabajoDetalle.fechaFinal.ToShortDateString()</div>
                        </div>
                    </div>
                </div>

                <!-- TAREAS -->
                <div class="ot-card">
                    <div class="collapsible-header">
                        Tareas
                    </div>
                    <div class="collapsible-content">

                        <table class="subtasks-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th>Avance</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in OrdenTrabajoDetalle.tareas)
                                {
                                    <tr>
                                        <td>@t.strNombreTarea</td>
                                        <td>@t.strDescripcionAutor</td>
                                        <td>@t.avance </td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                    </div>
                </div>

            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <button @onclick="CerrarModales">Cerrar</button>
            </div>

        </div>
    </div>
}

@if (IsTramiteModalOpen && OrdenTramiteDetalle != null)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-content modern-modal" @onclick:stopPropagation="true">

            <!-- HEADER -->
            <div class="modal-header">
                <span class="modal-icon">📄</span>
                Orden de Trámite
            </div>

            <!-- BODY -->
            <div class="modal-body modal-scroll">

                <!-- INFO -->
                <div class="tramite-card">
                    <div class="collapsible-header">
                        Información general
                    </div>
                    <div class="collapsible-content">
                        <div class="info-grid">
                            <div><b>Fecha solicitud:</b> @OrdenTramiteDetalle.fechaSolicitud</div>
                            <div><b>Cliente:</b> @OrdenTramiteDetalle.nombreGlobal</div>
                            <div><b>Solicitante:</b> @OrdenTramiteDetalle.solicitanteInterno</div>
                            <div><b>Fecha conclusión:</b> @OrdenTramiteDetalle.fechaConclusionTramite</div>
                            <div><b>Nombre global:</b> @OrdenTramiteDetalle.nombreGlobal</div>
                        </div>
                    </div>
                </div>

                <!-- TRÁMITES -->
                <div class="tramite-card">
                    <div class="collapsible-header">
                        Trámites individuales
                    </div>
                    <div class="collapsible-content">

                        <table class="subtasks-table">
                            <thead>
                                <tr>
                                    <th>Clave</th>
                                    <th>Trámite</th>
                                    <th>Encargado</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in OrdenTramiteDetalle.tramitesIndividuales)
                                {
                                    <tr>
                                        <td>@t.clave</td>
                                        <td>@t.tramiteIndividual</td>
                                        <td>@t.personalEncargado</td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                    </div>
                </div>

            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <button @onclick="CerrarModales">Cerrar</button>
            </div>

        </div>
    </div>
}

<!-- Toast -->
@if (ShowToast)
{
    <div class="toast">@ToastMessage</div>
}

@code {
    BaseTask? SelectedTask;
    BaseTask bt { get; set; } = new();

    List<SalasEm> salasList = new();
    List<FrecuenciaRecurrencia> frecuenciasList = new();
    List<Prioridad> prioridadesList = new();

    int? salaSeleccionada;
    bool EsOtraSala => salaSeleccionada == 0;

    bool IsOTModalOpen = false;
    bool IsTramiteModalOpen = false;
    // ---------- DÍAS NO LABORALES / ----------
    List<DiaNoLaboralDto> DiasNoLaboralesMes = new();
    async Task AbrirDetalle(BaseTask task)
    {
        SelectedTask = task;

        if (task.Tipo.Equals("WorkOrder", StringComparison.OrdinalIgnoreCase))
        {
            await CargarOrdenTrabajo(task.ApiId);
            IsOTModalOpen = true;
        }
        else if (task.Tipo.Equals("Tramite", StringComparison.OrdinalIgnoreCase))
        {
            await CargarOrdenTramite(task.ApiId);
            IsTramiteModalOpen = true;
        }

    }
    private async Task ToggleCompleteDynamic(BaseTask bt, ChangeEventArgs e)
    {
        bool nuevoEstado = false;

        if (e?.Value is bool b) nuevoEstado = b;
        else if (e?.Value is string s) nuevoEstado = s == "true" || s == "on";

        // Optimistic UI
        bt.IsCompleted = nuevoEstado;

        bool exito = false;

        try
        {
            if (bt.Tipo.Equals("Evento", StringComparison.OrdinalIgnoreCase))
            {
                exito = await AgendaService.CambiarEstadoEventoAsync(bt.ApiId, nuevoEstado);
            }
            else
            {
                exito = await AgendaService.CambiarEstadoTareaAsync(bt.ApiId, nuevoEstado);
            }

            if (!exito)
            {
                bt.IsCompleted = !nuevoEstado; // rollback
                await ShowTemporaryToastAsync("Error al actualizar el estado");
            }
            else
            {
                await ShowTemporaryToastAsync(bt.IsCompleted
                    ? $"Marcaste '{bt.Name}' como completada"
                    : $"Desmarcaste '{bt.Name}'");
            }
        }
        catch
        {
            bt.IsCompleted = !nuevoEstado; // rollback
            await ShowTemporaryToastAsync("Error al actualizar el estado");
        }

        StateHasChanged();
    }

    OrdenTrabajoDTO? OrdenTrabajoDetalle;
    async Task CargarOrdenTrabajo(int id)
    {
        OrdenTrabajoDetalle = await OrdenService.GetDetalle(id);
    }
    OrdenTramiteDTO? OrdenTramiteDetalle;
    async Task CargarOrdenTramite(int id)
    {
        OrdenTramiteDetalle = await OrdenTramiteService.GetDetalle(id);
    }
    void CerrarModales()
    {
        IsOTModalOpen = false;
        IsTramiteModalOpen = false;
        SelectedTask = null;
    }
    public List<TramiteIndividualDTO> tramitesIndividuales { get; set; }

    public List<OrdenTramiteDTO> detalleTramites { get; set; }
    public List<OrdenTramiteDTO> ordenesTramiteDetalle { get; set; }
    public string tramiteIndividual { get; set; }
    public string personalEncargado { get; set; }
    public string strNombre { get; set; }
    public string strDescripcion { get; set; }
    public int intAvance { get; set; }


    // ---------- Tipos internos para la vista ----------
    enum BlockType
    {
        AdminTask,
        WorkOrder,
        Tramite,
        GeneralTask,
        SelfAssessment
    }

    class DayColumn
    {
        public DateTime Date { get; set; }
        public List<Block> Blocks { get; set; } = new();
    }

    class Block
    {
        public string Title { get; set; } = "";
        public List<object> SubTasks { get; set; } = new();
        public string Color { get; set; } = "#fff";
        public bool IsExpanded { get; set; } = false;
    }

    class BaseTask
    {
        public Guid Id { get; set; } = Guid.NewGuid();

        // Identidad
        public int ApiId { get; set; }
        public int IdAgenda { get; set; }
        public int IdPrioridad { get; set; }

        // Tipo
        public string Tipo { get; set; } = "Tarea";

        // Contenido base
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";

        // Prioridad / recurrencia (ya existentes)
        public string Recurrence { get; set; } = "No repetir";

        // Estado
        public bool IsCompleted { get; set; }

        // Fechas (ya existentes)
        public DateTime StartDate { get; set; }
        public DateTime DueDate { get; set; }

        // Recurrencia real
        public bool EsRecurrente { get; set; }
        public string? ReglaRecurrencia { get; set; }

        // Evento
        public string? Ubicacion { get; set; }
        public int? IdSala { get; set; }
        public TimeOnly? HoraInicio { get; set; }
        public TimeOnly? HoraFin { get; set; }

        public int CreadorId { get; set; }
        public string? nombreCreador { get; set; }
        public List<string> Participantes { get; set; } = new();

        // Tarea
        public List<BaseSubTask> SubTasks { get; set; } = new();

        // UI
        public Block? ParentBlock { get; set; }

        public bool EsEvento =>
            Tipo.Equals("Evento", StringComparison.OrdinalIgnoreCase);

        public string IconoVisual =>
            EsEvento ? "📅" : "📝";
    }

    class BaseSubTask
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public bool IsCompleted { get; set; } = false;
    }

    int MapPriority(string prioridad)
    {
        return prioridad switch
        {
            "Alta" => 1,
            "Media" => 2,
            "Baja" => 3,
            _ => 2
        };
    }

    string MapPriorityBack(int id)
    {
        return id switch
        {
            1 => "Alta",
            2 => "Media",
            3 => "Baja",
            _ => "Media"
        };
    }

    public class EditarSubTareaDTO
    {
        public int Id { get; set; }
        public string Titulo { get; set; } = string.Empty;
    }


    class SelfAssessment
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public int IdRegistro { get; set; }
        public string ActivityName { get; set; } = "";
        public bool IsCompleted { get; set; } = false;

        public DateTime TaskDate { get; set; }   // 🔥 FECHA DE LA TAREA

        public Block ParentBlock { get; set; }
    }


    bool IsToday(SelfAssessment sa)
    {
        return sa.TaskDate.Date == DateTime.Today;
    }

    class ClientServiceTask
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public string CompanyName { get; set; } = "";
        public string ActivityDetail { get; set; } = "";
        public bool IsCompleted { get; set; } = false;
        public Block ParentBlock { get; set; }
    }

    // ---------- Estado del componente ----------
    List<DayColumn> Days = new();
    DateTime CurrentDate = DateTime.Today;

    object SelectedTaskObject { get; set; }
    bool IsModalOpen { get; set; } = false;
    bool IsEditMode { get; set; } = false;

    // Confirm delete
    bool ShowConfirmDelete { get; set; } = false;
    BaseTask TaskToDelete { get; set; }

    // Toast
    bool ShowToast { get; set; } = false;
    string ToastMessage { get; set; } = "";

    int WeekNumber => CultureInfo.CurrentCulture.Calendar.GetWeekOfYear(CurrentDate, CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
    string MonthName => CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.GetMonthName(CurrentDate.Month);

    bool catalogosCargados;

    protected override async Task OnInitializedAsync()
    {
        await LoadWeek(CurrentDate);

        if (catalogosCargados) return;

        salasList = await SalasEmService.GetSalas();
        frecuenciasList = await ReglasRecurrenciaServices.GetFrecuencia();
        prioridadesList = await ReglasRecurrenciaServices.GetPrioridad();

        catalogosCargados = true;
    }

    protected override void OnParametersSet()
    {
        if (bt.IdSala.HasValue && bt.IdSala > 0)
        {
            // Sala
            salaSeleccionada = bt.IdSala.Value;
        }
        else if (!string.IsNullOrWhiteSpace(bt.Ubicacion))
        {
            // Ubicacion
            salaSeleccionada = 0;
        }
        else
        {
            salaSeleccionada = null;
        }
    }


    async Task PrevWeek()
    {
        CurrentDate = CurrentDate.AddDays(-7);
        await LoadWeek(CurrentDate);
    }

    async Task NextWeek()
    {
        CurrentDate = CurrentDate.AddDays(7);
        await LoadWeek(CurrentDate);
    }
    async Task CargarDiasNoLaborales(DateTime referencia)
    {
        DiasNoLaboralesMes.Clear();

        var monday = StartOfWeek(referencia, DayOfWeek.Monday);
        var sunday = monday.AddDays(6);

        var meses = Enumerable
            .Range(0, 7)
            .Select(i => monday.AddDays(i))
            .Select(d => new { d.Year, d.Month })
            .Distinct();

        foreach (var m in meses)
        {
            var dias = await CalendarioService
                .ObtenerDiasNoLaborales(m.Year, m.Month);

            DiasNoLaboralesMes.AddRange(dias);
        }
    }

    bool EsDiaNoLaboral(DateTime fecha)
    {
        return DiasNoLaboralesMes.Any(d =>
            d.DiaInhabil.Date == fecha.Date
        );
    }

    string ObtenerDescripcionNoLaboral(DateTime fecha)
    {
        return DiasNoLaboralesMes
            .FirstOrDefault(d => d.DiaInhabil.Date == fecha.Date)?
            .Descripcion
            ?? "Día no laboral";
    }

    string IconoPrioridad(int idPrioridad) => idPrioridad switch
    {
        1 => "🔴", // Alta
        2 => "🟡", // Media
        3 => "🟢", // Baja
        _ => "⚪"
    };


    // ---------- Carga principal ----------
    async Task LoadWeek(DateTime reference)
    {
        await CargarDiasNoLaborales(reference);
        Days.Clear();
        var monday = StartOfWeek(reference, DayOfWeek.Monday);

        // Crear días y bloques (autoeval y servicio al cliente estáticos)
        for (int i = 0; i < 7; i++)
        {
            var date = monday.AddDays(i).Date;
            var day = new DayColumn { Date = date };

            // Bloque 1 - Tareas / Eventos (dinámico)
            day.Blocks.Add(new Block { Title = "Tareas", Color = "#FFD1DC", IsExpanded = true });

            // Bloque 2 - Órdenes de Trabajo (dinámico)
            day.Blocks.Add(new Block { Title = "Órdenes de Trabajo", Color = "#FFDAC1", IsExpanded = false });

            // Bloque 3 - Autoevaluación (ESTÁTICO)
            day.Blocks.Add(new Block { Title = "Autoevaluación", Color = "#E2F0CB", IsExpanded = false });

            // Bloque 4 - Servicio al Cliente (ESTÁTICO)
            var clienteBlock = new Block { Title = "Servicio al Cliente", Color = "#D7D1DD", IsExpanded = false };
            clienteBlock.SubTasks.Add(new ClientServiceTask { CompanyName = "Cliente ejemplo A", ActivityDetail = "Seguimiento semanal", ParentBlock = clienteBlock });
            clienteBlock.SubTasks.Add(new ClientServiceTask { CompanyName = "Cliente ejemplo B", ActivityDetail = "Revisión de pendientes", ParentBlock = clienteBlock });
            day.Blocks.Add(clienteBlock);

            Days.Add(day);
        }

        // Rango de la semana (por fechaFin)
        var startOfWeek = monday.Date;
        var endOfWeek = monday.AddDays(6).Date;

        // Obtener id de agenda (usa tu servicio)
        var agendas = await AgendaService.ObtenerAgendaAsignadasAsync();
        var idAgenda = agendas.FirstOrDefault();

        salasList = await SalasEmService.GetSalas();
        Debug.WriteLine($"Salas cargadas (post fetch): {salasList.Count}");


        // 1) Obtener tareas (api) y eventos (api)
        List<TareaCreada> agendaItems = new();

        if (idAgenda > 0)
        {
            var tareasApi = await AgendaService.ObtenerTareasApi(idAgenda);

            foreach (var t in tareasApi)
            {
                agendaItems.Add(new TareaCreada
                {
                    Tipo = "Tarea",
                    IsEvento = false,

                    Titulo = t.titulo,
                    Descripcion = t.descripcion,

                    FechaInicio = t.fechaInicio.Date,
                    FechaFin = t.fechaFin.Date,

                    HoraInicio = TimeOnly.FromDateTime(t.fechaInicio),
                    HoraFin = TimeOnly.FromDateTime(t.fechaFin),

                    Prioridad = t.idPrioridad,
                    IdAgenda = t.idAgenda,

                    EsRecurrente = t.esRecurrente,
                    ReglaRecurrencia = t.reglaRecurrencia,

                    Subtareas = t.subTareas?
                    .Select(st => st.titulo)
                    .ToList()
                    ?? new List<string>()
                });
            }

            var eventosApi = await AgendaService.ObtenerEventosPorEmpleado();

            foreach (var e in eventosApi)
            {
                agendaItems.Add(new TareaCreada
                {
                    Tipo = "Evento",
                    IsEvento = true,

                    Titulo = e.titulo,
                    Descripcion = e.descripcion,

                    FechaInicio = e.fechaInicio.Date,
                    FechaFin = e.fechaFin.Date,

                    HoraInicio = TimeOnly.FromDateTime(e.fechaInicio),
                    HoraFin = TimeOnly.FromDateTime(e.fechaFin),

                    Ubicacion = e.ubicacion,

                    Prioridad = e.idPrioridad,
                    EsRecurrente = e.esRecurrente,
                    ReglaRecurrencia = e.reglaRecurrencia,

                    IdAgenda = e.idAgenda,
                    IdSala = e.idSala,

                    IdCreador = e.creadorId,
                    NombreCreador = e.nombreCreador,

                    ParticipantesLista = e.participantes
                    .Select(p => new EmpleadoDTO
                    {
                        Id = p.idEmpleado,
                        Nombre = p.nombreEmpleado
                    })
                        .ToList()
                });
            }

            foreach (var item in agendaItems)
            {
                if (item.FechaFin == null) continue;
                if (item.FechaFin.Value.Date < startOfWeek || item.FechaFin.Value.Date > endOfWeek) continue;

                var day = Days.FirstOrDefault(d => d.Date.Date == item.FechaFin.Value.Date);
                if (day == null) continue;

                string ubicacionFinal;
                if (item.IdSala > 0)
                {
                    var sala = salasList.FirstOrDefault(s => s.Id == item.IdSala);
                    ubicacionFinal = sala?.Salas ?? item.Ubicacion;
                }
                else
                {
                    ubicacionFinal = item.Ubicacion;
                }

                var mapped = new BaseTask
                {
                    ApiId = item.IdAgenda,
                    Name = item.Titulo,
                    Description = item.Descripcion,

                    StartDate = item.FechaInicio ?? item.FechaFin ?? DateTime.Today,
                    DueDate = item.FechaFin ?? item.FechaInicio ?? DateTime.Today,

                    IsCompleted = false,
                    Tipo = item.Tipo,
                    ParentBlock = day.Blocks[0],

                    // Prioridad
                    IdPrioridad = item.Prioridad,

                    // Recurrencia
                    Recurrence = item.EsRecurrente
                        ? item.ReglaRecurrencia
                        : "No repetir",

                    // Evento
                    Ubicacion = ubicacionFinal,
                    IdSala = item.IdSala,
                    HoraInicio = item.HoraInicio,
                    HoraFin = item.HoraFin,

                    // Auditoría
                    CreadorId = item.IdCreador,
                    nombreCreador = item.NombreCreador ?? "",

                    // Subtareas (solo texto)
                    SubTasks = item.Subtareas
                    .Select(st => new BaseSubTask { Name = st })
                    .ToList() ?? new(),

                    // Participantes
                    Participantes = item.ParticipantesLista
                    .Select(p => p.Nombre)
                    .ToList() ?? new()
                };

                day.Blocks[0].SubTasks.Add(mapped);
            }
        }



        // Mapear y filtrar por fechaFin (acepta propiedades fechaFin o fechaFinal o fechaFinal en ordenes)

        // 2) Obtener órdenes de trabajo y mapear
        List<OrdenTrabajoDTO> ordenes = new();
        try
        {
            var ordProx = await OrdenService.GetOrdenesProximas();
            if (ordProx != null) ordenes.AddRange(ordProx);
            var ordHoy = await OrdenService.GetOrdenesHoy();
            if (ordHoy != null) ordenes.AddRange(ordHoy);
            var ordVenc = await OrdenService.GetOrdenesVencidas();
            if (ordVenc != null) ordenes.AddRange(ordVenc);
        }
        catch { /* ignore */ }

        foreach (var o in ordenes)
        {
            DateTime fecha = o.fechaFinal.Date;
            if (fecha < startOfWeek || fecha > endOfWeek) continue;
            var day = Days.FirstOrDefault(d => d.Date.Date == fecha);
            if (day == null) continue;

            var wt = new BaseTask
            {
                ApiId = o.id,
                Name = $"{o.strClave}",
                Description = o.strObjetivoOtro ?? o.strValor,
                StartDate = o.dteFechaSolicitud,
                DueDate = o.fechaFinal,
                IsCompleted = string.Equals(o.estado, "Completado", StringComparison.OrdinalIgnoreCase),
                Tipo = "WorkOrder",
                ParentBlock = day.Blocks[1]
            };

            day.Blocks[1].SubTasks.Add(wt);
        }
        // 2.1) Obtener ÓRDENES DE TRÁMITE y mapear al MISMO bloque
        List<OrdenTramiteDTO> tramites = new();

        try
        {
            var tVenc = await OrdenTramiteService.GetVencidas();
            if (tVenc != null) tramites.AddRange(tVenc);

            var tHoy = await OrdenTramiteService.GetHoy();
            if (tHoy != null) tramites.AddRange(tHoy);

            var tProx = await OrdenTramiteService.GetProximas();
            if (tProx != null) tramites.AddRange(tProx);
        }
        catch { /* ignore */ }

        foreach (var t in tramites)
        {
            // 🔥 fecha CLAVE: conclusión del trámite
            if (!DateTime.TryParse(t.fechaConclusionTramite, out var fecha))
                continue;

            fecha = fecha.Date;
            if (fecha < startOfWeek || fecha > endOfWeek) continue;

            var day = Days.FirstOrDefault(d => d.Date.Date == fecha);
            if (day == null) continue;

            var bt = new BaseTask
            {
                ApiId = t.idOrden,
                Name = $"{t.numeroOrden}",
                Description = t.solicitanteInterno,
                StartDate = DateTime.TryParse(t.fechaSolicitud, out var fs)
                    ? fs
                    : fecha,
                DueDate = fecha,
                IsCompleted = false,
                Tipo = "Tramite",

                ParentBlock = day.Blocks[1]
            };

            day.Blocks[1].SubTasks.Add(bt);
        }


        // 3) Obtener autoevaluacion y mapear
        List<AutoevaluacionDTO> autoevaluaciones = new();

        try
        {
            autoevaluaciones = await AutoevaluacionService.ObtenerAutoevaluacion();
        }
        catch { }


        foreach (var bloque in autoevaluaciones)
        {
            foreach (var tarea in bloque.Tareas)
            {
                foreach (var registro in tarea.Registros)
                {
                    // 🔥 DateOnly → DateTime (CRÍTICO)
                    var fecha = registro.Fecha.ToDateTime(TimeOnly.MinValue).Date;

                    if (fecha < startOfWeek || fecha > endOfWeek)
                        continue;

                    var day = Days.FirstOrDefault(d => d.Date.Date == fecha);
                    if (day == null)
                        continue;

                    var autoBlock = day.Blocks.First(b => b.Title == "Autoevaluación");

                    autoBlock.SubTasks.Add(new SelfAssessment
                    {
                        IdRegistro = registro.IdRegistro,   // ⬅️ AQUI
                        ActivityName = tarea.Tarea,
                        IsCompleted = registro.Realizado,
                        TaskDate = fecha,
                        ParentBlock = autoBlock
                    });

                }
            }
        }




        StateHasChanged();
    }

    // ---------- Helpers para leer propiedades de objetos retornados por el servicio ----------
    DateTime? TryGetDateTime(object obj, string propName)
    {
        try
        {
            var t = obj.GetType();
            var p = t.GetProperty(propName);
            if (p == null) return null;
            var val = p.GetValue(obj);
            if (val == null) return null;

            if (val is DateTime dt) return dt;
            if (val is string s)
            {
                if (DateTime.TryParse(s, out var parsed)) return parsed;
                // intentar formatos comunes
                if (DateTime.TryParseExact(s, "yyyy-MM-ddTHH:mm:ss", CultureInfo.InvariantCulture, DateTimeStyles.None, out parsed)) return parsed;
                if (DateTime.TryParseExact(s, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out parsed)) return parsed;
            }
        }
        catch { }
        return null;
    }

    string TryGetString(object obj, string propName)
    {
        try
        {
            var p = obj.GetType().GetProperty(propName);
            if (p == null) return null;
            var v = p.GetValue(obj);
            return v?.ToString();
        }
        catch { return null; }
    }

    int? TryGetInt(object obj, string propName)
    {
        try
        {
            var p = obj.GetType().GetProperty(propName);
            if (p == null) return null;
            var v = p.GetValue(obj);
            if (v == null) return null;
            if (v is int i) return i;
            if (int.TryParse(v.ToString(), out var parsed)) return parsed;
        }
        catch { }
        return null;
    }

    bool? TryGetBool(object obj, string propName)
    {
        try
        {
            var p = obj.GetType().GetProperty(propName);
            if (p == null) return null;
            var v = p.GetValue(obj);
            if (v == null) return null;
            if (v is bool b) return b;
            if (bool.TryParse(v.ToString(), out var parsed)) return parsed;
        }
        catch { }
        return null;
    }

    DateTime StartOfWeek(DateTime dt, DayOfWeek startOfWeek)
    {
        int diff = (7 + (dt.DayOfWeek - startOfWeek)) % 7;
        return dt.AddDays(-1 * diff).Date;
    }

    // ---------- UI helpers y acciones ----------
    void ToggleBlock(Block block) => block.IsExpanded = !block.IsExpanded;

    int PendingCount(Block block)
    {
        int count = 0;
        foreach (var t in block.SubTasks)
        {
            switch (t)
            {
                case BaseTask bt:
                    if (!bt.IsCompleted) count++;
                    break;
                case SelfAssessment sa:
                    if (!sa.IsCompleted) count++;
                    break;
                case ClientServiceTask cs:
                    if (!cs.IsCompleted) count++;
                    break;
            }
        }
        return count;
    }

    async Task ToggleComplete(BaseTask bt, ChangeEventArgs e)
    {
        if (e?.Value is bool b) bt.IsCompleted = b;
        else
        {
            bool parsed = false;
            if (e?.Value is string s) parsed = s == "true" || s == "on";
            bt.IsCompleted = parsed;
        }

        await ShowTemporaryToastAsync(bt.IsCompleted ? $"Marcaste '{bt.Name}' como completada" : $"Desmarcaste '{bt.Name}'");
        // TODO: Llamar a AgendaService para persistir cambio si lo deseas
    }

    async Task ToggleCompleteSelf(SelfAssessment sa, ChangeEventArgs e)
    {
        bool nuevoValor;

        if (e?.Value is bool b)
            nuevoValor = b;
        else if (e?.Value is string s)
            nuevoValor = s == "true" || s == "on";
        else
            return;

        // Optimistic UI
        sa.IsCompleted = nuevoValor;

        try
        {
            await AutoevaluacionService.MarcarRegistroRealizadoAsync(
                sa.IdRegistro,
                nuevoValor
            );

            await ShowTemporaryToastAsync(
                nuevoValor
                    ? "Autoevaluación marcada como realizada"
                    : "Autoevaluación desmarcada"
            );
        }
        catch
        {
            // 🔥 rollback si falla
            sa.IsCompleted = !nuevoValor;

            await ShowTemporaryToastAsync(
                "Error al guardar la autoevaluación"
            );
        }
    }


    async Task ToggleCompleteClient(ClientServiceTask cs, ChangeEventArgs e)
    {
        if (e?.Value is bool b) cs.IsCompleted = b;
        else
        {
            bool parsed = false;
            if (e?.Value is string s) parsed = s == "true" || s == "on";
            cs.IsCompleted = parsed;
        }
        await ShowTemporaryToastAsync(cs.IsCompleted ? "Actividad completada" : "Actividad desmarcada");
    }

    void OpenTaskModal(BaseTask task, bool editMode)
    {

        Console.WriteLine($"ANTES MODAL: {task.IdPrioridad}");
        SelectedTaskObject = null;
        IsModalOpen = false;

        SelectedTaskObject = task;
        //Console.WriteLine($"EN MODAL (POST ASSIGN): {SelectedTaskObject.IdPrioridad}");
        IsEditMode = editMode;
        IsModalOpen = true;
    }


    void OpenSelfAssessmentModal(SelfAssessment sa)
    {
        SelectedTaskObject = null;
        IsModalOpen = false;

        SelectedTaskObject = sa;
        IsEditMode = false;
        IsModalOpen = true;
    }


    void CloseTaskModal()
    {
        SelectedTaskObject = null;
        IsModalOpen = false;
        IsEditMode = false;
    }

    void OpenClientModal(ClientServiceTask cs)
    {
        SelectedClientTask = cs;
        IsClientModalOpen = true;
    }

    void CloseClientModal()
    {
        SelectedClientTask = null;
        IsClientModalOpen = false;
    }
    private ClientServiceTask? SelectedClientTask { get; set; }
    private bool IsClientModalOpen { get; set; } = false;



    string GetModalTitle()
    {
        if (SelectedTaskObject is BaseTask bt)
            return bt.Tipo switch
            {
                "Tarea" => "Tarea",
                _ => "Detalles de la tarea"
            };
        else if (SelectedTaskObject is SelfAssessment)
            return "Registro de Autoevaluación";

        return "Detalles";
    }

    void ConfirmDelete(BaseTask bt)
    {
        TaskToDelete = bt;
        ShowConfirmDelete = true;
    }

    async Task DeleteConfirmedAsync()
    {
        if (TaskToDelete is not BaseTask bt || bt.ApiId <= 0)
            return;

        await AgendaService.EliminarTareaAsync(bt.ApiId);

        bt.ParentBlock?.SubTasks.Remove(bt);

        await ShowTemporaryToastAsync("🗑️ Tarea eliminada");

        TaskToDelete = null;
        ShowConfirmDelete = false;
    }


    async Task SaveTask()
    {
        if (SelectedTaskObject is not BaseTask bt)
            return;

        // Validación básica
        if (bt.DueDate < bt.StartDate)
        {
            await ShowTemporaryToastAsync(
                "❌ La fecha fin no puede ser menor a la fecha inicio"
            );
            return;
        }

        // var model = new EditAgendaItemModel
        // {
        //     IdAgenda = bt.IdAgenda,
        //     Titulo = bt.Name,
        //     Descripcion = bt.Description,
        //     FechaInicio = bt.StartDate,
        //     FechaFin = bt.DueDate,
        //     EsRecurrente = bt.Recurrence != "No repetir",
        //     ReglaRecurrencia = bt.Recurrence == "No repetir"
        //         ? null
        //         : bt.Recurrence,

        //     Prioridad = bt.IdPrioridad,

        //     Subtareas = bt.SubTasks
        //     .Select(s => s.ToString()!)
        //     .ToList()

        // };

        Console.WriteLine($"🧪 ApiId enviado: {bt.ApiId}");
        //await AgendaService.EditarTareaAsync(bt.ApiId, model);

        IsEditMode = false;
        IsModalOpen = false;

        await ShowSuccessAlert(
            $"✅ La tarea '{bt.Name}' se guardó correctamente"
        );
    }

    void CancelEdit()
    {
        IsEditMode = false;
    }

    async Task ShowSuccessAlert(string message)
    {
        await JSRuntime.InvokeVoidAsync("Swal.fire", new
        {
            icon = "success",
            title = message,
            showConfirmButton = true,
            confirmButtonColor = "#0B3C4A",
            timer = 2000
        });
    }

    async Task ShowTemporaryToastAsync(string message, int milliseconds = 1600)
    {
        ToastMessage = message;
        ShowToast = true;
        StateHasChanged();
        await Task.Delay(milliseconds);
        ShowToast = false;
        StateHasChanged();
    }
}
<style>
    /*ESTILOS DE LOS DIAS NO LABORALES*/
    /* ===============================
           DÍA NO LABORAL – ESTILO SUAVE
           =============================== */

    .day-card.dia-no-laboral {
        background: linear-gradient( 180deg, #fdf2f2 0%, #fae8e8 100% );
        border: 1.5px dashed #FF4D4D;
        border-radius: 16px;
        color: #FFECEC;
        pointer-events: none;
        transition: all 0.3s ease;
    }

        /* Header */
        .day-card.dia-no-laboral .day-header {
            background: transparent;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* Nombre del día */
        .day-card.dia-no-laboral .day-name {
            font-weight: 600;
            text-transform: capitalize;
            color: #7a2c2c;
        }

        /* Número del día */
        .day-card.dia-no-laboral .day-date {
            background: #ffffff;
            color: #e25555;
            font-weight: 600;
            border-radius: 12px;
            padding: 6px 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        /* Ocultar tareas */
        .day-card.dia-no-laboral .blocks-list {
            display: none !important;
        }

    /* Contenido central */
    .no-laboral-info {
        margin-top: 28px;
        text-align: center;
        padding: 18px 14px;
        background: rgba(255,255,255,0.65);
        border-radius: 14px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
    }

        /* Icono */
        .no-laboral-info::before {
            content: "🚫📅";
            display: block;
            font-size: 1.6rem;
            margin-bottom: 6px;
        }

    /* Texto principal */
    .no-laboral-info {
        font-size: 0.95rem;
        font-weight: 500;
        color: #7a2c2c;
    }

        /* Descripción */
        .no-laboral-info small {
            display: block;
            margin-top: 6px;
            font-size: 0.85rem;
            color: #8f4a4a;
            opacity: 0.9;
        }

    /* Sin hover agresivo */
    .day-card.dia-no-laboral:hover {
        box-shadow: none;
        transform: none;
        cursor: default;
    }


    .day-card.sabado {
        background: #f5f5f5;
        opacity: 0.8;
    }


    /* Contenedor principal */
    .agenda-container {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: #fff;
        padding: 18px;
        border-radius: 12px;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        overflow: hidden;
    }

    .badge-pendientes {
        background-color: rgba(255, 255, 255, 0.5);
        color: #333;
        font-weight: 700;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        /* Corregido */
        display: flex;
        justify-content: center;
        align-items: center;
        min-width: 28px; /* Tamaño perfecto */
        height: 22px; /* Mantiene forma uniforme */
    }

    /* Header */
    .agenda-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .header-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1 1 auto;
    }

        .header-center h1 {
            margin: 0;
            font-size: 30px;
            font-weight: 700;
        }

    .month-pill {
        margin-top: 6px;
        background: linear-gradient(90deg,#f7f7f7,#fff);
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 600;
        color: #0b3c4a;
        box-shadow: 0 2px 6px rgba(11,60,74,0.06);
    }

    /* Botones */
    .btn {
        background: linear-gradient(90deg,#1e7a3a,#0b3c4a);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
    }

        .btn.primary {
            background: linear-gradient(90deg,#1e7a3a,#0b3c4a);
        }

        .btn:hover {
            background: linear-gradient(90deg, #155d2b, #062b35); /* tonos más oscuros */
            color: white; /* asegura que el texto siga siendo blanco */
            transform: translateY(-1px);
        }

    .arrow {
        font-weight: 700;
    }

    /* Grid de días */
    .days-grid.weekly {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 12px;
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 6px;
    }

    /* Tarjetas de día */
    .day-card {
        background: #f9fafb;
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 100%;
        overflow-y: auto;
    }

    /* Header del día */
    .day-header {
        display: flex;
        justify-content: space-between;
        font-weight: 700;
        text-transform: capitalize;
    }

    /* Lista de bloques */
    .blocks-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* Bloques individuales */
    .list-item {
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        transition: transform .12s ease;
    }

        .list-item:hover {
            transform: translateY(-3px);
        }

    .list-title {
        font-weight: 700;
        margin-bottom: 8px;
        user-select: none;
        cursor: pointer;
        display: grid;
        grid-template-columns: 1fr auto auto; /* Título | Badge | Flecha */
        align-items: center; /* Alinea TODO verticalmente al centro */
        gap: 8px;
    }


    .chev {
        font-size: 12px;
        opacity: 0.8;
        margin-left: 10px;
    }

    /* Subtareas */
    .subtasks {
        list-style: none;
        padding-left: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 300px;
        overflow-y: auto;
    }

    /* Ítems de tarea */
    .task-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 6px 4px;
        border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        flex: 0 0 18px;
        margin-right: 8px;
        cursor: pointer;
    }

    /* Nombre de la tarea */
    .task-name {
        flex-grow: 1;
        cursor: pointer;
        user-select: none;
        padding-right: 8px;
        transition: all 0.2s ease;
    }

    /* Línea superior para tareas completadas */
    .task-item.completed-task .task-name {
        border-top: 3px solid #0B3C4A; /* Línea encima más visible */
        padding-top: 4px; /* Espacio entre línea y texto */
        opacity: 0.85;
    }
    /* === Igual funcionalidad que subtareas === */
    .task-name.completed {
        text-decoration: line-through; /* misma línea encima */
        opacity: 0.6; /* más tenue */
        transition: all 0.2s ease;
    }

    /* Acciones de la tarea (botones) */
    .task-actions {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    /* Opcional: efecto al pasar el mouse por encima */
    .task-item:hover .task-name {
        color: #0B3C4A;
        font-weight: 600;
    }

    /* Botones de editar y eliminar */
    .edit-btn, .delete-btn {
        font-size: 14px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px;
        border-radius: 8px;
    }

        .edit-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .delete-btn:hover {
            background: rgba(255,0,0,0.06);
        }

    .workorder {
        font-weight: 700;
    }

    /* Modal */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(11,60,74,0.65);
        z-index: 1000;
    }

    .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        background: #FEFEFE;
        padding: 18px;
        border-radius: 12px;
        z-index: 1001;
        width: 90%;
        max-width: 640px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 12px 35px rgba(0,0,0,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .close-btn {
        font-size: 24px;
        background: none;
        border: none;
        cursor: pointer;
        color: #0B3C4A;
    }

    .form-group {
        margin-bottom: 10px;
    }

        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #eee;
            box-sizing: border-box;
        }

    input:disabled, textarea:disabled, select:disabled {
        background: #f5f5f5;
        color: #444;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding-top: 8px;
        border-top: 1px solid #f0f0f0;
    }

    .action-btn {
        padding: 8px 12px;
        font-weight: 700;
        color: white;
        border: none;
        border-radius: 999px;
        cursor: pointer;
    }

        .action-btn.save {
            background: #0B3C4A;
        }

        .action-btn.cancel {
            background: #ef4444;
        }

    /* Confirm modal */
    .confirm-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        z-index: 1002;
        background: white;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.18);
        width: 90%;
        max-width: 420px;
    }

    .confirm-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 12px;
    }

    /* Toast */
    .toast {
        position: fixed;
        right: 18px;
        bottom: 18px;
        background: linear-gradient(90deg,#0B3C4A,#1e7a3a);
        color: white;
        padding: 10px 14px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        z-index: 2000;
        font-weight: 700;
    }



    .btn {
        min-width: auto;
        padding: 8px 10px;
    }

    .task-icon {
        margin-right: 6px;
        font-size: 16px;
    }
    /* ================= MODAL OVERLAY ================= */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    /* ================= MODAL BASE ================= */
    .modal-content.modern-modal {
        background: #ffffff;
        border-radius: 22px;
        width: 95%;
        max-width: 1100px;
        height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 60px rgba(0,0,0,0.35);
        animation: modalFade 0.25s ease-out;
        overflow: hidden;
    }

    /* ================= HEADER ================= */
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 14px;
        padding: 22px;
        background: linear-gradient(90deg, #1e7a3a, #0b3c4a);
        color: #ffffff;
        font-size: 20px;
        font-weight: 700;
    }

    .modal-icon {
        font-size: 26px;
    }

    /* ================= BODY ================= */
    .modal-body.modal-scroll {
        flex: 1;
        padding: 24px 28px;
        overflow-y: auto;
        background: #f8fafc;
    }

    /* Scroll elegante */
    .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    /* ================= FOOTER ================= */
    .modal-footer {
        padding: 16px;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: center;
    }

        .modal-footer button {
            background: #0b3c4a;
            color: #ffffff;
            border: none;
            border-radius: 10px;
            padding: 10px 28px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

            .modal-footer button:hover {
                background: #145a6a;
            }

    /* ================= CARDS ================= */
    .ot-card,
    .tramite-card {
        background: #ffffff;
        border-radius: 14px;
        border: 1px solid #e5e7eb;
        margin-bottom: 18px;
        overflow: hidden;
    }

    /* ================= COLLAPSIBLE HEADER ================= */
    .collapsible-header {
        background: #f1f5f9;
        padding: 14px 18px;
        font-weight: 600;
        cursor: default;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .collapsible-header:hover {
            background: #e2e8f0;
        }

    /* ================= COLLAPSIBLE CONTENT ================= */
    .collapsible-content {
        padding: 18px;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
    }

    /* ================= INFO GRID ================= */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 14px 22px;
        font-size: 14px;
    }

        .info-grid div {
            background: #f9fafb;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

    /* ================= TABLES ================= */
    .subtasks-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 14px;
    }

        .subtasks-table th {
            background: #f3f4f6;
            padding: 12px;
            font-weight: 600;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .subtasks-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .subtasks-table tr:nth-child(even) {
            background: #fafafa;
        }

    /* ================= ANIMATION ================= */
    @@keyframes modalFade {
        from {
            opacity: 0;
            transform: scale(0.96);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>