@page "/semanal"
@using System.Globalization
@using System.Diagnostics
@using Newtonsoft.Json
@using pruebas1.Entidades
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@inject AgendaService AgendaService
@inject OrdenTrabajoService OrdenService
@inject IJSRuntime JSRuntime
@inject AutoevaluacionService AutoevaluacionService
@using System.Net.Http.Json;
@inject OrdenTramiteService OrdenTramiteService
@inject CalendarioService CalendarioService
@inject SalasEmService SalasEmService
@inject ReglasRecurrenciaServices ReglasRecurrenciaServices
@inject LoginService LoginService
@inject HttpClient Http
@inject ServicioClienteService ServicioClienteService

<br />
<br />
<br />
<div class="agenda-container">

    <header class="agenda-header">
        <button class="btn" @onclick="PrevWeek">
            <span class="arrow">&#9664;</span> Semana anterior
        </button>

        <div class="header-center">
            <h1>Semana @WeekNumber - @MonthName @CurrentDate.Year</h1>
        </div>

        <button class="btn primary" @onclick="NextWeek">
            Semana siguiente <span class="arrow">&#9654;</span>
        </button>
    </header>
    @* <div style="color:red;font-weight:bold">
        Días inhábiles cargados: @DiasNoLaboralesMes.Count
    </div> *@

    <div class="days-grid weekly">
        @foreach (var day in Days.Where(d => d.Date.DayOfWeek != DayOfWeek.Sunday))
        {
            bool esNoLaboral = EsDiaNoLaboral(day.Date);

            <div class="day-card @(esNoLaboral ? "dia-no-laboral" : "")">

                <div class="day-header">
                    <span class="day-name">@day.Date.ToString("dddd", new CultureInfo("es-ES"))</span>
                    <span class="day-date">@day.Date.ToString("dd")</span>
                </div>
                @if (esNoLaboral)
                {
                    <div class="no-laboral-info">
                        Día no laboral
                        <br />
                        <small>@ObtenerDescripcionNoLaboral(day.Date)</small>
                    </div>
                }
                else
                {
                    <div class="blocks-list">
                        @foreach (var block in day.Blocks)
                        {
                            <div class="list-item" style="background-color:@block.Color">
                                <div class="list-title" @onclick="() => ToggleBlock(block)">
                                    <span>@block.Title</span>

                                    <span class="badge-pendientes">
                                        @PendingCount(block)

                                    </span>

                                    <span class="chev">@((block.IsExpanded ? "▼" : "►"))</span>
                                </div>

                                @if (block.IsExpanded)
                                {
                                    <ul class="subtasks">
                                        @foreach (var taskObj in block.SubTasks)
                                        {
                                            @* <li class="task-item"> *@
                                                @switch (taskObj)
                                                {

                                                    case ClientServiceTask cs:
                                                    {
                                                        bool esEmpresa = string.IsNullOrEmpty(cs.Servicio) && string.IsNullOrEmpty(cs.Actividad);
                                                        bool esServicio = !string.IsNullOrEmpty(cs.Servicio) && string.IsNullOrEmpty(cs.Actividad);
                                                        bool esActividad = cs.ApiId > 0;

                                                        var empresaNode = cs.ParentBlock.SubTasks
                                                            .OfType<ClientServiceTask>()
                                                            .First(e => e.Empresa == cs.Empresa && string.IsNullOrEmpty(e.Servicio));

                                                        if (!empresaNode.IsExpanded && !esEmpresa)
                                                            break;

                                                        if (esActividad)
                                                        {
                                                            var servicioNode = cs.ParentBlock.SubTasks
                                                                .OfType<ClientServiceTask>()
                                                                .First(s =>
                                                                    s.Empresa == cs.Empresa &&
                                                                    s.Servicio == cs.Servicio &&
                                                                    string.IsNullOrEmpty(s.Actividad));

                                                            if (!servicioNode.IsExpanded)
                                                                break;
                                                        }

                                                        <li class="task-item">
                                                            <div class="client-row
                                                                @(esEmpresa ? "lvl-empresa" :
                                                                  esServicio ? "lvl-servicio" :
                                                                  "lvl-actividad")">

                                                                @if (esActividad)
                                                                {
                                                                    <input type="checkbox"
                                                                           checked="@cs.IsCompleted"
                                                                           disabled="@(day.Date.Date != DateTime.Today)"
                                                                           @onchange="(e) => ToggleServicioClienteAsync(cs, e)"
                                                                           @onclick:stopPropagation />
                                                                }
                                                                else
                                                                {
                                                                    <span class="toggle-icon"
                                                                          @onclick="() => cs.IsExpanded = !cs.IsExpanded">
                                                                        @(cs.IsExpanded ? "▾" : "▸")
                                                                    </span>
                                                                }

                                                                <span class="task-name @(esActividad && cs.IsCompleted ? "completed" : "")"
                                                                      @onclick="() =>
                                                                      {
                                                                          if (esActividad)
                                                                              OpenClientModal(cs);
                                                                          else
                                                                              cs.IsExpanded = !cs.IsExpanded;
                                                                      }">
                                                                    @(esActividad ? cs.Actividad :
                                                                      esServicio ? cs.Servicio :
                                                                      cs.Empresa)
                                                                </span>
                                                            </div>
                                                        </li>
                                                        break;
                                                    }
                                                    case SelfAssessment sa:
                                                        {
                                                            <li class="task-item">
                                                                <input type="checkbox"
                                                                       checked="@sa.IsCompleted"
                                                                       disabled="@(!IsToday(sa))"
                                                                       @onchange="(e) => ToggleCompleteSelf(sa, e)"
                                                                       @onclick:stopPropagation />

                                                                <span class="task-name @(sa.IsCompleted ? "completed" : "")"
                                                                      @onclick="() => OpenSelfAssessmentModal(sa)">
                                                                    @sa.ActivityName
                                                                </span>
                                                            </li>
                                                            break;
                                                        }
                                                    case BaseTask bt:
                                                    {
                                                        <li class="task-item">
                                                            @if (block.Title != "Órdenes de Trabajo")
                                                            {
                                                                <span class="task-name @(bt.IsCompleted ? "completed" : "")"
                                                                      @onclick="() => OpenTaskModal(bt, false)">
                                                                    <span class="task-icon">@bt.IconoVisual</span>
                                                                    @bt.Name
                                                                </span>

                                                                @if (!bt.IsCompleted && (!bt.EsEvento || bt.CreadorId == UsuarioActualId))
                                                                {
                                                                    <div class="task-actions">
                                                                        <button class="edit-btn"
                                                                                @onclick="(MouseEventArgs e) => OpenTaskModal(bt, true)"
                                                                                @onclick:stopPropagation>
                                                                            ✏️
                                                                        </button>

                                                                        <button class="delete-btn"
                                                                                @onclick="(MouseEventArgs e) => ConfirmDelete(bt)"
                                                                                @onclick:stopPropagation>
                                                                            🗑️
                                                                        </button>
                                                                    </div>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <span class="task-name @(bt.IsCompleted ? "completed" : "")"
                                                                      @onclick="() => AbrirDetalle(bt)">
                                                                    @bt.Name
                                                                </span>
                                                            }
                                                        </li>
                                                        break;
                                                    }
                                                    default:
                                                        <span>Desconocido</span>
                                                        ;
                                                        break;
                                                }
                                            @* </li> *@
                                        }
                                    </ul>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- Modal de Tarea (editar/ver) -->
@if (IsModalOpen && SelectedTaskObject != null)
{
    @* Usamos @key para que Blazor limpie la "memoria" del modal al cambiar de actividad *@
    <div class="view-overlay" @key="SelectedTaskObject" @onclick="CloseTaskModal">
        <div class="bento-modal" @onclick:stopPropagation>

            @* --- CASO 1: TAREAS O EVENTOS (Solo entra si es BaseTask y tenemos el snapshot) --- *@
            @if (SelectedTaskObject is BaseTask && SelectedTask != null)
            {
                var bt = SelectedTask;

                <div class="bento-header">
                    <div>
                        <span class="type-tag" style="background:#f0fdf4; color:#166534;">@(bt.EsEvento ? "EVENTO" : "TAREA")</span>
                        <div class="title-row">
                            <span class="emoji-icon">🏷️</span>
                            @if (IsEditMode)
                            {
                                <input type="text" @bind="bt.Name" class="bento-input-style title-input" placeholder="Nombre de la actividad" />
                            }
                            else
                            {
                                <h3>@bt.Name</h3>
                            }
                        </div>
                    </div>
                    <button class="bento-close" @onclick="CloseTaskModal">&times;</button>
                </div>

                <div class="bento-grid">
                    <div class="bento-item">
                        <label>📝 DESCRIPCIÓN</label>
                        @if (IsEditMode)
                        {
                            <textarea @bind="bt.Description" class="bento-input-style" placeholder="Añade detalles..."></textarea>
                        }
                        else
                        {
                            <p class="content-text">@(string.IsNullOrWhiteSpace(bt.Description) ? "Sin descripción detallada." : bt.Description)</p>
                        }
                    </div>

                    <div class="bento-item">
                        <label>⚡ PRIORIDAD</label>
                        @if (IsEditMode)
                        {
                            <select @bind="bt.IdPrioridad" class="bento-input-style">
                                @foreach (var p in prioridadesList)
                                {
                                    <option value="@p.Id">@p.Titulo</option>
                                }
                            </select>
                        }
                        else
                        {
                            <span class="prio-label @(bt.IdPrioridad == 1 ? "Alta" : bt.IdPrioridad == 2 ? "Media" : "Baja")">
                                @(prioridadesList.FirstOrDefault(p => p.Id == bt.IdPrioridad)?.Titulo)
                            </span>
                        }

                        <label class="mt-20">📅 PLANIFICACIÓN</label>
                        <div class="plan-row">
                            <div class="plan-item">
                                <span class="plan-label">🗓️Inicia:</span>
                                @if (IsEditMode)
                                {
                                    <div class="edit-date-row">
                                        <DatePicker Value="bt.StartDate" ValueChanged="@(v => bt.StartDate = v ?? bt.StartDate)" />
                                        @if (bt.EsEvento)
                                        {
                                            <TimePickerList @bind-Value="bt.HoraInicio" />
                                        }
                                    </div>
                                }
                                else
                                {
                                    <strong>@bt.StartDate.ToString("dd/MM/yyyy")</strong>
                                    @if (bt.EsEvento)
                                    {
                                        <span class="time-tag">🕒 @bt.HoraInicio?.ToString("HH:mm")</span>
                                    }
                                }
                            </div>
                            <div class="plan-item">
                                <span class="plan-label">🗓️ Termina:</span>
                                @if (IsEditMode)
                                {
                                    <div class="edit-date-row">
                                        <DatePicker Value="bt.DueDate" ValueChanged="@(v => bt.DueDate = v ?? bt.DueDate)" />
                                        @if (bt.EsEvento)
                                        {
                                            <TimePickerList @bind-Value="bt.HoraFin" />
                                        }
                                    </div>
                                }
                                else
                                {
                                    <strong>@bt.DueDate.ToString("dd/MM/yyyy")</strong>
                                    @if (bt.EsEvento)
                                    {
                                        <span class="time-tag">🕒 @bt.HoraFin?.ToString("HH:mm")</span>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    @if (bt.EsEvento)
                    {
                        <div class="bento-item">
                            <label>📍 UBICACIÓN</label>
                            @if (IsEditMode)
                            {
                                <select value="@salaSeleccionada" @onchange="OnSalaChanged" class="bento-input-style">
                                    <option value="">-- Selecciona --</option>
                                    @foreach (var s in salasList)
                                    {
                                        <option value="@s.Id">@s.Salas</option>
                                    }
                                    <option value="0">Otra...</option>
                                </select>
                                @if (EsOtraSala)
                                {
                                    <input type="text" @bind="bt.Ubicacion" class="bento-input-style mt-10" placeholder="Lugar específico" />
                                }
                            }
                            else
                            {
                                <p class="content-text uppercase">@bt.Ubicacion</p>
                            }
                        </div>

                        <div class="bento-item">
                            <label>👑 ORGANIZADO POR</label>
                            <p class="content-text uppercase">@bt.nombreCreador</p>
                        </div>
                    }

                    <div class="bento-item full-width">
                        @if (bt.EsEvento)
                        {
                            <label>👥 EQUIPO DE TRABAJO</label>
                            <div class="names-grid">
                                @if (IsEditMode)
                                {
                                    <div class="search-container">
                                        <input type="text" placeholder="Buscar empleado..." @bind="BusquedaEmpleado" @bind:event="oninput" class="bento-input-style search-input" />
                                        @if (!string.IsNullOrEmpty(BusquedaEmpleado))
                                        {
                                            <ul class="bento-search-results">
                                                @foreach (var emp in EmpleadosFiltrados)
                                                {
                                                    <li @onclick="() => AgregarParticipante(emp)">➕ @emp.Nombre</li>
                                                }
                                            </ul>
                                        }
                                    </div>
                                    @foreach (var p in ParticipantesEdit)
                                    {
                                        <div class="full-name-tag editable-tag">
                                            <span class="pin">📌</span> @p.nombreEmpleado
                                            <button class="remove-tag" @onclick="() => QuitarParticipante(p)">&times;</button>
                                        </div>
                                    }
                                }
                                else
                                {
                                    @foreach (var p in bt.Participantes)
                                    {
                                        <div class="full-name-tag">
                                            <span class="pin">📌</span> @p
                                        </div>
                                    }
                                }
                            </div>
                        }
                        else
                        {
                            <label>✅ SUBTAREAS ASOCIADAS</label>
                            <div class="subtasks-grid">
                                @foreach (var st in bt.SubTasks)
                                {
                                    <div class="subtask-card @(IsEditMode ? "editable-card" : "")">
                                        @st.Name
                                        @if (IsEditMode)
                                        {
                                            <button class="remove-sub" @onclick="() => RemoveSubTask(st)">🗑️</button>
                                        }
                                    </div>
                                }
                                @if (IsEditMode)
                                {
                                    <div class="add-subtask-box">
                                        <input type="text" @bind="NuevaSubtarea" placeholder="Nueva subtarea..." class="bento-input-style" />
                                        <button @onclick="AddSubTask" class="add-btn-circle">+</button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>

                <div class="bento-footer">
                    @if (IsEditMode)
                    {
                        <button class="bento-btn save" @onclick="SaveTask">Guardar Cambios</button>
                        <button class="bento-btn cancel" @onclick="CancelEdit">Cancelar</button>
                    }
                    else
                    {
                        <button class="bento-btn close-red" @onclick="CloseTaskModal">Cerrar</button>
                    }
                </div>
            }
            @* --- CASO 2: AUTOEVALUACIÓN (Aislado de la lógica de tareas) --- *@
            else if (SelectedTaskObject is SelfAssessment sa)
            {
                <div class="bento-header">
                    <div>
                        <span class="type-tag" style="background:#f0fdf4; color:#166534;">AUTOEVALUACIÓN</span>
                        <div class="title-row">
                            <span class="emoji-icon">🧠</span>
                            <h3>@sa.ActivityName</h3>
                        </div>
                    </div>
                    <button class="bento-close" @onclick="CloseTaskModal">&times;</button>
                </div>

              

                <div class="bento-footer">
                    <button class="bento-btn close-red" @onclick="CloseTaskModal">Cerrar</button>
                </div>
            }
        </div>
    </div>
}
@if (IsClientModalOpen && SelectedClientTask != null)
{
    <div class="modal-backdrop" @onclick="CloseClientModal"></div>

    <div class="modal-content" @onclick:stopPropagation>
        <div class="modal-header">
            <h2>Detalles del Cliente</h2>
            <button class="close-btn" @onclick="CloseClientModal">&times;</button>
        </div>

        <div class="modal-body">
            <div class="form-group">
                <label>Empresa</label>
                <p class="read-only-field">@SelectedClientTask.Empresa</p>
            </div>

            <div class="form-group">
                <label>Servicio</label>
                <p class="read-only-field">@SelectedClientTask.Servicio</p>
            </div>

            <div class="form-group">
                <label>Actividad</label>
                <p class="read-only-field">@SelectedClientTask.Actividad</p>
            </div>
        </div>

        <div class="modal-footer">
            <button class="action-btn save" @onclick="CloseClientModal">Cerrar</button>
        </div>
    </div>
}

<!-- Modal de Confirmación de Borrado -->
@if (ShowConfirmDelete)
{
    <div class="modal-backdrop" @onclick="() => ShowConfirmDelete = false"></div>
    <div class="confirm-modal" @onclick:stopPropagation>
        <h3>¿Eliminar tarea?</h3>
        <p>¿Estás seguro que quieres eliminar "<strong>@TaskToDelete?.Name</strong>"?</p>
        <div class="confirm-actions">
            <button class="action-btn save" @onclick="() => { ShowConfirmDelete = false; TaskToDelete = null; }">Cancelar</button>
            <button class="action-btn cancel" @onclick="() => DeleteConfirmedAsync()">Eliminar</button>
        </div>
    </div>
}
@if (IsOTModalOpen && OrdenTrabajoDetalle != null)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-content modern-modal" @onclick:stopPropagation="true">

            <!-- HEADER -->
            <div class="modal-header">
                <span class="modal-icon">📄</span>
                Orden de Trabajo
            </div>

            <!-- BODY -->
            <div class="modal-body modal-scroll">

                <!-- INFO -->
                <div class="ot-card">
                    <div class="collapsible-header">
                        Información general
                    </div>
                    <div class="collapsible-content">
                        <div class="info-grid">
                            <div><b>Número:</b> @OrdenTrabajoDetalle.strClave</div>
                            <div><b>Autor:</b> @OrdenTrabajoDetalle.nombreCompleto</div>
                            <div><b>Cliente:</b> @OrdenTrabajoDetalle.nombreCliente</div>
                            <div><b>Objetivo:</b> @OrdenTrabajoDetalle.strValor</div>
                            <div><b>Objetivo otro:</b> @OrdenTrabajoDetalle.strObjetivoOtro</div>
                            <div><b>Fecha solicitud:</b> @OrdenTrabajoDetalle.dteFechaSolicitud.ToShortDateString()</div>
                            <div><b>Fecha conclusión:</b> @OrdenTrabajoDetalle.fechaFinal.ToShortDateString()</div>
                        </div>
                    </div>
                </div>

                <!-- TAREAS -->
                <div class="ot-card">
                    <div class="collapsible-header">
                        Tareas
                    </div>
                    <div class="collapsible-content">

                        <table class="subtasks-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th>Avance</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in OrdenTrabajoDetalle.tareas)
                                {
                                    <tr>
                                        <td>@t.strNombreTarea</td>
                                        <td>@t.strDescripcionAutor</td>
                                        <td>@t.avance </td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                    </div>
                </div>

            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <button @onclick="CerrarModales">Cerrar</button>
            </div>

        </div>
    </div>
}

@if (IsTramiteModalOpen && OrdenTramiteDetalle != null)
{
    <div class="modal-overlay" @onclick="CerrarModales">
        <div class="modal-content modern-modal" @onclick:stopPropagation="true">

            <!-- HEADER -->
            <div class="modal-header">
                <span class="modal-icon">📄</span>
                Orden de Trámite
            </div>

            <!-- BODY -->
            <div class="modal-body modal-scroll">

                <!-- INFO -->
                <div class="tramite-card">
                    <div class="collapsible-header">
                        Información general
                    </div>
                    <div class="collapsible-content">
                        <div class="info-grid">
                            <div><b>Fecha solicitud:</b> @OrdenTramiteDetalle.fechaSolicitud</div>
                            <div><b>Cliente:</b> @OrdenTramiteDetalle.nombreGlobal</div>
                            <div><b>Solicitante:</b> @OrdenTramiteDetalle.solicitanteInterno</div>
                            <div><b>Fecha conclusión:</b> @OrdenTramiteDetalle.fechaConclusionTramite</div>
                            <div><b>Nombre global:</b> @OrdenTramiteDetalle.nombreGlobal</div>
                        </div>
                    </div>
                </div>

                <!-- TRÁMITES -->
                <div class="tramite-card">
                    <div class="collapsible-header">
                        Trámites individuales
                    </div>
                    <div class="collapsible-content">

                        <table class="subtasks-table">
                            <thead>
                                <tr>
                                    <th>Clave</th>
                                    <th>Trámite</th>
                                    <th>Encargado</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in OrdenTramiteDetalle.tramitesIndividuales)
                                {
                                    <tr>
                                        <td>@t.clave</td>
                                        <td>@t.tramiteIndividual</td>
                                        <td>@t.personalEncargado</td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                    </div>
                </div>

            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <button @onclick="CerrarModales">Cerrar</button>
            </div>

        </div>
    </div>
}

<!-- Toast -->
@if (ShowToast)
{
    <div class="toast">@ToastMessage</div>
}

@code {
    BaseTask? SelectedTask;
    BaseTask? OriginalTask;   // referencia al real

    BaseTask bt { get; set; } = new();

    List<SalasEm> salasList = new();
    List<FrecuenciaRecurrencia> frecuenciasList = new();
    List<Prioridad> prioridadesList = new();

    List<EmpleadoDTO> empleados = new();
    List<EmpleadoDTO> empleadosFiltrados = new();
    private List<EmpleadoDTO> participantesSeleccionados = new();

    int? salaSeleccionada;
    bool EsOtraSala => salaSeleccionada == 0;

    bool IsOTModalOpen = false;
    bool IsTramiteModalOpen = false;

    int UsuarioActualId;

    protected override void OnInitialized()
    {
        var usuario = LoginService.obtenerUsuarioLogueado();
        UsuarioActualId = usuario.IdUsuario;        
    }

    public List<ParticipanteDTO> ParticipantesEdit { get; set; } = new();
    List<EmpleadoDTO> todosLosEmpleados = new();
    string BusquedaEmpleado = string.Empty;

    IEnumerable<EmpleadoDTO> EmpleadosFiltrados =>
    string.IsNullOrWhiteSpace(BusquedaEmpleado)
        ? Enumerable.Empty<EmpleadoDTO>()
        : todosLosEmpleados
            .Where(e =>
                e.Nombre.Contains(BusquedaEmpleado, StringComparison.OrdinalIgnoreCase)
                || e.Id.ToString().Contains(BusquedaEmpleado)
            )
            .Take(10);


    string NuevaSubtarea { get; set; } = "";

    void AddSubTask()
    {
        if (string.IsNullOrWhiteSpace(NuevaSubtarea)) return;

        SelectedTask.SubTasks.Add(new BaseSubTask
        {
            Name = NuevaSubtarea,
            TempId = Guid.NewGuid()
        });

        NuevaSubtarea = "";
        StateHasChanged();
    }


    void RemoveSubTask(BaseSubTask st)
    {
        SelectedTask.SubTasks.Remove(st);
        StateHasChanged();
    }




    // ---------- DÍAS NO LABORALES / ----------
    List<DiaNoLaboralDto> DiasNoLaboralesMes = new();
    async Task AbrirDetalle(BaseTask task)
    {
        SelectedTask = task;

        if (task.Tipo.Equals("WorkOrder", StringComparison.OrdinalIgnoreCase))
        {
            await CargarOrdenTrabajo(task.ApiId);
            IsOTModalOpen = true;
        }
        else if (task.Tipo.Equals("Tramite", StringComparison.OrdinalIgnoreCase))
        {
            await CargarOrdenTramite(task.ApiId);
            IsTramiteModalOpen = true;
        }

    }
    private async Task ToggleCompleteDynamic(BaseTask bt, ChangeEventArgs e)
    {
        bool nuevoEstado = false;

        if (e?.Value is bool b) nuevoEstado = b;
        else if (e?.Value is string s) nuevoEstado = s == "true" || s == "on";

        // Optimistic UI
        bt.IsCompleted = nuevoEstado;

        bool exito = false;

        try
        {
            if (bt.Tipo.Equals("Evento", StringComparison.OrdinalIgnoreCase))
            {
                exito = await AgendaService.CambiarEstadoEventoAsync(bt.ApiId, nuevoEstado);
            }
            else
            {
                exito = await AgendaService.CambiarEstadoTareaAsync(bt.ApiId, nuevoEstado);
            }

            if (!exito)
            {
                bt.IsCompleted = !nuevoEstado; // rollback
                await ShowTemporaryToastAsync("Error al actualizar el estado");
            }
            else
            {
                await ShowTemporaryToastAsync(bt.IsCompleted
                    ? $"Marcaste '{bt.Name}' como completada"
                    : $"Desmarcaste '{bt.Name}'");
            }
        }
        catch
        {
            bt.IsCompleted = !nuevoEstado; // rollback
            await ShowTemporaryToastAsync("Error al actualizar el estado");
        }

        StateHasChanged();
    }

    void OnSalaChanged(ChangeEventArgs e)
    {
        if (SelectedTaskObject is not BaseTask bt)
            return;

        if (!int.TryParse(e.Value?.ToString(), out var value))
        {
            salaSeleccionada = null;
            return;
        }

        var veniaDeSala = bt.IdSala.HasValue && bt.IdSala > 0;

        salaSeleccionada = value;

        if (value == 0)
        {
            // Otra ubicación
            bt.IdSala = null;

            if (veniaDeSala)
            {
                bt.Ubicacion = string.Empty;
            }
        }
        else
        {
            // Sala seleccionada
            bt.IdSala = value;
            bt.Ubicacion = null;
        }
    }



    OrdenTrabajoDTO? OrdenTrabajoDetalle;
    async Task CargarOrdenTrabajo(int id)
    {
        OrdenTrabajoDetalle = await OrdenService.GetDetalle(id);
    }
    OrdenTramiteDTO? OrdenTramiteDetalle;
    async Task CargarOrdenTramite(int id)
    {
        OrdenTramiteDetalle = await OrdenTramiteService.GetDetalle(id);
    }
    void CerrarModales()
    {
        IsOTModalOpen = false;
        IsTramiteModalOpen = false;
        SelectedTask = null;
    }
    public List<TramiteIndividualDTO> tramitesIndividuales { get; set; }

    public List<OrdenTramiteDTO> detalleTramites { get; set; }
    public List<OrdenTramiteDTO> ordenesTramiteDetalle { get; set; }
    public string tramiteIndividual { get; set; }
    public string personalEncargado { get; set; }
    public string strNombre { get; set; }
    public string strDescripcion { get; set; }
    public int intAvance { get; set; }


    // ---------- Tipos internos para la vista ----------
    enum BlockType
    {
        AdminTask,
        WorkOrder,
        Tramite,
        GeneralTask,
        SelfAssessment
    }

    class DayColumn
    {
        public DateTime Date { get; set; }
        public List<Block> Blocks { get; set; } = new();
    }

    class Block
    {
        public string Title { get; set; } = "";
        public List<object> SubTasks { get; set; } = new();
        public string Color { get; set; } = "#fff";
        public bool IsExpanded { get; set; } = false;
    }

    class BaseTask
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public Guid TempId { get; set; } = Guid.NewGuid();

        // Identidad
        public int ApiId { get; set; }
        public int IdAgenda { get; set; }
        public int IdPrioridad { get; set; }

        // Tipo
        public string Tipo { get; set; } = "Tarea";

        // Contenido base
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";

        // Prioridad / recurrencia (ya existentes)
        public string Recurrence { get; set; } = "No repetir";

        // Estado
        public bool IsCompleted { get; set; }

        // Fechas (ya existentes)
        public DateTime StartDate { get; set; }
        public DateTime DueDate { get; set; }
        public DateTime? FinishDate { get; set; }

        // Recurrencia real
        public bool EsRecurrente { get; set; }
        public string? ReglaRecurrencia { get; set; }

        // Evento
        public string? Ubicacion { get; set; }
        public int? IdSala { get; set; }
        public TimeOnly? HoraInicio { get; set; }
        public TimeOnly? HoraFin { get; set; }

        public int CreadorId { get; set; }
        public string? nombreCreador { get; set; }
        public List<string> Participantes { get; set; } = new();

        // Tarea
        public List<BaseSubTask> SubTasks { get; set; } = new();

        // UI
        public Block? ParentBlock { get; set; }

        public bool EsEvento =>
            Tipo.Equals("Evento", StringComparison.OrdinalIgnoreCase);

        public string IconoVisual =>
            EsEvento ? "📅" : "📝";
    }

    class BaseSubTask
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public bool IsCompleted { get; set; } = false;
        public Guid TempId { get; set; } = Guid.NewGuid();

        public BaseSubTask Clone()
        {
            return new BaseSubTask
            {
                Id = this.Id,
                Name = this.Name,
                IsCompleted = this.IsCompleted,
                TempId = this.TempId 
            };
        }
    }

    int MapPriority(string prioridad)
    {
        return prioridad switch
        {
            "Alta" => 1,
            "Media" => 2,
            "Baja" => 3,
            _ => 2
        };
    }

    string MapPriorityBack(int id)
    {
        return id switch
        {
            1 => "Alta",
            2 => "Media",
            3 => "Baja",
            _ => "Media"
        };
    }

    public class EditarSubTareaDTO
    {
        public int Id { get; set; }
        public string Titulo { get; set; } = string.Empty;
    }

    public class EventoEditDTO
    {
        public string titulo { get; set; } = "";
        public string descripcion { get; set; } = "";
        public DateTime fechaInicio { get; set; }
        public DateTime fechaFin { get; set; }
        public bool esRecurrente { get; set; }
        public string? reglaRecurrencia { get; set; }
        public int idPrioridad { get; set; }
        public int? idSala { get; set; }
        public string? ubicacion { get; set; }

        public List<int> idsParticipantes { get; set; } = new();
    }

    public class TareaEditDTO
    {
        public string titulo { get; set; } = "";
        public string descripcion { get; set; } = "";
        public DateTime fechaInicio { get; set; }
        public DateTime fechaFin { get; set; }
        public bool esRecurrente { get; set; }
        public string? reglaRecurrencia { get; set; }
        public int idPrioridad { get; set; }

        public List<EditableSubtask> subTareas { get; set; } = new();
    }


    class SelfAssessment
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public int IdRegistro { get; set; }
        public string ActivityName { get; set; } = "";
        public bool IsCompleted { get; set; } = false;

        public DateTime TaskDate { get; set; }

        public Block ParentBlock { get; set; }
    }


    bool IsToday(SelfAssessment sa)
    {
        return sa.TaskDate.Date == DateTime.Today;
    }

    class ClientServiceTask
    {
        public Guid Id { get; set; } = Guid.NewGuid();

        public int ApiId { get; set; } // IdHorasProgramaTrabajo
        public bool IsExpanded { get; set; } = false;
        public string Empresa { get; set; } = "";
        public string Servicio { get; set; } = "";
        public string Actividad { get; set; } = "";

        public bool IsCompleted { get; set; }
        public DateTime? FechaCompletada { get; set; }

        public Block ParentBlock { get; set; }
    }


    // ---------- Estado del componente ----------
    List<DayColumn> Days = new();
    DateTime CurrentDate = DateTime.Today;

    object SelectedTaskObject { get; set; }
    bool IsModalOpen { get; set; } = false;
    bool IsEditMode { get; set; } = false;

    // Confirm delete
    bool ShowConfirmDelete { get; set; } = false;
    BaseTask TaskToDelete { get; set; }

    // Toast
    bool ShowToast { get; set; } = false;
    string ToastMessage { get; set; } = "";

    int WeekNumber => CultureInfo.CurrentCulture.Calendar.GetWeekOfYear(CurrentDate, CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
    string MonthName => CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.GetMonthName(CurrentDate.Month);

    bool catalogosCargados;

    protected override async Task OnInitializedAsync()
    {
        await LoadWeek(CurrentDate);

        if (catalogosCargados) return;

        salasList = await SalasEmService.GetSalas();
        frecuenciasList = await ReglasRecurrenciaServices.GetFrecuencia();
        prioridadesList = await ReglasRecurrenciaServices.GetPrioridad();

        catalogosCargados = true;

        try
        {
            var json = await Http.GetStringAsync("empleado");
            todosLosEmpleados =
                JsonConvert.DeserializeObject<List<EmpleadoDTO>>(json) ?? new();
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error cargando empleados: {ex.Message}");
        }
    }

    void AgregarParticipante(EmpleadoDTO emp)
    {
        if (ParticipantesEdit.Any(p => p.idEmpleado == emp.Id))
            return;

        ParticipantesEdit.Add(new ParticipanteDTO
        {
            idEmpleado = emp.Id,
            nombreEmpleado = emp.Nombre
        });

        BusquedaEmpleado = "";
    }

    void QuitarParticipante(ParticipanteDTO p)
    {
        ParticipantesEdit.Remove(p);
    }


    protected override void OnParametersSet()
    {
        if (bt == null) return;

        if (bt.IdSala.HasValue && bt.IdSala > 0)
        {
            // Viene de catálogo
            salaSeleccionada = bt.IdSala.Value;
        }
        else if (!string.IsNullOrWhiteSpace(bt.Ubicacion))
        {
            // Texto libre existente
            salaSeleccionada = 0;
        }
        else
        {
            // Evento sin ubicación definida
            salaSeleccionada = null;
        }
    }

    async Task PrevWeek()
    {
        CurrentDate = CurrentDate.AddDays(-7);
        await LoadWeek(CurrentDate);
    }

    async Task NextWeek()
    {
        CurrentDate = CurrentDate.AddDays(7);
        await LoadWeek(CurrentDate);
    }
    async Task CargarDiasNoLaborales(DateTime referencia)
    {
        DiasNoLaboralesMes.Clear();

        var monday = StartOfWeek(referencia, DayOfWeek.Monday);
        var sunday = monday.AddDays(6);

        var meses = Enumerable
            .Range(0, 7)
            .Select(i => monday.AddDays(i))
            .Select(d => new { d.Year, d.Month })
            .Distinct();

        foreach (var m in meses)
        {
            var dias = await CalendarioService
                .ObtenerDiasNoLaborales(m.Year, m.Month);

            DiasNoLaboralesMes.AddRange(dias);
        }
    }

    bool EsDiaNoLaboral(DateTime fecha)
    {
        return DiasNoLaboralesMes.Any(d =>
            d.DiaInhabil.Date == fecha.Date
        );
    }

    string ObtenerDescripcionNoLaboral(DateTime fecha)
    {
        return DiasNoLaboralesMes
            .FirstOrDefault(d => d.DiaInhabil.Date == fecha.Date)?
            .Descripcion
            ?? "Día no laboral";
    }

    string IconoPrioridad(int idPrioridad) => idPrioridad switch
    {
        1 => "🔴", // Alta
        2 => "🟡", // Media
        3 => "🟢", // Baja
        _ => "⚪"
    };

    // ---------- Carga principal ----------
    async Task LoadWeek(DateTime reference)
    {
        await CargarDiasNoLaborales(reference);
        Days.Clear();
        var monday = StartOfWeek(reference, DayOfWeek.Monday);

        // Crear días y bloques (autoeval y servicio al cliente estáticos)
        for (int i = 0; i < 7; i++)
        {
            var date = monday.AddDays(i).Date;
            var day = new DayColumn { Date = date };

            // Bloque 1 - Tareas / Eventos (dinámico)
            day.Blocks.Add(new Block { Title = "Tareas", Color = "#FFD1DC", IsExpanded = true });

            // Bloque 2 - Órdenes de Trabajo (dinámico)
            day.Blocks.Add(new Block { Title = "Órdenes de Trabajo", Color = "#FFDAC1", IsExpanded = false });

            // Bloque 3 - Autoevaluación (dinámico)
            day.Blocks.Add(new Block { Title = "Autoevaluación", Color = "#E2F0CB", IsExpanded = false });

            // Bloque 4 - Servicio al Cliente (dinámico)
            day.Blocks.Add(new Block {Title = "Servicio al Cliente", Color = "#D7D1DD", IsExpanded = false});


            Days.Add(day);
        }

        // Rango de la semana (por fechaFin)
        var startOfWeek = monday.Date;
        var endOfWeek = monday.AddDays(6).Date;

        // Obtener id de agenda (usa tu servicio)
        var agendas = await AgendaService.ObtenerAgendaAsignadasAsync();
        var idAgenda = agendas.FirstOrDefault();

        salasList = await SalasEmService.GetSalas();
        Debug.WriteLine($"Salas cargadas (post fetch): {salasList.Count}");


        // 1) Obtener tareas (api) y eventos (api)
        List<TareaCreada> agendaItems = new();

        if (idAgenda > 0)
        {
            var tareasApi = await AgendaService.ObtenerTareasApi(idAgenda);

            foreach (var t in tareasApi)
            {
                agendaItems.Add(new TareaCreada
                {
                    Tipo = "Tarea",
                    IsEvento = false,
                    IsCompleted = t.completada,

                    Titulo = t.titulo,
                    Descripcion = t.descripcion,

                    FechaInicio = t.fechaInicio.Date,
                    FechaFin = t.fechaFin.Date,
                    FechaCompletada = t.fechaCompletada,

                    HoraInicio = TimeOnly.FromDateTime(t.fechaInicio),
                    HoraFin = TimeOnly.FromDateTime(t.fechaFin),

                    Prioridad = t.idPrioridad,
                    IdAgenda = t.idAgenda,
                    Id = t.id,

                    EsRecurrente = t.esRecurrente,
                    ReglaRecurrencia = t.reglaRecurrencia,

                    Subtareas = t.subTareas?
                    .Select(st => st.titulo)
                    .ToList()
                    ?? new List<string>()
                });
            }

            var eventosApi = await AgendaService.ObtenerEventosPorEmpleado();

            foreach (var e in eventosApi)
            {
                agendaItems.Add(new TareaCreada
                {
                    Tipo = "Evento",
                    IsEvento = true,
                    IsCompleted = e.completada,

                    Titulo = e.titulo,
                    Descripcion = e.descripcion,

                    FechaInicio = e.fechaInicio.Date,
                    FechaFin = e.fechaFin.Date,
                    FechaCompletada = e.fechaCompletada,

                    HoraInicio = TimeOnly.FromDateTime(e.fechaInicio),
                    HoraFin = TimeOnly.FromDateTime(e.fechaFin),

                    Ubicacion = e.ubicacion,

                    Prioridad = e.idPrioridad,
                    EsRecurrente = e.esRecurrente,
                    ReglaRecurrencia = e.reglaRecurrencia,

                    Id = e.id,
                    IdAgenda = e.idAgenda,
                    IdSala = e.idSala,

                    IdCreador = e.creadorId,
                    NombreCreador = e.nombreCreador,

                    ParticipantesLista = e.participantes
                    .Select(p => new EmpleadoDTO
                    {
                        Id = p.idEmpleado,
                        Nombre = p.nombreEmpleado
                    })
                        .ToList()
                });
            }
            foreach (var item in agendaItems)
            {
                if (item.FechaInicio == null && item.FechaFin == null && item.FechaCompletada == null)
                    continue;

                var fechas = new List<DateTime>();

                if (item.IsCompleted == false && DateTime.Today > item.FechaFin && item.Tipo == "Tarea")
                {
                    DateTime fechaHoy = DateTime.Today;
                    fechas.Add(fechaHoy);
                }
                if (item.IsCompleted && item.FechaCompletada != null)
                {
                    fechas.Add(item.FechaCompletada!.Value.Date);
                }
                else
                {
                    if (item.FechaFin != null && item.FechaFin >= DateTime.Today && item.IsCompleted == false && item.Tipo == "Tarea")
                        fechas.Add(item.FechaFin.Value.Date);

                    if (item.FechaFin != null && item.IsCompleted == false && item.Tipo == "Evento")
                        fechas.Add(item.FechaFin.Value.Date);
                }

                fechas = fechas.Distinct().ToList();

                string ubicacionFinal;
                if (item.IdSala > 0)
                {
                    var sala = salasList.FirstOrDefault(s => s.Id == item.IdSala);
                    ubicacionFinal = sala?.Salas ?? item.Ubicacion;
                }
                else
                {
                    ubicacionFinal = item.Ubicacion;
                }

                foreach (var fecha in fechas)
                {
                    if (fecha < startOfWeek || fecha > endOfWeek)
                        continue;

                    var day = Days.FirstOrDefault(d => d.Date.Date == fecha);
                    if (day == null) continue;

                    var mapped = new BaseTask
                    {
                        ApiId = item.Id,
                        IdAgenda = item.IdAgenda,
                        Name = item.Titulo,
                        Description = item.Descripcion,

                        StartDate = item.FechaInicio ?? item.FechaFin ?? DateTime.Today,
                        DueDate = item.FechaFin ?? item.FechaInicio ?? DateTime.Today,
                        FinishDate = item.FechaCompletada,

                        IsCompleted = item.IsCompleted,
                        Tipo = item.Tipo,
                        ParentBlock = day.Blocks[0],

                        // Prioridad
                        IdPrioridad = item.Prioridad,

                        // Recurrencia
                        Recurrence = item.EsRecurrente
                            ? item.ReglaRecurrencia
                            : "No repetir",

                        // Evento
                        Ubicacion = ubicacionFinal,
                        IdSala = item.IdSala,
                        HoraInicio = item.HoraInicio,
                        HoraFin = item.HoraFin,

                        // Auditoría
                        CreadorId = item.IdCreador,
                        nombreCreador = item.NombreCreador ?? "",

                        // Subtareas
                        SubTasks = item.Subtareas?
                            .Select(st => new BaseSubTask { Name = st })
                            .ToList() ?? new(),

                        // Participantes
                        Participantes = item.ParticipantesLista?
                            .Select(p => p.Nombre)
                            .ToList() ?? new()
                    };
                    day.Blocks[0].SubTasks.Add(mapped);
                }
            }
        }

        // Mapear y filtrar por fechaFin (acepta propiedades fechaFin o fechaFinal o fechaFinal en ordenes)

        // 2) Obtener órdenes de trabajo y mapear
        List<OrdenTrabajoDTO> ordenes = new();
        try
        {
            var ordPen = await OrdenService.GetOrdenesPendntes();
            if (ordPen != null) ordenes.AddRange(ordPen);
            Debug.WriteLine($"Ordenes pendientes totales: {ordPen.Count}");
        }
        catch { /* ignore */ }

        foreach (var o in ordenes)
        {
            DateTime fecha = o.fechaFinal.Date;
            if (fecha < startOfWeek || fecha > endOfWeek) continue;
            var day = Days.FirstOrDefault(d => d.Date.Date == fecha);
            if (day == null) continue;

            var wt = new BaseTask
            {
                ApiId = o.id,
                Name = $"{o.strClave}",
                Description = o.strObjetivoOtro ?? o.strValor,
                StartDate = o.dteFechaSolicitud,
                DueDate = o.fechaFinal,
                IsCompleted = string.Equals(o.estado, "Completado", StringComparison.OrdinalIgnoreCase),
                Tipo = "WorkOrder",
                ParentBlock = day.Blocks[1]
            };

            day.Blocks[1].SubTasks.Add(wt);
        }
        // 2.1) Obtener ÓRDENES DE TRÁMITE y mapear al MISMO bloque
        List<OrdenTramiteDTO> tramites = new();

        try
        {
            var tPen = await OrdenTramiteService.GetPendientes();
            if (tPen != null) tramites.AddRange(tPen);
        }
        catch { /* ignore */ }

        foreach (var t in tramites)
        {
            // fecha CLAVE: conclusión del trámite
            if (!DateTime.TryParse(t.fechaConclusionTramite, out var fecha))
                continue;

            fecha = fecha.Date;
            if (fecha < startOfWeek || fecha > endOfWeek) continue;

            var day = Days.FirstOrDefault(d => d.Date.Date == fecha);
            if (day == null) continue;

            var bt = new BaseTask
            {
                ApiId = t.idOrden,
                Name = $"{t.numeroOrden}",
                Description = t.solicitanteInterno,
                StartDate = DateTime.TryParse(t.fechaSolicitud, out var fs)
                    ? fs
                    : fecha,
                DueDate = fecha,
                IsCompleted = false,
                Tipo = "Tramite",

                ParentBlock = day.Blocks[1]
            };

            day.Blocks[1].SubTasks.Add(bt);
        }

        // 3) Obtener autoevaluacion y mapear
        List<AutoevaluacionDTO> autoevaluaciones = new();

        try
        {
            autoevaluaciones = await AutoevaluacionService.ObtenerAutoevaluacion();
        }
        catch { }

        foreach (var bloque in autoevaluaciones)
        {
            foreach (var tarea in bloque.Tareas)
            {
                foreach (var registro in tarea.Registros)
                {
                    // 🔥 DateOnly → DateTime (CRÍTICO)
                    var fecha = registro.Fecha.ToDateTime(TimeOnly.MinValue).Date;

                    if (fecha < startOfWeek || fecha > endOfWeek)
                        continue;

                    var day = Days.FirstOrDefault(d => d.Date.Date == fecha);
                    if (day == null)
                        continue;

                    var autoBlock = day.Blocks.First(b => b.Title == "Autoevaluación");

                    autoBlock.SubTasks.Add(new SelfAssessment
                    {
                        IdRegistro = registro.IdRegistro,   // ⬅️ AQUI
                        ActivityName = tarea.Tarea,
                        IsCompleted = registro.Realizado,
                        TaskDate = fecha,
                        ParentBlock = autoBlock
                    });

                }
            }
        }


        // 4) Obtener Servicio al Cliente (AGRUPADO, NO por día)
        List<ServicioClienteAgendaDTO> serviciosCliente = new();

        try
        {
            serviciosCliente = await ServicioClienteService.ObtenerAgendaServicioCliente();
        }
        catch
        {
            serviciosCliente = new();
        }

        // Agrupar por EMPRESA → SERVICIO
        var empresas = serviciosCliente
            .GroupBy(sc => sc.NombreEmpresa);

        foreach (var empresa in empresas)
        {
            foreach (var servicio in empresa.GroupBy(sc => sc.NombreServicio))
            {
                foreach (var sc in servicio)
                {
                    var inicio = sc.FechaAsignacion.Date;
                    var fin = sc.FechaConclusion.Date;

                    foreach (var day in Days)
                    {
                        var fecha = day.Date.Date;

                        if (fecha < inicio || fecha > fin)
                            continue;

                        var bloqueCliente = day.Blocks
                            .First(b => b.Title == "Servicio al Cliente");

                        if (bloqueCliente != null)
                        {
                            RecalcularEstadoServicioCliente(bloqueCliente);
                        }

                        // ===== EMPRESA =====
                        var empresaNode = bloqueCliente.SubTasks
                            .OfType<ClientServiceTask>()
                            .FirstOrDefault(x =>
                                x.Empresa == sc.NombreEmpresa &&
                                string.IsNullOrEmpty(x.Servicio) &&
                                string.IsNullOrEmpty(x.Actividad));

                        if (empresaNode == null)
                        {
                            empresaNode = new ClientServiceTask
                            {
                                Empresa = sc.NombreEmpresa,
                                ParentBlock = bloqueCliente
                            };
                            bloqueCliente.SubTasks.Add(empresaNode);
                        }

                        // ===== SERVICIO =====
                        var servicioNode = bloqueCliente.SubTasks
                            .OfType<ClientServiceTask>()
                            .FirstOrDefault(x =>
                                x.Empresa == sc.NombreEmpresa &&
                                x.Servicio == sc.NombreServicio &&
                                string.IsNullOrEmpty(x.Actividad));

                        if (servicioNode == null)
                        {
                            servicioNode = new ClientServiceTask
                            {
                                Empresa = sc.NombreEmpresa,
                                Servicio = sc.NombreServicio,
                                ParentBlock = bloqueCliente
                            };
                            bloqueCliente.SubTasks.Add(servicioNode);
                        }

                        // ===== ACTIVIDAD (REAL) =====
                        bool yaExiste = bloqueCliente.SubTasks
    .OfType<ClientServiceTask>()
    .Any(x =>
        x.ApiId == sc.IdHorasProgramaTrabajo &&
        x.Empresa == sc.NombreEmpresa &&
        x.Servicio == sc.NombreServicio &&
        x.Actividad == sc.NombreActividad
    );

                        if (!yaExiste)
                        {
                            bloqueCliente.SubTasks.Add(new ClientServiceTask
                            {
                                ApiId = sc.IdHorasProgramaTrabajo,
                                Empresa = sc.NombreEmpresa,
                                Servicio = sc.NombreServicio,
                                Actividad = sc.NombreActividad,
                                IsCompleted = sc.Completada ?? false,
                                FechaCompletada = sc.FechaCompletada,
                                ParentBlock = bloqueCliente
                            });
                        }

                    }
                }
            }
        }





        StateHasChanged();
    }

    // ---------- Helpers para leer propiedades de objetos retornados por el servicio ----------
    DateTime? TryGetDateTime(object obj, string propName)
    {
        try
        {
            var t = obj.GetType();
            var p = t.GetProperty(propName);
            if (p == null) return null;
            var val = p.GetValue(obj);
            if (val == null) return null;

            if (val is DateTime dt) return dt;
            if (val is string s)
            {
                if (DateTime.TryParse(s, out var parsed)) return parsed;
                // intentar formatos comunes
                if (DateTime.TryParseExact(s, "yyyy-MM-ddTHH:mm:ss", CultureInfo.InvariantCulture, DateTimeStyles.None, out parsed)) return parsed;
                if (DateTime.TryParseExact(s, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out parsed)) return parsed;
            }
        }
        catch { }
        return null;
    }
    string TryGetString(object obj, string propName)
    {
        try
        {
            var p = obj.GetType().GetProperty(propName);
            if (p == null) return null;
            var v = p.GetValue(obj);
            return v?.ToString();
        }
        catch { return null; }
    }
    int? TryGetInt(object obj, string propName)
    {
        try
        {
            var p = obj.GetType().GetProperty(propName);
            if (p == null) return null;
            var v = p.GetValue(obj);
            if (v == null) return null;
            if (v is int i) return i;
            if (int.TryParse(v.ToString(), out var parsed)) return parsed;
        }
        catch { }
        return null;
    }
    bool? TryGetBool(object obj, string propName)
    {
        try
        {
            var p = obj.GetType().GetProperty(propName);
            if (p == null) return null;
            var v = p.GetValue(obj);
            if (v == null) return null;
            if (v is bool b) return b;
            if (bool.TryParse(v.ToString(), out var parsed)) return parsed;
        }
        catch { }
        return null;
    }
    DateTime StartOfWeek(DateTime dt, DayOfWeek startOfWeek)
    {
        int diff = (7 + (dt.DayOfWeek - startOfWeek)) % 7;
        return dt.AddDays(-1 * diff).Date;
    }

    // ---------- UI helpers y acciones ----------
    void ToggleBlock(Block block) => block.IsExpanded = !block.IsExpanded;

    int PendingCount(Block block)
    {
        int count = 0;
        foreach (var t in block.SubTasks)
        {
            switch (t)
            {
                case BaseTask bt:
                    if (!bt.IsCompleted) count++;
                    break;
                case SelfAssessment sa:
                    if (!sa.IsCompleted) count++;
                    break;
                case ClientServiceTask cs:
                    // SOLO contar ACTIVIDADES reales
                    if (!string.IsNullOrEmpty(cs.Actividad) && !cs.IsCompleted)
                        count++;
                    break;

            }
        }
        return count;
    }

    async Task ToggleComplete(BaseTask bt, ChangeEventArgs e)
    {
        if (e?.Value is bool b) bt.IsCompleted = b;
        else
        {
            bool parsed = false;
            if (e?.Value is string s) parsed = s == "true" || s == "on";
            bt.IsCompleted = parsed;
        }

        await ShowTemporaryToastAsync(bt.IsCompleted ? $"Marcaste '{bt.Name}' como completada" : $"Desmarcaste '{bt.Name}'");
        // TODO: Llamar a AgendaService para persistir cambio si lo deseas
    }

    async Task ToggleCompleteSelf(SelfAssessment sa, ChangeEventArgs e)
    {
        bool nuevoValor;

        if (e?.Value is bool b)
            nuevoValor = b;
        else if (e?.Value is string s)
            nuevoValor = s == "true" || s == "on";
        else
            return;

        // Optimistic UI
        sa.IsCompleted = nuevoValor;

        try
        {
            await AutoevaluacionService.MarcarRegistroRealizadoAsync(
                sa.IdRegistro,
                nuevoValor
            );

            await ShowTemporaryToastAsync(
                nuevoValor
                    ? "Autoevaluación marcada como realizada"
                    : "Autoevaluación desmarcada"
            );
        }
        catch
        {
            sa.IsCompleted = !nuevoValor;

            await ShowTemporaryToastAsync(
                "Error al guardar la autoevaluación"
            );
        }
    }


    async Task ToggleCompleteClient(ClientServiceTask cs, ChangeEventArgs e)
    {
        if (e?.Value is bool b) cs.IsCompleted = b;
        else
        {
            bool parsed = false;
            if (e?.Value is string s) parsed = s == "true" || s == "on";
            cs.IsCompleted = parsed;
        }
        await ShowTemporaryToastAsync(cs.IsCompleted ? "Actividad completada" : "Actividad desmarcada");
    }


    void RecalcularEstadoServicioCliente(Block bloque)
    {


        var all = bloque.SubTasks
            .OfType<ClientServiceTask>()
            .ToList();

        var actividades = all
            .Where(x => !string.IsNullOrEmpty(x.Actividad))
            .ToList();

        var servicios = all
            .Where(x =>
                !string.IsNullOrEmpty(x.Servicio) &&
                string.IsNullOrEmpty(x.Actividad))
            .ToList();

        var empresas = all
            .Where(x =>
                string.IsNullOrEmpty(x.Servicio) &&
                string.IsNullOrEmpty(x.Actividad))
            .ToList();

        Debug.WriteLine($"ALL: {all.Count}");
        Debug.WriteLine($"ACTIVIDADES: {actividades.Count}");
        Debug.WriteLine($"SERVICIOS: {servicios.Count}");
        Debug.WriteLine($"EMPRESAS: {empresas.Count}");

      
        // ===== SERVICIOS =====
        foreach (var servicio in servicios)
        {
            var acts = actividades
                .Where(a =>
                    a.Empresa == servicio.Empresa &&
                    a.Servicio == servicio.Servicio)
                .ToList();

            servicio.IsCompleted =
                acts.Count > 0 &&
                acts.All(a => a.IsCompleted);

            // ✅ DEBUG CORRECTO
            Debug.WriteLine(
                $"Servicio [{servicio.Servicio}] | Actividades: {acts.Count} | Completado: {servicio.IsCompleted}"
            );
        }


        foreach (var empresa in empresas)
        {
            var actsEmpresa = actividades
                .Where(a => a.Empresa == empresa.Empresa)
                .ToList();

            var serviciosEmpresa = actsEmpresa
                .GroupBy(a => a.Servicio)
                .ToList();

            bool empresaCompleta =
                serviciosEmpresa.Count > 0 &&
                serviciosEmpresa.All(g => g.All(a => a.IsCompleted));

            empresa.IsCompleted = empresaCompleta;

            foreach (var servicioGroup in serviciosEmpresa)
            {
                bool servicioCompleto = servicioGroup.All(a => a.IsCompleted);

                Debug.WriteLine(
                    $"Servicio [{servicioGroup.Key}] | Completado: {servicioCompleto}"
                );
            }

            Debug.WriteLine(
                $"Empresa [{empresa.Empresa}] | Completado: {empresa.IsCompleted}"
            );
        }


    }

    private async Task ToggleServicioClienteAsync(
    ClientServiceTask cs,
    ChangeEventArgs e)
    {
        var nuevoEstado = (bool)e.Value;

        // Optimistic UI
        cs.IsCompleted = nuevoEstado;
        cs.FechaCompletada = nuevoEstado ? DateTime.Now : null;

        var ok = await ServicioClienteService
            .CambiarEstadoServicioClienteAsync(cs.ApiId, nuevoEstado);

        if (!ok)
        {
            cs.IsCompleted = !nuevoEstado;
            cs.FechaCompletada = !nuevoEstado ? DateTime.Now : null;
            StateHasChanged();
            return;
        }

        // 🔁 sincronización por ApiId
        foreach (var day in Days)
        {
            foreach (var block in day.Blocks)
            {
                foreach (var t in block.SubTasks
                    .OfType<ClientServiceTask>()
                    .Where(x => x.ApiId == cs.ApiId))
                {
                    t.IsCompleted = nuevoEstado;
                    t.FechaCompletada = cs.FechaCompletada;
                }

                RecalcularEstadoServicioCliente(block);
            }
        }

        StateHasChanged();
    }




    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            StateHasChanged();
        }
    }



    void InicializarUbicacion(BaseTask bt)
    {
        if (bt.IdSala.HasValue && bt.IdSala > 0)
        {
            salaSeleccionada = bt.IdSala.Value;
        }
        else if (!string.IsNullOrWhiteSpace(bt.Ubicacion))
        {
            salaSeleccionada = 0;
        }
        else
        {
            salaSeleccionada = null;
        }
    }

    BaseTask CreateSnapshot(BaseTask source)
    {
        return new BaseTask
            {
                ApiId = source.ApiId,
                IdAgenda = source.IdAgenda,
                IdPrioridad = source.IdPrioridad,
                Tipo = source.Tipo,

                Name = source.Name,
                Description = source.Description,

                StartDate = source.StartDate,
                DueDate = source.DueDate,

                EsRecurrente = source.EsRecurrente,
                ReglaRecurrencia = source.ReglaRecurrencia,
                Recurrence = source.Recurrence,

                IdSala = source.IdSala,
                Ubicacion = source.Ubicacion,

                HoraInicio = source.HoraInicio,
                HoraFin = source.HoraFin,

                CreadorId = source.CreadorId,
                nombreCreador = source.nombreCreador,

                Participantes = new List<string>(source.Participantes),
                SubTasks = source.SubTasks
                    .Select(st => new BaseSubTask { Name = st.Name })
                    .ToList()
            };
    }

    // void OpenTaskModal(BaseTask task, bool editMode)
    // {
    //     OriginalTask = task;
    //     SelectedTask = CreateSnapshot(task);
    //     SelectedTask.SubTasks = task.SubTasks;

    //     SelectedTaskObject = task;
    //     IsEditMode = editMode;
    //     IsModalOpen = true;

    //     salaSeleccionada = SelectedTask.IdSala.HasValue && SelectedTask.IdSala > 0
    //         ? SelectedTask.IdSala
    //         : null;

    //     InicializarUbicacion(task);
    //     if (task.EsEvento)
    //     {
    //         ParticipantesEdit = todosLosEmpleados
    //             .Where(e => task.Participantes.Contains(e.Nombre))
    //             .Select(e => new ParticipanteDTO
    //             {
    //                 idEmpleado = e.Id,
    //                 nombreEmpleado = e.Nombre
    //             })
    //             .ToList();
    //     }
    //     else
    //     {
    //         ParticipantesEdit.Clear();
    //     }
    // }
    void OpenTaskModal(object item, bool editMode) // Cambiamos BaseTask por object para aceptar ambos
    {
        // 1. Limpieza total preventiva (Reset)
        CloseTaskModal();

        // 2. Asignación del objeto principal
        SelectedTaskObject = item;
        IsEditMode = editMode;
        IsModalOpen = true;

        // 3. Lógica específica según el tipo
        if (item is BaseTask task)
        {
            OriginalTask = task;
            SelectedTask = CreateSnapshot(task);
            SelectedTask.SubTasks = task.SubTasks;

            salaSeleccionada = SelectedTask.IdSala.HasValue && SelectedTask.IdSala > 0
                ? SelectedTask.IdSala
                : null;

            InicializarUbicacion(task);

            if (task.EsEvento)
            {
                ParticipantesEdit = todosLosEmpleados
                    .Where(e => task.Participantes.Contains(e.Nombre))
                    .Select(e => new ParticipanteDTO
                    {
                        idEmpleado = e.Id,
                        nombreEmpleado = e.Nombre
                    })
                    .ToList();
            }
        }
        else if (item is SelfAssessment sa)
        {
            // Si la autoevaluación necesita lógica previa, va aquí
            SelectedTask = null; // Nos aseguramos que no haya una tarea estorbando
            ParticipantesEdit.Clear();
        }
    }


    void OpenSelfAssessmentModal(SelfAssessment sa)
    {
        SelectedTaskObject = null;
        IsModalOpen = false;

        SelectedTaskObject = sa;
        IsEditMode = false;
        IsModalOpen = true;
    }

    // void CloseTaskModal()
    // {
    //     SelectedTask = null;
    //     OriginalTask = null;
    //     salaSeleccionada = null;

    //     IsModalOpen = false;
    //     IsEditMode = false;
    // }
    void CloseTaskModal()
    {
        // Limpia las referencias específicas
        SelectedTask = null;
        OriginalTask = null;
        salaSeleccionada = null;

        // ¡ESTA ES LA CLAVE!
        // Si no la limpias, el próximo modal puede heredar datos del anterior
        SelectedTaskObject = null;

        IsModalOpen = false;
        IsEditMode = false;

        // Opcional: Limpiar búsquedas de empleados si usas la misma variable
        BusquedaEmpleado = string.Empty;
    }
    void OpenClientModal(ClientServiceTask cs)
    {
        SelectedClientTask = cs;
        IsClientModalOpen = true;
    }

    void CloseClientModal()
    {
        SelectedClientTask = null;
        IsClientModalOpen = false;
    }
    private ClientServiceTask? SelectedClientTask { get; set; }
    private bool IsClientModalOpen { get; set; } = false;

    string GetModalTitle()
    {
        if (SelectedTaskObject is BaseTask bt)
            return bt.Tipo switch
            {
                "Tarea" => "Tarea",
                _ => "Detalles de la tarea"
            };
        else if (SelectedTaskObject is SelfAssessment)
            return "Registro de Autoevaluación";

        return "Detalles";
    }

    void ConfirmDelete(BaseTask bt)
    {
        TaskToDelete = bt;
        ShowConfirmDelete = true;
    }

    async Task DeleteConfirmedAsync()
    {
        if (TaskToDelete is not BaseTask bt || bt.ApiId <= 0)
            return;

        if (bt.EsEvento)
        {
            await AgendaService.EliminarEventoAsync(bt.ApiId);
            await ShowTemporaryToastAsync("🗑️ Evento eliminado");
        }
        else
        {
            await AgendaService.EliminarTareaAsync(bt.ApiId);
            await ShowTemporaryToastAsync("🗑️ Tarea eliminada");
        }

        bt.ParentBlock?.SubTasks.Remove(bt);

        TaskToDelete = null;
        ShowConfirmDelete = false;
    }

    async Task SaveTask()
    {
        if (SelectedTask is not BaseTask bt || OriginalTask == null)
            return;

        if (!ValidarFechas(bt))
            return;

        SincronizarSnapshot(bt);

        if (bt.EsEvento)
        {
            await GuardarEvento(OriginalTask);
        }
        else
        {
            await GuardarTarea(OriginalTask);
        }

        IsEditMode = false;
        IsModalOpen = false;

        await ShowSuccessAlert($"✅ '{bt.Name}' se guardó correctamente");
    }

    bool ValidarFechas(BaseTask bt)
    {
        if (bt.DueDate < bt.StartDate)
        {
            _ = ShowTemporaryToastAsync(
            "❌ La fecha fin no puede ser menor a la fecha inicio"
        );
            return false;
        }
        return true;
    }

    void SincronizarSnapshot(BaseTask bt)
    {
        OriginalTask.Name = bt.Name;
        OriginalTask.Description = bt.Description;
        OriginalTask.StartDate = bt.StartDate;
        OriginalTask.DueDate = bt.DueDate;
        OriginalTask.IdPrioridad = bt.IdPrioridad;
        OriginalTask.EsRecurrente = bt.EsRecurrente;
        OriginalTask.ReglaRecurrencia = bt.ReglaRecurrencia;
        OriginalTask.Recurrence = bt.Recurrence;
        OriginalTask.IdSala = bt.IdSala;
        OriginalTask.Ubicacion = bt.Ubicacion;
        OriginalTask.HoraInicio = bt.HoraInicio;
        OriginalTask.HoraFin = bt.HoraFin;
        OriginalTask.Participantes = bt.Participantes.ToList();
    }

    async Task GuardarTarea(BaseTask bt)
    {
        if (bt.Recurrence == "No repetir" || string.IsNullOrWhiteSpace(bt.Recurrence))
        {
            bt.EsRecurrente = false;
            bt.ReglaRecurrencia = null;
        }
        else
        {
            bt.EsRecurrente = true;
            bt.ReglaRecurrencia = bt.Recurrence;
        }

        Debug.WriteLine("SubTasks antes de enviar:");
        foreach (var st in bt.SubTasks)
            Debug.WriteLine($"- {st.Name}");

        var dto = new TareaEditDTO
        {
            titulo = bt.Name,
            descripcion = bt.Description,
            fechaInicio = CombinarFechaHora(bt.StartDate, new TimeOnly(0, 0)),
            fechaFin = CombinarFechaHora(bt.DueDate, new TimeOnly(0, 0)),
            esRecurrente = bt.EsRecurrente,
            reglaRecurrencia = bt.ReglaRecurrencia,
            idPrioridad = bt.IdPrioridad,
            subTareas = SelectedTask.SubTasks
            .Select(s => new EditableSubtask { Titulo = s.Name })
            .ToList()
        };
        await AgendaService.EditarTareaRawAsync(bt.ApiId, dto);
    }
 
    async Task GuardarEvento(BaseTask bt)
    {
        if (salaSeleccionada.HasValue && salaSeleccionada > 0)
        {
            bt.IdSala = salaSeleccionada.Value;
            bt.Ubicacion = null;
        }
        else
        {
            bt.IdSala = null;
        }

        if (bt.Recurrence == "No repetir" || string.IsNullOrWhiteSpace(bt.Recurrence))
        {
            bt.EsRecurrente = false;
            bt.ReglaRecurrencia = null;
        }
        else
        {
            bt.EsRecurrente = true;
            bt.ReglaRecurrencia = bt.Recurrence;
        }

        var dto = new EventoEditDTO
        {
            titulo = bt.Name,
            descripcion = bt.Description,
            fechaInicio = CombinarFechaHora(bt.StartDate, bt.HoraInicio),
            fechaFin = CombinarFechaHora(bt.DueDate, bt.HoraFin),
            esRecurrente = bt.EsRecurrente,
            reglaRecurrencia = bt.ReglaRecurrencia,
            idPrioridad = bt.IdPrioridad,
            idSala = bt.IdSala,
            ubicacion = bt.IdSala == null ? bt.Ubicacion : null,

            idsParticipantes = ParticipantesEdit
                .Where(p => p.idEmpleado > 0)
                .Select(p => p.idEmpleado)
                .Distinct()
                .ToList()
        };

        await AgendaService.EditarEventoRawAsync(bt.ApiId, dto);

        bt.Participantes = ParticipantesEdit
        .Select(p => p.nombreEmpleado)
        .ToList();
    }

    DateTime CombinarFechaHora(DateTime? fecha, TimeOnly? hora)
    {
        if (fecha == null || hora == null)
            return DateTime.MinValue;

        var dt = fecha.Value.Date
            .AddHours(hora.Value.Hour)
            .AddMinutes(hora.Value.Minute);

        return DateTime.SpecifyKind(dt, DateTimeKind.Unspecified);
    }


    void CancelEdit()
    {
        IsEditMode = false;
        SelectedTask = null;
        OriginalTask = null;
        salaSeleccionada = null;

        IsModalOpen = false;
        IsEditMode = false;
    }

    async Task ShowSuccessAlert(string message)
    {
        await JSRuntime.InvokeVoidAsync("Swal.fire", new
        {
            icon = "success",
            title = message,
            showConfirmButton = true,
            confirmButtonColor = "#0B3C4A",
            timer = 2000
        });
    }

    async Task ShowTemporaryToastAsync(string message, int milliseconds = 1600)
    {
        ToastMessage = message;
        ShowToast = true;
        StateHasChanged();
        await Task.Delay(milliseconds);
        ShowToast = false;
        StateHasChanged();
    }
}

<style>
    /* ======== OVERLAY Y MODAL CENTRAL ======== */
   .view-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
}

    .bento-modal {
        background: #ffffff;
        width: 100%;
        max-width: 850px;
        /* 1. ALTURA FIJA MÁXIMA: Esto impide que el modal crezca más que la pantalla */
        max-height: 75vh;
        border-radius: 32px;
        padding: 30px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        /* 2. FLEX COLUMN: Obliga a que Header, Grid y Footer se alineen verticalmente */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    /* ======== HEADER ======== */
   .bento-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    flex-shrink: 0; 
}
    .type-tag {
        background: #f1f5f9;
        color: #475569;
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 800;
    }

    .title-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
    }

        .title-row h3 {
            font-size: 24px;
            font-weight: 800;
            color: #1e293b;
            margin: 0;
        }

    .title-input {
        border: none !important;
        background: #f8fafc !important;
        padding: 5px 10px !important;
        font-size: 24px !important;
        font-weight: 800 !important;
        border-radius: 8px;
        width: 100%;
    }

    .bento-close {
        background: #f1f5f9;
        border: none;
        font-size: 22px;
        color: #94a3b8;
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
    }

        .bento-close:hover {
            background: #e2e8f0;
            color: #64748b;
        }

    /* ======== GRID SCROLLABLE (Cuerpo del modal) ======== */
    .bento-grid {
       display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    overflow-y: auto;
    padding-right: 10px; 
    margin-bottom: 20px;
    flex-grow: 1;
    }

        /* Personalización del scrollbar */
        .bento-grid::-webkit-scrollbar {
            width: 6px;
        }

        .bento-grid::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

    .bento-item {
        background: #f8fafc;
        border: 1px solid #f1f5f9;
        border-radius: 20px;
        padding: 20px;
    }

    .full-width {
        grid-column: span 2;
    }

    
    .bento-item label {
        font-size: 11px;
        font-weight: 800;
        color: #64748b;
        margin-bottom: 12px;
        display: block;
    }

    /* ======== INPUTS Y SELECTS ======== */
    .bento-input-style {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        transition: 0.2s;
        outline: none;
    }

        .bento-input-style:focus {
            border-color: #3b82f6;
            background: #fff;
        }

    /* ======== PLANIFICACIÓN (FECHAS Y HORAS) ======== */
    .plan-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .plan-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
    }

    .edit-date-row {
        display: flex;
        flex-wrap: wrap; /* Permite que bajen si no caben */
        gap: 8px;
        width: 100%;
        margin-top: 5px;
    }

        /* Ajuste específico para tus componentes de Fecha/Hora */
        .edit-date-row > * {
            flex: 1;
            min-width: 120px; /* Evita que se aplasten */
        }

    /* ======== TAGS DE PARTICIPANTES ======== */
    .names-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 180px; /* Límite para que no crezca el modal */
        overflow-y: auto;
        padding: 5px;
    }

    .full-name-tag {
        background: white;
        border: 1px solid #e2e8f0;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .remove-tag {
        background: #fee2e2;
        color: #ef4444;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        padding: 0 5px;
        line-height: 1;
    }

    /* ======== SUBTAREAS ======== */
    .subtasks-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .subtask-card {
        background: white;
        padding: 12px;
        border-radius: 12px;
        border-left: 4px solid #3b82f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        font-weight: 600;
    }

    .add-subtask-box {
        grid-column: span 2;
        display: flex;
        gap: 8px;
        margin-top: 10px;
    }

    .add-btn-circle {
        background: #3b82f6;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 12px;
        font-size: 20px;
        cursor: pointer;
        flex-shrink: 0;
    }

    /* ======== FOOTER ======== */
    .bento-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        /* CAMBIO: Antes tenías padding-top: 20px y heredaba el padding del modal */
        padding: 10px 10px; /* 10px arriba y abajo, 30px a los lados */
        border-top: 1px solid #f1f5f9;
        flex-shrink: 0;
        background: #ffffff;
    }

    .bento-btn {
        padding: 12px 25px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        border: none;
        transition: 0.2s;
    }

    .close-red {
        background: #ff5a5f;
        color: white;
    }

    .save {
        background: #10b981;
        color: white;
    }

    .cancel {
        background: #ff5a5f;
        color: white;
    }

    .bento-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    /* ======== ESTILOS PARA INPUTS DE HORA (TimePicker) ======== */

    /* Contenedor de la fila de edición para que no se amontonen */
    .edit-date-row {
        display: flex;
        align-items: center;
        gap: 10px; /* Espacio entre calendario y hora */
        margin-top: 8px;
        width: 100%;
    }

        /* Estilo para el input de hora específico */
        input[type="time"],
        .edit-date-row select,
        .edit-date-row input {
            background-color: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 12px; /* Redondeado tipo Bento */
            padding: 8px 12px;
            font-size: 14px;
            color: #1e293b;
            font-family: inherit;
            outline: none;
            transition: all 0.2s ease;
            box-shadow: none;
            -webkit-appearance: none; /* Quita estilos nativos de iOS/Chrome si estorban */
        }

            /* Efecto Focus para las horas */
            input[type="time"]:focus {
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

        /* Ajuste para que el DatePicker y el TimePicker compartan espacio equitativo */
        .edit-date-row > * {
            flex: 1;
            min-width: 0; /* Evita que los inputs se desborden */
        }

    /* Estilo para el icono del reloj dentro del input (en navegadores compatibles) */
    input[type="time"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        filter: invert(48%) sepia(13%) saturate(3207%) hue-rotate(185deg) brightness(95%) contrast(80%); /* Color azulado sutil */
    }

    /* ======== MEJORA DE LAS X Y BOTONES DE ELIMINAR ======== */
    .remove-tag, .remove-sub {
        background: #fee2e2 !important;
        color: #ef4444 !important;
        border: none;
        border-radius: 6px;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        transition: 0.2s;
        margin-left: 5px;
    }

        .remove-tag:hover {
            background: #fecaca !important;
            transform: scale(1.1);
        }

    /* ======== RESPONSIVIDAD ======== */
    @@media (max-width: 600px) {
        .bento-grid

    {
        grid-template-columns: 1fr;
    }

    .subtasks-grid {
        grid-template-columns: 1fr;
    }

    .add-subtask-box {
        grid-column: span 1;
    }

    }
    /*ESTILOS DE LOS DIAS NO LABORALES*/
    /* ===============================
           DÍA NO LABORAL – ESTILO SUAVE
           =============================== */

    .day-card.dia-no-laboral {
        background: linear-gradient( 180deg, #fdf2f2 0%, #fae8e8 100% );
        border: 1.5px dashed #FF4D4D;
        border-radius: 16px;
        color: #FFECEC;
        pointer-events: none;
        transition: all 0.3s ease;
    }

        /* Header */
        .day-card.dia-no-laboral .day-header {
            background: transparent;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* Nombre del día */
        .day-card.dia-no-laboral .day-name {
            font-weight: 600;
            text-transform: capitalize;
            color: #7a2c2c;
        }

        /* Número del día */
        .day-card.dia-no-laboral .day-date {
            background: #ffffff;
            color: #e25555;
            font-weight: 600;
            border-radius: 12px;
            padding: 6px 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        /* Ocultar tareas */
        .day-card.dia-no-laboral .blocks-list {
            display: none !important;
        }

    /* Contenido central */
    .no-laboral-info {
        margin-top: 28px;
        text-align: center;
        padding: 18px 14px;
        background: rgba(255,255,255,0.65);
        border-radius: 14px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
    }

        /* Icono */
        .no-laboral-info::before {
            content: "🚫📅";
            display: block;
            font-size: 1.6rem;
            margin-bottom: 6px;
        }

    /* Texto principal */
    .no-laboral-info {
        font-size: 0.95rem;
        font-weight: 500;
        color: #7a2c2c;
    }

        /* Descripción */
        .no-laboral-info small {
            display: block;
            margin-top: 6px;
            font-size: 0.85rem;
            color: #8f4a4a;
            opacity: 0.9;
        }

    /* Sin hover agresivo */
    .day-card.dia-no-laboral:hover {
        box-shadow: none;
        transform: none;
        cursor: default;
    }


    .day-card.sabado {
        background: #f5f5f5;
        opacity: 0.8;
    }


    /* Contenedor principal */
    .agenda-container {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: #fff;
        padding: 18px;
        border-radius: 12px;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        overflow: hidden;
    }

    .badge-pendientes {
        background-color: rgba(255, 255, 255, 0.5);
        color: #333;
        font-weight: 700;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        /* Corregido */
        display: flex;
        justify-content: center;
        align-items: center;
        min-width: 28px; /* Tamaño perfecto */
        height: 22px; /* Mantiene forma uniforme */
    }

    /* Header */
    .agenda-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .header-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1 1 auto;
    }

        .header-center h1 {
            margin: 0;
            font-size: 30px;
            font-weight: 700;
        }

    .month-pill {
        margin-top: 6px;
        background: linear-gradient(90deg,#f7f7f7,#fff);
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 600;
        color: #0b3c4a;
        box-shadow: 0 2px 6px rgba(11,60,74,0.06);
    }

    /* Botones */
    .btn {
        background: linear-gradient(90deg,#1e7a3a,#0b3c4a);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
    }

        .btn.primary {
            background: linear-gradient(90deg,#1e7a3a,#0b3c4a);
        }

        .btn:hover {
            background: linear-gradient(90deg, #155d2b, #062b35); /* tonos más oscuros */
            color: white; /* asegura que el texto siga siendo blanco */
            transform: translateY(-1px);
        }

    .arrow {
        font-weight: 700;
    }

    /* Grid de días */
    .days-grid.weekly {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 12px;
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 6px;
    }

    /* Tarjetas de día */
    .day-card {
        background: #f9fafb;
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 100%;
        overflow-y: auto;
    }

    /* Header del día */
    .day-header {
        display: flex;
        justify-content: space-between;
        font-weight: 700;
        text-transform: capitalize;
    }

    /* Lista de bloques */
    .blocks-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* Bloques individuales */
    .list-item {
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        transition: transform .12s ease;
    }

        .list-item:hover {
            transform: translateY(-3px);
        }

    .list-title {
        font-weight: 700;
        margin-bottom: 8px;
        user-select: none;
        cursor: pointer;
        display: grid;
        grid-template-columns: 1fr auto auto; /* Título | Badge | Flecha */
        align-items: center; /* Alinea TODO verticalmente al centro */
        gap: 8px;
    }


    .chev {
        font-size: 12px;
        opacity: 0.8;
        margin-left: 10px;
    }

    /* Subtareas */
    .subtasks {
        list-style: none;
        padding-left: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 300px;
        overflow-y: auto;
    }

    /* Ítems de tarea */
    .task-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 6px 4px;
        border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        flex: 0 0 18px;
        margin-right: 8px;
        cursor: pointer;
    }

    /* Nombre de la tarea */
    .task-name {
        flex-grow: 1;
        cursor: pointer;
        user-select: none;
        padding-right: 8px;
        transition: all 0.2s ease;
    }

    /* === Igual funcionalidad que subtareas === */
    .completed-task,
    .task-name.completed {
        text-decoration: line-through; /* misma línea encima */
        opacity: 0.6; /* más tenue */
        transition: all 0.2s ease;
    }

    /* Acciones de la tarea (botones) */
    .task-actions {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    /* Opcional: efecto al pasar el mouse por encima */
    .task-item:hover .task-name {
        color: #0B3C4A;
        font-weight: 600;
    }

    /* Botones de editar y eliminar */
    .edit-btn, .delete-btn {
        font-size: 14px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px;
        border-radius: 8px;
    }

        .edit-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .delete-btn:hover {
            background: rgba(255,0,0,0.06);
        }

    .workorder {
        font-weight: 700;
    }

    /* Modal */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(11,60,74,0.65);
        z-index: 1000;
    }

    .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        background: #FEFEFE;
        padding: 18px;
        border-radius: 12px;
        z-index: 1001;
        width: 90%;
        max-width: 640px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 12px 35px rgba(0,0,0,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .close-btn {
        font-size: 24px;
        background: none;
        border: none;
        cursor: pointer;
        color: #0B3C4A;
    }

    .form-group {
        margin-bottom: 10px;
    }

        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #eee;
            box-sizing: border-box;
        }

    input:disabled, textarea:disabled, select:disabled {
        background: #f5f5f5;
        color: #444;
    }

    input[type="checkbox"]:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }



    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding-top: 8px;
        border-top: 1px solid #f0f0f0;
    }

    .action-btn {
        padding: 8px 12px;
        font-weight: 700;
        color: white;
        border: none;
        border-radius: 999px;
        cursor: pointer;
    }

        .action-btn.save {
            background: #0B3C4A;
        }

        .action-btn.cancel {
            background: #ef4444;
        }

    /* Confirm modal */
    .confirm-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        z-index: 1002;
        background: white;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.18);
        width: 90%;
        max-width: 420px;
    }

    .confirm-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 12px;
    }

    /* Toast */
    .toast {
        position: fixed;
        right: 18px;
        bottom: 18px;
        background: linear-gradient(90deg,#0B3C4A,#1e7a3a);
        color: white;
        padding: 10px 14px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        z-index: 2000;
        font-weight: 700;
    }



    .btn {
        min-width: auto;
        padding: 8px 10px;
    }

    .task-icon {
        margin-right: 6px;
        font-size: 16px;
    }

    .timepicker-container {
        position: relative;
    }

    .timepicker-input {
        cursor: pointer;
        background-color: #fff;
    }

    .timepicker-panel {
        position: absolute;
        top: 42px;
        left: 0;
        display: flex;
        gap: 6px;
        width: 160px;
        max-height: 240px;
        background: white;
        border: 1px solid #dcdcdc;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0,0,0,.15);
        z-index: 3000;
        padding: 6px;
    }

    .timepicker-column {
        flex: 1;
        max-height: 220px;
        overflow-y: auto;
        border-radius: 6px;
    }

    .timepicker-item {
        padding: 8px 0;
        text-align: center;
        cursor: pointer;
        font-size: 14px;
    }

        .timepicker-item:hover {
            background-color: #f0f7ff;
        }

        .timepicker-item.selected {
            background-color: #0078d4;
            color: white;
            font-weight: 600;
        }
    /* ================= MODAL OVERLAY ================= */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    /* ================= MODAL BASE ================= */
    .modal-content.modern-modal {
        background: #ffffff;
        border-radius: 22px;
        width: 95%;
        max-width: 1100px;
        height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 60px rgba(0,0,0,0.35);
        animation: modalFade 0.25s ease-out;
        overflow: hidden;
    }

    /* ================= HEADER ================= */
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 14px;
        padding: 22px;
        background: linear-gradient(90deg, #1e7a3a, #0b3c4a);
        color: #ffffff;
        font-size: 20px;
        font-weight: 700;
    }

    .modal-icon {
        font-size: 26px;
    }

    /* ================= BODY ================= */
    .modal-body.modal-scroll {
        flex: 1;
        padding: 24px 28px;
        overflow-y: auto;
        background: #f8fafc;
    }

    /* Scroll elegante */
    .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    /* ================= FOOTER ================= */
    .modal-footer {
        padding: 16px;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: center;
    }

        .modal-footer button {
            background: #0b3c4a;
            color: #ffffff;
            border: none;
            border-radius: 10px;
            padding: 10px 28px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

            .modal-footer button:hover {
                background: #145a6a;
            }

    /* ================= CARDS ================= */
    .ot-card,
    .tramite-card {
        background: #ffffff;
        border-radius: 14px;
        border: 1px solid #e5e7eb;
        margin-bottom: 18px;
        overflow: hidden;
    }

    /* ================= COLLAPSIBLE HEADER ================= */
    .collapsible-header {
        background: #f1f5f9;
        padding: 14px 18px;
        font-weight: 600;
        cursor: default;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .collapsible-header:hover {
            background: #e2e8f0;
        }

    /* ================= COLLAPSIBLE CONTENT ================= */
    .collapsible-content {
        padding: 18px;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
    }

    /* ================= INFO GRID ================= */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 14px 22px;
        font-size: 14px;
    }

        .info-grid div {
            background: #f9fafb;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

    /* ================= TABLES ================= */
    .subtasks-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 14px;
    }

        .subtasks-table th {
            background: #f3f4f6;
            padding: 12px;
            font-weight: 600;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .subtasks-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .subtasks-table tr:nth-child(even) {
            background: #fafafa;
        }


    .client-row {
        display: flex;
        align-items: center;
        gap: 6px; /* ⬅️ menos separación horizontal */
        padding: 2px 0; /* ⬅️ menos altura por fila */
        line-height: 1.2;
    }

    .lvl-empresa {
        font-weight: 600;
        margin-top: 2px;
    }

    .lvl-servicio {
        padding-left: 16px; /* ⬅️ menos indent */
        font-weight: 500;
    }

    .lvl-actividad {
        padding-left: 32px; /* ⬅️ menos indent */
    }

    .toggle-icon {
        cursor: pointer;
        width: 12px;
        font-size: 11px;
        color: #444;
    }

    .task-name.completed {
        text-decoration: line-through;
        opacity: 0.6;
    }

    /* =================================================
       SISTEMA DE MODO OSCURO UNIFICADO (BENTO + AGENDA)
       ================================================= */

    /* 1. CONTENEDORES PRINCIPALES Y MODALES */
    [data-theme="dark"] .agenda-container,
    [data-theme="dark"] .bento-modal,
    [data-theme="dark"] .modern-modal,
    [data-theme="dark"] .modal-content {
        background: #15171d !important;
        color: #f3f4f6 !important;
        border: 1px solid #374151;
    }

    /* 2. HEADERS Y TÍTULOS */
    [data-theme="dark"] .bento-header,
    [data-theme="dark"] .modal-header {
        background: #111827 !important;
        border-bottom: 1px solid #374151;
    }

        [data-theme="dark"] .title-row h3,
        [data-theme="dark"] .modal-header h2,
        [data-theme="dark"] .agenda-header h1 {
            color: #ffffff !important;
        }

    /* 3. TARJETAS DE DÍAS (GRID SEMANAL) */
    [data-theme="dark"] .day-card {
        background-color: #1e293b !important;
        border: 1px solid #334155 !important;
        color: #f8fafc !important;
    }

    [data-theme="dark"] .day-header {
        border-bottom: 1px solid #334155 !important;
        color: #f8fafc !important;
    }

    /* 4. DÍAS NO LABORALES (CLASE: .dia-no-laboral) */
    [data-theme="dark"] .day-card.dia-no-laboral {
        background: rgba(127, 29, 29, 0.25) !important; /* Rojo sutil */
        border: 1px solid #991b1b !important; /* Borde rojo sólido */
        box-shadow: none !important;
    }

        /* Forzar textos rojos en el header y el info del día no laboral */
        [data-theme="dark"] .day-card.dia-no-laboral .day-header,
        [data-theme="dark"] .day-card.dia-no-laboral .day-name,
        [data-theme="dark"] .day-card.dia-no-laboral .day-date,
        [data-theme="dark"] .day-card.dia-no-laboral .no-laboral-info {
            color: #f87171 !important;
            background: transparent !important;
            border-bottom-color: rgba(153, 27, 27, 0.5) !important;
        }

        [data-theme="dark"] .day-card.dia-no-laboral .no-laboral-info {
            text-align: center;
            padding: 15px 5px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

    /* 5. ELEMENTOS INTERNOS Y BLOQUES */
    [data-theme="dark"] .bento-item,
    [data-theme="dark"] .ot-card,
    [data-theme="dark"] .tramite-card,
    [data-theme="dark"] .list-item {
        background: #1f2937 !important;
        border: 1px solid #374151 !important;
        color: #e5e7eb !important;
    }

        /* Colores de los bloques (Nth-child) */
        [data-theme="dark"] .list-item:nth-child(1) {
            background-color: rgba(244, 114, 182, 0.2) !important;
            color: #fce7f3 !important;
        }

        [data-theme="dark"] .list-item:nth-child(2) {
            background-color: rgba(251, 146, 60, 0.2) !important;
            color: #ffedd5 !important;
        }

        [data-theme="dark"] .list-item:nth-child(3) {
            background-color: rgba(74, 222, 128, 0.2) !important;
            color: #f0fdf4 !important;
        }

        [data-theme="dark"] .list-item:nth-child(4) {
            background-color: rgba(168, 85, 247, 0.2) !important;
            color: #f5f3ff !important;
        }

    /* 6. FORMULARIOS Y TABLAS */
    [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] textarea {
        background-color: #111827 !important;
        border: 1px solid #4b5563 !important;
        color: #ffffff !important;
    }

    [data-theme="dark"] .subtasks-table th {
        background: #374151 !important;
        color: #ffffff !important;
    }

    [data-theme="dark"] .subtasks-table td {
        border-bottom: 1px solid #374151 !important;
        color: #d1d5db !important;
    }

    /* 7. ACTIVIDADES COMPLETADAS */
    [data-theme="dark"] .actividad-completada,
    [data-theme="dark"] .realizado {
        color: #6b7280 !important;
        opacity: 0.5 !important;
        text-decoration: line-through !important;
    }

    Tienes razón, al aplicar los fondos con transparencia (rgba), el texto pierde contraste cuando el navegador aplica el filtro de oscurecimiento por defecto o cuando el fondo cambia en el hover.

    Para arreglarlo, vamos a añadir una regla que brille un poco más la tarjeta y mantenga el texto en blanco puro o en el color vibrante original cuando pases el mouse.

    Añade este bloque al final de tu CSS de modo oscuro:

    CSS
    /* =================================================
       ESTILOS HOVER PARA ACTIVIDADES (MODO OSCURO)
       ================================================= */
    /* 1. Efecto general para cualquier list-item en hover */
    [data-theme="dark"] .list-item:hover {
        filter: brightness(1.3) !important; /* Aclara la tarjeta en lugar de oscurecerla */
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
    }

    /* 2. Mantener el color del texto brillante en hover para cada tipo */
    [data-theme="dark"] .list-item:nth-child(1):hover {
        color: #ffffff !important;
        background-color: rgba(244, 114, 182, 0.35) !important;
    }

    [data-theme="dark"] .list-item:nth-child(2):hover {
        color: #ffffff !important;
        background-color: rgba(251, 146, 60, 0.35) !important;
    }

    [data-theme="dark"] .list-item:nth-child(3):hover {
        color: #ffffff !important;
        background-color: rgba(74, 222, 128, 0.35) !important;
    }

    [data-theme="dark"] .list-item:nth-child(4):hover {
        color: #ffffff !important;
        background-color: rgba(168, 85, 247, 0.35) !important;
    }

    /* 3. Asegurar que los íconos o spans internos no se oscurezcan */
    [data-theme="dark"] .list-item:hover span,
    [data-theme="dark"] .list-item:hover i {
        color: #ffffff !important;
    }

    CSS
    /* =================================================
       CORRECCIÓN FINAL: ELIMINACIÓN DE BLANCOS EN MODALES
       ================================================= */
    /* 1. Forzar el fondo del Modal y sus secciones */
    [data-theme="dark"] .bento-modal,
    [data-theme="dark"] .modal-content,
    [data-theme="dark"] .modal-body,
    [data-theme="dark"] .modal-footer {
        background-color: #111827 !important; /* Fondo oscuro profundo */
        background: #111827 !important;
        color: #f3f4f6 !important;
        border-color: #374151 !important;
    }

    /* 2. Limpiar las etiquetas de nombres (Equipo de Trabajo) */
    /* Según tu imagen image_782efb.png, estos son los que se ven blancos */
    [data-theme="dark"] .full-name-tag,
    [data-theme="dark"] .participant-item,
    [data-theme="dark"] .equipo-item {
        background-color: #1f2937 !important; /* Gris azulado oscuro */
        color: #e5e7eb !important;
        border: 1px solid #4b5563 !important;
    }

    /* 3. Limpiar el recuadro blanco del "Día no laboral" */
    /* En tu imagen image_77b759.png se ve un card blanco dentro de la columna */
    [data-theme="dark"] .no-laboral-info,
    [data-theme="dark"] .day-card.dia-no-laboral .no-laboral-info {
        background-color: rgba(127, 29, 29, 0.1) !important; /* Fondo rojizo casi transparente */
        background: transparent !important;
        border: 1px solid rgba(248, 113, 113, 0.2) !important;
        color: #f87171 !important;
    }

    /* 4. Inputs y elementos de formulario que podrían seguir blancos */
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-group input,
    [data-theme="dark"] .bento-input-style {
        background-color: #0f172a !important;
        color: #ffffff !important;
        border: 1px solid #374151 !important;
    }

    /* 5. Hover para actividades (Modo Oscuro) */
    [data-theme="dark"] .list-item:hover {
        filter: brightness(1.2) !important;
        background-color: rgba(255, 255, 255, 0.05) !important;
    }

    /* 1. El Footer (donde está el botón Cerrar) */
    [data-theme="dark"] .modal-footer,
    [data-theme="dark"] .bento-footer {
        background-color: #111827 !important; /* Azul profundo */
        background: #111827 !important;
        border-top: 1px solid #374151 !important;
    }

    /* 2. Los ítems del equipo (Filas blancas con tachuelas/pins) */
    [data-theme="dark"] .full-name-tag,
    [data-theme="dark"] .equipo-item,
    [data-theme="dark"] .participant-item,
    [data-theme="dark"] .modal-body .list-group-item {
        background-color: #1f2937 !important; /* Gris oscuro */
        color: #e5e7eb !important;
        border: 1px solid #374151 !important;
        margin-bottom: 8px; /* Espaciado para que no se peguen */
    }

    /* 3. El contenedor blanco del aviso "Día no laboral" */
    [data-theme="dark"] .no-laboral-info {
        background-color: rgba(127, 29, 29, 0.1) !important;
        background: transparent !important;
        border: none !important;
        color: #f87171 !important;
    }

    /* 4. Ajuste para el botón Cerrar (Opcional por si quieres que no brille tanto) */
    [data-theme="dark"] .btn-close-custom {
        box-shadow: none !important;
    }

    /* 5. Asegurar que los textos dentro de las filas del equipo sean legibles */
    [data-theme="dark"] .full-name-tag span,
    [data-theme="dark"] .equipo-item i {
        color: #9ca3af !important; /* Gris claro para íconos */
    }

    /* =================================================
       MODO OSCURO: TARJETAS DE SUBTAREAS (SUBTASK-CARD)
       ================================================= */

    [data-theme="dark"] .subtask-card {
        /* Un fondo ligeramente más claro que el fondo del modal (#0f172a)
           para que se note la elevación */
        background: #1e293b !important;
        /* Mantenemos el borde izquierdo para el color de prioridad/estado */
        border-left: 4px solid #3b82f6 !important;
        /* Texto en blanco suave para que no canse la vista */
        color: #f1f5f9 !important;
        /* Sombra sutil para separar del fondo */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        /* Espaciados consistentes */
        padding: 12px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px; /* Separación entre tarjetas */
    }

        /* Efecto Hover para que se sienta interactivo */
        [data-theme="dark"] .subtask-card:hover {
            background: #2d3748 !important;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        /* Ajuste para los iconos o botones dentro de la card si existen */
        [data-theme="dark"] .subtask-card .view-icon,
        [data-theme="dark"] .subtask-card i {
            color: #94a3b8 !important;
        }

    [data-theme="dark"] .remove-tag, .remove-sub {
        background: #1e293b !important;
   
    }

</style>