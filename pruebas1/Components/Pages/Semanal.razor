@page "/semanal"
@using System
@using System.Collections.Generic
@using System.Globalization
@inject IJSRuntime JSRuntime
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="agenda-container">

    <header class="agenda-header">
        <button class="btn" @onclick="PrevWeek">
            <span class="arrow">&#9664;</span> Semana anterior
        </button>

        <div class="header-center">
            <h1>Semana @WeekNumber -@MonthName @CurrentDate.Year</h1>
            
        </div>

        <button class="btn primary" @onclick="NextWeek">
            Semana siguiente <span class="arrow">&#9654;</span>
        </button>
    </header>

    <div class="days-grid weekly">
        @foreach (var day in Days.Where(d => d.Date.DayOfWeek != DayOfWeek.Sunday))
        {
            <div class="day-card">
                <div class="day-header">
                    <span class="day-name">@day.Date.ToString("dddd", new CultureInfo("es-ES"))</span>
                    <span class="day-date">@day.Date.ToString("dd")</span>
                </div>

                <div class="blocks-list">
                    @foreach (var block in day.Blocks)
                    {
                        <div class="list-item" style="background-color:@block.Color">
                            <div class="list-title" @onclick="() => ToggleBlock(block)">
                                @block.Title
                                <span class="chev">@((block.IsExpanded ? "▼" : "►"))</span>
                            </div>

                            @if (block.IsExpanded)
                            {
                                <ul class="subtasks">
                                    @foreach (var task in block.SubTasks)
                                    {
                                        <li class="task-item">
                                            @if (task is BaseTask bt)
                                            {
                                                @if (block.Title != "Órdenes de Trabajo")
                                                {
                                                    <input type="checkbox"
                                                           @onchange="(e) => ToggleComplete(bt, e)"
                                                           checked="@bt.IsCompleted"
                                                           @onclick:stopPropagation />
                                                    <span class="task-name @(bt.IsCompleted ? "completed" : "")"
                                                          @onclick="() => OpenTaskModal(bt, false)">
                                                        @bt.Name
                                                    </span>
                                                    <div class="task-actions">
                                                        <button class="edit-btn"
                                                                title="Editar"
                                                                @onclick="(MouseEventArgs e) => OpenTaskModal(bt, true)"
                                                                @onclick:stopPropagation="true">
                                                            ✏️
                                                        </button>

                                                        <button class="delete-btn"
                                                                title="Eliminar"
                                                                @onclick="(MouseEventArgs e) => ConfirmDelete(bt)"
                                                                @onclick:stopPropagation="true">
                                                            🗑️
                                                        </button>
                                                    </div>

                                                }
                                                else
                                                {
                                                    <!-- Órdenes de Trabajo: solo mostrar nombre -->
                                                    <span class="workorder">@bt.Name</span>
                                                }
                                            }
                                            else if (task is SelfAssessment sa)
                                            {
                                               
                                                <input type="checkbox"
                                                       @onchange="(e) => ToggleCompleteSelf(sa, e)"
                                                       checked="@sa.IsCompleted"
                                                       @onclick:stopPropagation />
                                                <span class="task-name @(sa.IsCompleted ? "completed" : "")"
                                                      @onclick="() => OpenTaskModal(sa, false)">
                                                    @sa.ActivityName
                                                </span>
                                            }

                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- Modal de Tarea (editar/ver) -->
@if (IsModalOpen && SelectedTaskObject != null)
{
    <div class="modal-backdrop" @onclick="CloseTaskModal"></div>

    <div class="modal-content" @onclick:stopPropagation>
        <div class="modal-header">
            <h2>@GetModalTitle()</h2>
            <button class="close-btn" @onclick="CloseTaskModal">&times;</button>
        </div>

        <div class="modal-body">
            @if (SelectedTaskObject is BaseTask bt)
            {
                <div class="form-group">
                    <label>Actividad:</label>
                    <input type="text" @bind="bt.Name" disabled="@(!IsEditMode)" />
                </div>
                <div class="form-group">
                    <label>Descripción:</label>
                    <textarea @bind="bt.Description" disabled="@(!IsEditMode)"></textarea>
                </div>
                <div class="form-group">
                    <label>Prioridad:</label>
                    <select @bind="bt.Priority" disabled="@(!IsEditMode)">
                        <option value="Alta">🔴 Alta</option>
                        <option value="Media">🟡 Media</option>
                        <option value="Baja">🟢 Baja</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Recurrencia:</label>
                    <select @bind="bt.Recurrence" disabled="@(!IsEditMode)">
                        <option value="No repetir">No repetir</option>
                        <option value="Diario">Diario</option>
                        <option value="Semanal">Semanal</option>
                        <option value="Quincenal">Quincenal</option>
                        <option value="Mensual">Mensual</option>
                        <option value="Anual">Anual</option>
                    </select>
                </div>
                <div class="form-group inline">
                    <label>Fecha inicio</label>
                    <input type="date" @bind="bt.StartDate" disabled="@(!IsEditMode)" />
                </div>
                <div class="form-group inline">
                    <label>Fecha fin</label>
                    <input type="date" @bind="bt.DueDate" disabled="@(!IsEditMode)" />
                </div>
            }
            else if (SelectedTaskObject is SelfAssessment sa)
            {
                <div class="form-group">
                    <label>Actividad:</label>
                    <p class="read-only-field">@sa.ActivityName</p>
                </div>
            }
        </div>

        <div class="modal-footer">
            @if (IsEditMode)
            {
                <button class="action-btn save" @onclick="SaveTask">💾 Guardar</button>
                <button class="action-btn cancel" @onclick="CancelEdit">❌ Cancelar</button>
            }
            else
            {
                <button class="action-btn save" @onclick="() => IsModalOpen = false">✔️ Cerrar</button>
            }
        </div>
    </div>
}

<!-- Modal de Confirmación de Borrado -->
@if (ShowConfirmDelete)
{
    <div class="modal-backdrop" @onclick="() => ShowConfirmDelete = false"></div>
    <div class="confirm-modal" @onclick:stopPropagation>
        <h3>¿Eliminar tarea?</h3>
        <p>¿Estás seguro que quieres eliminar "<strong>@TaskToDelete?.Name</strong>"?</p>
        <div class="confirm-actions">
            <button class="action-btn cancel" @onclick="() => { ShowConfirmDelete = false; TaskToDelete = null; }">Cancelar</button>
            <button class="action-btn save" @onclick="() => DeleteConfirmedAsync()">Eliminar</button>
        </div>
    </div>
}

<!-- Toast -->
@if (ShowToast)
{
    <div class="toast">@ToastMessage</div>
}

@code {
    enum BlockType { AdminTask, WorkOrder, GeneralTask, SelfAssessment }

    class BaseTask
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public BlockType Type { get; set; }
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Priority { get; set; } = "Media";
        public string Recurrence { get; set; } = "No repetir";
        public bool IsCompleted { get; set; } = false;
        public DateTime StartDate { get; set; } = DateTime.Today;
        public DateTime DueDate { get; set; } = DateTime.Today;
        public List<object> SubTasks { get; set; } = new();
        public Block ParentBlock { get; set; }
    }

    class AdminTask : BaseTask { }
    class GeneralTask : BaseTask { }
    class WorkOrder : BaseTask { }

    class SelfAssessment
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public string ActivityName { get; set; } = "";
        public bool IsCompleted { get; set; } = false;
        public Block ParentBlock { get; set; }
    }

    class Block
    {
        public string Title { get; set; } = "";
        public List<object> SubTasks { get; set; } = new();
        public string Color { get; set; } = "#fff";
        public bool IsExpanded { get; set; } = false;
    }

    class DayColumn
    {
        public DateTime Date { get; set; }
        public List<Block> Blocks { get; set; } = new();
    }

    List<DayColumn> Days = new();
    DateTime CurrentDate = DateTime.Today;
    object SelectedTaskObject { get; set; }
    bool IsModalOpen { get; set; } = false;
    bool IsEditMode { get; set; } = false;

    // Confirm delete
    bool ShowConfirmDelete { get; set; } = false;
    BaseTask TaskToDelete { get; set; }

    // Toast
    bool ShowToast { get; set; } = false;
    string ToastMessage { get; set; } = "";

    int WeekNumber => CultureInfo.CurrentCulture.Calendar.GetWeekOfYear(CurrentDate, CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
    string MonthName => CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.GetMonthName(CurrentDate.Month);

    protected override void OnInitialized() => BuildWeek();

    void BuildWeek()
    {
        Days.Clear();
        var diff = (7 + (CurrentDate.DayOfWeek - DayOfWeek.Monday)) % 7;
        var monday = CurrentDate.AddDays(-1 * diff).Date;

        for (int i = 0; i < 7; i++)
            Days.Add(CreateDay(monday.AddDays(i)));
    }

    DayColumn CreateDay(DateTime date)
    {
        var day = new DayColumn { Date = date };
        if (date.DayOfWeek == DayOfWeek.Sunday) return day;

        // Tareas Administrativas
        var adminBlock = new Block { Title = "Tareas Administrativas", Color = "#FFD1DC" };
        var t1 = new AdminTask { Name = "Área de TI limpia", Description = "Me aseguré de que el área y la estación de insumos de TI esté limpia, ordenada y funcional", ParentBlock = adminBlock, Type = BlockType.AdminTask };
        t1.SubTasks.Add(new BaseTask { Name = "Subtarea 1" });
        t1.SubTasks.Add(new BaseTask { Name = "Subtarea 2" });
        var t2 = new AdminTask { Name = "Control de suscripciones", Description = "Di seguimiento en tiempo y forma al control de suscripciones de las que es responsable TI.", ParentBlock = adminBlock, Type = BlockType.AdminTask };
        var t3 = new AdminTask { Name = "Recepción de facturas", Description = "Di seguimiento a la recepción de facturas de acuerdo con las solicitudes de pago y las entregue a Administración.", ParentBlock = adminBlock, Type = BlockType.AdminTask };
        adminBlock.SubTasks.Add(t1); adminBlock.SubTasks.Add(t2); adminBlock.SubTasks.Add(t3);
        day.Blocks.Add(adminBlock);

        // Tareas Operativas
        var opBlock = new Block { Title = "Tareas Operativas", Color = "#B5EAD7" };
        var o1 = new GeneralTask { Name = "Entregar reporte semanal", Description = "Revisar bien los reportes de la semana", ParentBlock = opBlock, Type = BlockType.GeneralTask };
        var o2 = new GeneralTask { Name = "Reunión equipo", Description = "Llevar el control de las reuniones hechas", ParentBlock = opBlock, Type = BlockType.GeneralTask };
        var o3 = new GeneralTask { Name = "Entrega reporte semanal", Description = "Revisar que los reportes de mis compañeros los suban", ParentBlock = opBlock, Type = BlockType.GeneralTask };
        opBlock.SubTasks.Add(o1); opBlock.SubTasks.Add(o2); opBlock.SubTasks.Add(o3);
        day.Blocks.Add(opBlock);

        // Órdenes de Trabajo
        var woBlock = new Block { Title = "Órdenes de Trabajo", Color = "#FFDAC1" };
        woBlock.SubTasks.Add(new WorkOrder { Name = "ORD-13683" });
        woBlock.SubTasks.Add(new WorkOrder { Name = "ORD-13503" });
        woBlock.SubTasks.Add(new WorkOrder { Name = "ORD-13296" });
        day.Blocks.Add(woBlock);

        // Autoevaluación
        var autoBlock = new Block { Title = "Autoevaluación", Color = "#E2F0CB" };
        autoBlock.SubTasks.Add(new SelfAssessment { ActivityName = "Me aseguré de que el área y la estación de insumos de TI esté limpia, ordenada y funcional.", ParentBlock = autoBlock });
        autoBlock.SubTasks.Add(new SelfAssessment { ActivityName = "Validé que los vales de papelería relacionados con los insumos de TI se encuentren llenados correctamente; realicé el escaneo de los mismos y entregué a servicios de oficina.", ParentBlock = autoBlock });
        autoBlock.SubTasks.Add(new SelfAssessment { ActivityName = "Confirmé con el personal de TI, al menos 2 veces al día, las actividades programadas de acuerdo con su programa de trabajo.", ParentBlock = autoBlock });
        day.Blocks.Add(autoBlock);

    
        return day;
    }

    string GetModalTitle()
    {
        if (SelectedTaskObject is BaseTask bt)
            return bt.Type switch
            {
                BlockType.AdminTask => "Tarea Administrativa",
                BlockType.GeneralTask => "Tarea Operativa",
                _ => "Detalles de la tarea"
            };
        else if (SelectedTaskObject is SelfAssessment)
            return "Registro de Autoevaluación";
        return "Detalles";
    }

    void OpenTaskModal(object task, bool editMode)
    {
        SelectedTaskObject = task;
        IsModalOpen = true;
        IsEditMode = editMode;
    }

    void CloseTaskModal()
    {
        SelectedTaskObject = null;
        IsModalOpen = false;
        IsEditMode = false;
    }
    async Task SaveTask()
    {
        IsEditMode = false;
        IsModalOpen = false;

        if (SelectedTaskObject is BaseTask bt)
        {
            await ShowSuccessAlert($"✅ La tarea '{bt.Name}' se guardó correctamente");
        }
    }
    // Método para mostrar alerta bonita tipo SweetAlert2
    async Task ShowSuccessAlert(string message)
    {
        await JSRuntime.InvokeVoidAsync("Swal.fire", new
        {
            icon = "success",
            title = message,
            showConfirmButton = true,
            confirmButtonColor = "#0B3C4A",
            timer = 2000
        });
    }



    void CancelEdit()
    {
        // No guardamos cambios; se podría recargar datos originales si se mantiene snapshot (no implementado aquí).
        IsEditMode = false;
    }

    // Abrir confirmación para borrar
    void ConfirmDelete(BaseTask bt)
    {
        TaskToDelete = bt;
        ShowConfirmDelete = true;
    }

    // Borrar confirmado (async para UX)
    async Task DeleteConfirmedAsync()
    {
        if (TaskToDelete != null)
        {
            TaskToDelete.ParentBlock?.SubTasks.Remove(TaskToDelete);
            await ShowTemporaryToastAsync("Tarea eliminada");
        }
        TaskToDelete = null;
        ShowConfirmDelete = false;
    }

    // Manejo checkbox para BaseTask
    async Task ToggleComplete(BaseTask bt, ChangeEventArgs e)
    {
        if (e?.Value is bool b)
            bt.IsCompleted = b;
        else
        {
            // algunos navegadores mandan "on"/"off", intentar parse
            bool parsed = false;
            if (e?.Value is string s)
                parsed = string.Equals(s, "true", StringComparison.OrdinalIgnoreCase) || string.Equals(s, "on", StringComparison.OrdinalIgnoreCase);
            bt.IsCompleted = parsed;
        }

        // Opcional: persistir, notificar
        if (bt.IsCompleted)
            await ShowTemporaryToastAsync($"Marcaste '{bt.Name}' como completada");
        else
            await ShowTemporaryToastAsync($"Desmarcaste '{bt.Name}'");
    }

    // Manejo checkbox para SelfAssessment
    async Task ToggleCompleteSelf(SelfAssessment sa, ChangeEventArgs e)
    {
        if (e?.Value is bool b) sa.IsCompleted = b;
        else
        {
            bool parsed = false;
            if (e?.Value is string s) parsed = string.Equals(s, "true", StringComparison.OrdinalIgnoreCase) || string.Equals(s, "on", StringComparison.OrdinalIgnoreCase);
            sa.IsCompleted = parsed;
        }

        if (sa.IsCompleted)
            await ShowTemporaryToastAsync($"Autoevaluación marcada");
        else
            await ShowTemporaryToastAsync($"Autoevaluación desmarcada");
    }

    void ToggleBlock(Block block)
    {
        block.IsExpanded = !block.IsExpanded;
    }

    void PrevWeek() { CurrentDate = CurrentDate.AddDays(-7); BuildWeek(); }
    void NextWeek() { CurrentDate = CurrentDate.AddDays(7); BuildWeek(); }

    async Task ShowTemporaryToastAsync(string message, int milliseconds = 1600)
    {
        ToastMessage = message;
        ShowToast = true;
        StateHasChanged();
        await Task.Delay(milliseconds);
        ShowToast = false;
        StateHasChanged();
    }
}

<style>
    /* Contenedor principal */
    .agenda-container {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: #fff;
        padding: 18px;
        border-radius: 12px;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        overflow: hidden;
    }

    /* Header */
    .agenda-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .header-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1 1 auto;
    }

        .header-center h1 {
            margin: 0;
            font-size: 30px;
            font-weight: 700;
        }

    .month-pill {
        margin-top: 6px;
        background: linear-gradient(90deg,#f7f7f7,#fff);
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 600;
        color: #0b3c4a;
        box-shadow: 0 2px 6px rgba(11,60,74,0.06);
    }

    /* Botones */
    .btn {
        background: linear-gradient(90deg,#1e7a3a,#0b3c4a);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
    }

        .btn.primary {
            background: linear-gradient(90deg,#1e7a3a,#0b3c4a);
        }

        .btn:hover {
            background: linear-gradient(90deg, #155d2b, #062b35); /* tonos más oscuros */
            color: white; /* asegura que el texto siga siendo blanco */
            transform: translateY(-1px);
        }

    .arrow {
        font-weight: 700;
    }

    /* Grid de días */
    .days-grid.weekly {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 12px;
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 6px;
    }

    /* Tarjetas de día */
    .day-card {
        background: #f9fafb;
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 100%;
        overflow-y: auto;
    }

    /* Header del día */
    .day-header {
        display: flex;
        justify-content: space-between;
        font-weight: 700;
        text-transform: capitalize;
    }

    /* Lista de bloques */
    .blocks-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* Bloques individuales */
    .list-item {
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        transition: transform .12s ease;
    }

        .list-item:hover {
            transform: translateY(-3px);
        }

    .list-title {
        font-weight: 700;
        margin-bottom: 8px;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }

    .chev {
        font-size: 12px;
        opacity: 0.8;
        margin-left: 10px;
    }

    /* Subtareas */
    .subtasks {
        list-style: none;
        padding-left: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 300px;
        overflow-y: auto;
    }

    /* Ítems de tarea */
    .task-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 6px 4px;
        border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        flex: 0 0 18px;
        margin-right: 8px;
        cursor: pointer;
    }

    /* Nombre de la tarea */
    .task-name {
        flex-grow: 1;
        cursor: pointer;
        user-select: none;
        padding-right: 8px;
        transition: all 0.2s ease;
    }

    /* Línea superior para tareas completadas */
    .task-item.completed-task .task-name {
        border-top: 3px solid #0B3C4A; /* Línea encima más visible */
        padding-top: 4px; /* Espacio entre línea y texto */
        opacity: 0.85;
    }
    /* === Igual funcionalidad que subtareas === */
    .task-name.completed {
        text-decoration: line-through; /* misma línea encima */
        opacity: 0.6; /* más tenue */
        transition: all 0.2s ease;
    }

    /* Acciones de la tarea (botones) */
    .task-actions {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    /* Opcional: efecto al pasar el mouse por encima */
    .task-item:hover .task-name {
        color: #0B3C4A;
        font-weight: 600;
    }

    /* Botones de editar y eliminar */
    .edit-btn, .delete-btn {
        font-size: 14px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px;
        border-radius: 8px;
    }

        .edit-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .delete-btn:hover {
            background: rgba(255,0,0,0.06);
        }

    .workorder {
        font-weight: 700;
    }

    /* Modal */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(11,60,74,0.65);
        z-index: 1000;
    }

    .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        background: #FEFEFE;
        padding: 18px;
        border-radius: 12px;
        z-index: 1001;
        width: 90%;
        max-width: 640px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 12px 35px rgba(0,0,0,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .close-btn {
        font-size: 24px;
        background: none;
        border: none;
        cursor: pointer;
        color: #0B3C4A;
    }

    .form-group {
        margin-bottom: 10px;
    }

        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #eee;
            box-sizing: border-box;
        }

    input:disabled, textarea:disabled, select:disabled {
        background: #f5f5f5;
        color: #444;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding-top: 8px;
        border-top: 1px solid #f0f0f0;
    }

    .action-btn {
        padding: 8px 12px;
        font-weight: 700;
        color: white;
        border: none;
        border-radius: 999px;
        cursor: pointer;
    }

        .action-btn.save {
            background: #0B3C4A;
        }

        .action-btn.cancel {
            background: #ef4444;
        }

    /* Confirm modal */
    .confirm-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        z-index: 1002;
        background: white;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.18);
        width: 90%;
        max-width: 420px;
    }

    .confirm-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 12px;
    }

    /* Toast */
    .toast {
        position: fixed;
        right: 18px;
        bottom: 18px;
        background: linear-gradient(90deg,#0B3C4A,#1e7a3a);
        color: white;
        padding: 10px 14px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        z-index: 2000;
        font-weight: 700;
    }

    

    .btn {
        min-width: auto;
        padding: 8px 10px;
    }

    }
</style>
