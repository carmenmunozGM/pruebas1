@page "/Calendario"
@using System.Globalization
@using System
@using System.Collections.Generic

<button class="btn btn-success" >➕ Abrir Modal de Creación</button>
<div class="agenda-container">
    <header class="agenda-header">
        <div class="header-controls">
            <button class="btn" @onclick="PrevMonth">Mes anterior</button>
        </div>
        <h1>@MonthName @CurrentDate.Year</h1>
        <div class="header-controls">
            <button class="btn primary" @onclick="NextMonth">Mes siguiente</button>
        </div>
    </header>

    <div class="days-grid-mensual">
        <div class="day-name-header">Lunes</div>
        <div class="day-name-header">Martes</div>
        <div class="day-name-header">Miércoles</div>
        <div class="day-name-header">Jueves</div>
        <div class="day-name-header">Viernes</div>
        <div class="day-name-header">Sábado</div>
        <div class="day-name-header">Domingo</div>

        @foreach (var day in Days)
        {
            @if (day != null)
            {
                <div class="day-card @(day.Date.DayOfWeek == DayOfWeek.Sunday ? "sunday" : "")">
                    <div class="day-header">
                        <span class="day-name">@day.Date.ToString("dd")</span>
                    </div>

                    @if (day.Date.DayOfWeek == DayOfWeek.Sunday)
                    {
                        <div class="no-laboral">
                            <span>No Laboral</span>
                        </div>
                    }
                    else
                    {
                        <div class="blocks-list">
                            @foreach (var block in day.Blocks)
                            {
                                <div class="list-item" style="background-color:@block.Color">
                                    <div class="list-title">
                                        @block.Title
                                        <span class="task-count">
                                            @block.SubTasks.Count()
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="day-card empty"></div>
            }
        }
    </div>
</div>

<style>
    /* Estilos generales */
    .agenda-container {
        font-family: Inter, system-ui, sans-serif;
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        width: 100vw;
        height: 100vh;
        max-width: 100%;
        max-height: 100%;
        margin: 0;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
    }

    /* --- Encabezado del Mes y Controles (MODIFICADO para alineación lateral) --- */
    .agenda-header {
        display: flex;
        justify-content: space-between; /* Alinea ítems a los extremos */
        align-items: center;
        margin-bottom: 20px;
        padding: 0 10px; /* Pequeño padding para no pegar a los bordes */
    }

        .agenda-header h1 {
            font-size: 32px;
            margin: 0; /* Centrado por flexbox, no necesita margen */
            color: #333;
        }

    /* Controles de botones (contenedor sin centrado) */
    .header-controls {
        display: flex;
        gap: 15px;
    }

    /* Asegura que el contenedor de la izquierda se mantenga pequeño, envolviendo solo su botón */
    .agenda-header > .header-controls:first-child {
        min-width: 150px; /* Espacio para que el título no se desplace */
        justify-content: flex-start;
    }

    /* Asegura que el contenedor de la derecha se mantenga pequeño, envolviendo solo su botón */
    .agenda-header > .header-controls:last-child {
        min-width: 150px; /* Espacio simétrico */
        justify-content: flex-end;
    }

    .btn {
        background: #E0E7FF; /* Pastel Azul Claro */
        color: #4338CA; /* Texto Azul Oscuro */
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
    }

        .btn:hover {
            background: #C7D2FE;
        }

        .btn.primary {
            background: #4338CA; /* Azul Índigo para el botón principal */
            color: white;
        }

            .btn.primary:hover {
                background: #3730A3;
            }

    /* --- Grid del Calendario --- */
    .days-grid-mensual {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        flex-grow: 1;
    }

    .day-name-header {
        font-weight: 700;
        text-align: center;
        padding: 10px 0;
        color: #6B7280;
        border-bottom: 2px solid #F3F4F6;
    }

    .day-card {
        background: #ffffff;
        border: 1px solid #E5E7EB;
        border-radius: 10px;
        padding: 10px;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: box-shadow 0.2s;
    }

        .day-card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .day-card.empty {
            background-color: transparent;
            border: none;
            box-shadow: none;
        }

        .day-card.sunday {
            background: #F9FAFB;
            color: #9CA3AF;
        }

    .day-header {
        display: flex;
        justify-content: flex-start;
        font-size: 18px;
        font-weight: 700;
        color: #333;
    }

    .day-card.sunday .day-name {
        color: #9CA3AF;
    }

    /* --- Bloques de Tareas --- */
    .blocks-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
        list-style: none;
        padding: 0;
    }

    .list-item {
        border-radius: 6px;
        padding: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: default;
        overflow: hidden;
        color: #333;
        font-size: 14px;
        line-height: 1.3;
    }

    .list-title {
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .task-count {
        background-color: rgba(255, 255, 255, 0.5);
        color: #333;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        min-width: 15px;
        text-align: center;
    }

    .no-laboral {
        font-weight: 600;
        font-size: 14px;
        color: #EF4444;
        text-align: center;
        margin-top: 10px;
    }
</style>

@code {
    class Block
    {
        public string Title { get; set; }
        public List<string> SubTasks { get; set; } = new();
        public string Color { get; set; }
    }
    class DayColumn
    {
        public DateTime Date { get; set; }
        public List<Block> Blocks { get; set; } = new();
    }

    List<DayColumn> Days = new();
    DateTime CurrentDate = DateTime.Today;

    // Paleta de Colores Pasteles Empresariales
    private readonly Dictionary<string, string> BlockColors = new Dictionary<string, string>
    {
        {"Tareas Administrativas", "#B5EAD7"}, // Verde Menta Pastel
        {"Órdenes de Trabajo", "#FFDAC1"},    // Naranja Melocotón Pastel
        {"Tareas", "#E2F0CB"},                // Verde Lima Pastel
        {"Autoevalución", "#C7CEEA"},         // Azul Lavanda Pastel (Usamos este para reemplazar 'Servicio al Cliente' con 'Autoevaluación')
    };

    // Lista de títulos de bloques a usar
    private readonly List<string> definedTitles = new List<string> {
        "Tareas Administrativas",
        "Órdenes de Trabajo",
        "Tareas",
        "Autoevalución"
    };

    string MonthName => CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.GetMonthName(CurrentDate.Month);

    protected override void OnInitialized() => BuildMonth();

    void BuildMonth()
    {
        Days.Clear();
        var firstDayOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        var firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
        // Ajusta el primer día para empezar en Lunes (1), no en Domingo (0)
        var startPadding = (firstDayOfWeek == 0) ? 6 : firstDayOfWeek - 1;

        for (int i = 0; i < startPadding; i++)
        {
            Days.Add(null);
        }

        var daysInMonth = DateTime.DaysInMonth(CurrentDate.Year, CurrentDate.Month);
        for (int i = 1; i <= daysInMonth; i++)
        {
            var date = new DateTime(CurrentDate.Year, CurrentDate.Month, i);
            Days.Add(CreateDay(date));
        }
    }

    DayColumn CreateDay(DateTime date)
    {
        var d = new DayColumn { Date = date };
        if (date.DayOfWeek == DayOfWeek.Sunday)
        {
            return d;
        }

        var random = new Random();

        // Selecciona de 1 a 4 tipos de bloques diferentes al azar
        int blockCount = random.Next(1, definedTitles.Count + 1);
        var selectedTitles = definedTitles.OrderBy(x => random.Next()).Take(blockCount).ToList();

        foreach (var title in selectedTitles)
        {
            d.Blocks.Add(new Block
            {
                Title = title,
                SubTasks = GetRandomSubTasks(title), // Genera las subtareas para obtener el conteo
                Color = BlockColors[title]
            });
        }

        return d;
    }

    List<string> GetRandomSubTasks(string title)
    {
        var random = new Random();
        var subtasks = new List<string>();

        // Define un mínimo y máximo de tareas para que el número sea variable (2 a 7)
        int maxTasks = random.Next(2, 8);

        switch (title)
        {
            case "Tareas Administrativas":
                for (int i = 1; i <= maxTasks; i++)
                    subtasks.Add($"Revisión administrativa #{i}");
                break;
            case "Órdenes de Trabajo":
                for (int i = 1; i <= maxTasks; i++)
                    subtasks.Add($"Orden T. #{random.Next(100, 999)}");
                break;
            case "Tareas":
                for (int i = 1; i <= maxTasks; i++)
                    subtasks.Add($"Tarea de Proyecto P-{random.Next(1, 10)}");
                break;
            case "Autoevalución":
                for (int i = 1; i <= maxTasks; i++)
                    subtasks.Add($"Criterio de Autoevaluación #{i}");
                break;
            default:
                for (int i = 1; i <= maxTasks; i++)
                    subtasks.Add("Tarea Genérica");
                break;
        }
        return subtasks;
    }

    void PrevMonth() { CurrentDate = CurrentDate.AddMonths(-1); BuildMonth(); }
    void NextMonth() { CurrentDate = CurrentDate.AddMonths(1); BuildMonth(); }
}