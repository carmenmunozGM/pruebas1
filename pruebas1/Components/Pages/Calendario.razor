@page "/calendario"
@using System.Globalization
@using System
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@using System.Collections.Generic
@inject LoginService loginService
@inject AgendaService AgendaService
@inject AutoevaluacionService AutoevaluacionService
@inject OrdenTrabajoService OrdenTrabajoService
@inject OrdenTramiteService OrdenTramiteService
@inject CalendarioService CalendarioService
@inject ServicioClienteService ServicioClienteService
@inject InfoPersonalService infoPersonalService
<br />
<br />
<div class="agenda-container">
    <!-- Encabezado -->
    <header class="agenda-header">
        <div class="header-controls">
            <button class="btn" @onclick="PrevMonth">
                <span class="arrow">&#9664;</span> Mes anterior
            </button>
        </div>
        <h1>@MonthName @CurrentDate.Year</h1>
        <div class="header-controls">
            <button class="btn primary" @onclick="NextMonth">
                Mes siguiente <span class="arrow">&#9654;</span>
            </button>
        </div>
    </header>

    <!-- Grid de días -->
    <div class="days-grid-mensual">
        @foreach (var dayName in new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo" })
        {
            <div class="day-name-header">@dayName</div>
        }

        @foreach (var day in Days)
        {
            @if (day != null)
            {

                <div class="day-card @(EsNoLaboral(day.Date) ? "no-laboral" : "")"
                     title="@DescripcionNoLaboral(day.Date)">
                    <div class="day-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="font-size: 1.2rem; color: #d9534f;"></strong>
                        <div class="badges-container">
                        @{
                            var festejadosHoy = ObtenerCumpleaniosDelDia(day.Date.Day);
                        }

                        @if (festejadosHoy.Any())
                        {
                            <div class="birthday-badge"
                                 @onclick="() => OpenBirthdayModal(day.Date)"
                                 @onclick:stopPropagation="true"
                                 title="Cumpleaños de: @(string.Join(", ", festejadosHoy.Select(f => f.Nombre)))">
                                <span class ="emoji">🎂</span>
                            </div>
                        }
                        @if (listaVacaciones != null && EsDiaDeVacaciones(day.Date))
                        {
                            var totalHoy = listaVacaciones.Count(v =>
                            DateTime.TryParse(v.Desde, out var d) && DateTime.TryParse(v.Hasta, out var h) &&
                            day.Date >= d.Date && day.Date <= h.Date);
                      @*       <div class="vacation-badge"
                                 @onclick="() => OpenVacationModal(day.Date)"
                                 @onclick:stopPropagation="true"
                                 style="position: absolute;
                                top: 5px;
                                left: 50%;
                                transform: translateX(-50%);
                                width: 35px;
                                height: 35px;
                                background: #E8F8F5;
                                border: 1px solid #E8F8F5 !important;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                                z-index: 10;
                                box-shadow: 0 2px 6px rgba(0,0,0,0.1);"
                                 title="Ver periodo de vacaciones">
 *@
                                <div class="badge-custom vacation-badge"
                                     @onclick="() => OpenVacationModal(day.Date)"
                                     @onclick:stopPropagation="true"
                                     style="position: absolute; top: 5px; left: 50%; transform: translateX(-50%);"
                                     title="Ver periodo de vacaciones">
                                <span  class="emoji">🏖️</span>
                                @if (totalHoy > 1)
                                {
                                        <div class="notification-count">
                                            @totalHoy
                                        </div>
                                }
                            </div>
                        }
                    </div>
                    </div>
                    <div class="day-header">
                        @day.Date.ToString("dd")
                        @if (day.Date.DayOfWeek == DayOfWeek.Sunday)
                        {

                        }

                    </div>
                        
                 
                    @if (EsNoLaboral(day.Date))
                    {
                        <div class="no-laboral">
                            @DescripcionNoLaboral(day.Date)
                        </div>
                    }

                    else
                    {
                        <div class="blocks-list">
                            @foreach (var block in day.Blocks)
                            {
                                <div class="list-item" style="background-color:@block.Color" @onclick="async () => await OpenBlockModal(block)">
                                    <div class="list-title">
                                        @block.Title
                                        <span class="task-count">
                                            @(
                                                                        block.Title == "Autoevaluación"
                                                                        ? block.SubTasks
                                                                        .OfType<AutoevaluacionItem>()
                                                                        .Count(a => !a.Realizado)

                                                                        : block.Title == "Servicio a Cliente"
                                                                        ? block.SubTasks
                                                                        .OfType<ServicioClienteAgendaDTO>()
                                                                        .Count(x => x.Completada != true)

                                                                        : (block.Title == "Tareas" || block.Title == "Tareas Operativas")
                                                                        ? (block.SubTasks.OfType<TaskItem>().Count(t => !t.Completada) +
                                                                        block.SubTasks.OfType<EventItem>().Count(e => !e.Completada))
                                                                        : block.SubTasks.Count

                                                                        )
                                    </span>

                                    </div>
                                </div>
                                }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="day-card empty"></div>
            }
        }
    </div>
</div>
@* --- MODAL DE CUMPLEAÑOS --- *@
@if (ShowBirthdayModal)
{
    <div class="modal-backdrop-custom" @onclick="() => ShowBirthdayModal = false">
        <div class="modal-birthday-card" @onclick:stopPropagation="true">

            <div class="modal-birthday-header">
                <div style="font-size: 40px;">🎂</div>
                <h3>¡Festejados!</h3>
            </div>

            <div class="modal-birthday-body">
                @if (EmpleadosFestejados != null && EmpleadosFestejados.Any())
                {
                    @foreach (var emp in EmpleadosFestejados)
                    {
                        <div class="birthday-item">
                            <div class="birthday-avatar">
                                <i class="fas fa-user">
                                    <svg width="100" height="100" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M20 21v-1a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v1" fill="#AED6F1" stroke="#2C3E50" stroke-width="1.5" stroke-linecap="round" />
                                        <circle cx="12" cy="11" r="4" fill="#AED6F1" stroke="#2C3E50" stroke-width="1.5" />

                                        <path d="M12 2L16 9H8L12 2Z" fill="#FF5733" stroke="#2C3E50" stroke-width="1" stroke-linejoin="round" />

                                        <circle cx="12" cy="4.5" r="0.4" fill="white" />
                                        <circle cx="11" cy="6" r="0.4" fill="white" />
                                        <circle cx="13" cy="6" r="0.4" fill="white" />
                                        <circle cx="10.5" cy="7.5" r="0.4" fill="white" />
                                        <circle cx="12" cy="7.5" r="0.4" fill="white" />
                                        <circle cx="13.5" cy="7.5" r="0.4" fill="white" />

                                        <circle cx="12" cy="2" r="0.8" fill="#FFC300" stroke="#2C3E50" stroke-width="0.5" />
                                    </svg>
                                </i>
                            </div>
                            <div class="birthday-info">
                                <span class="birthday-name">@emp.Nombre</span>
                                <span class="birthday-id">No.Empleado: @emp.NumeroPersonal</span>
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="modal-birthday-footer">
                <button class="btn-close-modal" @onclick="() => ShowBirthdayModal = false">
                    Cerrar
                </button>
            </div>

        </div>
    </div>
}

@* --- MODAL DE DETALLE DE VACACIONES --- *@
@if (ShowVacationModal && EmpleadosEnVacaciones != null)
{
    <div class="modal-backdrop-custom" @onclick="() => ShowVacationModal = false"
         style="background: rgba(0,0,0,0.5) !important; position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; display: flex !important; align-items: center !important; justify-content: center !important; backdrop-filter: blur(5px);">

        <div class="mini-card-vacation" @onclick:stopPropagation="true"
             style="background: white !important;
                        padding: 20px !important;
                        border-radius: 24px !important;
                        width: 340px !important; @* Un poquito más ancho para la lista *@
                        max-width: 90% !important;
                        max-height: 85vh !important; @* Para que no se salga de la pantalla *@
                        text-align: center !important;
                        border: none !important;
                        box-shadow: 0 15px 40px rgba(0,0,0,0.2) !important;
                        display: flex !important;
                        flex-direction: column !important;
                        position: relative !important;">

            <div style="font-size: 50px; margin: 0 auto 10px auto; display: block;">☀️</div>

            <h3 style="color: #0E6655 !important; font-weight: 800 !important; margin: 0 0 5px 0 !important; font-size: 1.2rem !important; text-transform: uppercase;">
                Personal de Vacaciones
            </h3>

            <p style="color: #7F8C8D !important; font-size: 0.85rem !important; margin: 0 0 15px 0 !important;">
                @EmpleadosEnVacaciones.Count personas coinciden este día
            </p>

            <div style="overflow-y: auto; flex-grow: 1; margin-bottom: 20px; padding-right: 5px;">
                @foreach (var vaca in EmpleadosEnVacaciones)
                {
                    <div style="background: #F0FAF8 !important;
                                        border: 1px solid #E3F2F0 !important;
                                        border-radius: 15px !important;
                                        padding: 12px !important;
                                        margin-bottom: 12px !important;
                                        text-align: left !important;">

                        <p style="color: #117A65 !important; font-weight: bold !important; font-size: 0.9rem !important; margin: 0 0 8px 0 !important;">
                            @vaca.Personal
                        </p>

                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="text-align: center;">
                                <small style="color: #95A5A6; display: block; font-size: 0.6rem;">INICIO</small>
                                <b style="color: #2C3E50; font-size: 0.8rem;">@DateTime.Parse(vaca.Desde).ToString("dd/MM/yy")</b>
                            </div>

                            <div style="background: #3498DB; color: white; border-radius: 4px; padding: 1px 4px; font-size: 10px;">➡</div>

                            <div style="text-align: center;">
                                <small style="color: #95A5A6; display: block; font-size: 0.6rem;">FIN</small>
                                <b style="color: #2C3E50; font-size: 0.8rem;">@DateTime.Parse(vaca.Hasta).ToString("dd/MM/yy")</b>
                            </div>
                        </div>

                        <div style="margin-top: 8px; border-top: 1px solid #E3F2F0; padding-top: 5px;">
                            <span style="color: #1ABC9C; font-size: 0.7rem; font-weight: bold;">
                                📍 @vaca.Area
                            </span>
                        </div>
                    </div>
                }
            </div>

            <button @onclick="() => ShowVacationModal = false"
                    style="background: #1ABC9C !important; color: white !important; border: none !important; border-radius: 12px !important; width: 100% !important; height: 45px !important; font-weight: bold !important; font-size: 1rem !important; cursor: pointer; flex-shrink: 0;">
                Cerrar
            </button>
        </div>
    </div>
}


<!-- Modal -->
@if (SelectedBlock != null)
{
    <div class="modal-overlay" @onclick="CloseBlockModal">
        <div class="modal-content modern-modal modal-xl" @onclick:stopPropagation="true">
            <div class="modal-header">
                <span class="modal-icon">@GetIcon(SelectedBlock.Title)</span>
                <h2>@SelectedBlock.Title</h2>
            </div>

            <div class="modal-body modal-scrol">
                @if (SelectedBlock.Title == "Autoevaluación")
                {
                    @if (!SelectedBlock.SubTasks.Any())
                    {
                        <div class="no-tasks-msg">✅ No tienes autoevaluaciones pendientes para este día.</div>
                    }
                    else
                    {
                        <ul class="collapsible-list">
                            @foreach (var task in SelectedBlock.SubTasks.OfType<AutoevaluacionItem>())
                            {
                                <li class="task-item @(task.Realizado ? "realizado" : "")">
                                    @task.Nombre
                                </li>
                            }
                        </ul>
                    }
                }
                else if (SelectedBlock.Title == "Órdenes de Trabajo")
                {
                    var ots = SelectedBlock.SubTasks.OfType<OrdenTrabajoDTO>().ToList();
                    var tramites = SelectedBlock.SubTasks.OfType<OrdenTramiteDTO>().ToList();

                    @if (!ots.Any() && !tramites.Any())
                    {
                        <div class="no-tasks-msg">📋 No se encontraron órdenes de trabajo ni trámites para hoy.</div>
                    }
                    else
                    {

                        @foreach (var ot in ots)
                        {
                            <div class="ot-card">
                                <div class="collapsible-header" @onclick="() => ToggleOrdenTrabajo(ot.id)">
                                    <span>🧾 <b>@ot.strClave</b> — @ot.nombreCliente</span>
                                    <span class="toggle-icon">@(OrdenesTrabajoExpandidas.Contains(ot.id) ? "▲" : "▼")</span>
                                </div>

                                @if (OrdenesTrabajoExpandidas.Contains(ot.id))
                                {
                                    <div class="collapsible-content">
                                        <p><b>Autor:</b> @ot.nombreCompleto</p>
                                        <p><b>Fecha solicitud:</b> @ot.dteFechaSolicitud.ToShortDateString()</p>
                                        <p><b>Objetivo:</b> @ot.strValor</p>
                                        @if (!string.IsNullOrWhiteSpace(ot.strObjetivoOtro))
                                        {
                                            <p><b>Objetivo otros:</b> @ot.strObjetivoOtro</p>
                                        }
                                        <p><b>Conclusión programada:</b> @ot.fechaFinal.ToShortDateString()</p>

                                        <table class="subtasks-table">
                                            <thead>
                                                <tr>
                                                    <th>Tarea</th>
                                                    <th>Descripción</th>
                                                    <th>Avance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var t in ot.tareas)
                                                {
                                                    <tr>
                                                        <td>@t.strNombreTarea</td>
                                                        <td>@t.strDescripcionAutor</td>
                                                        <td>@t.avance%</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        }
                        @foreach (var tr in tramites)
                        {
                            <div class="tramite-card">
                                <div class="collapsible-header" @onclick="() => ToggleOrdenTramite(tr.idOrden)">
                                    <span>📁 <b>@tr.numeroOrden</b> — @tr.nombreGlobal</span>
                                    <span class="toggle-icon">@(OrdenesTramiteExpandidas.Contains(tr.idOrden) ? "▲" : "▼")</span>
                                </div>

                                @if (OrdenesTramiteExpandidas.Contains(tr.idOrden))
                                {
                                    <div class="collapsible-content">
                                        <p><b>Solicitante:</b> @tr.solicitanteInterno</p>
                                        <p><b>Cliente:</b> @tr.cliente</p>
                                        <p><b>Fecha solicitud:</b> @tr.fechaSolicitud</p>
                                        <p><b>Conclusión:</b> @tr.fechaConclusionTramite</p>

                                        <table class="subtasks-table">
                                            <thead>
                                                <tr>
                                                    <th>Clave</th>
                                                    <th>Trámite</th>
                                                    <th>Encargado</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var ti in tr.tramitesIndividuales)
                                                {
                                                    <tr>
                                                        <td>@ti.clave</td>
                                                        <td>@ti.tramiteIndividual</td>
                                                        <td>@ti.personalEncargado</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        }
                    }
                }
                else if (SelectedBlock.Title == "Servicio a Cliente")
                {
                    var items = SelectedBlock.SubTasks.OfType<ServicioClienteAgendaDTO>().GroupBy(x => x.NombreEmpresa);

                    @if (!items.Any())
                    {
                        <div class="no-tasks-msg">🏢 Este día no tienes servicios programados.</div>
                    }
                    else
                    {
                        @foreach (var empresa in items)
                        {
                            <div class="ot-card">
                                <div class="collapsible-header empresa-header">
                                    <span>🏢 <b>@empresa.Key</b></span>
                                </div>
                                <div class="collapsible-content" style="display: block;">
                                    @foreach (var servicio in empresa.GroupBy(x => x.NombreServicio))
                                    {
                                        var servicioId = $"{empresa.Key}_{servicio.Key}";
                                        <div class="service-card">
                                            <div class="collapsible-header service-header" @onclick="() => ToggleServicio(servicioId)">
                                                <span>▪️ @servicio.Key</span>
                                                <span class="toggle-icon">@(ServiciosExpandidos.Contains(servicioId) ? "▲" : "▼")</span>
                                            </div>

                                            @if (ServiciosExpandidos.Contains(servicioId))
                                            {
                                                <div class="collapsible-content">
                                                    <ul class="actividad-list">
                                                        @foreach (var act in servicio)
                                                        {
                                                            <li class="actividad-item @(act.Completada == true ? "actividad-completada" : "")">
                                                                ↳ @act.NombreActividad
                                                            </li>
                                                        }
                                                    </ul>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                }
                else if (SelectedBlock.Title == "Tareas" || SelectedBlock.Title == "Tareas Operativas")
                {
                    @if (!SelectedBlock.SubTasks.Any())
                    {
                        <div class="no-tasks-msg">📑 No tienes tareas ni eventos agendados para este día.</div>
                    }
                    else
                    {
                        <ul class="collapsible-list">
                            @foreach (var item in SelectedBlock.SubTasks)
                            {
                                if (item is TaskItem task)
                                {
                                    <li class="ot-card">
                                        <div class="collapsible-header @(task.Completada ? "actividad-completada" : "")" @onclick="() => ToggleTask(task)">
                                            <span>📑 <b>@task.Nombre</b></span>
                                            <span class="toggle-icon">@(ExpandedTasks.Contains(task) ? "▲" : "▼")</span>
                                        </div>
                                        @if (ExpandedTasks.Contains(task))
                                        {
                                            <div class="collapsible-content task-details">
                                                <p><strong>Descripción:</strong> @task.Descripcion</p>
                                                <p><strong>Fecha Inicio:</strong> @task.FechaInicio.ToShortDateString()</p>
                                                <p><strong>Fecha Fin:</strong> @task.FechaFin.ToShortDateString()</p>
                                                <p><strong>Prioridad:</strong> @task.Prioridad</p>

                                                @if (task.Subtareas != null && task.Subtareas.Any())
                                                {
                                                    <p><strong>Subtareas:</strong></p>
                                                    <ul class="actividad-list">
                                                        @foreach (var sub in task.Subtareas)
                                                        {
                                                            <li class="actividad-item">▪ @sub</li>
                                                        }
                                                    </ul>
                                                }
                                            </div>
                                        }
                                    </li>
                                }
                                else if (item is EventItem ev)
                                {
                                    <li class="ot-card">
                                        <div class="collapsible-header @(ev.Completada ? "actividad-completada" : "")" @onclick="() => ToggleEvent(ev)">
                                            <span>📅 <b>@ev.Nombre</b></span>
                                            <span class="toggle-icon">@(ExpandedEvents.Contains(ev) ? "▲" : "▼")</span>
                                        </div>
                                        @if (ExpandedEvents.Contains(ev))
                                        {
                                            <div class="collapsible-content task-details">
                                                <p><strong>Descripción:</strong> @ev.Descripcion</p>
                                                <p><strong>Fecha Inicio:</strong> @ev.FechaInicio.ToShortDateString()</p>
                                                <p><strong>Fecha Fin:</strong> @ev.FechaFin.ToShortDateString()</p>
                                                <p><strong>Horario:</strong> @ev.HoraInicio - @ev.HoraFin</p>
                                                <p><strong>Organizado por:</strong> @ev.Creador</p>
                                                <p><strong>Participantes:</strong></p>
                                                @if (ev.Participantes != null && ev.Participantes.Any())
                                                {
                                                    <ul class="actividad-list">
                                                        @foreach (var p in ev.Participantes)
                                                        {
                                                            <li class="actividad-item">👤 @p</li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <p class="text-muted">Sin participantes</p>
                                                }

                                            </div>
                                        }
                                    </li>
                                }
                            }
                        </ul>
                    }
                }
            </div>

            <div class="modal-footer">
                <button class="btn primary" @onclick="CloseBlockModal">Cerrar</button>
            </div>
        </div>
    </div>
}



@code {
    List<pruebas1.Entidades.TareaApi> TareasApi = new();
    List<EventoApiDTO> EventosApi = new();
    List<OrdenTrabajoDTO> OrdenesTrabajo = new();
    List<OrdenTramiteDTO> OrdenesTramite = new();
    List<DiaNoLaboralDto> DiasNoLaborales = new();
    List<ServicioClienteAgendaDTO> ServicioClienteAgenda = new();
    private List<CumpleaniosDTO> listaTodosCumple = new();
    private List<CumpleaniosDTO> EmpleadosFestejados = new(); 
    private List<CumpleaniosDTO> CumplesMesActual = new(); 
    private bool ShowBirthdayModal = false;
    private List<VacacionesDTO> listaVacaciones = new();
    private bool ShowVacationModal = false;
    private VacacionesDTO? VacationSelected;
    private List<VacacionesDTO> EmpleadosEnVacaciones = new();
    public string desde { get; set; }
    public string hasta { get; set; }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            StateHasChanged();
        }
    }


    class TaskItem
    {
        public string Nombre { get; set; }
        public string Descripcion { get; set; }
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
        public string Prioridad { get; set; }
        public List<string> Subtareas { get; set; } = new();
        public bool Completada { get; set; }
    }
    class EventItem
    {
        public string Nombre { get; set; }
        public string Descripcion { get; set; }
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
        public TimeSpan HoraInicio { get; set; }
        public TimeSpan HoraFin { get; set; }
        public bool Completada { get; set; }
        public string Creador { get; set; }
        public List<string> Participantes { get; set; } = new();

    }
    private HashSet<string> ServiciosExpandidos = new();

    private void ToggleServicio(string servicio)
    {
        if (!ServiciosExpandidos.Add(servicio))
            ServiciosExpandidos.Remove(servicio);
    }
    private bool EsDiaDeVacaciones(DateTime fecha)
    {
        if (listaVacaciones == null || !listaVacaciones.Any()) return false;

        return listaVacaciones.Any(v =>
            // Usar TryParse normal suele ser más flexible que TryParseExact
            DateTime.TryParse(v.Desde, out DateTime inicio) &&
            DateTime.TryParse(v.Hasta, out DateTime fin) &&
            fecha.Date >= inicio.Date && fecha.Date <= fin.Date);
    }
    private void OpenVacationModal(DateTime fecha)
    {
        EmpleadosEnVacaciones = listaVacaciones.Where(v =>
        {
            if (DateTime.TryParse(v.Desde, out DateTime inicio) &&
                DateTime.TryParse(v.Hasta, out DateTime fin))
            {
                return fecha.Date >= inicio.Date && fecha.Date <= fin.Date;
            }
            return false;
        }).ToList();

        if (EmpleadosEnVacaciones.Any())
        {
            ShowVacationModal = true;
        }
    }
    HashSet<int> OrdenesTrabajoExpandidas = new();

    void ToggleOrdenTrabajo(int idOrden)
    {
        if (!OrdenesTrabajoExpandidas.Add(idOrden))
            OrdenesTrabajoExpandidas.Remove(idOrden);
    }
    HashSet<int> OrdenesTramiteExpandidas = new();

    void ToggleOrdenTramite(int id)
    {
        if (!OrdenesTramiteExpandidas.Add(id))
            OrdenesTramiteExpandidas.Remove(id);
    }


    class AutoevaluacionItem
    {
        public string Nombre { get; set; }
        public bool Realizado { get; set; }
    }

    HashSet<TaskItem> ExpandedTasks = new();

    void ToggleTask(TaskItem task)
    {
        if (ExpandedTasks.Contains(task))
            ExpandedTasks.Remove(task);
        else
            ExpandedTasks.Add(task);
    }

    class Block
    {
        public string Title { get; set; }
        public List<object> SubTasks { get; set; } = new();
        public string Color { get; set; }
    }

    class DayColumn
    {
        public DateTime Date { get; set; }
        public List<Block> Blocks { get; set; } = new();
    }

    List<DayColumn> Days = new();
    DateTime CurrentDate = DateTime.Today;
    Block SelectedBlock = null;

    string MonthName => CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.GetMonthName(CurrentDate.Month);

    protected override async Task OnInitializedAsync()
    {
        listaTodosCumple = await infoPersonalService.GetTodosLosCumpleanios() ?? new();
        var resultado = await infoPersonalService.GetVacacionesTodos();
        if (resultado != null && resultado.Any())
        {
            listaVacaciones = resultado;
        }
        await CargarAutoevaluaciones();
       
        var agendas = await AgendaService.ObtenerAgendaAsignadasAsync();
        var idAgenda = agendas.FirstOrDefault();

        await CargarOrdenes();

        TareasApi = await AgendaService.ObtenerTareasApi(idAgenda);
        EventosApi = await AgendaService.ObtenerEventosPorEmpleado();
        ServicioClienteAgenda = await ServicioClienteService.ObtenerAgendaServicioCliente();

        await CargarDiasNoLaborales();
        BuildMonth();
    }

    async Task CargarDiasNoLaborales()
    {
        DiasNoLaborales.Clear();
        try
        {
            var dias = await CalendarioService.ObtenerDiasNoLaborales(CurrentDate.Year, CurrentDate.Month);
            DiasNoLaborales.AddRange(dias);
        }
        catch
        {

        }
    }

    bool EsNoLaboral(DateTime date)
    {
        if (date.DayOfWeek == DayOfWeek.Sunday)
            return true;

        return DiasNoLaborales.Any(d =>
            d.DiaInhabil.Date == date.Date);
    }

    string DescripcionNoLaboral(DateTime date)
    {
        if (date.DayOfWeek == DayOfWeek.Sunday)
            return "No laborable";

        return DiasNoLaborales
            .FirstOrDefault(d => d.DiaInhabil.Date == date.Date)
            ?.Descripcion;
    }


    async Task CargarOrdenes()
    {
        var otPen = await OrdenTrabajoService.GetOrdenesPendntes();
        var otHoy = await OrdenTrabajoService.GetOrdenesHoy();
        var otProx = await OrdenTrabajoService.GetOrdenesProximas();
        var otVenc = await OrdenTrabajoService.GetOrdenesVencidas();

        OrdenesTrabajo = otHoy
            .Concat(otProx)
            .Concat(otVenc)
            .Concat(otPen)
            .GroupBy(o => o.id)
            .Select(g => g.First())
            .ToList();

        var trPen = await OrdenTramiteService.GetPendientes();
        var trHoy = await OrdenTramiteService.GetHoy();
        var trProx = await OrdenTramiteService.GetProximas();
        var trVenc = await OrdenTramiteService.GetVencidas();

        OrdenesTramite = trHoy
            .Concat(trProx)
            .Concat(trVenc)
            .Concat(trPen)
            .GroupBy(o => o.idOrden)
            .Select(g => g.First())
            .ToList();
    }

    void BuildMonth()
    {
        Days.Clear();
        var firstDayOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        int firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
        int padding = firstDayOfWeek == 0 ? 6 : firstDayOfWeek - 1;

        for (int i = 0; i < padding; i++)
            Days.Add(null);
       
        CumplesMesActual = listaTodosCumple.Where(c =>
        {
            var partes = c.Cumpleanios?.Split('/');
            return partes?.Length >= 2 && int.TryParse(partes[1], out int m) && m == CurrentDate.Month;
        }).ToList();
        int daysInMonth = DateTime.DaysInMonth(CurrentDate.Year, CurrentDate.Month);
        for (int i = 1; i <= daysInMonth; i++)
        {
            var date = new DateTime(CurrentDate.Year, CurrentDate.Month, i);
            Days.Add(CreateDay(date));
        }
    }
    HashSet<EventItem> ExpandedEvents = new();
    void ToggleEvent(EventItem ev)
    {
        if (ExpandedEvents.Contains(ev))
            ExpandedEvents.Remove(ev);
        else
            ExpandedEvents.Add(ev);
    }
    void OpenBirthdayModal(DateTime date)
    {
        EmpleadosFestejados = ObtenerCumpleaniosDelDia(date.Day);
        if (EmpleadosFestejados.Any()) ShowBirthdayModal = true;
    }
    private List<CumpleaniosDTO> ObtenerCumpleaniosDelDia(int dia)
    {
        return CumplesMesActual.Where(c =>
        {
            var partes = c.Cumpleanios?.Split('/');
            return partes != null && int.TryParse(partes[0], out int d) && d == dia;
        }).ToList();
    }
    DayColumn CreateDay(DateTime date)
    {
        var day = new DayColumn { Date = date };
        if (date.DayOfWeek == DayOfWeek.Sunday) return day;
        var tareasDelDia = TareasApi
    .Where(t => t.fechaInicio.Date <= date.Date && t.fechaFin.Date >= date.Date)
    .Select(t => new TaskItem
    {
        Nombre = t.titulo,
        Descripcion = t.descripcion,
        FechaInicio = t.fechaInicio,
        FechaFin = t.fechaFin,
        Prioridad = t.prioridadTitulo ?? "Sin prioridad",
        Subtareas = t.subTareas.Select(s => s.titulo).ToList(),
        Completada = t.completada
    })
    .Cast<object>();

        var eventosDelDia = EventosApi
        .Where(e => e.fechaInicio.Date <= date.Date && e.fechaFin.Date >= date.Date)
            .Select(e => new EventItem
            {
                Nombre = e.titulo,
                Descripcion = e.descripcion,
                FechaInicio = e.fechaInicio,
                FechaFin = e.fechaFin,
                HoraInicio = e.fechaInicio.TimeOfDay,
                HoraFin = e.fechaFin.TimeOfDay,
                Creador = e.nombreCreador, 
                Completada = e.completada,
                Participantes = e.participantes
            .Select(p => p.nombreEmpleado)
            .ToList()
            })
            .Cast<object>();

        day.Blocks.Add(new Block
        {
            Title = "Tareas",
            Color = "#FFD1DC",
            SubTasks = tareasDelDia
                .Concat(eventosDelDia)
                .ToList()
        });


        DateTime FechaOT(OrdenTrabajoDTO ot)
        {
            return ot.fechaFinal.Date;
        }

        DateTime FechaTramite(OrdenTramiteDTO tr)
        {
            return DateTime.TryParse(tr.fechaConclusionTramite, out var d)
                ? d.Date
                : DateTime.MinValue;
        }


        var ordenesTrabajoDia = OrdenesTrabajo
       .Where(o => FechaOT(o) == date.Date)
       .Cast<object>()
       .ToList();

        var ordenesTramiteDia = OrdenesTramite
            .Where(t => FechaTramite(t) == date.Date)
            .Cast<object>()
            .ToList();

        day.Blocks.Add(new Block
        {
            Title = "Órdenes de Trabajo",
            Color = "#FFDAC1",
            SubTasks = ordenesTrabajoDia
         .Concat(ordenesTramiteDia)
         .ToList()
        });


        var autoevaluacionesDelDia = Autoevaluaciones
            .Where(a => a.Fecha.Date == date.Date)
            .Select(a => new AutoevaluacionItem
            {
                Nombre = a.Nombre,
                Realizado = a.Realizado
            })
            .Cast<object>()
            .ToList();

        day.Blocks.Add(new Block
        {
            Title = "Autoevaluación",
            Color = "#E2F0CB",
            SubTasks = autoevaluacionesDelDia
        });

        day.Blocks.Add(new Block
        {
            Title = "Servicio a Cliente",
            Color = "#D7D1DD",
            SubTasks = ServicioClienteAgenda
        .Where(s =>
            s.FechaAsignacion.Date <= date.Date &&
            s.FechaConclusion.Date >= date.Date
        )
        .Cast<object>()
        .ToList()
        });

        return day;
    }

    async void PrevMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        await CargarDiasNoLaborales();
        BuildMonth();
        StateHasChanged();
    }

    async void NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        await CargarDiasNoLaborales();
        BuildMonth();
        StateHasChanged();
    }

    async Task OpenBlockModal(Block block)
    {
        SelectedBlock = block;

        if (block.Title == "Órdenes de Trabajo")
        {
            var detalleCompleto = new List<object>();

            foreach (var item in block.SubTasks)
            {
                if (item is OrdenTrabajoDTO ot)
                {
                    var detalle = await OrdenTrabajoService.GetDetalle(ot.id);
                    if (detalle != null)
                        detalleCompleto.Add(detalle);
                }
                else
                {
                    detalleCompleto.Add(item);
                }
            }

            SelectedBlock.SubTasks = detalleCompleto;
        }
    }

    void CloseBlockModal() => SelectedBlock = null;

    class AutoevaluacionCalendarioItem
    {
        public string Nombre { get; set; }
        public DateTime Fecha { get; set; }
        public bool Realizado { get; set; }
    }

    List<AutoevaluacionCalendarioItem> Autoevaluaciones = new();

    async Task CargarAutoevaluaciones()
    {
        Autoevaluaciones.Clear();
        var data = await AutoevaluacionService.ObtenerAutoevaluacion();

        foreach (var bloque in data)
        {
            foreach (var tarea in bloque.Tareas)
            {
                foreach (var registro in tarea.Registros)
                {
                    Autoevaluaciones.Add(new AutoevaluacionCalendarioItem
                    {
                        Nombre = tarea.Tarea,
                        Fecha = registro.Fecha.ToDateTime(TimeOnly.MinValue),
                        Realizado = registro.Realizado
                    });
                }
            }
        }
    }

    string GetIcon(string title) => title switch
    {
        "Órdenes de Trabajo" => "🧾",
        "Tareas" => "🗃️",
        "Autoevaluación" => "⭐",
        "Servicio a Cliente" => "🏢",
        _ => "📋"
    };
}