@page "/calendario"
@using System.Globalization
@using System
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@using System.Collections.Generic
@inject LoginService loginService
@inject AgendaService AgendaService
@inject AutoevaluacionService AutoevaluacionService
@inject OrdenTrabajoService OrdenTrabajoService
@inject OrdenTramiteService OrdenTramiteService
<br />
<br />
<div class="agenda-container">
    <!-- Encabezado -->
    <header class="agenda-header">
        <div class="header-controls">
            <button class="btn" @onclick="PrevMonth">
                <span class="arrow">&#9664;</span> Mes anterior
            </button>
        </div>
        <h1>@MonthName @CurrentDate.Year</h1>
        <div class="header-controls">
            <button class="btn primary" @onclick="NextMonth">
                Mes siguiente <span class="arrow">&#9654;</span>
            </button>
        </div>
    </header>

    <!-- Grid de días -->
    <div class="days-grid-mensual">
        @foreach (var dayName in new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo" })
        {
            <div class="day-name-header">@dayName</div>
        }

        @foreach (var day in Days)
        {
            @if (day != null)
            {
                <div class="day-card @(day.Date.DayOfWeek == DayOfWeek.Sunday ? "sunday" : "")">
                    <div class="day-header">@day.Date.ToString("dd")</div>

                    @if (day.Date.DayOfWeek == DayOfWeek.Sunday)
                    {
                        <div class="no-laboral">No laborable</div>
                    }
                    else
                    {
                        <div class="blocks-list">
                            @foreach (var block in day.Blocks)
                            {
                                <div class="list-item" style="background-color:@block.Color" @onclick="async () => await OpenBlockModal(block)">
                                    <div class="list-title">
                                        @block.Title
                                        <span class="task-count">
                                            @(
                                                                        block.Title == "Autoevaluación"
                                                                        ? block.SubTasks.OfType<AutoevaluacionItem>().Count(a => !a.Realizado)
                                                                        : block.SubTasks.Count
                                                                        )
                                    </span>
                                </div>
                            </div>
                                }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="day-card empty"></div>
            }
        }
    </div>
</div>

<!-- Modal -->
@if (SelectedBlock != null)
{
    <div class="modal-overlay" @onclick="CloseBlockModal">
        <div class="modal-content modern-modal modal-xl" @onclick:stopPropagation="true">
            <div class="modal-header">
                <span class="modal-icon">@GetIcon(SelectedBlock.Title)</span>
                <h2>@SelectedBlock.Title</h2>
            </div>

            <div class="modal-body modal-scrol">
                @if (SelectedBlock.Title == "Autoevaluación")
                {
                    <ul class="collapsible-list">
                        @foreach (var task in SelectedBlock.SubTasks.OfType<AutoevaluacionItem>())
                        {
                            <li class="task-item @(task.Realizado ? "realizado" : "")">
                                @task.Nombre
                            </li>
                        }
                    </ul>
                }
                else if (SelectedBlock.Title == "Órdenes de Trabajo")
                {
                    <!-- ================= ORDENES DE TRABAJO ================= -->
                    @foreach (var ot in SelectedBlock.SubTasks.OfType<OrdenTrabajoDTO>())
                    {
                        <div class="ot-card">

                            <!-- HEADER -->
                            <div class="collapsible-header"
                                 @onclick="() => ToggleOrdenTrabajo(ot.id)">
                                <span>
                                    🧾 <b>@ot.strClave</b> — @ot.nombreCliente
                                </span>
                                <span class="toggle-icon">
                                    @(OrdenesTrabajoExpandidas.Contains(ot.id) ? "▲" : "▼")
                                </span>
                            </div>

                            @if (OrdenesTrabajoExpandidas.Contains(ot.id))
                            {
                                <div class="collapsible-content">
                                    <p><b>Autor:</b> @ot.nombreCompleto</p>
                                    <p><b>Fecha solicitud:</b> @ot.dteFechaSolicitud.ToShortDateString()</p>
                                    <p><b>Objetivo:</b> @ot.strValor</p>

                                    @if (!string.IsNullOrWhiteSpace(ot.strObjetivoOtro))
                                    {
                                        <p><b>Objetivo otros:</b> @ot.strObjetivoOtro</p>
                                    }

                                    <p><b>Conclusión programada:</b> @ot.fechaFinal.ToShortDateString()</p>

                                    <table class="subtasks-table">
                                        <thead>
                                            <tr>
                                                <th>Tarea</th>
                                                <th>Descripción</th>
                                                <th>Avance</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var t in ot.tareas)
                                            {
                                                <tr>
                                                    <td>@t.strNombreTarea</td>
                                                    <td>@t.strDescripcionAutor</td>
                                                    <td>@t.avance</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    }

                    <!-- ================= ORDENES DE TRAMITE ================= -->
                    @foreach (var tr in SelectedBlock.SubTasks.OfType<OrdenTramiteDTO>())
                    {
                        <div class="tramite-card">

                            <!-- HEADER -->
                            <div class="collapsible-header"
                                 @onclick="() => ToggleOrdenTramite(tr.idOrden)">
                                <span>
                                    📁 <b>@tr.numeroOrden</b> — @tr.nombreGlobal
                                </span>
                                <span class="toggle-icon">
                                    @(OrdenesTramiteExpandidas.Contains(tr.idOrden) ? "▲" : "▼")
                                </span>
                            </div>

                            @if (OrdenesTramiteExpandidas.Contains(tr.idOrden))
                            {
                                <div class="collapsible-content">
                                    <p><b>Solicitante:</b> @tr.solicitanteInterno</p>
                                    <p><b>Cliente:</b> @tr.cliente</p>
                                    <p><b>Fecha solicitud:</b> @tr.fechaSolicitud</p>
                                    <p><b>Conclusión:</b> @tr.fechaConclusionTramite</p>

                                    <table class="subtasks-table">
                                        <thead>
                                            <tr>
                                                <th>Clave</th>
                                                <th>Trámite</th>
                                                <th>Encargado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var ti in tr.tramitesIndividuales)
                                            {
                                                <tr>
                                                    <td>@ti.clave</td>
                                                    <td>@ti.tramiteIndividual</td>
                                                    <td>@ti.personalEncargado</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    }
                }

                else if (SelectedBlock.Title == "Servicio a Cliente")
                {
                    @foreach (var task in SelectedBlock.SubTasks.OfType<TaskItem>())
                    {
                        <h4>@task.Nombre</h4>
                        @if (task.Subtareas?.Any() == true)
                        {
                            <table class="subtasks-table">
                                <thead>
                                    <tr>
                                        <th>Actividad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var st in task.Subtareas)
                                    {
                                        <tr>
                                            <td>@st</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    }
                }
                else if (SelectedBlock.Title == "Tareas" || SelectedBlock.Title == "Tareas Operativas")
                {
                    <ul class="collapsible-list">
                        @foreach (var item in SelectedBlock.SubTasks)
                        {
                            if (item is TaskItem task)
                            {
                                <li>
                                    <div class="collapsible-header" @onclick="() => ToggleTask(task)">
                                        📝 @task.Nombre
                                        <span class="toggle-icon">@((ExpandedTasks.Contains(task) ? "▲" : "▼"))</span>
                                    </div>

                                    @if (ExpandedTasks.Contains(task))
                                    {
                                        <div class="task-details">
                                            <p><strong>Descripción:</strong> @task.Descripcion</p>
                                            <p><strong>Fecha Inicio:</strong> @task.FechaInicio.ToShortDateString()</p>
                                            <p><strong>Fecha Fin:</strong> @task.FechaFin.ToShortDateString()</p>
                                            <p><strong>Prioridad:</strong> @task.Prioridad</p>

                                            @if (task.Subtareas.Any())
                                            {
                                                <p><strong>Subtareas:</strong></p>
                                                <ul>
                                                    @foreach (var sub in task.Subtareas)
                                                    {
                                                        <li>@sub</li>
                                                    }
                                                </ul>
                                            }
                                        </div>
                                    }
                                </li>
                            }
                            else if (item is EventItem ev)
                            {
                                <li>
                                    <div class="collapsible-header" @onclick="() => ToggleEvent(ev)">
                                        📅 @ev.Nombre
                                        <span class="toggle-icon">@((ExpandedEvents.Contains(ev) ? "▲" : "▼"))</span>
                                    </div>

                                    @if (ExpandedEvents.Contains(ev))
                                    {
                                        <div class="task-details">
                                            <p><strong>Descripción:</strong> @ev.Descripcion</p>
                                            <p><strong>Fecha Inicio:</strong> @ev.FechaInicio.ToShortDateString()</p>
                                            <p><strong>Fecha Fin:</strong> @ev.FechaFin.ToShortDateString()</p>
                                            <p><strong>Horario:</strong> @ev.HoraInicio - @ev.HoraFin</p>
                                        </div>
                                    }
                                </li>
                            }

                        }

                    </ul>
                }
            </div>

            <div class="modal-footer">
                <button class="btn primary" @onclick="CloseBlockModal">Cerrar</button>
            </div>
        </div>
    </div>
}

@code {
    List<pruebas1.Entidades.TareaApi> TareasApi = new();
    List<EventoApiDTO> EventosApi = new();
    List<OrdenTrabajoDTO> OrdenesTrabajo = new();
    List<OrdenTramiteDTO> OrdenesTramite = new();

    class TaskItem
    {
        public string Nombre { get; set; }
        public string Descripcion { get; set; }
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
        public string Prioridad { get; set; }
        public List<string> Subtareas { get; set; } = new();
    }
    class EventItem
    {
        public string Nombre { get; set; }
        public string Descripcion { get; set; }
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
        public TimeSpan HoraInicio { get; set; }
        public TimeSpan HoraFin { get; set; }
    }

    HashSet<int> OrdenesTrabajoExpandidas = new();

    void ToggleOrdenTrabajo(int idOrden)
    {
        if (!OrdenesTrabajoExpandidas.Add(idOrden))
            OrdenesTrabajoExpandidas.Remove(idOrden);
    }
    HashSet<int> OrdenesTramiteExpandidas = new();

    void ToggleOrdenTramite(int id)
    {
        if (!OrdenesTramiteExpandidas.Add(id))
            OrdenesTramiteExpandidas.Remove(id);
    }


    class AutoevaluacionItem
    {
        public string Nombre { get; set; }
        public bool Realizado { get; set; }
    }

    HashSet<TaskItem> ExpandedTasks = new();

    void ToggleTask(TaskItem task)
    {
        if (ExpandedTasks.Contains(task))
            ExpandedTasks.Remove(task);
        else
            ExpandedTasks.Add(task);
    }

    class Block
    {
        public string Title { get; set; }
        public List<object> SubTasks { get; set; } = new();
        public string Color { get; set; }
    }

    class DayColumn
    {
        public DateTime Date { get; set; }
        public List<Block> Blocks { get; set; } = new();
    }

    List<DayColumn> Days = new();
    DateTime CurrentDate = DateTime.Today;
    Block SelectedBlock = null;

    string MonthName => CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.GetMonthName(CurrentDate.Month);

    protected override async Task OnInitializedAsync()
    {
        await CargarAutoevaluaciones();
        var agendas = await AgendaService.ObtenerAgendaAsignadasAsync();
        var idAgenda = agendas.FirstOrDefault();
        await CargarOrdenes();

        TareasApi = await AgendaService.ObtenerTareasApi(idAgenda);
        EventosApi = await AgendaService.ObtenerEventos(idAgenda);
        BuildMonth();
    }

    async Task CargarOrdenes()
    {
        var otHoy = await OrdenTrabajoService.GetOrdenesHoy();
        var otProx = await OrdenTrabajoService.GetOrdenesProximas();
        var otVenc = await OrdenTrabajoService.GetOrdenesVencidas();

        OrdenesTrabajo = otHoy
            .Concat(otProx)
            .Concat(otVenc)
            .GroupBy(o => o.id)
            .Select(g => g.First())
            .ToList();

        var trHoy = await OrdenTramiteService.GetHoy();
        var trProx = await OrdenTramiteService.GetProximas();
        var trVenc = await OrdenTramiteService.GetVencidas();

        OrdenesTramite = trHoy
            .Concat(trProx)
            .Concat(trVenc)
            .GroupBy(o => o.idOrden)
            .Select(g => g.First())
            .ToList();
    }

    void BuildMonth()
    {
        Days.Clear();
        var firstDayOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        int firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
        int padding = firstDayOfWeek == 0 ? 6 : firstDayOfWeek - 1;

        for (int i = 0; i < padding; i++)
            Days.Add(null);

        int daysInMonth = DateTime.DaysInMonth(CurrentDate.Year, CurrentDate.Month);
        for (int i = 1; i <= daysInMonth; i++)
        {
            var date = new DateTime(CurrentDate.Year, CurrentDate.Month, i);
            Days.Add(CreateDay(date));
        }
    }
    HashSet<EventItem> ExpandedEvents = new();
    void ToggleEvent(EventItem ev)
    {
        if (ExpandedEvents.Contains(ev))
            ExpandedEvents.Remove(ev);
        else
            ExpandedEvents.Add(ev);
    }

    DayColumn CreateDay(DateTime date)
    {
        var day = new DayColumn { Date = date };
        if (date.DayOfWeek == DayOfWeek.Sunday) return day;
        var tareasDelDia = TareasApi
    .Where(t => t.fechaInicio.Date <= date.Date && t.fechaFin.Date >= date.Date)
    .Select(t => new TaskItem
    {
        Nombre = t.titulo,
        Descripcion = t.descripcion,
        FechaInicio = t.fechaInicio,
        FechaFin = t.fechaFin,
        Prioridad = t.prioridadTitulo ?? "Sin prioridad",
        Subtareas = t.subTareas.Select(s => s.titulo).ToList()
    })
    .Cast<object>();

        var eventosDelDia = EventosApi
            .Where(e => e.fechaInicio.Date <= date.Date && e.fechaFin.Date >= date.Date)
            .Select(e => new EventItem
            {
                Nombre = e.titulo,
                Descripcion = e.descripcion,
                FechaInicio = e.fechaInicio,
                FechaFin = e.fechaFin,
                HoraInicio = e.fechaInicio.TimeOfDay,
                HoraFin = e.fechaFin.TimeOfDay
            })
            .Cast<object>();

        day.Blocks.Add(new Block
        {
            Title = "Tareas",
            Color = "#FFD1DC",
            SubTasks = tareasDelDia
                .Concat(eventosDelDia)
                .ToList()
        });


        DateTime FechaOT(OrdenTrabajoDTO ot)
        {
            return ot.fechaFinal.Date;
        }

        DateTime FechaTramite(OrdenTramiteDTO tr)
        {
            return DateTime.TryParse(tr.fechaConclusionTramite, out var d)
                ? d.Date
                : DateTime.MinValue;
        }


        var ordenesTrabajoDia = OrdenesTrabajo
       .Where(o => FechaOT(o) == date.Date)
       .Cast<object>()
       .ToList();

        var ordenesTramiteDia = OrdenesTramite
            .Where(t => FechaTramite(t) == date.Date)
            .Cast<object>()
            .ToList();

        day.Blocks.Add(new Block
        {
            Title = "Órdenes de Trabajo",
            Color = "#FFDAC1",
            SubTasks = ordenesTrabajoDia
         .Concat(ordenesTramiteDia)
         .ToList()
        });


        var autoevaluacionesDelDia = Autoevaluaciones
            .Where(a => a.Fecha.Date == date.Date)
            .Select(a => new AutoevaluacionItem
            {
                Nombre = a.Nombre,
                Realizado = a.Realizado
            })
            .Cast<object>()
            .ToList();

        day.Blocks.Add(new Block
        {
            Title = "Autoevaluación",
            Color = "#E2F0CB",
            SubTasks = autoevaluacionesDelDia
        });

        day.Blocks.Add(new Block
        {
            Title = "Servicio a Cliente",
            Color = "#D7D1DD",
            SubTasks = new List<object>
            {
                new TaskItem
                {
                    Nombre = "1658 CASAS Y DESARROLLOS VITA SAPI DE CV",
                    Subtareas = new List<string>
                    {
                        "Acordar con Lic.Gerardo cuando mandara el informe",
                        "Solicitar a TI descarga de CFDIS",
                        "Asegurar la recepción de documentos enviados por el Lic.Gerardo"
                    }
                },
                new TaskItem
                {
                    Nombre = "2389 RODAROSA,SA DE CV",
                    Subtareas = new List<string> { "Actualizar base de datos", "Enviar cotización" }
                }
            }
        });

        return day;
    }

    void PrevMonth() { CurrentDate = CurrentDate.AddMonths(-1); BuildMonth(); }
    void NextMonth() { CurrentDate = CurrentDate.AddMonths(1); BuildMonth(); }
    //void OpenBlockModal(Block block) => SelectedBlock = block;
    async Task OpenBlockModal(Block block)
    {
        SelectedBlock = block;

        if (block.Title == "Órdenes de Trabajo")
        {
            var detalleCompleto = new List<object>();

            foreach (var item in block.SubTasks)
            {
                if (item is OrdenTrabajoDTO ot)
                {
                    var detalle = await OrdenTrabajoService.GetDetalle(ot.id);
                    if (detalle != null)
                        detalleCompleto.Add(detalle);
                }
                else
                {
                    detalleCompleto.Add(item);
                }
            }

            SelectedBlock.SubTasks = detalleCompleto;
        }
    }

    void CloseBlockModal() => SelectedBlock = null;

    class AutoevaluacionCalendarioItem
    {
        public string Nombre { get; set; }
        public DateTime Fecha { get; set; }
        public bool Realizado { get; set; }
    }

    List<AutoevaluacionCalendarioItem> Autoevaluaciones = new();

    async Task CargarAutoevaluaciones()
    {
        Autoevaluaciones.Clear();
        var data = await AutoevaluacionService.ObtenerAutoevaluacion();

        foreach (var bloque in data)
        {
            foreach (var tarea in bloque.Tareas)
            {
                foreach (var registro in tarea.Registros)
                {
                    Autoevaluaciones.Add(new AutoevaluacionCalendarioItem
                    {
                        Nombre = tarea.Tarea,
                        Fecha = registro.Fecha.ToDateTime(TimeOnly.MinValue),
                        Realizado = registro.Realizado
                    });
                }
            }
        }
    }

    string GetIcon(string title) => title switch
    {
        "Órdenes de Trabajo" => "🧾",
        "Tareas" => "🗂️",
        "Autoevaluación" => "⭐",
        "Servicio a Cliente" => "🏢",
        _ => "📋"
    };
}



<style>
    body {
        margin: 0;
        overflow-y: auto;
    }
    /* Contenedor del calendario */
    .agenda-container {
        min-height: 100vh;
        font-family: Inter, system-ui, sans-serif;
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        width: 100vw;
        height: auto;
        max-width: 100%;
        max-height: 100%;
        margin: 0;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        overflow: visible; /* IMPORTANTE */
    }

    /* Encabezado */
    .agenda-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 0 10px;
    }

        .agenda-header h1 {
            font-size: 32px;
            margin: 0;
            color: #000;
            font-weight: 700;
        }

    /* Controles de botones */
    .header-controls {
        display: flex;
        gap: 15px;
    }

    .agenda-header > .header-controls:first-child {
        min-width: 150px;
        justify-content: flex-start;
    }

    .agenda-header > .header-controls:last-child {
        min-width: 150px;
        justify-content: flex-end;
    }

    /* Botones */
    .btn {
        background: linear-gradient(90deg,#1e7a3a,#0b3c4a);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
    }

        .btn.primary {
            background: linear-gradient(90deg,#1e7a3a,#0b3c4a);
        }

        .btn:hover {
            background: linear-gradient(90deg, #155d2b, #062b35);
            color: white;
            transform: translateY(-1px);
        }

    .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        background: #f5f7fa;
        padding: 10px;
        border-radius: 6px;
        font-weight: 600;
    }

        .collapsible-header:hover {
            background: #e9edf3;
        }

    .toggle-icon {
        font-size: 13px;
    }

    .collapsible-content {
        padding: 10px;
        margin-top: 6px;
        border-left: 3px solid #4f46e5;
    }

    .ot-card, .tramite-card {
        margin-bottom: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }

    .arrow {
        font-weight: 700;
    }

    /* Grid de días */
    .days-grid-mensual {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        flex-grow: 1;
    }

    .day-name-header {
        font-weight: 700;
        text-align: center;
        padding: 10px 0;
        color: #6B7280;
        border-bottom: 2px solid #F3F4F6;
    }

    .day-card {
        background: #ffffff;
        border: 1px solid #E5E7EB;
        border-radius: 10px;
        padding: 10px;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: box-shadow 0.2s;
    }

        .day-card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .day-card.empty {
            background-color: transparent;
            border: none;
            box-shadow: none;
        }

        .day-card.sunday {
            background: #F9FAFB;
            color: #9CA3AF;
        }

    .day-header {
        display: flex;
        justify-content: flex-start;
        font-size: 18px;
        font-weight: 700;
        color: #333;
    }

    .day-card.sunday .day-name {
        color: #9CA3AF;
    }

    /* Bloques de tareas */
    .blocks-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
        list-style: none;
        padding: 0;
    }

    .list-item {
        border-radius: 6px;
        padding: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        overflow: hidden;
        color: #333;
        font-size: 14px;
        line-height: 1.3;
    }

        .list-item:hover {
            filter: brightness(0.97);
            transform: translateY(-1px);
            transition: all 0.15s ease-in-out;
        }

    .list-title {
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .task-count {
        background-color: rgba(255, 255, 255, 0.5);
        color: #333;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        min-width: 15px;
        text-align: center;
    }

    .no-laboral {
        font-weight: 600;
        font-size: 14px;
        color: #EF4444;
        text-align: center;
        margin-top: 10px;
    }

    /* ================= MODAL OVERLAY ================= */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    /* ================= MODAL BASE ================= */
    .modal-content.modern-modal {
        background: #ffffff;
        border-radius: 22px;
        width: 95%;
        max-width: 1100px; /* MÁS ANCHO */
        height: 85vh; /* MÁS ALTO */
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 60px rgba(0,0,0,0.35);
        animation: modalFade 0.25s ease-out;
        overflow: hidden;
    }

    /* ================= HEADER ================= */
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 14px;
        padding: 22px;
        background: linear-gradient(90deg, #1e7a3a, #0b3c4a);
        color: white;
        font-size: 20px;
        font-weight: 700;
    }

    .modal-icon {
        font-size: 26px;
    }

    /* ================= BODY ================= */
    .modal-body.modal-scroll {
        flex: 1;
        padding: 22px 26px;
        overflow-y: auto;
        background: #f8fafc;
    }

    /* Scroll elegante */
    .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    /* ================= FOOTER ================= */
    .modal-footer {
        padding: 16px;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: center;
    }

    /* ================= CARDS ================= */
    .ot-card,
    .tramite-card {
        background: white;
        border-radius: 14px;
        border: 1px solid #e5e7eb;
        margin-bottom: 16px;
        overflow: hidden;
    }

    /* ================= COLLAPSIBLE HEADER ================= */
    .collapsible-header {
        background: #f1f5f9;
        padding: 14px 18px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .collapsible-header:hover {
            background: #e2e8f0;
        }

    .toggle-icon {
        font-size: 14px;
    }

    /* ================= COLLAPSIBLE CONTENT ================= */
    .collapsible-content {
        padding: 18px;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
    }

    /* ================= TASK DETAILS ================= */
    .task-details {
        background: #f9fafb;
        padding: 16px;
        border-radius: 12px;
        margin-top: 12px;
    }

    /* ================= TABLES ================= */
    .subtasks-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 14px;
        font-size: 14px;
    }

        .subtasks-table th {
            background: #f3f4f6;
            padding: 10px;
            font-weight: 600;
        }

        .subtasks-table td {
            padding: 10px;
            border-top: 1px solid #e5e7eb;
        }

        .subtasks-table tr:nth-child(even) {
            background: #fafafa;
        }

    /* ================= LIST ITEMS ================= */
    .collapsible-list li {
        margin-bottom: 8px;
    }

    .task-item.realizado {
        text-decoration: line-through;
        opacity: 0.6;
    }

    /* ================= ANIMATION ================= */
    @@keyframes modalFade {
        from {
            opacity: 0;
            transform: scale(0.96);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>