@page "/calendario"
@using System.Globalization
@using System
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@using System.Collections.Generic
@inject LoginService loginService
@inject AgendaService AgendaService
@inject AutoevaluacionService AutoevaluacionService
@inject OrdenTrabajoService OrdenTrabajoService
@inject OrdenTramiteService OrdenTramiteService
@inject CalendarioService CalendarioService
@inject ServicioClienteService ServicioClienteService
<br />
<br />
<div class="agenda-container">
    <!-- Encabezado -->
    <header class="agenda-header">
        <div class="header-controls">
            <button class="btn" @onclick="PrevMonth">
                <span class="arrow">&#9664;</span> Mes anterior
            </button>
        </div>
        <h1>@MonthName @CurrentDate.Year</h1>
        <div class="header-controls">
            <button class="btn primary" @onclick="NextMonth">
                Mes siguiente <span class="arrow">&#9654;</span>
            </button>
        </div>
    </header>

    <!-- Grid de días -->
    <div class="days-grid-mensual">
        @foreach (var dayName in new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo" })
        {
            <div class="day-name-header">@dayName</div>
        }

        @foreach (var day in Days)
        {
            @if (day != null)
            {
                <div class="day-card @(EsNoLaboral(day.Date) ? "no-laboral" : "")"
                     title="@DescripcionNoLaboral(day.Date)">

                    <div class="day-header">
                        @day.Date.ToString("dd")
                        @if (day.Date.DayOfWeek == DayOfWeek.Sunday)
                        {
                           
                        }
                       
                    </div>


                    @if (EsNoLaboral(day.Date))
                    {
                        <div class="no-laboral">
                            @DescripcionNoLaboral(day.Date)
                        </div>
                    }

                    else
                    {
                        <div class="blocks-list">
                            @foreach (var block in day.Blocks)
                            {
                                <div class="list-item" style="background-color:@block.Color" @onclick="async () => await OpenBlockModal(block)">
                                    <div class="list-title">
                                        @block.Title
                                        <span class="task-count">
                                            @(
                                                                        block.Title == "Autoevaluación"
                                                                        ? block.SubTasks
                                                                        .OfType<AutoevaluacionItem>()
                                                                        .Count(a => !a.Realizado)

                                                                        : block.Title == "Servicio a Cliente"
                                                                        ? block.SubTasks
                                                                        .OfType<ServicioClienteAgendaDTO>()
                                                                        .Count(x => x.Completada != true)

                                                                        : (block.Title == "Tareas" || block.Title == "Tareas Operativas")
                                                                        ? (block.SubTasks.OfType<TaskItem>().Count(t => !t.Completada) +
                                                                        block.SubTasks.OfType<EventItem>().Count(e => !e.Completada))
                                                                        : block.SubTasks.Count

                                                                        )
                                    </span>

                                </div>
                            </div>
                                }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="day-card empty"></div>
            }
        }
    </div>
</div>

<!-- Modal -->
@if (SelectedBlock != null)
{
    <div class="modal-overlay" @onclick="CloseBlockModal">
        <div class="modal-content modern-modal modal-xl" @onclick:stopPropagation="true">
            <div class="modal-header">
                <span class="modal-icon">@GetIcon(SelectedBlock.Title)</span>
                <h2>@SelectedBlock.Title</h2>
            </div>

            <div class="modal-body modal-scrol">

                @* ================= AUTOEVALUACIÓN ================= *@
                @if (SelectedBlock.Title == "Autoevaluación")
                {
                    @if (!SelectedBlock.SubTasks.Any())
                    {
                        <div class="no-tasks-msg">✅ No tienes autoevaluaciones pendientes para este día.</div>
                    }
                    else
                    {
                        <ul class="collapsible-list">
                            @foreach (var task in SelectedBlock.SubTasks.OfType<AutoevaluacionItem>())
                            {
                                <li class="task-item @(task.Realizado ? "realizado" : "")">
                                    @task.Nombre
                                </li>
                            }
                        </ul>
                    }
                }

                @* ================= ÓRDENES DE TRABAJO ================= *@
                else if (SelectedBlock.Title == "Órdenes de Trabajo")
                {
                    var ots = SelectedBlock.SubTasks.OfType<OrdenTrabajoDTO>().ToList();
                    var tramites = SelectedBlock.SubTasks.OfType<OrdenTramiteDTO>().ToList();

                    @if (!ots.Any() && !tramites.Any())
                    {
                        <div class="no-tasks-msg">📋 No se encontraron órdenes de trabajo ni trámites para hoy.</div>
                    }
                    else
                    {
                        @* --- SECCIÓN OT --- *@
                        @foreach (var ot in ots)
                        {
                            <div class="ot-card">
                                <div class="collapsible-header" @onclick="() => ToggleOrdenTrabajo(ot.id)">
                                    <span>🧾 <b>@ot.strClave</b> — @ot.nombreCliente</span>
                                    <span class="toggle-icon">@(OrdenesTrabajoExpandidas.Contains(ot.id) ? "▲" : "▼")</span>
                                </div>

                                @if (OrdenesTrabajoExpandidas.Contains(ot.id))
                                {
                                    <div class="collapsible-content">
                                        <p><b>Autor:</b> @ot.nombreCompleto</p>
                                        <p><b>Fecha solicitud:</b> @ot.dteFechaSolicitud.ToShortDateString()</p>
                                        <p><b>Objetivo:</b> @ot.strValor</p>
                                        @if (!string.IsNullOrWhiteSpace(ot.strObjetivoOtro))
                                        {
                                            <p><b>Objetivo otros:</b> @ot.strObjetivoOtro</p>
                                        }
                                        <p><b>Conclusión programada:</b> @ot.fechaFinal.ToShortDateString()</p>

                                        <table class="subtasks-table">
                                            <thead>
                                                <tr>
                                                    <th>Tarea</th>
                                                    <th>Descripción</th>
                                                    <th>Avance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var t in ot.tareas)
                                                {
                                                    <tr>
                                                        <td>@t.strNombreTarea</td>
                                                        <td>@t.strDescripcionAutor</td>
                                                        <td>@t.avance%</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        }

                        @* --- SECCIÓN TRÁMITES --- *@
                        @foreach (var tr in tramites)
                        {
                            <div class="tramite-card">
                                <div class="collapsible-header" @onclick="() => ToggleOrdenTramite(tr.idOrden)">
                                    <span>📁 <b>@tr.numeroOrden</b> — @tr.nombreGlobal</span>
                                    <span class="toggle-icon">@(OrdenesTramiteExpandidas.Contains(tr.idOrden) ? "▲" : "▼")</span>
                                </div>

                                @if (OrdenesTramiteExpandidas.Contains(tr.idOrden))
                                {
                                    <div class="collapsible-content">
                                        <p><b>Solicitante:</b> @tr.solicitanteInterno</p>
                                        <p><b>Cliente:</b> @tr.cliente</p>
                                        <p><b>Fecha solicitud:</b> @tr.fechaSolicitud</p>
                                        <p><b>Conclusión:</b> @tr.fechaConclusionTramite</p>

                                        <table class="subtasks-table">
                                            <thead>
                                                <tr>
                                                    <th>Clave</th>
                                                    <th>Trámite</th>
                                                    <th>Encargado</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var ti in tr.tramitesIndividuales)
                                                {
                                                    <tr>
                                                        <td>@ti.clave</td>
                                                        <td>@ti.tramiteIndividual</td>
                                                        <td>@ti.personalEncargado</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        }
                    }
                }

                @* ================= SERVICIO A CLIENTE ================= *@
                else if (SelectedBlock.Title == "Servicio a Cliente")
                {
                    var items = SelectedBlock.SubTasks.OfType<ServicioClienteAgendaDTO>().GroupBy(x => x.NombreEmpresa);

                    @if (!items.Any())
                    {
                        <div class="no-tasks-msg">🏢 Este día no tienes servicios programados.</div>
                    }
                    else
                    {
                        @foreach (var empresa in items)
                        {
                            <div class="ot-card">
                                <div class="collapsible-header empresa-header">
                                    <span>🏢 <b>@empresa.Key</b></span>
                                </div>
                                <div class="collapsible-content" style="display: block;">
                                    @foreach (var servicio in empresa.GroupBy(x => x.NombreServicio))
                                    {
                                        var servicioId = $"{empresa.Key}_{servicio.Key}";
                                        <div class="service-card">
                                            <div class="collapsible-header service-header" @onclick="() => ToggleServicio(servicioId)">
                                                <span>▪️ @servicio.Key</span>
                                                <span class="toggle-icon">@(ServiciosExpandidos.Contains(servicioId) ? "▲" : "▼")</span>
                                            </div>

                                            @if (ServiciosExpandidos.Contains(servicioId))
                                            {
                                                <div class="collapsible-content">
                                                    <ul class="actividad-list">
                                                        @foreach (var act in servicio)
                                                        {
                                                            <li class="actividad-item @(act.Completada == true ? "actividad-completada" : "")">
                                                                ↳ @act.NombreActividad
                                                            </li>
                                                        }
                                                    </ul>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                }

                @* ================= TAREAS Y EVENTOS ================= *@
                else if (SelectedBlock.Title == "Tareas" || SelectedBlock.Title == "Tareas Operativas")
                {
                    @if (!SelectedBlock.SubTasks.Any())
                    {
                        <div class="no-tasks-msg">📑 No tienes tareas ni eventos agendados para este día.</div>
                    }
                    else
                    {
                        <ul class="collapsible-list">
                            @foreach (var item in SelectedBlock.SubTasks)
                            {
                                if (item is TaskItem task)
                                {
                                    <li class="ot-card">
                                        <div class="collapsible-header @(task.Completada ? "actividad-completada" : "")" @onclick="() => ToggleTask(task)">
                                            <span>📑 <b>@task.Nombre</b></span>
                                            <span class="toggle-icon">@(ExpandedTasks.Contains(task) ? "▲" : "▼")</span>
                                        </div>
                                        @if (ExpandedTasks.Contains(task))
                                        {
                                            <div class="collapsible-content task-details">
                                                <p><strong>Descripción:</strong> @task.Descripcion</p>
                                                <p><strong>Fecha Inicio:</strong> @task.FechaInicio.ToShortDateString()</p>
                                                <p><strong>Fecha Fin:</strong> @task.FechaFin.ToShortDateString()</p>
                                                <p><strong>Prioridad:</strong> @task.Prioridad</p>

                                                @if (task.Subtareas != null && task.Subtareas.Any())
                                                {
                                                    <p><strong>Subtareas:</strong></p>
                                                    <ul class="actividad-list">
                                                        @foreach (var sub in task.Subtareas)
                                                        {
                                                            <li class="actividad-item">▪ @sub</li>
                                                        }
                                                    </ul>
                                                }
                                            </div>
                                        }
                                    </li>
                                }
                                else if (item is EventItem ev)
                                {
                                    <li class="ot-card">
                                        <div class="collapsible-header @(ev.Completada ? "actividad-completada" : "")" @onclick="() => ToggleEvent(ev)">
                                            <span>📅 <b>@ev.Nombre</b></span>
                                            <span class="toggle-icon">@(ExpandedEvents.Contains(ev) ? "▲" : "▼")</span>
                                        </div>
                                        @if (ExpandedEvents.Contains(ev))
                                        {
                                            <div class="collapsible-content task-details">
                                                <p><strong>Descripción:</strong> @ev.Descripcion</p>
                                                <p><strong>Fecha Inicio:</strong> @ev.FechaInicio.ToShortDateString()</p>
                                                <p><strong>Fecha Fin:</strong> @ev.FechaFin.ToShortDateString()</p>
                                                <p><strong>Horario:</strong> @ev.HoraInicio - @ev.HoraFin</p>
                                            </div>
                                        }
                                    </li>
                                }
                            }
                        </ul>
                    }
                }
            </div>

            <div class="modal-footer">
                <button class="btn primary" @onclick="CloseBlockModal">Cerrar</button>
            </div>
        </div>
    </div>
}



@code {
    List<pruebas1.Entidades.TareaApi> TareasApi = new();
    List<EventoApiDTO> EventosApi = new();
    List<OrdenTrabajoDTO> OrdenesTrabajo = new();
    List<OrdenTramiteDTO> OrdenesTramite = new();
    List<DiaNoLaboralDto> DiasNoLaborales = new();
    List<ServicioClienteAgendaDTO> ServicioClienteAgenda = new();


    class TaskItem
    {
        public string Nombre { get; set; }
        public string Descripcion { get; set; }
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
        public string Prioridad { get; set; }
        public List<string> Subtareas { get; set; } = new();
        public bool Completada { get; set; }
    }
    class EventItem
    {
        public string Nombre { get; set; }
        public string Descripcion { get; set; }
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
        public TimeSpan HoraInicio { get; set; }
        public TimeSpan HoraFin { get; set; }
        public bool Completada { get; set; }
    }
    private HashSet<string> ServiciosExpandidos = new();

    private void ToggleServicio(string servicio)
    {
        if (!ServiciosExpandidos.Add(servicio))
            ServiciosExpandidos.Remove(servicio);
    }

    HashSet<int> OrdenesTrabajoExpandidas = new();

    void ToggleOrdenTrabajo(int idOrden)
    {
        if (!OrdenesTrabajoExpandidas.Add(idOrden))
            OrdenesTrabajoExpandidas.Remove(idOrden);
    }
    HashSet<int> OrdenesTramiteExpandidas = new();

    void ToggleOrdenTramite(int id)
    {
        if (!OrdenesTramiteExpandidas.Add(id))
            OrdenesTramiteExpandidas.Remove(id);
    }


    class AutoevaluacionItem
    {
        public string Nombre { get; set; }
        public bool Realizado { get; set; }
    }

    HashSet<TaskItem> ExpandedTasks = new();

    void ToggleTask(TaskItem task)
    {
        if (ExpandedTasks.Contains(task))
            ExpandedTasks.Remove(task);
        else
            ExpandedTasks.Add(task);
    }

    class Block
    {
        public string Title { get; set; }
        public List<object> SubTasks { get; set; } = new();
        public string Color { get; set; }
    }

    class DayColumn
    {
        public DateTime Date { get; set; }
        public List<Block> Blocks { get; set; } = new();
    }

    List<DayColumn> Days = new();
    DateTime CurrentDate = DateTime.Today;
    Block SelectedBlock = null;

    string MonthName => CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.GetMonthName(CurrentDate.Month);

    protected override async Task OnInitializedAsync()
    {
        await CargarAutoevaluaciones();

        var agendas = await AgendaService.ObtenerAgendaAsignadasAsync();
        var idAgenda = agendas.FirstOrDefault();

        await CargarOrdenes();

        TareasApi = await AgendaService.ObtenerTareasApi(idAgenda);
        EventosApi = await AgendaService.ObtenerEventos(idAgenda);

        ServicioClienteAgenda = await ServicioClienteService.ObtenerAgendaServicioCliente();

        await CargarDiasNoLaborales();
        BuildMonth();
    }

    async Task CargarDiasNoLaborales()
    {
        DiasNoLaborales.Clear();
        try
        {
            var dias = await CalendarioService.ObtenerDiasNoLaborales(CurrentDate.Year, CurrentDate.Month);
            DiasNoLaborales.AddRange(dias);
        }
        catch
        {
            
        }
    }

    bool EsNoLaboral(DateTime date)
    {
        if (date.DayOfWeek == DayOfWeek.Sunday)
            return true;

        return DiasNoLaborales.Any(d =>
            d.DiaInhabil.Date == date.Date);
    }

    string DescripcionNoLaboral(DateTime date)
    {
        if (date.DayOfWeek == DayOfWeek.Sunday)
            return "No laborable";

        return DiasNoLaborales
            .FirstOrDefault(d => d.DiaInhabil.Date == date.Date)
            ?.Descripcion;
    }


    async Task CargarOrdenes()
    {
        var otHoy = await OrdenTrabajoService.GetOrdenesHoy();
        var otProx = await OrdenTrabajoService.GetOrdenesProximas();
        var otVenc = await OrdenTrabajoService.GetOrdenesVencidas();

        OrdenesTrabajo = otHoy
            .Concat(otProx)
            .Concat(otVenc)
            .GroupBy(o => o.id)
            .Select(g => g.First())
            .ToList();

        var trHoy = await OrdenTramiteService.GetHoy();
        var trProx = await OrdenTramiteService.GetProximas();
        var trVenc = await OrdenTramiteService.GetVencidas();

        OrdenesTramite = trHoy
            .Concat(trProx)
            .Concat(trVenc)
            .GroupBy(o => o.idOrden)
            .Select(g => g.First())
            .ToList();
    }

    void BuildMonth()
    {
        Days.Clear();
        var firstDayOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        int firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
        int padding = firstDayOfWeek == 0 ? 6 : firstDayOfWeek - 1;

        for (int i = 0; i < padding; i++)
            Days.Add(null);

        int daysInMonth = DateTime.DaysInMonth(CurrentDate.Year, CurrentDate.Month);
        for (int i = 1; i <= daysInMonth; i++)
        {
            var date = new DateTime(CurrentDate.Year, CurrentDate.Month, i);
            Days.Add(CreateDay(date));
        }
    }
    HashSet<EventItem> ExpandedEvents = new();
    void ToggleEvent(EventItem ev)
    {
        if (ExpandedEvents.Contains(ev))
            ExpandedEvents.Remove(ev);
        else
            ExpandedEvents.Add(ev);
    }

    DayColumn CreateDay(DateTime date)
    {
        var day = new DayColumn { Date = date };
        if (date.DayOfWeek == DayOfWeek.Sunday) return day;
        var tareasDelDia = TareasApi
    .Where(t => t.fechaInicio.Date <= date.Date && t.fechaFin.Date >= date.Date)
    .Select(t => new TaskItem
    {
        Nombre = t.titulo,
        Descripcion = t.descripcion,
        FechaInicio = t.fechaInicio,
        FechaFin = t.fechaFin,
        Prioridad = t.prioridadTitulo ?? "Sin prioridad",
        Subtareas = t.subTareas.Select(s => s.titulo).ToList(),
        Completada = t.completada
    })
    .Cast<object>();

        var eventosDelDia = EventosApi
            .Where(e => e.fechaInicio.Date <= date.Date && e.fechaFin.Date >= date.Date)
            .Select(e => new EventItem
            {
                Nombre = e.titulo,
                Descripcion = e.descripcion,
                FechaInicio = e.fechaInicio,
                FechaFin = e.fechaFin,
                HoraInicio = e.fechaInicio.TimeOfDay,
                HoraFin = e.fechaFin.TimeOfDay
            })
            .Cast<object>();

        day.Blocks.Add(new Block
        {
            Title = "Tareas",
            Color = "#FFD1DC",
            SubTasks = tareasDelDia
                .Concat(eventosDelDia)
                .ToList()
        });


        DateTime FechaOT(OrdenTrabajoDTO ot)
        {
            return ot.fechaFinal.Date;
        }

        DateTime FechaTramite(OrdenTramiteDTO tr)
        {
            return DateTime.TryParse(tr.fechaConclusionTramite, out var d)
                ? d.Date
                : DateTime.MinValue;
        }


        var ordenesTrabajoDia = OrdenesTrabajo
       .Where(o => FechaOT(o) == date.Date)
       .Cast<object>()
       .ToList();

        var ordenesTramiteDia = OrdenesTramite
            .Where(t => FechaTramite(t) == date.Date)
            .Cast<object>()
            .ToList();

        day.Blocks.Add(new Block
        {
            Title = "Órdenes de Trabajo",
            Color = "#FFDAC1",
            SubTasks = ordenesTrabajoDia
         .Concat(ordenesTramiteDia)
         .ToList()
        });


        var autoevaluacionesDelDia = Autoevaluaciones
            .Where(a => a.Fecha.Date == date.Date)
            .Select(a => new AutoevaluacionItem
            {
                Nombre = a.Nombre,
                Realizado = a.Realizado
            })
            .Cast<object>()
            .ToList();

        day.Blocks.Add(new Block
        {
            Title = "Autoevaluación",
            Color = "#E2F0CB",
            SubTasks = autoevaluacionesDelDia
        });

        day.Blocks.Add(new Block
        {
            Title = "Servicio a Cliente",
            Color = "#D7D1DD",
            SubTasks = ServicioClienteAgenda
        .Where(s =>
            s.FechaAsignacion.Date <= date.Date &&
            s.FechaConclusion.Date >= date.Date
        )
        .Cast<object>()
        .ToList()
        });

        return day;
    }

    async void PrevMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        await CargarDiasNoLaborales();
        BuildMonth();
        StateHasChanged();
    }

    async void NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        await CargarDiasNoLaborales();
        BuildMonth();
        StateHasChanged();
    }

    async Task OpenBlockModal(Block block)
    {
        SelectedBlock = block;

        if (block.Title == "Órdenes de Trabajo")
        {
            var detalleCompleto = new List<object>();

            foreach (var item in block.SubTasks)
            {
                if (item is OrdenTrabajoDTO ot)
                {
                    var detalle = await OrdenTrabajoService.GetDetalle(ot.id);
                    if (detalle != null)
                        detalleCompleto.Add(detalle);
                }
                else
                {
                    detalleCompleto.Add(item);
                }
            }

            SelectedBlock.SubTasks = detalleCompleto;
        }
    }

    void CloseBlockModal() => SelectedBlock = null;

    class AutoevaluacionCalendarioItem
    {
        public string Nombre { get; set; }
        public DateTime Fecha { get; set; }
        public bool Realizado { get; set; }
    }

    List<AutoevaluacionCalendarioItem> Autoevaluaciones = new();

    async Task CargarAutoevaluaciones()
    {
        Autoevaluaciones.Clear();
        var data = await AutoevaluacionService.ObtenerAutoevaluacion();

        foreach (var bloque in data)
        {
            foreach (var tarea in bloque.Tareas)
            {
                foreach (var registro in tarea.Registros)
                {
                    Autoevaluaciones.Add(new AutoevaluacionCalendarioItem
                    {
                        Nombre = tarea.Tarea,
                        Fecha = registro.Fecha.ToDateTime(TimeOnly.MinValue),
                        Realizado = registro.Realizado
                    });
                }
            }
        }
    }

    string GetIcon(string title) => title switch
    {
        "Órdenes de Trabajo" => "🧾",
        "Tareas" => "🗃️",
        "Autoevaluación" => "⭐",
        "Servicio a Cliente" => "🏢",
        _ => "📋"
    };
}



