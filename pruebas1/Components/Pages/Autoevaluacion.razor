@page "/autoevaluacion"

<br />

<h2 class="title">📋 Autoevaluación</h2>

<div class="evaluation-container">
    @foreach (var bloque in Bloques)
    {
        <div class="block">
            <h3 class="block-title">@bloque.Nombre</h3>
            <table class="activities-table">
                <thead>
                    <tr>
                        <th>Actividad</th>
                        <th>Periodicidad</th>
                        <th>Programado</th>
                        <th>Realizado</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tarea in bloque.Tareas)
                    {
                        <tr>
                            <td class="@GetTextDecoration(tarea)">@tarea.Nombre</td>
                            <td>
                                <span class="badge @tarea.Periodicidad.ToLower()">@tarea.Periodicidad</span>
                            </td>
                            <td class="check-cell">@tarea.RegistradoProgramado</td>
                            <td class="check-cell">
                                <input type="checkbox"
                                       checked="@tarea.Realizado"
                                       @onchange="(e) => OnCheckChanged(tarea, e.Value is bool b && b)"
                                       disabled="@IsLocked" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<div class="save-container">
    <button class="btn-save" @onclick="ConfirmarGuardar" disabled="@IsLocked">Guardar Autoevaluación</button>
</div>

<!-- Modal para seleccionar día/fecha -->
@if (ShowModal)
{
    <div class="overlay" @onclick="CloseModal">
        <div class="modal small" @onclick:stopPropagation="true">
            <h3 class="modal-title">@ModalTitle</h3>

            <div class="modal-body">
                @if (IsWeekly)
                {
                    <label>Selecciona el día de la semana:</label>
                    <div class="weekdays small">
                        @for (int i = 0; i < WeekDays.Length; i++)
                        {
                            <label class="day-option small @(IsLocked ? "locked" : "")">
                                <input type="radio"
                                       name="weekday"
                                       @bind-Value="SelectedWeekIndex"
                                       @bind-Value:event="onchange"
                                       disabled="@IsLocked" />
                                <span>@WeekDays[i]</span>
                            </label>
                        }
                    </div>
                }
                else if (IsMonthly)
                {
                    <label>Selecciona la fecha:</label>
                    <input type="date" @bind="SelectedDate" class="input-date small" disabled="@IsLocked" />
                }
                else if (IsAnnual)
                {
                    <label>Selecciona el mes y año:</label>
                    <input type="month" @bind="SelectedDate" class="input-date small" disabled="@IsLocked" />
                }
            </div>

            <div class="modal-footer">
                <button class="btn-save" @onclick="SaveModal" disabled="@IsLocked">Guardar</button>
                <button class="btn-cancel" @onclick="CloseModal" disabled="@IsLocked">Cancelar</button>
            </div>
        </div>
    </div>
}

@if (ShowConfirm)
{
    <div class="overlay" @onclick="() => ShowConfirm = false">
        <div class="modal small" @onclick:stopPropagation="true">
            <h3 class="modal-title">Confirmar Guardado</h3>
            <div class="modal-body">
                ¿Seguro que desea guardar la autoevaluación? Solo podrá editar hasta fin de mes.
            </div>
            <div class="modal-footer">
                <button class="btn-save" @onclick="GuardarAutoevaluacionFinal">Sí, guardar</button>
                <button class="btn-cancel" @onclick="() => ShowConfirm = false">Cancelar</button>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(AlertMessage))
{
    <div class="alert-modal @AlertType">
        <span>@AlertMessage</span>
        <button class="close-alert" @onclick="() => AlertMessage = string.Empty">×</button>
    </div>
}

@code {
    public class Tarea
    {
        public string Nombre { get; set; } = "";
        public string Periodicidad { get; set; } = "";
        public bool Realizado { get; set; } = false;
        public string RegistradoProgramado { get; set; } = "";
    }

    public class Bloque
    {
        public string Nombre { get; set; } = "";
        public List<Tarea> Tareas { get; set; } = new();
    }

    public List<Bloque> Bloques { get; set; } = new();

    public bool ShowModal { get; set; }
    public bool IsWeekly { get; set; }
    public bool IsMonthly { get; set; }
    public bool IsAnnual { get; set; }
    public string ModalTitle { get; set; } = string.Empty;
    public bool IsLocked { get; set; } = false;
    public bool ShowConfirm { get; set; } = false;

    public string[] WeekDays = new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado" };
    public int SelectedWeekIndex { get; set; } = -1;
    public DateTime SelectedDate { get; set; } = DateTime.Today;
    private Tarea? CurrentTask;

    private string AlertMessage { get; set; } = "";
    private string AlertType { get; set; } = "info";

    protected override void OnInitialized()
    {
        Bloques = new List<Bloque>
        {
            new Bloque
            {
                Nombre = "CONTROL ADMINISTRATIVO DEL SPEC",
                Tareas = new List<Tarea>
                {
                    new() { Nombre = "Área limpia y funcional", Periodicidad = "Diario" },
                    new() { Nombre = "Control de suscripciones TI", Periodicidad = "Semanal" },
                    new() { Nombre = "Solicitudes de pago activo fijo", Periodicidad = "Mensual" },
                    new() { Nombre = "Seguimiento a reportes de pago", Periodicidad = "Mensual" },
                    new() { Nombre = "Entrega de informes y autoevaluaciones", Periodicidad = "Semanal" }
                }
            },
            new Bloque
            {
                Nombre = "COMUNICACIÓN",
                Tareas = new List<Tarea>
                {
                    new() { Nombre = "Confirmé actividades programadas", Periodicidad = "Diario" },
                    new() { Nombre = "Efectué llamadas y control de asuntos pendientes", Periodicidad = "Diario" }
                }
            },
            new Bloque
            {
                Nombre = "AGENDA",
                Tareas = new List<Tarea>
                {
                    new() { Nombre = "Actualización de agenda y recados", Periodicidad = "Diario" },
                    new() { Nombre = "Programé citas y comuniqué responsables", Periodicidad = "Diario" },
                    new() { Nombre = "Revisión de pendientes", Periodicidad = "Semanal" },
                    new() { Nombre = "Retroalimentación psicométrica", Periodicidad = "Anual" }
                }
            }
        };
    }

    private void OnCheckChanged(Tarea tarea, bool value)
    {
        if (IsLocked) return;

        CurrentTask = tarea;

        if (tarea.Periodicidad == "Semanal")
        {
            IsWeekly = true; IsMonthly = false; IsAnnual = false;
            ModalTitle = tarea.Nombre;

            // Si ya tiene valor, selecciona el día correcto
            SelectedWeekIndex = Array.IndexOf(WeekDays, tarea.RegistradoProgramado);
            if (SelectedWeekIndex < 0) SelectedWeekIndex = 0; // default

            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Mensual")
        {
            IsWeekly = false; IsMonthly = true; IsAnnual = false;
            ModalTitle = tarea.Nombre;
            SelectedDate = DateTime.Today;
            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Anual")
        {
            IsWeekly = false; IsMonthly = false; IsAnnual = true;
            ModalTitle = tarea.Nombre;
            SelectedDate = DateTime.Today;
            ShowModal = true;
        }
        else
        {
            tarea.Realizado = value;
            tarea.RegistradoProgramado = "Registrado";
        }
    }

    private void SaveModal()
    {
        if (CurrentTask != null)
        {
            if (IsWeekly)
            {
                CurrentTask.Realizado = true;
                CurrentTask.RegistradoProgramado = WeekDays[SelectedWeekIndex];
            }
            else if (IsMonthly)
            {
                CurrentTask.Realizado = true;
                CurrentTask.RegistradoProgramado = SelectedDate.Day + " de cada mes";
            }
            else if (IsAnnual)
            {
                CurrentTask.Realizado = true;
                CurrentTask.RegistradoProgramado = SelectedDate.ToString("MMMM yyyy");
            }
        }
        ShowModal = false;
    }

    private void CloseModal() => ShowModal = false;

    private string GetTextDecoration(Tarea tarea)
        => (tarea.Realizado && !string.IsNullOrEmpty(tarea.RegistradoProgramado)) ? "subrayado" : "";

    private void ConfirmarGuardar()
    {
        var incomplete = Bloques.SelectMany(b => b.Tareas)
                                .Where(t => t.Realizado && string.IsNullOrEmpty(t.RegistradoProgramado))
                                .ToList();
        if (incomplete.Any())
        {
            AlertMessage = "No puede guardar hasta que llene los días de todas las tareas marcadas";
            AlertType = "error";
            return;
        }
        ShowConfirm = true;
    }

    private void GuardarAutoevaluacionFinal()
    {
        IsLocked = true;
        ShowConfirm = false;
        AlertMessage = "Autoevaluación guardada correctamente. No podrá editar hasta fin de mes.";
        AlertType = "success";
    }
}

<style>
    /* -------------------- ESTILOS -------------------- */
    .title {
        text-align: center;
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        color: #333;
    }

    .evaluation-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        width: 95%;
        max-width: 1100px;
        margin: 0 auto;
    }

    .block {
        background: #fff;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .block-title {
        color: #1a237e;
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
    }

    .activities-table {
        width: 100%;
        border-collapse: collapse;
    }

        .activities-table th {
            text-align: left;
            background: #f4f4f8;
            padding: 0.6rem;
            font-weight: 600;
            color: #333;
        }

        .activities-table td {
            padding: 0.6rem;
            border-top: 1px solid #eee;
            vertical-align: middle;
        }

    .badge {
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        font-size: 0.8rem;
        color: #fff;
        text-transform: capitalize;
    }

        .badge.diario {
            background: #4caf50;
        }

        .badge.semanal {
            background: #2196f3;
        }

        .badge.mensual {
            background: #9c27b0;
        }

        .badge.eventual {
            background: #ff9800;
        }

        .badge.anual {
            background: #607d8b;
        }

    .check-cell {
        text-align: center;
    }

    /* Subrayado negro arriba del texto */
    .subrayado {
        border-top: 2px solid black;
        font-weight: 600;
        padding-top: 2px;
    }

    /* Botón de guardar centrado */
    .save-container {
        display: flex;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .btn-save, .btn-cancel {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .btn-save {
        background: #007bff;
        color: white;
    }

        .btn-save:hover {
            background: #0056b3;
        }

    .btn-cancel {
        background: #f1f1f1;
        color: #333;
    }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

    /* Radio semanal bloqueado */
    .day-option.locked {
        background: #e0e0e0;
        color: #555;
        cursor: not-allowed;
    }

        .day-option.locked span {
            opacity: 0.7;
        }

    /* Modal centrado */
    .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal {
        background: #fff;
        border-radius: 14px;
        padding: 1.5rem;
        width: 90%;
        max-width: 360px;
        box-shadow: 0 6px 24px rgba(0,0,0,0.25);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .modal-title {
        text-align: center;
        margin: 0;
        font-weight: 600;
        color: #333;
    }

    .modal-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .weekdays {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
    }

    .day-option {
        background: #f3f3f3;
        border-radius: 8px;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

        .day-option:hover {
            background: #e2e8f0;
        }

        .day-option input[type="radio"] {
            accent-color: #007bff;
        }

    .input-date {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 0.95rem;
        width: 100%;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.8rem;
    }

    /* Alertas */
    .alert-modal {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 1rem 1.2rem;
        border-radius: 10px;
        color: white;
        z-index: 2000;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

        .alert-modal.info {
            background: #2196f3;
        }

        .alert-modal.success {
            background: #4caf50;
        }

        .alert-modal.error {
            background: #f44336;
        }

    .close-alert {
        background: transparent;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
    }

</style>
