@page "/autoevaluacion"
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
@inject IJSRuntime JS
@inject AutoevaluacionService AutoService

<br />
<br />
<br />
<h2 class="title">📋 Autoevaluación</h2>

<div class="evaluation-container">
    @foreach (var bloque in Bloques)
    {
        <div class="block">
            <h3 class="block-title">@bloque.Nombre</h3>
            <table class="activities-table">
                <thead>
                    <tr>
                        <th>Actividad</th>
                        <th>Periodicidad</th>
                        <th>Programado</th>
                        <th>Selección</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tarea in bloque.Tareas)
                    {
                        <tr>
                            <td class="@GetTextDecoration(tarea)">@tarea.Nombre</td>
                            <td>
                                <span class="badge @tarea.Periodicidad.ToLower()">@tarea.Periodicidad</span>
                            </td>
                 <td class="check-cell"
                        title="@string.Join(", ", FechasEventuales.Select(f => f.ToString("dd/MM/yyyy")))" >

                        <div class="fechas-multiline">
    @foreach (var linea in tarea.RegistradoProgramado.Split('\n'))
    {
        <div class="fecha-linea">@linea</div>
    }
</div>


                    </td>
       @* CLase  que maneja el chek del eventual y añade el boton de editar*@              
                            <td class="check-cell">
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <input type="checkbox"
                                           checked="@tarea.Realizado"
                                           @onchange="(e) => OnCheckChanged(tarea, e.Value is bool b && b)"
                                           disabled="@IsLocked" />

                                    @* 🔥 NUEVO — BOTÓN EDITAR SOLO PARA EVENTUALES (junto al checkbox) *@
                                   @if (tarea.Periodicidad == "Eventual"
                                     && !string.IsNullOrWhiteSpace(tarea.RegistradoProgramado)
                                     && tarea.Realizado
                                     && !IsLocked)
{
                                        <button class="btn-confirm" style="padding:4px 8px; font-size:12px;"
                                                @onclick="() => EditarEventual(tarea)">
                                            ✏️
                                        </button>
                                    }
                                </div>
                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<div class="save-container">
    <button class="btn-save" @onclick="ConfirmarGuardar" disabled="@IsLocked">
        Guarda Autoevaluación
    </button>
</div>

<!-- Modal para seleccionar día/fecha -->
@if (ShowModal)
{
    <div class="confirm-overlay">
        <div class="confirm-modal" style="max-width: 500px;">

            <h3 class="confirm-title">@ModalTitle</h3>

            <div class="confirm-message">

                @* SEMANAL *@
                @if (IsWeekly)
                {
                    <p>Seleccione el día programado:</p>

                    <div class="weekdays" style="display:flex; justify-content:center;">
                        <select @bind="SelectedWeekIndex" class="select-days">
                            @for (int j = 0; j < WeekDays.Length; j++)
                            {
                                <option value="@j">@WeekDays[j]</option>
                            }
                        </select>
                    </div>
                }

                @* MENSUAL *@
                @if (IsMonthly)
                {
                    <p>Seleccione la fecha del mes:</p>

                    <DatePicker Value="CurrentTask.FechaMensualSeleccionada"
                                ValueChanged="@(v => CurrentTask.FechaMensualSeleccionada = v)"
                                CssClass="form-control" />

                }


                @* EVENTUAL (AHORA SOPORTA VARIAS FECHAS + OPCIÓN SIN FECHAS) *@
                @if (IsEventual)
                {
                    <div class="modal-section">

                        <label>Seleccione una o varias fechas del evento:</label>

                        <div class="eventual-scroll">
                            @for (int i = 0; i < FechasEventuales.Count; i++)
                            {
                                var localIndex = i;

                                <div style="display:flex; gap:10px; margin-bottom:8px; align-items:center;">

                                    <DatePicker Value="FechasEventuales[localIndex]"
                                                ValueChanged="@(v => OnFechaEventualChange(localIndex, v))"
                                                CssClass="form-control" />

                                    @if (FechasEventuales.Count > 1)
                                    {
                                        <button class="btn-cancel" style="padding:6px 10px; height:38px;"
                                                @onclick="() => RemoveFechaEventual(localIndex)">
                                            ❌
                                        </button>
                                    }
                                </div>
                            }
                        </div>

                        <div style="display:flex;
                    justify-content:space-between;
                    gap:12px;
                    margin-top:12px;">

                            <!-- IZQUIERDA -->
                            <button class="btn-confirm" style="white-space:nowrap"
                                    @onclick="AddNuevaFechaEventual">
                                ➕ Añadir nueva fecha
                            </button>

                            <!-- DERECHA -->
                            <button class="btn-cancel" style="white-space:nowrap"
                                    @onclick="NoSeleccionarFechasEventual">
                                ❌ No seleccionar fechas
                            </button>

                        </div>


                    </div>
                }


                @if (IsAnnual)
                {
                    <p>Seleccione una fecha anual (opcional):</p>

                    <DatePicker Value="SelectedDate"
                                ValueChanged="@(v => SelectedDate = v)"
                                CssClass="form-control" />

                    <div style="display:flex; justify-content:center; margin-top:12px;">
                        <button class="btn-cancel"
                                @onclick="NoSeleccionarFechaAnual">
                            ❌ No seleccionar fecha
                        </button>
                    </div>
                }





                @if (IsQuincenal)
{
    <div class="modal-section">
        <label>Seleccione una fecha por quincena:</label>

        <div style="display:flex; gap:10px; margin-bottom:8px;">
            <DatePicker Value="FechasQuincenales[0]"
                        ValueChanged="@(v => FechasQuincenales[0] = v)"
                        CssClass="form-control" />
        </div>

        <div style="display:flex; gap:10px; margin-bottom:8px;">
            <DatePicker Value="FechasQuincenales[1]"
                        ValueChanged="@(v => FechasQuincenales[1] = v)"
                        CssClass="form-control" />
        </div>

        <small style="color:#6c757d">
            Una fecha del <strong>1–15</strong> y otra del <strong>16–31</strong>
        </small>
    </div>
}




            </div>

            <div class="confirm-footer">
                <button class="btn-confirm" @onclick="SaveModal">Guardar</button>
                <button class="btn-cancel" @onclick="CloseModal">Cancelar</button>
            </div>

        </div>
    </div>
}

@if (ShowConfirm)
{
    <div class="confirm-overlay">
        <div class="confirm-modal">
            <h3 class="confirm-title">Confirmar guardado</h3>
            <p class="confirm-message">¿Seguro que desea guardar la autoevaluación? Solo podrá editar hasta fin de mes.</p>

            <div class="confirm-footer">
                <button class="btn-confirm"
                        disabled="@IsSaving"
                        @onclick="GuardarAutoevaluacionFinal">

                    @if (IsSaving)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span style="margin-left:6px;">Guardando...</span>
                    }
                    else
                    {
                        <span>Sí, guardar</span>
                    }
                </button>

                <button class="btn-cancel" @onclick="() => ShowConfirm = false">Cancelar</button>
            </div>
        </div>
    </div>
}

@if (ShowAlertModal)
{
    <div class="alert-overlay">
        <div class="alert-modal">
            <h3 class="alert-title">@AlertTitle</h3>
            <p class="alert-message">@AlertMessage</p>

            <div class="alert-footer">
                <button class="btn-confirm" @onclick="() => ShowAlertModal = false">Aceptar</button>
            </div>
        </div>
    </div>
}


@code {
    private bool IsSaving = false;   // CORRECTO
    public List<DateTime?> FechasQuincenales { get; set; } = new();


    // Extrae IdTareaAU desde tu objeto de tarea del frontend
    // Si tu Tarea de frontend ya tiene IdTareaAU (recomendado), retornarlo directamente.
    // Si no, implementa la forma en que lo guardaste (por ejemplo: tarea.IdTareaAU)
    private int GetIdFromTareaObject(Tarea tarea)
    {
        return (tarea as dynamic)?.IdTareaAU ?? 0;
    }

    // Parsear las líneas (varias líneas con saltos y comas) a DateTime list
    private List<DateTime> ParseFechasFromRegistradoProgramado(string registrado)
    {
        var list = new List<DateTime>();
        if (string.IsNullOrWhiteSpace(registrado)) return list;

        // El formato aquí es: líneas separadas por '\n', y dentro de cada línea fechas separadas por ','
        var partesLineas = registrado.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        foreach (var linea in partesLineas)
        {
            var fechas = linea.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            foreach (var f in fechas)
            {
                // f viene como "dd/MM/yyyy" — parsear con exacto
                if (DateTime.TryParseExact(f.Trim(), "dd/MM/yyyy", System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out var dt))
                {
                    list.Add(dt);
                }
            }
        }

        // ordenar y devolver único
        return list.Distinct().OrderBy(x => x).ToList();
    }

    bool ShowAlertModal = false;
    string AlertTitle = "Mensaje";
    string AlertMessage = "";
    void ShowAlert(string title, string message)
    {
        AlertTitle = title;
        AlertMessage = message;
        ShowAlertModal = true;
    }

    public class Tarea
    {
        public int IdTareaAU { get; set; }  // ← 🔥 NECESARIO
        public string Nombre { get; set; } = "";
        public string Periodicidad { get; set; } = "";
        public bool Realizado { get; set; } = false;
        public string RegistradoProgramado { get; set; } = "";
        public DateTime? FechaMensualSeleccionada { get; set; }

    }

    public class Bloque
    {
        public string Nombre { get; set; } = "";
        public List<Tarea> Tareas { get; set; } = new();
    }

    public List<Bloque> Bloques { get; set; } = new();

    public bool ShowModal { get; set; }
    public bool IsWeekly { get; set; }
    public bool IsMonthly { get; set; }
    public bool IsAnnual { get; set; }
    public string ModalTitle { get; set; } = string.Empty;
    public bool IsLocked { get; set; } = false;
    public bool ShowConfirm { get; set; } = false;
    bool IsEventual = false; 
    bool IsQuincenal = false;

    public string[] WeekDays = new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado" };
    public int SelectedWeekIndex { get; set; } = -1;
    int SelectedMonthDay = 0;
    int SelectedYearMonth = 0;
    string SelectedTime = "";
    public DateTime? SelectedDate { get; set; } = null;

    private Tarea? CurrentTask;
    private DateTime? FechaEventual { get; set; }

    // ---------- NUEVO: lista de fechas para Eventual ----------
    public List<DateTime> FechasEventuales { get; set; } = new();

    //BOTON PARA DEJAR EN BLANCO LAS FECHAS EVENTUALES
    private void NoSeleccionarFechasEventual()
    {
        if (CurrentTask == null)
            return;

        // 👉 Marcar como realizada SIN fechas
        CurrentTask.Realizado = true;
        CurrentTask.RegistradoProgramado = "";

        // Limpiar fechas eventuales
        FechasEventuales.Clear();

        // Cerrar modal
        IsEventual = false;
        ShowModal = false;
    }

    private void NoSeleccionarFechaAnual()
    {
        if (CurrentTask == null)
            return;

        // ✔ Marcar como realizada
        CurrentTask.Realizado = true;

        // ✔ Anual puede ir vacío
        CurrentTask.RegistradoProgramado = "";

        // ✔ Limpiar selección
        SelectedDate = null;

        // ✔ Cerrar modal
        IsAnnual = false;
        ShowModal = false;
    }

    void LimpiarFechaAnual()
    {
        SelectedDate = null;
    }


    // ---------- CODIGO PARA CONVERTIR LAS FECHAS
    private void OnFechaEventualChange(int index, DateTime? value)
    {
        if (index < 0 || index >= FechasEventuales.Count)
            return;

        if (value.HasValue)
            FechasEventuales[index] = value.Value;
    }


    // ===== BACKUP PARA CANCELACIÓN =====
    private bool BackupRealizado;
    private string BackupRegistradoProgramado = "";
    private List<DateTime> BackupFechasEventuales = new();

    private string AlertType { get; set; } = "info";
    async Task Guardar()
    {
        // VALIDACIONES
        if (IsWeekly && SelectedWeekIndex < 0)
        {
            await JS.InvokeVoidAsync("Swal.fire", new
            {
                icon = "warning",
                title = "Falta seleccionar un día",
                text = "Debes elegir un día de la semana antes de guardar."
            });
            return;
        }

        if (IsMonthly && SelectedMonthDay <= 0)
        {
            await JS.InvokeVoidAsync("Swal.fire", new
            {
                icon = "warning",
                title = "Falta seleccionar un día del mes",
                text = "Selecciona un día del 1 al 31."
            });
            return;
        }

        if (IsAnnual && SelectedYearMonth <= 0)
        {
            await JS.InvokeVoidAsync("Swal.fire", new
            {
                icon = "warning",
                title = "Falta seleccionar un mes del año",
                text = "Selecciona un mes válido antes de guardar."
            });
            return;
        }

        // SI TODO ESTÁ BIEN → GUARDAR
        await JS.InvokeVoidAsync("Swal.fire", new
        {
            icon = "success",
            title = "¡Guardado exitosamente!",
            showConfirmButton = false,
            timer = 1500
        });

        // Cerrar modal
        ShowModal = false;
    }


    protected override async Task OnInitializedAsync()
    {
        Bloques = new List<Bloque>();

        // ← cargar autoevaluación desde tu API
        await CargarAutoevaluacionAsync();
    }

    private async Task CargarAutoevaluacionAsync()
    {
        var data = await AutoService.ObtenerAutoevaluacion();

        int mesActual = DateTime.Today.Month;
        int añoActual = DateTime.Today.Year;

        // ---------------------------------------------
        // 🔒 1) Determinar si se debe bloquear
        // ---------------------------------------------
        IsLocked =
            data.SelectMany(b => b.Tareas)
                .Any(t =>
                    t.Registros != null &&
                    t.Registros.Any(r =>
                        r.Fecha.Month == mesActual &&
                        r.Fecha.Year == añoActual
                    )
                );

        Bloques.Clear();

        // ---------------------------------------------
        // 2) Construir bloques desde REGISTROS
        // ---------------------------------------------
        foreach (var bloqueApi in data)
        {
            var nuevoBloque = new Bloque
            {
                Nombre = bloqueApi.Bloque,
                Tareas = new List<Tarea>()
            };

            foreach (var t in bloqueApi.Tareas)
            {
                bool tieneRegistroValido =
                    t.Registros != null &&
                    t.Registros.Any(r =>
                        r.Fecha.Month == mesActual &&
                        r.Fecha.Year == añoActual
                    );

                bool realizadoFinal = tieneRegistroValido;
                string programadoFinal = "";
                DateTime? fechaReal = null;

                if (tieneRegistroValido)
                {
                    var fechas = t.Registros
                        .Where(r => r.Fecha.Month == mesActual && r.Fecha.Year == añoActual)
                        .Select(r => r.Fecha.ToDateTime(TimeOnly.MinValue))
                        .OrderBy(f => f)
                        .ToList();

                    fechaReal = fechas.FirstOrDefault();

                    if (t.Periodicidad == "Diario")
                    {
                        programadoFinal = "Registrado";
                    }
                    else if (t.Periodicidad is "Eventual" or "Quincenal" or "Anual")
                    {
                        programadoFinal = FormatearFechasEnLineas(fechas);
                    }
                    else if (t.Periodicidad == "Mensual")
                    {
                        var f = fechas.First();
                        programadoFinal = $"{f.Day} de {f:MMMM}";
                    }
                    else if (t.Periodicidad == "Semanal")
                    {
                        programadoFinal = fechas.First().DayOfWeek switch
                        {
                            DayOfWeek.Monday => "Lunes",
                            DayOfWeek.Tuesday => "Martes",
                            DayOfWeek.Wednesday => "Miércoles",
                            DayOfWeek.Thursday => "Jueves",
                            DayOfWeek.Friday => "Viernes",
                            DayOfWeek.Saturday => "Sábado",
                            _ => ""
                        };
                    }
                }

                nuevoBloque.Tareas.Add(new Tarea
                {
                    IdTareaAU = t.IdTareaAU,
                    Nombre = t.Tarea,
                    Periodicidad = t.Periodicidad,

                    RegistradoProgramado = programadoFinal,
                    Realizado = realizadoFinal,

                    FechaMensualSeleccionada = fechaReal
                });
            }

            Bloques.Add(nuevoBloque);
        }
    }


    // Helper: intenta extraer una fecha usable para "Mensual" desde el texto Programado.
    // Acepta formatos:
    //  - "dd/MM/yyyy"   -> devuelve esa fecha
    //  - "15 de cada mes" -> devuelve la fecha correspondiente al día 15 del mes actual
    // Si no puede parsear devuelve null.
    private DateTime? ParseFechaMensual(string programado)
    {
        if (string.IsNullOrWhiteSpace(programado))
            return null;

        // 1) si viene como fecha exacta dd/MM/yyyy
        if (DateTime.TryParseExact(programado.Trim(),
                                   "dd/MM/yyyy",
                                   System.Globalization.CultureInfo.InvariantCulture,
                                   System.Globalization.DateTimeStyles.None,
                                   out var exactDate))
        {
            return exactDate;
        }

        // 2) si viene como "15 de cada mes" (tomamos el primer token como día)
        var tokens = programado.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (tokens.Length > 0 && int.TryParse(tokens[0], out var dia))
        {
            var hoy = DateTime.Today;
            // Asegurarnos que el día existe en el mes actual
            var diaValido = Math.Clamp(dia, 1, DateTime.DaysInMonth(hoy.Year, hoy.Month));
            return new DateTime(hoy.Year, hoy.Month, diaValido);
        }

        return null;
    }

    private async Task GuardarAutoevaluacionFinal()
    {
        if (IsSaving)
            return;

        IsSaving = true;

        // ⛔ Cerrar el modal de confirmación inmediatamente
        ShowConfirm = false;

        var dto = new GuardarAutoevaluacionEmpleadoDTO
        {
            Tareas = new List<RegistroTareaDTO>()
        };

        foreach (var bloque in Bloques)
        {
            foreach (var tarea in bloque.Tareas)
            {
                var idTareaProp = GetIdFromTareaObject(tarea);
                if (idTareaProp == 0)
                    continue;

                var registro = new RegistroTareaDTO
                {
                    IdTareaAU = idTareaProp,
                    Fechas = new List<DateOnly>(),
                    DiaSemana = null,
                    DiaMes = null
                };

                // ================= EVENTUAL / QUINCENAL / ANUAL =================
                if (tarea.Periodicidad is "Eventual" or "Quincenal" or "Anual")
                {
                    if (!string.IsNullOrWhiteSpace(tarea.RegistradoProgramado))
                    {
                        var fechas = ParseFechasFromRegistradoProgramado(tarea.RegistradoProgramado);

                        registro.Fechas = fechas
                            .Select(f => DateOnly.FromDateTime(f))
                            .ToList();
                    }
                }

                // ================= SEMANAL =================
                if (tarea.Periodicidad == "Semanal")
                {
                    registro.DiaSemana = ConvertirDiaSemana(tarea.RegistradoProgramado);
                }

                // ================= MENSUAL =================
                if (tarea.Periodicidad == "Mensual")
                {
                    if (tarea.FechaMensualSeleccionada == null)
                        throw new Exception("Debe seleccionar una fecha mensual.");

                    registro.Fechas.Add(
                        DateOnly.FromDateTime(tarea.FechaMensualSeleccionada.Value)
                    );
                }

                dto.Tareas.Add(registro);
            }
        }

        try
        {
            // ⏱️ TIMEOUT DE 3 MINUTOS
            using var cts = new CancellationTokenSource(TimeSpan.FromMinutes(3));

            var ok = await AutoService.GuardarAutoevaluacion(dto, cts.Token);

            if (ok)
            {
                IsLocked = true;

                await JS.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "success",
                    title = "Guardado",
                    timer = 1200,
                    showConfirmButton = false
                });
            }
        }
        catch (OperationCanceledException)
        {
            await JS.InvokeVoidAsync("Swal.fire", new
            {
                icon = "error",
                title = "Error",
                text = "Problemas al guardar, verifique su conexión e intente más tarde"
            });
        }
        catch (Exception ex)
        {
            // 🔥 MENSAJE CLARO DE FECHAS FUERA DEL MES
            if (ex.Message.Contains("mes", StringComparison.OrdinalIgnoreCase))
            {
                await JS.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "warning",
                    title = "Fechas inválidas",
                    text = "Todas las fechas seleccionadas deben ser del mes en curso"
                });
            }
            else
            {
                await JS.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "error",
                    title = "Error al guardar (Verifique que todas las fechas seleccionadas sean del mes en curso) ",
                    text = ex.Message
                });
            }

            IsLocked = false;
        }
        finally
        {
            IsSaving = false;
        }
    }




    private int ConvertirDiaSemana(string diaTexto)
    {
        if (string.IsNullOrWhiteSpace(diaTexto))
            throw new Exception("No se envió el día de la semana.");

        return diaTexto.Trim().ToLower() switch
        {
            "lunes" => 0,
            "martes" => 1,
            "miércoles" => 2,
            "jueves" => 3,
            "viernes" => 4,
            "sábado" => 5,
            "sabado" => 5,
            "domingo" => 6,
            _ => throw new Exception("Día de semana inválido: " + diaTexto)
        };
    }

    private void OnCheckChanged(Tarea tarea, bool value)
    {
        if (IsLocked) return;

        // ✔ SI DESMARCA → LIMPIAR TODO
        if (!value)
        {
            tarea.Realizado = false;
            tarea.RegistradoProgramado = "";
            SelectedWeekIndex = -1;
            SelectedDate = DateTime.Today;
            CurrentTask = null;
            ShowModal = false;
            IsEventual = false; // asegurar reset
            FechasEventuales = new List<DateTime>(); // limpiar listas de fechas
            return;
        }

        // ✔ SI MARCA → ABRIR EL MODAL SEGÚN PERIODICIDAD O SOLO MARCAR SI YA ESTÁ PROGRAMADA (Eventual)
        CurrentTask = tarea;

        ////// 🔥 BACKUP DE DATOS PARA CANCELAR
        BackupRealizado = tarea.Realizado;
        BackupRegistradoProgramado = tarea.RegistradoProgramado;
        try
        {
            BackupFechasEventuales = FechasEventuales?.ToList() ?? new List<DateTime>();
            if (BackupFechasEventuales == null || !BackupFechasEventuales.Any())
            {
                // intentar parsear desde tarea.RegistradoProgramado
                var tmp = new List<DateTime>();
                if (!string.IsNullOrWhiteSpace(tarea.RegistradoProgramado))
                {
                    foreach (var linea in tarea.RegistradoProgramado.Split('\n'))
                    {
                        foreach (var fechaStr in linea.Split(',', StringSplitOptions.TrimEntries))
                        {
                            if (DateTime.TryParseExact(fechaStr, "dd/MM/yyyy",
                                System.Globalization.CultureInfo.InvariantCulture,
                                System.Globalization.DateTimeStyles.None, out var dt))
                            {
                                tmp.Add(dt);
                            }
                        }
                    }
                }
                BackupFechasEventuales = tmp;
            }
        }
        catch
        {
            BackupFechasEventuales = new List<DateTime>();
        }

        // marca la tarea
        tarea.Realizado = true;

        // ***** NUEVO: SI ES EVENTUAL Y YA TIENE FECHAS → NO ABRIR MODAL *****
        if (tarea.Periodicidad == "Eventual" &&
            !string.IsNullOrWhiteSpace(tarea.RegistradoProgramado))
        {
            // Solo marcar, NO abrir modal
            return;
        }

        // === abrir modal según periodicidad ===
        ResetModalFlags();
        CurrentTask = tarea;

        if (tarea.Periodicidad == "Semanal")
        {
            IsWeekly = true;
            ModalTitle = tarea.Nombre;

            SelectedWeekIndex = Array.IndexOf(WeekDays, tarea.RegistradoProgramado);
            if (SelectedWeekIndex < 0)
                SelectedWeekIndex = -1;

            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Mensual")
        {
            IsMonthly = true;
            ModalTitle = tarea.Nombre;

            SelectedDate = DateTime.Today;
            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Anual")
        {
            IsAnnual = true;
            ModalTitle = tarea.Nombre;

            SelectedDate = null;

            // Si ya tenía fecha guardada
            if (!string.IsNullOrWhiteSpace(tarea.RegistradoProgramado))
            {
                var fechas = ParseFechasFromRegistradoProgramado(tarea.RegistradoProgramado);
                SelectedDate = fechas.FirstOrDefault();
            }

            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Eventual")
        {
            IsEventual = true;
            ModalTitle = tarea.Nombre;
            ShowModal = true;

            FechasEventuales = new List<DateTime>();

            if (!string.IsNullOrWhiteSpace(tarea.RegistradoProgramado))
            {
                var fechas = ParseFechasFromRegistradoProgramado(tarea.RegistradoProgramado);
                FechasEventuales = fechas.Any() ? fechas : new List<DateTime>();
            }

            if (!FechasEventuales.Any())
                FechasEventuales.Add(DateTime.Today);
        }
        else if (tarea.Periodicidad == "Quincenal")
{
    ResetModalFlags();
    IsQuincenal = true;
    ModalTitle = tarea.Nombre;
    ShowModal = true;

    FechasQuincenales = new List<DateTime?> { null, null };

    if (!string.IsNullOrWhiteSpace(tarea.RegistradoProgramado))
    {
        var fechas = ParseFechasFromRegistradoProgramado(tarea.RegistradoProgramado);
        if (fechas.Count == 2)
        {
            FechasQuincenales[0] = fechas[0];
            FechasQuincenales[1] = fechas[1];
        }
    }
}



        else
        {
            // Diario
            tarea.RegistradoProgramado = "Registrado";
        }
    }


private void ResetModalFlags()
{
    IsWeekly = false;
    IsMonthly = false;
    IsQuincenal = false;
    IsEventual = false;
    IsAnnual = false;
}


//Metodo para modificar las fechas de las taras eventuales
private void EditarEventual(Tarea tarea)
{
    CurrentTask = tarea;

    BackupRealizado = tarea.Realizado;
    BackupRegistradoProgramado = tarea.RegistradoProgramado;

    BackupFechasEventuales = new List<DateTime>();
    FechasEventuales = new List<DateTime>();

    if (!string.IsNullOrWhiteSpace(tarea.RegistradoProgramado))
    {
        var partes = tarea.RegistradoProgramado.Split('\n', StringSplitOptions.TrimEntries);
        foreach (var linea in partes)
        {
            foreach (var p in linea.Split(',', StringSplitOptions.TrimEntries))
            {
                if (DateTime.TryParseExact(p, "dd/MM/yyyy",
                    System.Globalization.CultureInfo.InvariantCulture,
                    System.Globalization.DateTimeStyles.None,
                    out var dt))
                {
                    FechasEventuales.Add(dt);
                }
            }
        }
    }

    if (!FechasEventuales.Any())
        FechasEventuales.Add(DateTime.Today);

    IsWeekly = false; IsMonthly = false; IsAnnual = false; IsEventual = true;
    ModalTitle = tarea.Nombre;
    ShowModal = true;
}

    private void SaveModal()
    {
        if (CurrentTask != null)
        {
            if (IsWeekly)
            {
                // Validación correcta para evitar el error
                if (SelectedWeekIndex < 0 || SelectedWeekIndex >= WeekDays.Length)
                {
                    ShowAlert("Error", "Seleccione un día antes de guardar.");
                    return;
                }

                CurrentTask.Realizado = true;
                CurrentTask.RegistradoProgramado = WeekDays[SelectedWeekIndex];
            }
            else if (IsMonthly)
            {
                if (CurrentTask.FechaMensualSeleccionada == null)
                {
                    ShowAlert("Error", "Debes seleccionar una fecha del mes.");
                    return;
                }

                CurrentTask.Realizado = true;

                
                var dia = CurrentTask.FechaMensualSeleccionada.Value.Day;
                var nombreMes = CurrentTask.FechaMensualSeleccionada.Value.ToString("MMMM");
                CurrentTask.RegistradoProgramado = $"{dia} de {nombreMes}";
            }

            else if (IsAnnual)
            {
                CurrentTask.Realizado = true;

                if (SelectedDate.HasValue)
                {
                    // Mostrar en pantalla (solo texto)
                    CurrentTask.RegistradoProgramado =
                        SelectedDate.Value.ToString("dd/MM/yyyy");
                }
                else
                {
                    // Anual sin fecha
                    CurrentTask.RegistradoProgramado = "";
                }
            }


          else if (IsEventual)
{
    // VALIDACIÓN → No permitir fechas duplicadas
    var duplicados = FechasEventuales
        .GroupBy(f => f.Date)
        .Where(g => g.Count() > 1)
        .ToList();

    if (duplicados.Any())
    {
        ShowAlert("Fechas duplicadas", 
            "No puede seleccionar la misma fecha más de una vez para la misma tarea.");
        return;
    }

    // Ordenar fechas
    FechasEventuales = FechasEventuales
        .OrderBy(f => f)
        .ToList();

    CurrentTask.Realizado = true;

    // Guardar TODAS las fechas formateadas en líneas de 3
    CurrentTask.RegistradoProgramado = FormatearFechasEnLineas(FechasEventuales);

}
            
            else if (IsQuincenal)
            {
                if (FechasQuincenales.Any(f => f == null))
                {
                    ShowAlert("Quincenal inválido",
                        "Debes seleccionar las dos fechas.");
                    return;
                }

                var fechas = FechasQuincenales.Select(f => f!.Value).ToList();

                var primera = fechas.Count(f => f.Day <= 15);
                var segunda = fechas.Count(f => f.Day >= 16);

                if (primera != 1 || segunda != 1)
                {
                    ShowAlert("Fechas inválidas",
                        "Debe elegir una fecha del 1–15 y otra del 16–31.");
                    return;
                }

                CurrentTask.Realizado = true;
                CurrentTask.RegistradoProgramado =
                    FormatearFechasEnLineas(fechas.OrderBy(f => f).ToList());
            }



        }
         // 🔥 LIMPIEZA ÚNICA Y CORRECTA
        ResetModalFlags();
        SelectedWeekIndex = -1;
        ShowModal = false;
        CurrentTask = null;
    }


    private void CloseModal()
{
    // Restaurar valores previos si canceló
    if (CurrentTask != null)
    {
        CurrentTask.Realizado = BackupRealizado;
        CurrentTask.RegistradoProgramado = BackupRegistradoProgramado;
        FechasEventuales = BackupFechasEventuales.ToList();
    }

    // 🔥 LIMPIEZA TOTAL
    ResetModalFlags();
    ShowModal = false;

    CurrentTask = null;
    SelectedWeekIndex = -1;
}


    // ---------- MÉTODOS PARA MANEJO DE FECHAS EVENTUALES ----------
    private void AddNuevaFechaEventual()
    {
        FechasEventuales.Add(DateTime.Today);
    }

    private void RemoveFechaEventual(int index)
    {
        if (index >= 0 && index < FechasEventuales.Count)
        {
            FechasEventuales.RemoveAt(index);
        }
    }

    private void OnFechaEventualChange(int index, string? value)
    {
        if (index < 0 || index >= FechasEventuales.Count)
            return;

        if (DateTime.TryParse(value, out var fecha))
            FechasEventuales[index] = fecha;
    }


//Ayuda a que se muestren las tareas de 3 en 3
private string FormatearFechasEnLineas(List<DateTime> fechas)
{
    if (fechas == null || fechas.Count == 0)
        return "";

    // Ordenar
    fechas = fechas.OrderBy(f => f).ToList();

    List<string> lineas = new();

    for (int i = 0; i < fechas.Count; i += 3)
    {
        var chunk = fechas
            .Skip(i)
            .Take(3)
            .Select(f => f.ToString("dd/MM/yyyy"));

        // NO poner coma al final de cada línea
        lineas.Add(string.Join(", ", chunk));
    }

    // Unir con salto de línea real
    return string.Join("\n", lineas);
}

    // ---------- RESTO DEL CÓDIGO EXISTENTE ----------
    private string GetTextDecoration(Tarea tarea)
        => (tarea.Realizado && !string.IsNullOrEmpty(tarea.RegistradoProgramado)) ? "subrayado" : "";
    private void ConfirmarGuardar()
    {
        // Tareas incompletas (marcadas como realizadas pero sin programación)
        var incompletas = Bloques
            .SelectMany(b => b.Tareas)
            .Where(t =>
                t.Realizado &&
                string.IsNullOrWhiteSpace(t.RegistradoProgramado) &&
                t.Periodicidad != "Eventual" &&
                 t.Periodicidad != "Anual"  
            )
            .ToList();


        if (incompletas.Any())
        {
            ShowAlert("Faltan actividades",
                "No puede guardar la autoevaluación. Debe programar todas las actividades marcadas antes de guardar.");
            return;
        }

        // Tareas que NO fueron realizadas (checkbox sin marcar)
        var sinRealizar = Bloques
            .SelectMany(b => b.Tareas)
            .Where(t => !t.Realizado)
            .ToList();

        if (sinRealizar.Any())
        {
            ShowAlert("Actividades sin marcar",
                "Debe marcar y programar TODAS las actividades antes de guardar.");
            return;
        }

        // Si todo está completo → Mostrar confirmación final
        ShowConfirm = true;
    }


    //Metodo para guardar la autoevaluacion
    private object? ConstruirDTO(Tarea tarea)
    {
        // El backend necesita saber cuál tarea es
        if (!int.TryParse(tarea.Nombre.Split('-')[0], out int idTarea))
            return null; // Si el nombre no tiene ID, se descarta

        // SEMANAL
        if (tarea.Periodicidad == "Semanal")
        {
            return new
            {
                IdTareaAU = idTarea,
                DiaSemana = Array.IndexOf(WeekDays, tarea.RegistradoProgramado),
                DiaMes = (int?)null,
                Fechas = new List<string>()
            };
        }

        // MENSUAL
        if (tarea.Periodicidad == "Mensual")
        {
            // texto ejemplo: "15 de cada mes"
            int dia = int.Parse(tarea.RegistradoProgramado.Split(' ')[0]);

            return new
            {
                IdTareaAU = idTarea,
                DiaSemana = (int?)null,
                DiaMes = dia,
                Fechas = new List<string>()
            };
        }

        // EVENTUAL
        if (tarea.Periodicidad == "Eventual")
        {
            var fechas = FechasEventuales
                .Select(f => DateOnly.FromDateTime(f).ToString("yyyy-MM-dd"))
                .ToList();

            return new
            {
                IdTareaAU = idTarea,
                DiaSemana = (int?)null,
                DiaMes = (int?)null,
                Fechas = fechas
            };
        }

        // DIARIO → no manda nada
        if (tarea.Periodicidad == "Diario")
        {
            return new
            {
                IdTareaAU = idTarea,
                DiaSemana = (int?)null,
                DiaMes = (int?)null,
                Fechas = new List<string>()
            };
        }

        return null;
    }

}




<style>
    /* -------------------- ESTILOS -------------------- */
    /* -------------------- ESTILOS -------------------- */
    .title {
        text-align: center;
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        color: #333;
    }
    /* ---- MODAL DE ALERTA ---- */


    /* ------------ MODAL CONFIRMACIÓN / ALERTA (SweetAlert Style) ------------ */

    .confirm-overlay,
    .alert-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    .confirm-modal,
    .alert-modal {
        background: #fff;
        padding: 2.5rem 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 520px; /* MÁS GRANDE */
        box-shadow: 0 10px 35px rgba(0,0,0,0.35);
        animation: pop 0.25s ease-out;
        text-align: center;
    }

    .confirm-title,
    .alert-title {
        font-size: 2rem; /* ANTES 1.5rem */
        font-weight: 800;
        color: #000;
        margin-bottom: 1.2rem;
    }

    .confirm-message,
    .alert-message {
        color: #555;
        font-size: 0.95rem;
        margin-bottom: 1.3rem;
    }

    .confirm-footer,
    .alert-footer {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .btn-confirm {
        background: #007bff;
        border: none;
        padding: 0.55rem 1rem;
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
    }

        .btn-confirm:hover {
            background: #0056b3;
        }

    .btn-cancel {
        background: #eee;
        border: none;
        padding: 0.55rem 1rem;
        color: #333;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
    }

        .btn-cancel:hover {
            background: #ddd;
        }

    .evaluation-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        width: 95%;
        max-width: 1100px;
        margin: 0 auto;
    }

    .block {
        background: #fff;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .block-title {
        color: #1a237e;
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
    }

    .activities-table {
        width: 100%;
        border-collapse: collapse;
    }

        .activities-table th {
            text-align: left;
            background: #f4f4f8;
            padding: 0.6rem;
            font-weight: 600;
            color: #333;
        }

        .activities-table td {
            padding: 0.6rem;
            border-top: 1px solid #eee;
            vertical-align: middle;
        }

    .badge {
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        font-size: 0.8rem;
        color: #fff;
        text-transform: capitalize;
    }

        .badge.diario {
            background: #4caf50;
        }

        .badge.semanal {
            background: #2196f3;
        }

        .badge.mensual {
            background: #9c27b0;
        }

        .badge.eventual {
            background: #ff9800;
        }

        .badge.anual {
            background: #607d8b;
        }

        .badge.quincenal {
            background-color: #FF0080; 
        }

    .check-cell {
        text-align: center;
    }

    /* Subrayado negro arriba del texto */
    .subrayado {
        border-top: 2px solid black;
        font-weight: 600;
        padding-top: 2px;
    }

    /* Botón de guardar centrado */
    .save-container {
        display: flex;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .btn-save, .btn-cancel {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .btn-save {
        background: #007bff;
        color: white;
    }

        .btn-save:hover {
            background: #0056b3;
        }

    .btn-cancel {
        background: #f1f1f1;
        color: #333;
    }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

    /* Radio semanal bloqueado */
    .day-option.locked {
        background: #e0e0e0;
        color: #555;
        cursor: not-allowed;
    }

        .day-option.locked span {
            opacity: 0.7;
        }

    /* Modal centrado */
    .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal {
        background: #fff;
        border-radius: 14px;
        padding: 1.5rem;
        width: 90%;
        max-width: 360px;
        box-shadow: 0 6px 24px rgba(0,0,0,0.25);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .modal-title {
        text-align: center;
        margin: 0;
        font-weight: 600;
        color: #333;
    }

    .modal-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .weekdays {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
    }

    .day-option {
        background: #f3f3f3;
        border-radius: 8px;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

        .day-option:hover {
            background: #e2e8f0;
        }

        .day-option input[type="radio"] {
            accent-color: #007bff;
        }

    .input-date {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 0.95rem;
        width: 100%;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.8rem;
    }


    /* Scroll para muchas fechas en el modal */
.eventual-scroll {
    max-height: 36vh; /* ~ 7 líneas en la mayoría de pantallas */
    overflow-y: auto;
    padding-right: 10px;
    scrollbar-gutter: stable;
}



/*Muestra las fechas en formato de 3 */
.fechas-multiline {
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
    max-height: calc(1.4em * 3); /* 3 líneas de cualquier tamaño automáticamente */
    padding-right: 4vh;
}

.fecha-linea {
    white-space: nowrap;
    line-height: 1.4em; /* Altura relativa, totalmente responsiva */
}

.fechas-multiline::-webkit-scrollbar {
    width: 8px;
}

.fechas-multiline::-webkit-scrollbar-thumb {
    background: #bbb;
    border-radius: 4px;
}


.annual-no-date-container {
    display: flex;
    justify-content: center;
    margin-top: 14px;
}
</style>
