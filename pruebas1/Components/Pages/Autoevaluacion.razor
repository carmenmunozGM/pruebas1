@page "/autoevaluacion"
@using pruebas1.Servicios
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
@inject IJSRuntime JS
@inject AutoevaluacionService AutoService

<br />

<h2 class="title">📋 Autoevaluación</h2>

<div class="evaluation-container">
    @foreach (var bloque in Bloques)
    {
        <div class="block">
            <h3 class="block-title">@bloque.Nombre</h3>
            <table class="activities-table">
                <thead>
                    <tr>
                        <th>Actividad</th>
                        <th>Periodicidad</th>
                        <th>Programado</th>
                        <th>Selección</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tarea in bloque.Tareas)
                    {
                        <tr>
                            <td class="@GetTextDecoration(tarea)">@tarea.Nombre</td>
                            <td>
                                <span class="badge @tarea.Periodicidad.ToLower()">@tarea.Periodicidad</span>
                            </td>
                            <td class="check-cell">@tarea.RegistradoProgramado</td>
                            <td class="check-cell">
                                <input type="checkbox"
                                       checked="@tarea.Realizado"
                                       @onchange="(e) => OnCheckChanged(tarea, e.Value is bool b && b)"
                                       disabled="@IsLocked" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<div class="save-container">
    <button class="btn-save" @onclick="ConfirmarGuardar" disabled="@IsLocked">
        Guarda Autoevaluación
    </button>
</div>

<!-- Modal para seleccionar día/fecha -->
@if (ShowModal)
{
    <div class="confirm-overlay">
        <div class="confirm-modal" style="max-width: 400px;">

            <h3 class="confirm-title">@ModalTitle</h3>

            <div class="confirm-message">

                @* SEMANAL *@
                @if (IsWeekly)
                {
                    <p>Seleccione el día programado:</p>

                    <div class="weekdays" style="display:flex; justify-content:center;">
                        <select @bind="SelectedWeekIndex" class="select-days">
                            @for (int j = 0; j < WeekDays.Length; j++)
                            {
                                <option value="@j">@WeekDays[j]</option>
                            }
                        </select>
                    </div>
                }

                @* MENSUAL *@
                @if (IsMonthly)
                {
                    <p>Seleccione la fecha del mes:</p>
                    <input class="input-date" type="date" @bind="SelectedDate" />
                }

                @* EVENTUAL *@
                @if (IsEventual)
                {
                    <div class="modal-section">
                        <label>Seleccione la fecha del evento:</label>
                        <input class="input-date" type="date" @bind="SelectedDate" />
                    </div>
                }

                @* ANUAL *@
                @if (IsAnnual)
                {
                    <p>Seleccione mes y año:</p>
                    <input class="input-date" type="month" @bind="SelectedDate" />
                }

            </div>

            <div class="confirm-footer">
                <button class="btn-confirm" @onclick="SaveModal">Guardar</button>
                <button class="btn-cancel" @onclick="CloseModal">Cancelar</button>
            </div>

        </div>
    </div>
}

@if (ShowConfirm)
{
    <div class="confirm-overlay">
        <div class="confirm-modal">
            <h3 class="confirm-title">Confirmar guardado</h3>
            <p class="confirm-message">¿Seguro que desea guardar la autoevaluación? Solo podrá editar hasta fin de mes.</p>

            <div class="confirm-footer">
                <button class="btn-confirm" @onclick="GuardarAutoevaluacionFinal">Sí, guardar</button>
                <button class="btn-cancel" @onclick="() => ShowConfirm = false">Cancelar</button>
            </div>
        </div>
    </div>
}

@if (ShowAlertModal)
{
    <div class="alert-overlay">
        <div class="alert-modal">
            <h3 class="alert-title">@AlertTitle</h3>
            <p class="alert-message">@AlertMessage</p>

            <div class="alert-footer">
                <button class="btn-confirm" @onclick="() => ShowAlertModal = false">Aceptar</button>
            </div>
        </div>
    </div>
}


@code {
    bool ShowAlertModal = false;
    string AlertTitle = "Mensaje";
    string AlertMessage = "";
    void ShowAlert(string title, string message)
    {
        AlertTitle = title;
        AlertMessage = message;
        ShowAlertModal = true;
    }

    public class Tarea
    {
        public string Nombre { get; set; } = "";
        public string Periodicidad { get; set; } = "";
        public bool Realizado { get; set; } = false;
        public string RegistradoProgramado { get; set; } = "";
    }

    public class Bloque
    {
        public string Nombre { get; set; } = "";
        public List<Tarea> Tareas { get; set; } = new();
    }

    public List<Bloque> Bloques { get; set; } = new();

    public bool ShowModal { get; set; }
    public bool IsWeekly { get; set; }
    public bool IsMonthly { get; set; }
    public bool IsAnnual { get; set; }
    public string ModalTitle { get; set; } = string.Empty;
    public bool IsLocked { get; set; } = false;
    public bool ShowConfirm { get; set; } = false;
    bool IsEventual = false; // NUEVO 🔥

    public string[] WeekDays = new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado" };
    public int SelectedWeekIndex { get; set; } = -1;
    int SelectedMonthDay = 0;
    int SelectedYearMonth = 0;
    string SelectedTime = "";
    public DateTime SelectedDate { get; set; } = DateTime.Today;
    private Tarea? CurrentTask;
    private DateTime? FechaEventual { get; set; }


    private string AlertType { get; set; } = "info";
    async Task Guardar()
    {
        // VALIDACIONES
        if (IsWeekly && SelectedWeekIndex < 0)
        {
            await JS.InvokeVoidAsync("Swal.fire", new
            {
                icon = "warning",
                title = "Falta seleccionar un día",
                text = "Debes elegir un día de la semana antes de guardar."
            });
            return;
        }

        if (IsMonthly && SelectedMonthDay <= 0)
        {
            await JS.InvokeVoidAsync("Swal.fire", new
            {
                icon = "warning",
                title = "Falta seleccionar un día del mes",
                text = "Selecciona un día del 1 al 31."
            });
            return;
        }

        if (IsAnnual && SelectedYearMonth <= 0)
        {
            await JS.InvokeVoidAsync("Swal.fire", new
            {
                icon = "warning",
                title = "Falta seleccionar un mes del año",
                text = "Selecciona un mes válido antes de guardar."
            });
            return;
        }

        // SI TODO ESTÁ BIEN → GUARDAR
        await JS.InvokeVoidAsync("Swal.fire", new
        {
            icon = "success",
            title = "¡Guardado exitosamente!",
            showConfirmButton = false,
            timer = 1500
        });

        // Cerrar modal
        ShowModal = false;
    }

    protected override async Task OnInitializedAsync()
    {
        Bloques = new List<Bloque>();

        // ← cargar autoevaluación desde tu API
        await CargarAutoevaluacionAsync();
    }
    private async Task CargarAutoevaluacionAsync()
    {
        var data = await AutoService.ObtenerAutoevaluacion();

        foreach (var bloqueApi in data)
        {
            var nuevoBloque = new Bloque
            {
                Nombre = bloqueApi.Bloque,
                Tareas = bloqueApi.Tareas.Select(t => new Tarea
                {
                    Nombre = t.Tarea,
                    Periodicidad = t.Periodicidad,
                    Realizado = false,
                    RegistradoProgramado = ""
                }).ToList()
            };

            Bloques.Add(nuevoBloque);
        }
    }

    private void OnCheckChanged(Tarea tarea, bool value)
    {
        if (IsLocked) return;

        // ✔ SI DESMARCA → LIMPIAR TODO
        if (!value)
        {
            tarea.Realizado = false;
            tarea.RegistradoProgramado = "";
            SelectedWeekIndex = -1;
            SelectedDate = DateTime.Today;
            CurrentTask = null;
            ShowModal = false;
            IsEventual = false; // asegurar reset
            return;
        }

        // ✔ SI MARCA → ABRIR EL MODAL SEGÚN PERIODICIDAD
        CurrentTask = tarea;
        tarea.Realizado = true;

        if (tarea.Periodicidad == "Semanal")
        {
            IsWeekly = true; IsMonthly = false; IsAnnual = false; IsEventual = false;
            ModalTitle = tarea.Nombre;

            // Si ya tiene un día programado, cargarlo
            SelectedWeekIndex = Array.IndexOf(WeekDays, tarea.RegistradoProgramado);

            if (SelectedWeekIndex < 0)
                SelectedWeekIndex = -1;

            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Mensual")
        {
            IsWeekly = false; IsMonthly = true; IsAnnual = false; IsEventual = false;
            ModalTitle = tarea.Nombre;
            SelectedDate = DateTime.Today;
            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Anual")
        {
            IsWeekly = false; IsMonthly = false; IsAnnual = true; IsEventual = false;
            ModalTitle = tarea.Nombre;
            SelectedDate = DateTime.Today;
            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Eventual") // NUEVO 🔥
        {
            IsWeekly = false; IsMonthly = false; IsAnnual = false; IsEventual = true;
            ModalTitle = tarea.Nombre ;
            SelectedDate = DateTime.Today;
            ShowModal = true;
        }

        else
        {
            // Diario → marcar directo
            tarea.RegistradoProgramado = "Registrado";
        }
    }

    private void SaveModal()
    {
        if (CurrentTask != null)
        {
            if (IsWeekly)
            {
                // Validación correcta para evitar el error
                if (SelectedWeekIndex < 0 || SelectedWeekIndex >= WeekDays.Length)
                {
                    ShowAlert("Error", "Seleccione un día antes de guardar.");
                    return;
                }

                CurrentTask.Realizado = true;
                CurrentTask.RegistradoProgramado = WeekDays[SelectedWeekIndex];
            }
            else if (IsMonthly)
            {
                CurrentTask.Realizado = true;
                CurrentTask.RegistradoProgramado = SelectedDate.Day + " de cada mes";
            }
            else if (IsAnnual)
            {
                CurrentTask.Realizado = true;
                CurrentTask.RegistradoProgramado = SelectedDate.ToString("MMMM yyyy");
            }
            else if (IsEventual) // NUEVO 🔥
            {
                CurrentTask.Realizado = true;
                CurrentTask.RegistradoProgramado = SelectedDate.ToString("dd/MM/yyyy");
            }
        }
        // 🔥 REINICIAR FLAGS
        IsWeekly = false;
        IsMonthly = false;
        IsAnnual = false;
        IsEventual = false;
        // 🔥 REINICIAR EL DÍA / MES
        SelectedWeekIndex = -1;

        ShowModal = false;
    }


    private void CloseModal()
    {
        // Resetear estados visuales para evitar duplicados
        IsWeekly = false;
        IsMonthly = false;
        IsAnnual = false;
        IsEventual = false;
        ShowModal = false;
    }

    private string GetTextDecoration(Tarea tarea)
        => (tarea.Realizado && !string.IsNullOrEmpty(tarea.RegistradoProgramado)) ? "subrayado" : "";
    private void ConfirmarGuardar()
    {
        // Tareas incompletas (marcadas como realizadas pero sin programación)
        var incompletas = Bloques
            .SelectMany(b => b.Tareas)
            .Where(t =>
                t.Realizado && string.IsNullOrWhiteSpace(t.RegistradoProgramado))
            .ToList();

        if (incompletas.Any())
        {
            ShowAlert("Faltan actividades",
                "No puede guardar la autoevaluación. Debe programar todas las actividades marcadas antes de guardar.");
            return;
        }

        // Tareas que NO fueron realizadas (checkbox sin marcar)
        var sinRealizar = Bloques
            .SelectMany(b => b.Tareas)
            .Where(t => !t.Realizado)
            .ToList();

        if (sinRealizar.Any())
        {
            ShowAlert("Actividades sin marcar",
                "Debe marcar y programar TODAS las actividades antes de guardar.");
            return;
        }

        // Si todo está completo → Mostrar confirmación final
        ShowConfirm = true;
    }

    private void GuardarAutoevaluacionFinal()
    {
        // 🔒 BLOQUEA TODO
        IsLocked = true;
        ShowConfirm = false;

        // Alerta final
        ShowAlert("Guardado exitoso",
            "Autoevaluación guardada correctamente. Ya no podrá editar hasta fin de mes.");
    }


}


<style>
    /* -------------------- ESTILOS -------------------- */
    /* -------------------- ESTILOS -------------------- */
    .title {
        text-align: center;
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        color: #333;
    }
    /* ---- MODAL DE ALERTA ---- */


    /* ------------ MODAL CONFIRMACIÓN / ALERTA (SweetAlert Style) ------------ */

    .confirm-overlay,
    .alert-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    .confirm-modal,
    .alert-modal {
        background: #fff;
        padding: 2.5rem 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 520px; /* MÁS GRANDE */
        box-shadow: 0 10px 35px rgba(0,0,0,0.35);
        animation: pop 0.25s ease-out;
        text-align: center;
    }

    .confirm-title,
    .alert-title {
        font-size: 2rem; /* ANTES 1.5rem */
        font-weight: 800;
        color: #000;
        margin-bottom: 1.2rem;
    }

    .confirm-message,
    .alert-message {
        color: #555;
        font-size: 0.95rem;
        margin-bottom: 1.3rem;
    }

    .confirm-footer,
    .alert-footer {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .btn-confirm {
        background: #007bff;
        border: none;
        padding: 0.55rem 1rem;
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
    }

        .btn-confirm:hover {
            background: #0056b3;
        }

    .btn-cancel {
        background: #eee;
        border: none;
        padding: 0.55rem 1rem;
        color: #333;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
    }

        .btn-cancel:hover {
            background: #ddd;
        }




    .evaluation-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        width: 95%;
        max-width: 1100px;
        margin: 0 auto;
    }

    .block {
        background: #fff;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .block-title {
        color: #1a237e;
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
    }

    .activities-table {
        width: 100%;
        border-collapse: collapse;
    }

        .activities-table th {
            text-align: left;
            background: #f4f4f8;
            padding: 0.6rem;
            font-weight: 600;
            color: #333;
        }

        .activities-table td {
            padding: 0.6rem;
            border-top: 1px solid #eee;
            vertical-align: middle;
        }

    .badge {
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        font-size: 0.8rem;
        color: #fff;
        text-transform: capitalize;
    }

        .badge.diario {
            background: #4caf50;
        }

        .badge.semanal {
            background: #2196f3;
        }

        .badge.mensual {
            background: #9c27b0;
        }

        .badge.eventual {
            background: #ff9800;
        }

        .badge.anual {
            background: #607d8b;
        }

    .check-cell {
        text-align: center;
    }

    /* Subrayado negro arriba del texto */
    .subrayado {
        border-top: 2px solid black;
        font-weight: 600;
        padding-top: 2px;
    }

    /* Botón de guardar centrado */
    .save-container {
        display: flex;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .btn-save, .btn-cancel {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .btn-save {
        background: #007bff;
        color: white;
    }

        .btn-save:hover {
            background: #0056b3;
        }

    .btn-cancel {
        background: #f1f1f1;
        color: #333;
    }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

    /* Radio semanal bloqueado */
    .day-option.locked {
        background: #e0e0e0;
        color: #555;
        cursor: not-allowed;
    }

        .day-option.locked span {
            opacity: 0.7;
        }

    /* Modal centrado */
    .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal {
        background: #fff;
        border-radius: 14px;
        padding: 1.5rem;
        width: 90%;
        max-width: 360px;
        box-shadow: 0 6px 24px rgba(0,0,0,0.25);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .modal-title {
        text-align: center;
        margin: 0;
        font-weight: 600;
        color: #333;
    }

    .modal-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .weekdays {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
    }

    .day-option {
        background: #f3f3f3;
        border-radius: 8px;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

        .day-option:hover {
            background: #e2e8f0;
        }

        .day-option input[type="radio"] {
            accent-color: #007bff;
        }

    .input-date {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 0.95rem;
        width: 100%;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.8rem;
    }

</style>