@page "/autoevaluacion"
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
@inject IJSRuntime JS
@inject AutoevaluacionService AutoService

<br />
<br />
<br />
<h2 class="title">📋 Autoevaluación</h2>

<div class="month-selector">
    <button class="btn-cancel" @onclick="() => CambiarMes(-1)">◀</button>

    <strong style="min-width:180px; text-align:center; text-transform: capitalize;">
        @FechaConsulta.ToString("MMMM yyyy")
    </strong>

    <button class="btn-confirm" @onclick="() => CambiarMes(1)"> ▶</button>
</div>


<div class="evaluation-container">
    @foreach (var bloque in Bloques)
    {
        <div class="block">
            <h3 class="block-title">@bloque.Nombre</h3>
            <table class="activities-table">
                <thead>
                    <tr>
                        <th>Actividad</th>
                        <th>Periodicidad</th>
                        <th>Programado</th>
                        <th>Selección</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tarea in bloque.Tareas)
                    {
                        <tr>
                            <td class="@GetTextDecoration(tarea)">@tarea.Nombre</td>
                            <td>
                                <span class="badge @tarea.Periodicidad.ToLower()">@tarea.Periodicidad</span>
                            </td>
                            <td class="check-cell"
                                title="@string.Join(", ", FechasEventuales.Select(f => f.ToString("dd/MM/yyyy")))">

                                <div class="fechas-multiline">
                                    @foreach (var linea in tarea.RegistradoProgramado.Split('\n'))
                                    {
                                        <div class="fecha-linea">@linea</div>
                                    }
                                </div>


                            </td>
                            <td class="check-cell">
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <input type="checkbox"
                                           checked="@tarea.Realizado"
                                           @onchange="(e) => OnCheckChanged(tarea, e.Value is bool b && b)"
                                           disabled="@EstaTareaBloqueada(tarea)" />


                                    @if (tarea.Periodicidad == "Eventual"
                                                                && tarea.Realizado
                                                                && !EstaTareaBloqueada(tarea))
                                    {
                                        <button class="btn-confirm" style="padding:4px 8px; font-size:12px;"
                                                @onclick="() => EditarEventual(tarea)">
                                            ✏️
                                        </button>
                                    }

                                </div>
                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<div class="save-container">
    <button class="btn-save" @onclick="ConfirmarGuardar" disabled="@IsLocked">
        Guarda Autoevaluación
    </button>
</div>

@if (ShowModal)
{
    <div class="confirm-overlay" style="z-index: 1050;">
        <div class="confirm-modal" style="max-width: 500px;">

            <h3 class="confirm-title">@ModalTitle</h3>

            <div class="confirm-message">

                @* SEMANAL *@
                @if (IsWeekly)
                {
                    <p>Seleccione el día programado:</p>

                    <div class="weekdays" style="display:flex; justify-content:center;">
                        <select @bind="SelectedWeekIndex" class="select-days">
                            @for (int j = 0; j < WeekDays.Length; j++)
                            {
                                <option value="@j">@WeekDays[j]</option>
                            }
                        </select>
                    </div>
                }

                @* MENSUAL *@
                @if (IsMonthly)
                {
                    <p>Seleccione la fecha del mes:</p>

                    <DatePicker Value="CurrentTask.FechaMensualSeleccionada"
                                ValueChanged="@(v => CurrentTask.FechaMensualSeleccionada = v)"
                                CssClass="form-control" />

                }


                @* EVENTUAL *@
                @if (IsEventual)
                {
                    <div class="modal-section">

                        <label>Seleccione una o varias fechas del evento:</label>

                        <div class="eventual-scroll">
                            @for (int i = 0; i < FechasEventuales.Count; i++)
                            {
                                var localIndex = i;

                                <div style="display:flex; gap:10px; margin-bottom:8px; align-items:center;">

                                    <DatePicker Value="FechasEventuales[localIndex]"
                                        ValueChanged="@(v => OnFechaEventualChange(localIndex, v))"
                                        CssClass="form-control" />


                                    @if (FechasEventuales.Count > 1)
                                    {
                                        <button class="btn-cancel" style="padding:6px 10px; height:38px;"
                                                @onclick="() => RemoveFechaEventual(localIndex)">
                                            ❌
                                        </button>
                                    }
                                </div>
                            }
                        </div>

                        <div style="display:flex;
                                    justify-content:space-between;
                                    gap:12px;
                                    margin-top:12px;">

                            <button class="btn-confirm" style="white-space:nowrap"
                                    @onclick="AddNuevaFechaEventual">
                                ➕ Añadir nueva fecha
                            </button>

                            <button class="btn-cancel" style="white-space:nowrap"
                                    @onclick="NoSeleccionarFechasEventual">
                                ❌ No seleccionar fechas
                            </button>

                        </div>


                    </div>
                }


                @if (IsAnnual)
                {
                    <p>Seleccione una fecha anual (opcional):</p>

                    <DatePicker Value="SelectedDate"
                                ValueChanged="@(v => SelectedDate = v)"
                                CssClass="form-control" />

                    <div style="display:flex; justify-content:center; margin-top:12px;">
                        <button class="btn-cancel"
                                @onclick="NoSeleccionarFechaAnual">
                            ❌ No seleccionar fecha
                        </button>
                    </div>
                }





                @if (IsQuincenal)
                {
                    <div class="modal-section">
                        <label>Seleccione una fecha por quincena:</label>

                        <div style="display:flex; gap:10px; margin-bottom:8px;">
                            <DatePicker Value="FechasQuincenales[0]"
                                        ValueChanged="@(v => FechasQuincenales[0] = v)"
                                        CssClass="form-control" />
                        </div>

                        <div style="display:flex; gap:10px; margin-bottom:8px;">
                            <DatePicker Value="FechasQuincenales[1]"
                                        ValueChanged="@(v => FechasQuincenales[1] = v)"
                                        CssClass="form-control" />
                        </div>

                        <small style="color:#6c757d">
                            Una fecha del <strong>1–15</strong> y otra del <strong>16–31</strong>
                        </small>
                    </div>
                }




            </div>

            <div class="confirm-footer">
                <button class="btn-confirm" @onclick="SaveModal">Guardar</button>
                <button class="btn-cancel" @onclick="CloseModal">Cancelar</button>
            </div>

        </div>
    </div>
}

@if (ShowConfirm)
{
    <div class="confirm-overlay" style="z-index: 1060;">
        <div class="confirm-modal">
            <h3 class="confirm-title">Confirmar guardado</h3>
            <p class="confirm-message">¿Seguro que desea guardar la autoevaluación del mes de @FechaConsulta.ToString("MMMM")?</p>

            <div class="confirm-footer">
                <button class="btn-confirm"
                        disabled="@IsSaving"
                        @onclick="GuardarAutoevaluacionFinal">

                    @if (IsSaving)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span style="margin-left:6px;">Guardando...</span>
                    }
                    else
                    {
                        <span>Sí, guardar</span>
                    }
                </button>

                <button class="btn-cancel" @onclick="() => ShowConfirm = false">Cancelar</button>
            </div>
        </div>
    </div>
}

@if (ShowAlertModal)
{
    <div class="alert-overlay" style="z-index: 2000;">
        <div class="alert-modal">
            <h3 class="alert-title">@AlertTitle</h3>
            <p class="alert-message">@AlertMessage</p>

            <div class="alert-footer">
                <button class="btn-confirm" @onclick="() => ShowAlertModal = false">Aceptar</button>
            </div>
        </div>
    </div>
}


@code {
    private bool IsSaving = false;
    public List<DateTime?> FechasQuincenales { get; set; } = new() { null, null };

    private async Task CambiarMes(int cantidad)
    {
        FechaConsulta = FechaConsulta.AddMonths(cantidad);
        await CargarAutoevaluacionAsync();
    }


    private bool EsMesActual =>
    FechaConsulta.Year == DateTime.Today.Year &&
    FechaConsulta.Month == DateTime.Today.Month;

    private DateTime? MinFechaEventual =>
    EsMesActual
        ? DateTime.Today
        : new DateTime(FechaConsulta.Year, FechaConsulta.Month, 1);

    // Fecha actual para comparar
    private DateTime FechaActual = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime FechaConsulta = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);

    public bool IsLocked =>FechaConsulta < new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);

    private int GetIdFromTareaObject(Tarea tarea)
    {
        return tarea.IdTareaAU;
    }

    private List<DateTime> ParseFechasFromRegistradoProgramado(string registrado)
    {
        var list = new List<DateTime>();
        // Si el texto es nulo, vacío o explícitamente "Sin fechas", retornamos lista vacía
        if (string.IsNullOrWhiteSpace(registrado) || registrado == "Sin fechas") return list;

        var partesLineas = registrado.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        foreach (var linea in partesLineas)
        {
            var fechas = linea.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            foreach (var f in fechas)
            {
                if (DateTime.TryParseExact(f.Trim(), "dd/MM/yyyy", System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out var dt))
                {
                    list.Add(dt);
                }
            }
        }
        return list.Distinct().OrderBy(x => x).ToList();
    }

    bool ShowAlertModal = false;
    string AlertTitle = "Mensaje";
    string AlertMessage = "";
    void ShowAlert(string title, string message)
    {
        AlertTitle = title;
        AlertMessage = message;
        ShowAlertModal = true;
    }

    public class Tarea
    {
        public int IdTareaAU { get; set; }
        public string Nombre { get; set; } = "";
        public string Periodicidad { get; set; } = "";
        public bool Realizado { get; set; } = false;
        public string RegistradoProgramado { get; set; } = "";
        public DateTime? FechaMensualSeleccionada { get; set; }
        public List<RegistroGeneradoDTO> Registros { get; set; } = new();
        public bool EditadoManualmente { get; set; } = false; 
    }

    public class Bloque
    {
        public string Nombre { get; set; } = "";
        public List<Tarea> Tareas { get; set; } = new();
    }

    public List<Bloque> Bloques { get; set; } = new();

    public bool ShowModal { get; set; }
    public bool IsWeekly { get; set; }
    public bool IsMonthly { get; set; }
    public bool IsAnnual { get; set; }
    public string ModalTitle { get; set; } = string.Empty;
    public bool ShowConfirm { get; set; } = false;
    bool IsEventual = false;
    bool IsQuincenal = false;

    public string[] WeekDays = new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado" };
    public int SelectedWeekIndex { get; set; } = -1;
    public DateTime? SelectedDate { get; set; } = null;

    private Tarea? CurrentTask;
    public List<DateTime> FechasEventuales { get; set; } = new();

    private void NoSeleccionarFechasEventual()
    {
        if (CurrentTask == null) return;
        CurrentTask.Realizado = true;
        CurrentTask.RegistradoProgramado = "Sin fechas";
        CurrentTask.EditadoManualmente = true;
        FechasEventuales.Clear();
        IsEventual = false;
        ShowModal = false;
    }

    private void NoSeleccionarFechaAnual()
    {
        if (CurrentTask == null) return;
        CurrentTask.Realizado = true;
        CurrentTask.RegistradoProgramado = "Sin fechas";
        CurrentTask.EditadoManualmente = true;
        SelectedDate = null;
        IsAnnual = false;
        ShowModal = false;
    }

    private void OnFechaEventualChange(int index, DateTime? value)
    {
        if (index < 0 || index >= FechasEventuales.Count) return;
        if (value.HasValue) FechasEventuales[index] = value.Value;
    }

    private bool BackupRealizado;
    private string BackupRegistradoProgramado = "";

    protected override async Task OnInitializedAsync()
    {
        Bloques = new List<Bloque>();
        await CargarAutoevaluacionAsync();
    }

    private async Task CargarAutoevaluacionAsync()
    {
        var data = await AutoService.ObtenerAutoevaluacion();
        int mesFiltro = FechaConsulta.Month;
        int añoFiltro = FechaConsulta.Year;

        // 1. Verificar si el usuario tiene CUALQUIER registro guardado en este mes/año
        bool usuarioYaTieneRegistrosEnMes = data
            .SelectMany(b => b.Tareas)
            .Any(t => t.Registros != null &&
                 t.Registros.Any(r => r.Fecha.Month == mesFiltro && r.Fecha.Year == añoFiltro));

        Bloques.Clear();
        foreach (var bloqueApi in data)
        {
            var nuevoBloque = new Bloque { Nombre = bloqueApi.Bloque, Tareas = new List<Tarea>() };

            foreach (var t in bloqueApi.Tareas)
            {
                var registrosMes = t.Registros?.Where(r => r.Fecha.Month == mesFiltro && r.Fecha.Year == añoFiltro).ToList() ?? new List<RegistroGeneradoDTO>();

                bool tieneRegistros = registrosMes.Any();
                string programadoTexto = "";
                DateTime? primeraFecha = null;
                bool marcado = false;

                if (tieneRegistros)
                {
                    marcado = true;
                    var fechasSorted = registrosMes.Select(r => r.Fecha.ToDateTime(TimeOnly.MinValue)).OrderBy(f => f).ToList();
                    primeraFecha = fechasSorted.FirstOrDefault();
                    programadoTexto = t.Periodicidad switch
                    {
                        "Diario" => "Registrado",
                        "Semanal" => fechasSorted.First().ToString("dddd"),
                        "Mensual" => $"{fechasSorted.First().Day} de {fechasSorted.First():MMMM}",
                        _ => string.Join(", ", fechasSorted.Select(f => f.ToString("dd/MM")))
                    };
                }
                // LÓGICA CLAVE: Si el usuario ya guardó algo este mes, y esta tarea es Eventual/Anual y está vacía
                else if (usuarioYaTieneRegistrosEnMes && (t.Periodicidad is "Eventual" or "Anual"))
                {
                    marcado = true;
                    programadoTexto = "Sin fechas";
                }

                nuevoBloque.Tareas.Add(new Tarea
                {
                    IdTareaAU = t.IdTareaAU,
                    Nombre = t.Tarea,
                    Periodicidad = t.Periodicidad,
                    RegistradoProgramado = programadoTexto,
                    Realizado = marcado,
                    FechaMensualSeleccionada = primeraFecha,
                    Registros = t.Registros,
                    EditadoManualmente = false
                });
            }
            Bloques.Add(nuevoBloque);
        }
        StateHasChanged();
    }

    private async Task SaveModal()
    {
        if (CurrentTask == null) return;

        List<DateTime?> fechasAValidar = new();
        if (IsMonthly) fechasAValidar.Add(CurrentTask.FechaMensualSeleccionada);
        if (IsAnnual) fechasAValidar.Add(SelectedDate);
        if (IsQuincenal) fechasAValidar.AddRange(FechasQuincenales);
        if (IsEventual) fechasAValidar.AddRange(FechasEventuales.Cast<DateTime?>());

        // ---------------------------------------------
        // 1️⃣ Validar que todas las fechas sean del mes consultado
        // ---------------------------------------------
        bool fueraDeRango = fechasAValidar.Any(f =>
            f.HasValue &&
            (f.Value.Month != FechaConsulta.Month ||
             f.Value.Year != FechaConsulta.Year));

        if (fueraDeRango)
        {
            await JS.InvokeVoidAsync("Swal.fire", new
            {
                title = "Fecha fuera de rango",
                text = $"Debe seleccionar fechas del mes de {FechaConsulta:MMMM yyyy}",
                icon = "error",
                backdrop = false,
                customClass = new { container = "swal-ontop" }
            });
            return;
        }

        // ---------------------------------------------
        // 2️⃣ EVENTUAL en mes actual: no permitir fechas pasadas
        // ---------------------------------------------
        if (IsEventual &&
            FechaConsulta.Year == DateTime.Today.Year &&
            FechaConsulta.Month == DateTime.Today.Month)
        {
            var hoy = DateTime.Today;

            bool hayFechasInvalidas = fechasAValidar.Any(f =>
                f.HasValue && f.Value.Date < hoy);

            if (hayFechasInvalidas)
            {
                await JS.InvokeVoidAsync("Swal.fire", new
                {
                    title = "Fecha no válida",
                    text = "No puede seleccionar fechas anteriores al día de hoy en el mes en curso.",
                    icon = "warning",
                    backdrop = false,
                    customClass = new { container = "swal-ontop" }
                });
                return;
            }
        }

        // ---------------------------------------------
        // 3️⃣ Validaciones específicas
        // ---------------------------------------------
        if (IsQuincenal)
        {
            if (FechasQuincenales[0] == null || FechasQuincenales[1] == null)
            {
                await JS.InvokeVoidAsync("Swal.fire", "Faltan fechas",
                    "Debe seleccionar ambas fechas quincenales", "warning");
                return;
            }

            if (FechasQuincenales[0]?.Day > 15 || FechasQuincenales[1]?.Day < 16)
            {
                await JS.InvokeVoidAsync("Swal.fire", "Error Quincena",
                    "La primera fecha debe ser del 1–15 y la segunda del 16–31.", "warning");
                return;
            }
        }

        if (IsWeekly)
        {
            if (SelectedWeekIndex < 0)
            {
                await JS.InvokeVoidAsync("Swal.fire", "Cuidado",
                    "Seleccione un día", "warning");
                return;
            }

            CurrentTask.RegistradoProgramado = WeekDays[SelectedWeekIndex];
        }
        else if (IsMonthly)
            CurrentTask.RegistradoProgramado =
                CurrentTask.FechaMensualSeleccionada?.ToString("dd/MM/yyyy") ?? "";
        else if (IsQuincenal)
            CurrentTask.RegistradoProgramado =
                string.Join("\n", FechasQuincenales
                    .Where(f => f.HasValue)
                    .Select(f => f.Value.ToString("dd/MM/yyyy")));
        else if (IsEventual)
            CurrentTask.RegistradoProgramado =
                string.Join("\n", FechasEventuales.Select(f => f.ToString("dd/MM/yyyy")));
        else if (IsAnnual)
            CurrentTask.RegistradoProgramado =
                SelectedDate?.ToString("dd/MM/yyyy") ?? "";

        CurrentTask.Realizado = true;
        CurrentTask.EditadoManualmente = true;
        ShowModal = false;
    }


    private async Task GuardarAutoevaluacionFinal()
    {
        if (IsSaving) return;

        // Validación de obligatorios (Mantenida)
        foreach (var b in Bloques)
        {
            foreach (var t in b.Tareas)
            {
                if ((t.Periodicidad == "Diario" || t.Periodicidad == "Semanal" || t.Periodicidad == "Mensual" || t.Periodicidad == "Quincenal") && !t.Realizado)
                {
                    await JS.InvokeVoidAsync("Swal.fire", "Atención", "Por favor selecciona las fechas faltantes", "warning");
                    return;
                }
            }
        }

        IsSaving = true;
        ShowConfirm = false;

        var dto = new GuardarAutoevaluacionEmpleadoDTO
        {
            Mes = FechaConsulta.Month,
            Anio = FechaConsulta.Year,
            Tareas = new List<RegistroTareaDTO>()
        };

        foreach (var bloque in Bloques)
        {
            foreach (var tarea in bloque.Tareas)
            {
                // Solo procesamos tareas marcadas o Eventuales/Anuales (que permiten vacío intencional)
                if (!tarea.Realizado && tarea.Periodicidad != "Eventual" && tarea.Periodicidad != "Anual") continue;

                var registro = new RegistroTareaDTO { IdTareaAU = tarea.IdTareaAU, Fechas = new List<DateOnly>() };

                // 1. SI SE EDITÓ MANUALMENTE (Incluye "Sin fechas")
                if (tarea.EditadoManualmente)
                {
                    if (tarea.RegistradoProgramado != "Sin fechas")
                    {
                        if (tarea.Periodicidad is "Eventual" or "Quincenal" or "Anual" or "Mensual")
                        {
                            registro.Fechas = ParseFechasFromRegistradoProgramado(tarea.RegistradoProgramado)
                                              .Select(f => DateOnly.FromDateTime(f)).ToList();
                        }
                    }
                    // Si es "Sin fechas", registro.Fechas queda vacío (Correcto para DB)

                    if (tarea.Periodicidad == "Semanal")
                        registro.DiaSemana = ConvertirDiaSemana(tarea.RegistradoProgramado);
                }
                // 2. SI EL ESTADO CARGADO ES "SIN FECHAS"
                else if (tarea.RegistradoProgramado == "Sin fechas")
                {
                    registro.Fechas = new List<DateOnly>();
                }
                // 3. SI HAY REGISTROS EN DB (Protección contra pérdida)
                else if (tarea.Registros != null && tarea.Registros.Any(r => r.Fecha.Month == FechaConsulta.Month && r.Fecha.Year == FechaConsulta.Year))
                {
                    registro.Fechas = tarea.Registros
                        .Where(r => r.Fecha.Month == FechaConsulta.Month && r.Fecha.Year == FechaConsulta.Year)
                        .Select(r => r.Fecha).ToList();

                    if (tarea.Periodicidad == "Semanal")
                        registro.DiaSemana = ConvertirDiaSemana(tarea.RegistradoProgramado);
                }
                // 4. TAREAS NUEVAS (Ej: Diario)
                else if (!string.IsNullOrWhiteSpace(tarea.RegistradoProgramado))
                {
                    if (tarea.Periodicidad is "Eventual" or "Quincenal" or "Anual" or "Mensual")
                    {
                        registro.Fechas = ParseFechasFromRegistradoProgramado(tarea.RegistradoProgramado)
                                          .Select(f => DateOnly.FromDateTime(f)).ToList();
                    }
                    if (tarea.Periodicidad == "Semanal")
                        registro.DiaSemana = ConvertirDiaSemana(tarea.RegistradoProgramado);
                }

                if (!dto.Tareas.Any(x => x.IdTareaAU == registro.IdTareaAU))
                    dto.Tareas.Add(registro);
            }
        }

        try
        {
            using var cts = new CancellationTokenSource(TimeSpan.FromMinutes(3));
            var ok = await AutoService.GuardarAutoevaluacion(dto, cts.Token);
            if (ok)
            {
                await CargarAutoevaluacionAsync();
                await JS.InvokeVoidAsync("Swal.fire", new { icon = "success", title = "Guardado", timer = 1200, showConfirmButton = false });
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("Swal.fire", "Error", ex.Message, "error");
        }
        finally { IsSaving = false; }
    }

    private bool EstaTareaBloqueada(Tarea tarea)
    {
        // Mes pasado → todo bloqueado
        if (FechaConsulta < new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1))
            return true;

        // Mes actual → SOLO Eventual se permite
        if (FechaConsulta.Year == DateTime.Today.Year &&
            FechaConsulta.Month == DateTime.Today.Month)
        {
            return tarea.Periodicidad != "Eventual";
        }

        // Mes futuro → nada bloqueado
        return false;
    }


    private int ConvertirDiaSemana(string diaTexto)
    {
        if (string.IsNullOrWhiteSpace(diaTexto)) return 0;
        return diaTexto.Trim().ToLower() switch
        {
            "lunes" => 0,
            "martes" => 1,
            "miércoles" => 2,
            "jueves" => 3,
            "viernes" => 4,
            "sábado" => 5,
            "sabado" => 5,
            "domingo" => 6,
            _ => 0
        };
    }

    private void OnCheckChanged(Tarea tarea, bool value)
    {
        if (EstaTareaBloqueada(tarea))return;

        if (!value)
        {
            tarea.Realizado = false;
            tarea.RegistradoProgramado = "";
            tarea.EditadoManualmente = false;
            return;
        }

        CurrentTask = tarea;
        BackupRealizado = tarea.Realizado;
        BackupRegistradoProgramado = tarea.RegistradoProgramado;
        tarea.Realizado = true;

        // Si es Diario, registramos directo y salimos
        if (tarea.Periodicidad == "Diario")
        {
            tarea.RegistradoProgramado = "Registrado";
            return;
        }

        // Si es Eventual y ya tiene datos (y no es "Sin fechas"), permitimos que el check se quede
        // Pero si el usuario hace click de nuevo, normalmente es para editar,
        // así que quitamos el return para que los modales siempre puedan abrirse si es necesario.
        // if (tarea.Periodicidad == "Eventual" && !string.IsNullOrWhiteSpace(tarea.RegistradoProgramado) && tarea.RegistradoProgramado != "Sin fechas") return;

        ResetModalFlags();
        ModalTitle = tarea.Nombre;

        if (tarea.Periodicidad == "Semanal")
        {
            IsWeekly = true;
            SelectedWeekIndex = Array.IndexOf(WeekDays, tarea.RegistradoProgramado);
            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Mensual")
        {
            IsMonthly = true;
            // Forzamos a que el calendario mensual abra en el mes de consulta
            CurrentTask.FechaMensualSeleccionada = new DateTime(FechaConsulta.Year, FechaConsulta.Month, 1);
            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Anual")
        {
            IsAnnual = true;

            if (string.IsNullOrEmpty(tarea.RegistradoProgramado) || tarea.RegistradoProgramado == "Sin fechas")
            {
                SelectedDate = new DateTime(FechaConsulta.Year, FechaConsulta.Month, 1);
            }
            else
            {
                var fechas = ParseFechasFromRegistradoProgramado(tarea.RegistradoProgramado);
                // Verificamos si la lista tiene elementos antes de asignar
                if (fechas.Any())
                {
                    SelectedDate = fechas.First();
                }
                else
                {
                    SelectedDate = new DateTime(FechaConsulta.Year, FechaConsulta.Month, 1);
                }
            }
            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Eventual")
        {
            IsEventual = true;
            // Iniciamos con el primer día del mes de consulta
            FechasEventuales = new List<DateTime> { new DateTime(FechaConsulta.Year, FechaConsulta.Month, 1) };
            ShowModal = true;
        }
        else if (tarea.Periodicidad == "Quincenal")
        {
            IsQuincenal = true;
            // Iniciamos la quincena basada en el mes de consulta
            FechasQuincenales = new List<DateTime?> {
            new DateTime(FechaConsulta.Year, FechaConsulta.Month, 1),
            new DateTime(FechaConsulta.Year, FechaConsulta.Month, 1).AddDays(14)
        };
            ModalTitle = tarea.Nombre;
            ShowModal = true;
        }
    }
    

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Esto lee el atributo data-theme que pusimos en el MainLayout
            // y fuerza a la página a refrescar sus colores.
            StateHasChanged();
        }
    }

    private void ResetModalFlags() { IsWeekly = IsMonthly = IsAnnual = IsEventual = IsQuincenal = false; }
    private void CloseModal() { if (CurrentTask != null) { CurrentTask.Realizado = BackupRealizado; CurrentTask.RegistradoProgramado = BackupRegistradoProgramado; } ShowModal = false; }
    private void ConfirmarGuardar() => ShowConfirm = true;
    private void AddNuevaFechaEventual() => FechasEventuales.Add(FechaConsulta);
    private void RemoveFechaEventual(int index) => FechasEventuales.RemoveAt(index);

    private void EditarEventual(Tarea tarea)
    {
        CurrentTask = tarea;
        ResetModalFlags();
        IsEventual = true;
        // PRIORIDAD 1: Si tiene registros reales en el objeto, usarlos (esto viene de la DB)
        if (tarea.Registros != null && tarea.Registros.Any(r => r.Fecha.Month == FechaConsulta.Month))
        {
            FechasEventuales = tarea.Registros
                .Where(r => r.Fecha.Month == FechaConsulta.Month)
                .Select(r => r.Fecha.ToDateTime(TimeOnly.MinValue))
                .ToList();
        }
        // PRIORIDAD 2: Si no hay registros (es nuevo), intentar parsear el texto
        else
        {
            FechasEventuales = ParseFechasFromRegistradoProgramado(tarea.RegistradoProgramado);
        }
        if (!FechasEventuales.Any()) FechasEventuales.Add(FechaConsulta);
        ShowModal = true;
    }

    private string GetTextDecoration(Tarea tarea) => tarea.Realizado ? "text-decoration: line-through; color: gray;" : "";
}

<style>

    /* --- INTEGRACIÓN CON EL SISTEMA DE TEMAS (MODO OSCURO) --- */

    /* ESTO ES LO MÁS IMPORTANTE:
           Forzamos a que TODO el fondo de la página sea oscuro
/* =================================================
   SECCIÓN EVALUACIÓN Y MODALES (UNIFICACIÓN)
   ================================================= */

/* 1. Fondos Base de la Aplicación */
[data-theme="dark"],
[data-theme="dark"] body,
[data-theme="dark"] #app,
[data-theme="dark"] .main,
[data-theme="dark"] .content,
[data-theme="dark"] .evaluation-container {
    background-color: #111827 !important;
    color: #ffffff !important;
}

/* 2. Bloques de Contenido (Tarjetas) */
[data-theme="dark"] .block {
    background-color: #1f2937 !important;
    border: 1px solid #374151 !important;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3) !important;
}

[data-theme="dark"] .block-title {
    color: #818cf8 !important; /* Azul índigo original */
}

/* 3. Sistema de Modales (Overlays y Ventanas) */
[data-theme="dark"] .overlay,
[data-theme="dark"] .confirm-overlay,
[data-theme="dark"] .alert-overlay {
    background: rgba(0, 0, 0, 0.8) !important;
}

[data-theme="dark"] .modal,
[data-theme="dark"] .confirm-modal,
[data-theme="dark"] .alert-modal {
    background-color: #1f2937 !important;
    color: #ffffff !important;
    border: 1px solid #374151 !important;
}

[data-theme="dark"] .modal-title,
[data-theme="dark"] .confirm-title,
[data-theme="dark"] .alert-title {
    color: #ffffff !important;
}

[data-theme="dark"] .confirm-message,
[data-theme="dark"] .alert-message {
    color: #d1d5db !important;
}

/* 4. Elementos de Formulario dentro de Evaluación */
[data-theme="dark"] .month-selector button,
[data-theme="dark"] .input-date,
[data-theme="dark"] .day-option,
[data-theme="dark"] .btn-cancel {
    background-color: #374151 !important;
    color: #ffffff !important;
    border: 1px solid #4b5563 !important;
}

[data-theme="dark"] .btn-cancel:hover {
    background: #4b5563 !important;
}

/* 5. Tablas de Actividades */
[data-theme="dark"] .activities-table th {
    background: #374151 !important;
    color: #e5e7eb !important;
}

[data-theme="dark"] .activities-table td {
    border-top: 1px solid #374151 !important;
    color: #d1d5db !important;
}

/* 6. Textos Generales */
[data-theme="dark"] .title {
    color: #ffffff !important;
}
    /* -------------------- ESTILOS ORIGINALES (MODO CLARO) -------------------- */

    .title {
        text-align: center;
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        color: #333;
        display: block;
        width: 100%;
    }

    .check-cell {
        text-align: center;
    }

    .save-container {
        text-align: center;
        margin-top: 30px;
        margin-bottom: 50px;
        display: flex;
        justify-content: center;
    }

    .btn-save {
        background: #28a745;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: 0.3s;
    }

        .btn-save:hover {
            background: #218838;
        }

        .btn-save:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

    .confirm-overlay, .alert-overlay, .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .confirm-modal, .alert-modal, .modal {
        background: white;
        padding: 2.5rem 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 520px;
        box-shadow: 0 10px 35px rgba(0,0,0,0.35);
        text-align: center;
    }

    .confirm-title, .alert-title {
        font-size: 2rem;
        font-weight: 800;
        color: #000;
        margin-bottom: 1.2rem;
    }

    .confirm-message, .alert-message {
        color: #555;
        font-size: 0.95rem;
        margin-bottom: 1.3rem;
    }

    .confirm-footer, .alert-footer, .modal-footer {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 20px;
    }

    .btn-confirm {
        background: #007bff;
        color: white;
        padding: 0.55rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .btn-cancel {
        background: #eee;
        color: #333;
        padding: 0.55rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .evaluation-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        width: 95%;
        max-width: 1100px;
        margin: 0 auto;
    }

    .block {
        background: #fff;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .block-title {
        color: #1a237e;
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
    }

    .activities-table {
        width: 100%;
        border-collapse: collapse;
    }

        .activities-table th {
            text-align: left;
            background: #f4f4f8;
            padding: 0.6rem;
            font-weight: 600;
            color: #333;
        }

        .activities-table td {
            padding: 0.6rem;
            border-top: 1px solid #eee;
            vertical-align: middle;
        }

    .badge {
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        font-size: 0.8rem;
        color: #fff;
        text-transform: capitalize;
    }

        .badge.diario {
            background: #4caf50;
        }

        .badge.semanal {
            background: #2196f3;
        }

        .badge.mensual {
            background: #9c27b0;
        }

        .badge.eventual {
            background: #ff9800;
        }

        .badge.anual {
            background: #607d8b;
        }

        .badge.quincenal {
            background-color: #FF0080;
        }

    .subrayado {
        border-top: 2px solid black;
        font-weight: 600;
        padding-top: 2px;
    }

    .day-option.locked {
        background: #e0e0e0;
        color: #555;
        cursor: not-allowed;
    }

        .day-option.locked span {
            opacity: 0.7;
        }

    .modal-title {
        text-align: center;
        margin: 0;
        font-weight: 600;
        color: #333;
    }

    .weekdays {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
    }

    .day-option {
        background: #f3f3f3;
        border-radius: 8px;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .input-date {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 100%;
    }

    .eventual-scroll {
        max-height: 36vh;
        overflow-y: auto;
        padding-right: 10px;
        scrollbar-gutter: stable;
    }

    .fechas-multiline {
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        max-height: calc(1.4em * 3);
        padding-right: 4vh;
    }

    .fecha-linea {
        white-space: nowrap;
        line-height: 1.4em;
    }

    .month-selector {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

</style>