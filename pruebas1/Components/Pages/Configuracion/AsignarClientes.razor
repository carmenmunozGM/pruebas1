@using Models
@using System.Diagnostics
@using pruebas1.Components.DTOs
@using pruebas1.Components.UI
@using pruebas1.Servicios
@inject HttpClient Http
@using pruebas1.Entidades
@using System.Globalization
@inject LoginService LoginService
@inject IJSRuntime JS
@inject EmpleadosService EmpleadosService

<div class="asignar-container">
    <div class="section-header">
        <h2 class="section-title">Asignar Clientes</h2>
        <p class="section-description">
            Asigna empleados a clientes o grupos de clientes con sus servicios y actividades
        </p>
    </div>

    <!-- Formulario de nueva asignaci√≥n -->
    <div class="assignment-form">
        <h3 class="form-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
            </svg>
            Nueva Asignaci√≥n
        </h3>

        <div class="form-steps">
            <!-- Paso 1: Tipo de Asignaci√≥n -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number @(assignmentType != null ? "step-completed" : "")">1</div>
                    <label class="step-label">Tipo de Asignaci√≥n</label>
                </div>
                <div class="step-content">
                    <div class="assignment-type-buttons">
                        <button class="type-button @(assignmentType == "client" ? "type-button-active" : "")"
                                @onclick="@(() => SetAssignmentType("client"))">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Asignar por Cliente
                        </button>
                        <button class="type-button @(assignmentType == "group" ? "type-button-active" : "")"
                                @onclick="@(() => SetAssignmentType("group"))">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Asignar por Grupo de Clientes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Paso 2: Seleccionar Empleado -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number @(selectedEmployee != null ? "step-completed" : "") @(assignmentType == null ? "step-disabled" : "")">2</div>
                    <label class="step-label">Seleccionar Empleado</label>
                </div>
                <div class="step-content">
                    <div class="autocomplete-container">
                        <input class="form-select"
                               placeholder="Buscar empleado..."
                               value="@searchText"
                               @onfocus="MostrarEmpleados"
                               @oninput="FiltrarEmpleados"
                               disabled="@(assignmentType == null)" />


                        @if (mostrarLista)
                        {
                            <ul class="autocomplete-list">
                                @foreach (var emp in empleadosFiltrados)
                                {
                                    <li @onclick="() => SeleccionarEmpleado(emp)">
                                        <strong>@emp.Nombre</strong> ‚Äî @emp.ClavePersonal
                                        <br />
                                        <small>@emp.Puesto ‚Äî @emp.Area</small>
                                    </li>
                                }
                            </ul>
                        }
                    </div>

                </div>
            </div>

            <!-- Paso 3: Seleccionar Cliente/Grupo -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number @(selectedClient != null ? "step-completed" : "") @(selectedEmployee == null ? "step-disabled" : "")">3</div>
                    <label class="step-label">
                        @(assignmentType == "client" ? "Seleccionar Cliente" : "Seleccionar Grupo")
                    </label>
                </div>

                <div class="step-content">
                    <div class="autocomplete-container">
                        <input class="form-select"
                               placeholder="@(assignmentType == "client" ? "Buscar cliente..." : "Buscar grupo...")"
                               value="@searchTextCliente"
                               @onfocus="MostrarClientes"
                               @oninput="FiltrarClientes"
                               disabled="@(selectedEmployee == null)" />

                        @if (mostrarClientes && clientesFiltrados.Any())
                        {
                            <ul class="autocomplete-list">
                                @foreach (var item in clientesFiltrados)
                                {
                                    <li @onclick="() => SeleccionarCliente(item)">
                                        @item.Nombre
                                    </li>
                                }
                            </ul>
                        }
                    </div>

                    @if (assignmentType == "group" && selectedClient != null)
                    {
                        var grupo = gruposClientes.FirstOrDefault(g => g.Id == int.Parse(selectedClient));
                        if (grupo != null)
                        {
                            <div class="group-companies">
                                <p class="group-label">Empresas en este grupo:</p>
                                <div class="company-tags">
                                    @foreach (var cli in grupo.Clientes)
                                    {
                                        <span class="company-tag">@cli.RazonSocial</span>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
            @if (serviciosCargados && sinServiciosOActividades)
            {
                <div class="alert-warning">
                    El √°rea a la que pertenece esta persona no tiene servicios y/o actividades
                </div>
            }

            <!-- Paso 4: Seleccionar Servicios -->
            @if (selectedClient != null && currentEntity != null)
            {
                <div class="form-step">
                    <div class="step-header">
                        <div class="step-number @(selectedServices.Any() ? "step-completed" : "")">4</div>
                        <label class="step-label">Seleccionar Servicios</label>
                    </div>
                    <div class="step-content">
                        <div class="services-list">
                            @foreach (var service in currentEntity.Services)
                            {
                                <div class="service-item">
                                    <label class="checkbox-wrapper">
                                        <input type="checkbox"
                                               checked="@selectedServices.Contains(service.Id)"
                                               @onchange="() => ToggleService(service.Id)" />
                                        <span class="checkbox-custom"></span>
                                        <span class="service-name">@service.Name</span>
                                    </label>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Paso 5: Seleccionar Actividades -->
                @if (selectedServices.Any())
                {
                    <div class="form-step">
                        <div class="step-header">
                            <div class="step-number @(selectedActivities.Any() ? "step-completed" : "")">5</div>
                            <label class="step-label">Seleccionar Actividades</label>
                        </div>
                        <div class="step-content">
                            <div class="activities-by-service">
                                @foreach (var service in currentEntity.Services.Where(s => selectedServices.Contains(s.Id)))
                                {
                                    <div class="service-activities">
                                        <p class="service-header">
                                            <label class="checkbox-wrapper service-checkbox">
                                                <input type="checkbox"
                                                       checked="@IsServiceFullySelected(service)"
                                                       @onchange="() => ToggleAllActivitiesForService(service)" />
                                                <span class="checkbox-custom"></span>

                                                <svg width="16" height="16" viewBox="0 0 24 24"
                                                     fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="9 18 15 12 9 6"></polyline>
                                                </svg>

                                                <strong>@service.Name</strong>
                                            </label>
                                        </p>
                                        <div class="activities-list">
                                            @foreach (var activity in service.Activities)
                                            {
                                                <div class="activity-item">
                                                    <label class="checkbox-wrapper">
                                                        <input type="checkbox"
                                                               checked="@selectedActivities.Contains(activity.Id)"
                                                               @onchange="() => ToggleActivity(activity.Id)" />
                                                        <span class="checkbox-custom"></span>
                                                        <span class="activity-name">@activity.Name</span>
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Botones de acci√≥n -->
        <div class="form-actions">
            <button class="btn-save @(!IsFormComplete() ? "btn-disabled" : "")"
                    @onclick="SaveAssignment"
                    disabled="@(!IsFormComplete())">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Guardar Asignaci√≥n
            </button>
            <button class="btn-cancel" @onclick="ResetForm">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Tabla de asignaciones realizadas -->
    @if (cargandoHistorial)
    {
        <p>Cargando historial...</p>
    }
    else if (historialAsignaciones.Any())
    {
        <div class="assignments-table">
            <h3 class="table-title">
                Historial de Asignaciones (@historialAsignaciones.Count)
            </h3>

            <div class="table-wrapper">
                <table class="assignments-grid">
                    <thead>
                        <tr>
                            <th>Empleado</th>
                            <th>Cliente / Grupo</th>
                            <th>Tipo</th>
                            <th>Servicios</th>
                            <th>Actividades</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in historialAsignaciones)
                        {
                            <tr>
                                <td class="td-bold">@item.Empleado</td>
                                <td>@item.Entidad</td>
                                <td>
                                    <span class="type-badge type-badge-@item.TipoEntidad.ToLower()">
                                        @item.TipoEntidad
                                    </span>
                                </td>
                                <td class="td-services">
                                    @item.Servicios
                                </td>
                                <td>
                                    @item.TotalActividades actividad@(item.TotalActividades != 1 ? "es" : "")
                                </td>
                                <td>
                                    @item.FechaAsignacion.ToString("dd/MM/yyyy")
                                </td>
                                <td>
                                    <button class="btn-copy"
                                            disabled="@copiando"
                                            @onclick="() => CopiarAsignacion(item)">

                                        @if (copiando)
                                        {
                                            <span class="spinner-border spinner-border-sm"></span>
                                        }
                                        else
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 width="18"
                                                 height="18"
                                                 viewBox="0 0 24 24"
                                                 fill="none"
                                                 stroke="#0D9488"
                                                 stroke-width="2"
                                                 stroke-linecap="round"
                                                 stroke-linejoin="round"
                                                 style="background: none; border: none;">
                                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                                            </svg>
                                        }

                                    </button>
                                    <button class="btn-reassign"
                                            @onclick="() => AbrirReasignacion(item)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="background: none; border: none;">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                                        </svg>
                                    </button>
                                    <button class="btn-delete-assign"
                                            @onclick="() => AbrirModalEliminar(item)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#A30029" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="background: none; border: none;">
                                            <path d="M3 6h18" />
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
                                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                            <line x1="10" y1="11" x2="10" y2="17" />
                                            <line x1="14" y1="11" x2="14" y2="17" />
                                        </svg>
                                    </button>
                                </td>

                            </tr>
                        }
                    </tbody>
                </table>
              
            </div>
        </div>
        @if (mostrarModalReasignar && asignacionSeleccionada != null)
        {
            <div class="modal-overlay">
                <div class="modal-content">
                    <h3>Reasignar</h3>

                    <p><strong>Empleado actual:</strong> @asignacionSeleccionada.Empleado</p>
                    <p><strong>Entidad:</strong> @asignacionSeleccionada.Entidad</p>

                    <div class="autocomplete-container">

                        <input class="form-select"
                               placeholder="Buscar nuevo empleado..."
                               @bind="searchReasignar"
                               @onfocus="MostrarListaEmpleados"
                               @oninput="FiltrarEmpleadosReasignar" />

                        @if (mostrarListaReasignar && empleadosFiltradosReasignar.Any())
                        {
                            <ul class="autocomplete-list">
                                @foreach (var emp in empleadosFiltradosReasignar)
                                {
                                    <li @onclick="() => SeleccionarNuevoEmpleado(emp)">
                                        <strong>@emp.Nombre</strong> ‚Äî @emp.ClavePersonal
                                        <br />
                                        <small>@emp.Puesto ‚Äî @emp.Area</small>
                                    </li>
                                }
                            </ul>
                        }

                    </div>
                    <div class="form-actions">
                        <button class="btn-save"
                                disabled="@(nuevoEmpleadoSeleccionado == null)"
                                @onclick="ConfirmarReasignacion">
                            Confirmar
                        </button>

                        <button class="btn-cancel"
                                @onclick="CerrarModalReasignar">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        }
        @if (mostrarModalEliminar && asignacionEliminar != null)
        {
            <div class="modal-overlay">
                <div class="modal-content">
                    <h3>Confirmar Eliminaci√≥n</h3>

                    <p>
                        ¬øDeseas eliminar esta asignaci√≥n?
                    </p>

                    <p><strong>Empleado:</strong> @asignacionEliminar.Empleado</p>
                    <p><strong>Entidad:</strong> @asignacionEliminar.Entidad</p>

                    <div class="form-actions">
                        <button class="btn-save"
                                @onclick="ConfirmarEliminar"
                                disabled="@eliminando">
                            Confirmar
                        </button>

                        <button class="btn-cancel"
                                @onclick="CerrarModalEliminar">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        }

    
    }
    else
    {
        <p>No hay asignaciones registradas.</p>
    }

  
</div>

@code {

    private string? assignmentType = null;
    private string? selectedEmployee = null;
    private string? selectedClient = null;
    private List<string> selectedServices = new();
    private List<string> selectedActivities = new();
    private List<ClientesDTO> clientes = new();
    private List<GrupoClientesDTO> gruposClientes = new();
    private List<EmpleadoDTO> empleados = new();
    private List<EmpleadoDTO> empleadosFiltrados = new();
    private EmpleadoDTO? empleadoSeleccionado;
    private string searchText = "";
    private bool mostrarLista = false;
    private string searchTextCliente = "";
    private bool mostrarClientes = false;
    private List<(int Id, string Nombre)> clientesFiltrados = new();
    private List<Service> servicios = new();
    private bool cargandoServicios = false;
    private List<ServicioConActividadesDTO> serviciosPorArea = new();
    private bool sinServiciosOActividades = false;
    private bool serviciosCargados = false;
    private List<HistorialAsignacionDTO> historialAsignaciones = new();
    private bool cargandoHistorial = false;
    private bool mostrarModalReasignar = false;
    private HistorialAsignacionDTO? asignacionSeleccionada;
    private EmpleadoDTO? nuevoEmpleadoSeleccionado;
    private string searchReasignar = "";
    private List<EmpleadoDTO> empleadosFiltradosReasignar = new();
    private bool mostrarListaReasignar = false;
    private bool mostrarModalEliminar = false;
    private HistorialAsignacionDTO? asignacionEliminar;
    private bool eliminando = false;


    protected override async Task OnInitializedAsync()
    {
        var cultura = new CultureInfo("es-MX");
        CultureInfo.CurrentCulture = cultura;
        CultureInfo.CurrentUICulture = cultura;

        await CargarEmpleados();
        await CargarHistorialAsignaciones();
    }


    private async Task SetAssignmentType(string type)
    {
        assignmentType = type;
        LimpiarEmpleado();
        LimpiarCliente();

        selectedServices.Clear();
        selectedActivities.Clear();

        Debug.WriteLine("===== TIPO DE ASIGNACI√ìN =====");
        Debug.WriteLine($"assignmentType = [{assignmentType}]");
        Debug.WriteLine("=============================");

        if (type == "client")
            await CargarClientes();
        else
            await CargarGruposClientes();
         sinServiciosOActividades = false;
            serviciosCargados = false;
    }


    private void LimpiarEmpleado()
    {
        empleadoSeleccionado = null;
        selectedEmployee = null;
        searchText = "";
        mostrarLista = false;
    }

    private void LimpiarCliente()
    {
        selectedClient = null;
        searchTextCliente = "";
        mostrarClientes = false;
    }


    private async Task CargarClientes()
    {
        clientes = await Http
            .GetFromJsonAsync<List<ClientesDTO>>(
                "/api/servicio-cliente/admin/clientes")
            ?? new();
    }

    private async Task CargarGruposClientes()
    {
        gruposClientes = await Http
            .GetFromJsonAsync<List<GrupoClientesDTO>>(
                "/api/servicio-cliente/admin/grupos-clientes")
            ?? new();
    }

    private async Task CargarEmpleados()
    {
        empleados = await EmpleadosService.GetFiltrados();
    }

    private async Task CargarHistorialAsignaciones()
    {
        cargandoHistorial = true;

        try
        {
            historialAsignaciones =
                await Http.GetFromJsonAsync<List<HistorialAsignacionDTO>>(
                    "/api/servicio-cliente/admin/historial-asignaciones"
                ) ?? new();
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"‚ùå Error cargando historial: {ex.Message}");
            historialAsignaciones = new();
        }

        cargandoHistorial = false;
    }


    private void MostrarEmpleados()
    {
        if (empleadoSeleccionado != null)
            return;

        empleadosFiltrados = empleados
            .Where(e =>
                string.IsNullOrEmpty(searchText) ||
                e.Nombre.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                e.ClavePersonal.ToString().Contains(searchText))
            .ToList();

        mostrarLista = true;

    }

    private void FiltrarEmpleados(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";

        empleadosFiltrados = empleados
            .Where(e =>
                e.Nombre.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                e.ClavePersonal.ToString().Contains(searchText))
            .ToList();

        mostrarLista = empleadosFiltrados.Any();
    }

    private async Task SeleccionarEmpleado(EmpleadoDTO emp)
    {
        empleadoSeleccionado = emp;
        selectedEmployee = emp.Id.ToString();
        searchText = emp.Nombre;
        mostrarLista = false;

        Debug.WriteLine("===== EMPLEADO SELECCIONADO =====");
        Debug.WriteLine($"ID: {emp.Id}");
        Debug.WriteLine($"NOMBRE: {emp.Nombre}");
        Debug.WriteLine($"AREA: [{emp.Area}]");
        Debug.WriteLine("================================");

        await CargarServiciosPorArea();
    }


    private void MostrarClientes()
    {
        if (!string.IsNullOrEmpty(selectedClient))
            return;

        clientesFiltrados = assignmentType == "client"
            ? clientes
                .Where(c =>
                    string.IsNullOrEmpty(searchTextCliente) ||
                    (c.RazonSocial != null &&
                     c.RazonSocial.Contains(searchTextCliente, StringComparison.OrdinalIgnoreCase)))
                .Select(c => (c.Id, c.RazonSocial ?? ""))
                .ToList()
            : gruposClientes
                .Where(g =>
                    string.IsNullOrEmpty(searchTextCliente) ||
                    g.Nombre.Contains(searchTextCliente, StringComparison.OrdinalIgnoreCase))
                .Select(g => (g.Id, g.Nombre))
                .ToList();

        mostrarClientes = clientesFiltrados.Any();
    }


    private void FiltrarClientes(ChangeEventArgs e)
    {
        searchTextCliente = e.Value?.ToString() ?? "";

        clientesFiltrados = assignmentType == "client"
            ? clientes
                .Where(c => c.RazonSocial != null &&
                            c.RazonSocial.Contains(searchTextCliente, StringComparison.OrdinalIgnoreCase))
                .Select(c => (c.Id, c.RazonSocial ?? ""))
                .ToList()
            : gruposClientes
                .Where(g => g.Nombre.Contains(searchTextCliente, StringComparison.OrdinalIgnoreCase))
                .Select(g => (g.Id, g.Nombre))
                .ToList();

        mostrarClientes = true;
    }

    private async Task SeleccionarCliente((int Id, string Nombre) item)

    {
        selectedClient = item.Id.ToString();
        searchTextCliente = item.Nombre;
        mostrarClientes = false;

        Debug.WriteLine("===== CLIENTE / GRUPO =====");
        Debug.WriteLine($"ID SELECCIONADO: {selectedClient}");
        Debug.WriteLine($"NOMBRE: {item.Nombre}");
        Debug.WriteLine("===========================");

        selectedServices.Clear();
        selectedActivities.Clear();

        await CargarServiciosPorArea();
    }

    private void OnClientChanged()
    {
        selectedServices.Clear();
        selectedActivities.Clear();
    }

    private void ToggleService(string serviceId)
    {

        Debug.WriteLine($"SERVICE TOGGLE: {serviceId}");

        if (selectedServices.Contains(serviceId))
        {
            selectedServices.Remove(serviceId);
            // Remove activities of this service
            var service = currentEntity?.Services.FirstOrDefault(s => s.Id == serviceId);
            if (service != null)
            {
                foreach (var activity in service.Activities)
                {
                    selectedActivities.Remove(activity.Id);
                }
            }
        }
        else
        {
            selectedServices.Add(serviceId);
        }

        Debug.WriteLine($"SERVICIOS SELECCIONADOS: {string.Join(", ", selectedServices)}");
    }

    private void ToggleActivity(string activityId)
    {

        Debug.WriteLine($"ACTIVITY TOGGLE: {activityId}");
        if (selectedActivities.Contains(activityId))
        {
            selectedActivities.Remove(activityId);
        }
        else
        {
            selectedActivities.Add(activityId);
        }

        Debug.WriteLine($"ACTIVIDADES SELECCIONADAS: {string.Join(", ", selectedActivities)}");
    }

    private bool IsFormComplete()
    {
        return !string.IsNullOrEmpty(selectedEmployee) &&
               !string.IsNullOrEmpty(selectedClient) &&
               selectedServices.Any() &&
               selectedActivities.Any();
    }

    private async Task SaveAssignment()
    {

        var usuario = LoginService.obtenerUsuarioLogueado();

        if (usuario == null || !usuario.IdAgendasAsignadas.Any())
        {
            Debug.WriteLine("‚ùå Usuario sin agendas asignadas");
            return;
        }

        int idAgenda = usuario.IdAgendasAsignadas.First();


        Debug.WriteLine("===== BACKEND CREAR ASIGNACION =====");
        Debug.WriteLine($"IdAgenda recibido: {idAgenda}");
        Debug.WriteLine($"Empleado: {selectedEmployee}");
        Debug.WriteLine($"Cliente/Grupo: {selectedClient}");
        Debug.WriteLine($"Tipo: {assignmentType}");

        Debug.WriteLine($"Servicios: {string.Join(", ", selectedServices)}");
        Debug.WriteLine($"Actividades: {string.Join(", ", selectedActivities)}");
        if (!IsFormComplete() || empleadoSeleccionado == null)
            return;

        // 1Ô∏è‚É£ Determinar IDs de clientes
        List<int> entidadesIds;

        if (assignmentType == "client")
        {
            entidadesIds = new List<int>
        {
            int.Parse(selectedClient!)
        };
        }
        else // group
        {
            entidadesIds = gruposClientes
                .First(g => g.Id == int.Parse(selectedClient!))
                .Clientes
                .Select(c => c.Id)
                .ToList();
        }

        // 2Ô∏è‚É£ Construir DTO
        var dto = new AsignacionClienteActividadesDTO
        {
            IdAgenda = idAgenda,
            TipoEntidad = assignmentType == "client" ? "Cliente" : "Grupo",
            IdEmpleado = empleadoSeleccionado.Id,
            ClientesIds = entidadesIds,
            ActividadesIds = selectedActivities.Select(int.Parse).ToList()
        };

        // 3Ô∏è‚É£ POST al backend
        var response = await Http.PostAsJsonAsync(
            "/api/servicio-cliente/admin/asignar",
            dto
        );

        if (!response.IsSuccessStatusCode)
        {
            var error = await response.Content.ReadAsStringAsync();
            Debug.WriteLine($"‚ùå Error al guardar asignaci√≥n: {error}");
            return;
        }




        await CargarHistorialAsignaciones();

        ResetForm();
    }

    private void ResetForm()
    {
        assignmentType = null;
        selectedServices.Clear();
        selectedActivities.Clear();



        LimpiarCliente();
        LimpiarEmpleado();
    }


    // Models
    public class Employee { public string Id { get; set; } = ""; public string Name { get; set; } = ""; }
    public class Activity { public string Id { get; set; } = ""; public string Name { get; set; } = ""; }
    public class Service
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public List<Activity> Activities { get; set; } = new();
    }

    public interface IEntityWithServices
    {
        string Id { get; set; }
        string Name { get; set; }
        List<Service> Services { get; set; }
    }

    private IEntityWithServices? currentEntity
    {
        get
        {
            if (string.IsNullOrEmpty(selectedClient))
                return null;

            if (assignmentType == "client")
            {
                var cli = clientes.FirstOrDefault(c => c.Id == int.Parse(selectedClient));
                if (cli == null) return null;

                return new EntityWithServices
                {
                    Id = cli.Id.ToString(),
                    Name = cli.RazonSocial ?? "",
                    Services = servicios
                };
            }

            if (assignmentType == "group")
            {
                var grp = gruposClientes.FirstOrDefault(g => g.Id == int.Parse(selectedClient));
                if (grp == null) return null;

                return new EntityWithServices
                {
                    Id = grp.Id.ToString(),
                    Name = grp.Nombre,
                    Services = servicios
                };
            }

            return null;
        }
    }

    private class EntityWithServices : IEntityWithServices
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public List<Service> Services { get; set; } = new();
    }



    public class Company : IEntityWithServices
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public List<Service> Services { get; set; } = new();
    }

    public class ClientGroup : IEntityWithServices
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public List<string> Companies { get; set; } = new();
        public List<Service> Services { get; set; } = new();
    }

    public class SavedAssignment
    {
        public string Id { get; set; } = "";
        public string Employee { get; set; } = "";
        public string ClientOrGroup { get; set; } = "";
        public string Type { get; set; } = "";
        public List<string> Services { get; set; } = new();
        public List<string> Activities { get; set; } = new();
        public string Date { get; set; } = "";
    }

    private async Task CargarServiciosPorArea()
    {
        if (empleadoSeleccionado == null)
        {
            Debug.WriteLine("‚ùå CargarServiciosPorArea: empleadoSeleccionado es NULL");
            return;
        }

        cargandoServicios = true;
        sinServiciosOActividades = false;
        serviciosCargados = false;

        var area = empleadoSeleccionado.Area?.Trim() ?? "";

        // üîé DEBUG 1: √Årea usada para la consulta
        Debug.WriteLine("===== CARGAR SERVICIOS POR √ÅREA =====");
        Debug.WriteLine($"Empleado ID: {empleadoSeleccionado.Id}");
        Debug.WriteLine($"Empleado Nombre: {empleadoSeleccionado.Nombre}");
        Debug.WriteLine($"√Årea enviada: [{area}]");

        serviciosPorArea = await Http.GetFromJsonAsync<List<ServicioConActividadesDTO>>(
            $"/api/servicio-cliente/admin/servicios-actividades?area={Uri.EscapeDataString(area)}"
        ) ?? new();

        serviciosCargados = true;

        // üîé DEBUG 2: Resultado crudo del backend
        Debug.WriteLine($"Servicios recibidos: {serviciosPorArea.Count}");

        foreach (var s in serviciosPorArea)
        {
            Debug.WriteLine(
                $"Servicio -> ID: {s.IdServicio}, Nombre: {s.Servicio}, " +
                $"Actividades: {(s.Actividades == null ? "NULL" : s.Actividades.Count.ToString())}"
            );
        }

        sinServiciosOActividades =
            !serviciosPorArea.Any() ||
            serviciosPorArea.All(s => s.Actividades == null || !s.Actividades.Any());

        // üîé DEBUG 3: Evaluaci√≥n de bandera
        Debug.WriteLine($"sinServiciosOActividades = {sinServiciosOActividades}");

        // Mapear a la estructura que usa la UI
        servicios = serviciosPorArea.Select(s => new Service
        {
            Id = s.IdServicio.ToString(),
            Name = s.Servicio,
            Activities = s.Actividades.Select(a => new Activity
            {
                Id = a.IdActividad.ToString(),
                Name = a.Actividad
            }).ToList()
        }).ToList();

        // üîé DEBUG 4: Resultado final que usa la UI
        Debug.WriteLine($"Servicios mapeados a UI: {servicios.Count}");

        foreach (var srv in servicios)
        {
            Debug.WriteLine(
                $"UI Servicio -> ID: {srv.Id}, Nombre: {srv.Name}, Actividades: {srv.Activities.Count}"
            );
        }

        Debug.WriteLine("===== FIN CARGAR SERVICIOS =====");

        cargandoServicios = false;
    }

    private bool IsServiceFullySelected(Service service)
    {
        return service.Activities.Any() &&
               service.Activities.All(a => selectedActivities.Contains(a.Id));
    }

    private void ToggleAllActivitiesForService(Service service)
    {
        var allSelected = IsServiceFullySelected(service);

        foreach (var activity in service.Activities)
        {
            if (allSelected)
            {
                selectedActivities.Remove(activity.Id);
            }
            else
            {
                if (!selectedActivities.Contains(activity.Id))
                    selectedActivities.Add(activity.Id);
            }
        }
    }


    private void AbrirReasignacion(HistorialAsignacionDTO item)
    {
        asignacionSeleccionada = item;
        mostrarModalReasignar = true;
        nuevoEmpleadoSeleccionado = null;
        searchReasignar = "";
    }

    private void CerrarModalReasignar()
    {
        mostrarModalReasignar = false;
        asignacionSeleccionada = null;
        nuevoEmpleadoSeleccionado = null;
        empleadosFiltradosReasignar.Clear();
        searchReasignar = "";
        mostrarListaReasignar = false;
    }


    private void FiltrarEmpleadosReasignar(ChangeEventArgs e)
    {
        searchReasignar = e.Value?.ToString() ?? "";

        empleadosFiltradosReasignar = empleados
            .Where(x => x.Nombre.Contains(searchReasignar,
                    StringComparison.OrdinalIgnoreCase))
            .ToList();

        mostrarListaReasignar = true;
    }

   
    private void SeleccionarNuevoEmpleado(EmpleadoDTO emp)
    {
        nuevoEmpleadoSeleccionado = emp;
        searchReasignar = emp.Nombre;
        mostrarListaReasignar = false;
    }

    

    private async Task ConfirmarReasignacion()
    {
        if (asignacionSeleccionada == null || nuevoEmpleadoSeleccionado == null)
            return;

        var usuario = LoginService.obtenerUsuarioLogueado();

        if (usuario == null || !usuario.IdAgendasAsignadas.Any())
            return;

        Debug.WriteLine("üî• ConfirmarReasignacion ejecutado");
        Debug.WriteLine($"AsignacionSeleccionada null? {asignacionSeleccionada == null}");
        Debug.WriteLine($"NuevoEmpleado null? {nuevoEmpleadoSeleccionado == null}");

        int idAgenda = usuario.IdAgendasAsignadas.First();

        var dto = new ReasignarAsignacionDTO
        {
            IdUsuarioEntidadAgenda = asignacionSeleccionada.IdUsuarioEntidadAgenda,
            IdEmpleadoActual = asignacionSeleccionada.IdEmpleado,
            IdEmpleadoNuevo = nuevoEmpleadoSeleccionado.Id
        };

        var response = await Http.PatchAsJsonAsync(
        "/api/servicio-cliente/admin/reasignar",
        dto
    );

        if (!response.IsSuccessStatusCode)
        {
            var error = await response.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alertaErrorReasignacion", error);
            return;
        }

        await JS.InvokeVoidAsync("alertaReasignacionExitosa");


        CerrarModalReasignar();
        await CargarHistorialAsignaciones();
    }

    private void MostrarListaEmpleados()
    {
        empleadosFiltradosReasignar = empleados.ToList();
        mostrarListaReasignar = true;
    }

    private void AbrirModalEliminar(HistorialAsignacionDTO item)
    {
        asignacionEliminar = item;
        mostrarModalEliminar = true;
    }

    private void CerrarModalEliminar()
    {
        mostrarModalEliminar = false;
        asignacionEliminar = null;
    }
    private async Task ConfirmarEliminar()
    {
        if (asignacionEliminar == null)
            return;

        eliminando = true;

        var dto = new EliminarAsignacionDTO
        {
            IdEmpleado = asignacionEliminar.IdEmpleado,
            IdUsuarioEntidadAgenda = asignacionEliminar.IdUsuarioEntidadAgenda
        };

        var request = new HttpRequestMessage(HttpMethod.Delete,
            "/api/servicio-cliente/admin/eliminar-asignacion")
        {
            Content = JsonContent.Create(dto)
        };

        var response = await Http.SendAsync(request);

        eliminando = false;

        // üî• Cerrar modal SIEMPRE
        CerrarModalEliminar();

        if (!response.IsSuccessStatusCode)
        {
            var error = await response.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alertaErrorEliminar", error);
            return;
        }

        await JS.InvokeVoidAsync("alertaEliminarExitosa");

        await CargarHistorialAsignaciones();
    }


    private bool copiando = false;
    private async Task CopiarAsignacion(HistorialAsignacionDTO item)
    {
        if (copiando)
            return;

        copiando = true;

        try
        {
            var usuario = LoginService.obtenerUsuarioLogueado();

            if (usuario == null || !usuario.IdAgendasAsignadas.Any())
                return;

            int idAgenda = usuario.IdAgendasAsignadas.First();

            var dto = new AsignacionClienteActividadesDTO
            {
                IdAgenda = idAgenda,
                TipoEntidad = item.TipoEntidad,
                IdEmpleado = item.IdEmpleado,
                ClientesIds = item.EntidadesExternasIds,
                ActividadesIds = item.ActividadesIds
            };

            var response = await Http.PostAsJsonAsync(
                "/api/servicio-cliente/admin/asignar",
                dto
            );

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alertaErrorReasignacion", error);
                return;
            }

            await CargarHistorialAsignaciones();
        }
        finally
        {
            copiando = false;
        }
    }
}
