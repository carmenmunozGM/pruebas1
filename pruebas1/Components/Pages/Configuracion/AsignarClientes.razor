@* Componente de Asignación de Clientes con flujo guiado *@
@using Models
@using pruebas1.Components.UI

<div class="asignar-container">
    <div class="section-header">
        <h2 class="section-title">Asignar Clientes</h2>
        <p class="section-description">
            Asigna empleados a clientes o grupos de clientes con sus servicios y actividades
        </p>
    </div>

    <!-- Formulario de nueva asignación -->
    <div class="assignment-form">
        <h3 class="form-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
            </svg>
            Nueva Asignación
        </h3>

        <div class="form-steps">
            <!-- Paso 1: Tipo de Asignación -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number @(assignmentType != null ? "step-completed" : "")">1</div>
                    <label class="step-label">Tipo de Asignación</label>
                </div>
                <div class="step-content">
                    <div class="assignment-type-buttons">
                        <button 
                            class="type-button @(assignmentType == "client" ? "type-button-active" : "")"
                            @onclick="@(() => SetAssignmentType("client"))">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Asignar por Cliente
                        </button>
                        <button 
                            class="type-button @(assignmentType == "group" ? "type-button-active" : "")"
                            @onclick="@(() => SetAssignmentType("group"))">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Asignar por Grupo de Clientes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Paso 2: Seleccionar Empleado -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number @(selectedEmployee != null ? "step-completed" : "") @(assignmentType == null ? "step-disabled" : "")">2</div>
                    <label class="step-label">Seleccionar Empleado</label>
                </div>
                <div class="step-content">
                    <select 
                        class="form-select" 
                        @bind="selectedEmployee" 
                        disabled="@(assignmentType == null)">
                        <option value="">Selecciona un empleado...</option>
                        @foreach (var emp in employees)
                        {
                            <option value="@emp.Id">@emp.Name</option>
                        }
                    </select>
                </div>
            </div>

            <!-- Paso 3: Seleccionar Cliente/Grupo -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number @(selectedClient != null ? "step-completed" : "") @(selectedEmployee == null ? "step-disabled" : "")">3</div>
                    <label class="step-label">@(assignmentType == "client" ? "Seleccionar Cliente" : "Seleccionar Grupo")</label>
                </div>
                <div class="step-content">
                    <select 
                        class="form-select" 
                        @bind="selectedClient"
                        @bind:after="OnClientChanged"
                        disabled="@(selectedEmployee == null)">
                        <option value="">@(assignmentType == "client" ? "Selecciona un cliente..." : "Selecciona un grupo...")</option>
                        @if (assignmentType == "client")
                        {
                            @foreach (var company in companies)
                            {
                                <option value="@company.Id">@company.Name</option>
                            }
                        }
                        else if (assignmentType == "group")
                        {
                            @foreach (var group in clientGroups)
                            {
                                <option value="@group.Id">@group.Name</option>
                            }
                        }
                    </select>

                    @if (assignmentType == "group" && selectedClient != null)
                    {
                        var group = clientGroups.FirstOrDefault(g => g.Id == selectedClient);
                        if (group != null)
                        {
                            <div class="group-companies">
                                <p class="group-label">Empresas en este grupo:</p>
                                <div class="company-tags">
                                    @foreach (var company in group.Companies)
                                    {
                                        <span class="company-tag">@company</span>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Paso 4: Seleccionar Servicios -->
            @if (selectedClient != null && currentEntity != null)
            {
                <div class="form-step">
                    <div class="step-header">
                        <div class="step-number @(selectedServices.Any() ? "step-completed" : "")">4</div>
                        <label class="step-label">Seleccionar Servicios</label>
                    </div>
                    <div class="step-content">
                        <div class="services-list">
                            @foreach (var service in currentEntity.Services)
                            {
                                <div class="service-item">
                                    <label class="checkbox-wrapper">
                                        <input 
                                            type="checkbox"
                                            checked="@selectedServices.Contains(service.Id)"
                                            @onchange="() => ToggleService(service.Id)" />
                                        <span class="checkbox-custom"></span>
                                        <span class="service-name">@service.Name</span>
                                    </label>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Paso 5: Seleccionar Actividades -->
                @if (selectedServices.Any())
                {
                    <div class="form-step">
                        <div class="step-header">
                            <div class="step-number @(selectedActivities.Any() ? "step-completed" : "")">5</div>
                            <label class="step-label">Seleccionar Actividades</label>
                        </div>
                        <div class="step-content">
                            <div class="activities-by-service">
                                @foreach (var service in currentEntity.Services.Where(s => selectedServices.Contains(s.Id)))
                                {
                                    <div class="service-activities">
                                        <p class="service-header">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="9 18 15 12 9 6"></polyline>
                                            </svg>
                                            @service.Name
                                        </p>
                                        <div class="activities-list">
                                            @foreach (var activity in service.Activities)
                                            {
                                                <div class="activity-item">
                                                    <label class="checkbox-wrapper">
                                                        <input 
                                                            type="checkbox"
                                                            checked="@selectedActivities.Contains(activity.Id)"
                                                            @onchange="() => ToggleActivity(activity.Id)" />
                                                        <span class="checkbox-custom"></span>
                                                        <span class="activity-name">@activity.Name</span>
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Botones de acción -->
        <div class="form-actions">
            <button 
                class="btn-save @(!IsFormComplete() ? "btn-disabled" : "")"
                @onclick="SaveAssignment"
                disabled="@(!IsFormComplete())">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Guardar Asignación
            </button>
            <button class="btn-cancel" @onclick="ResetForm">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Tabla de asignaciones realizadas -->
    @if (savedAssignments.Any())
    {
        <div class="assignments-table">
            <h3 class="table-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Asignaciones Realizadas (@savedAssignments.Count)
            </h3>

            <div class="table-wrapper">
                <table class="assignments-grid">
                    <thead>
                        <tr>
                            <th>Empleado</th>
                            <th>Cliente/Grupo</th>
                            <th>Tipo</th>
                            <th>Servicios</th>
                            <th>Actividades</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var assignment in savedAssignments)
                        {
                            <tr>
                                <td class="td-bold">@assignment.Employee</td>
                                <td>@assignment.ClientOrGroup</td>
                                <td>
                                    <span class="type-badge type-badge-@assignment.Type">
                                        @if (assignment.Type == "client")
                                        {
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="12" cy="7" r="4"></circle>
                                            </svg>
                                            <text>Cliente</text>
                                        }
                                        else
                                        {
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                            </svg>
                                            <text>Grupo</text>
                                        }
                                    </span>
                                </td>
                                <td class="td-services">
                                    @{
                                        var displayServices = string.Join(", ", assignment.Services.Take(2));
                                        if (assignment.Services.Count > 2)
                                        {
                                            <span>@displayServices <span class="services-more">+@(assignment.Services.Count - 2) más</span></span>
                                        }
                                        else
                                        {
                                            <span>@displayServices</span>
                                        }
                                    }
                                </td>
                                <td>@assignment.Activities.Count actividad@(assignment.Activities.Count != 1 ? "es" : "")</td>
                                <td>@assignment.Date</td>
                                <td>
                                    <button class="btn-delete" @onclick="() => DeleteAssignment(assignment.Id)" title="Eliminar asignación">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    // Mock data (igual que en el componente React)
    private List<Employee> employees = new()
    {
        new Employee { Id = "emp1", Name = "Karim Negrete" },
        new Employee { Id = "emp2", Name = "Carmen Muñoz" },
        new Employee { Id = "emp3", Name = "Gustavo Betanzos" },
        new Employee { Id = "emp4", Name = "María González" }
    };

    private List<Company> companies = new()
    {
        new Company 
        { 
            Id = "comp1", 
            Name = "Empresa ABC S.A.",
            Services = new List<Service>
            {
                new Service 
                { 
                    Id = "serv1", 
                    Name = "Auditoría Fiscal",
                    Activities = new List<Activity>
                    {
                        new Activity { Id = "act1", Name = "Revisión de estados financieros" },
                        new Activity { Id = "act2", Name = "Análisis de declaraciones" },
                        new Activity { Id = "act3", Name = "Emisión de informe final" }
                    }
                },
                new Service 
                { 
                    Id = "serv2", 
                    Name = "Consultoría Legal",
                    Activities = new List<Activity>
                    {
                        new Activity { Id = "act4", Name = "Revisión de contratos" },
                        new Activity { Id = "act5", Name = "Asesoría corporativa" }
                    }
                },
                new Service 
                { 
                    Id = "serv3", 
                    Name = "Gestión de Nómina",
                    Activities = new List<Activity>
                    {
                        new Activity { Id = "act6", Name = "Cálculo de nómina mensual" },
                        new Activity { Id = "act7", Name = "Declaraciones de IMSS" },
                        new Activity { Id = "act8", Name = "Reporte de impuestos sobre nómina" }
                    }
                }
            }
        },
        new Company 
        { 
            Id = "comp2", 
            Name = "Industrias XYZ",
            Services = new List<Service>
            {
                new Service 
                { 
                    Id = "serv4", 
                    Name = "Auditoría Operativa",
                    Activities = new List<Activity>
                    {
                        new Activity { Id = "act9", Name = "Evaluación de procesos" },
                        new Activity { Id = "act10", Name = "Identificación de riesgos" }
                    }
                },
                new Service 
                { 
                    Id = "serv5", 
                    Name = "Control Interno",
                    Activities = new List<Activity>
                    {
                        new Activity { Id = "act11", Name = "Diseño de políticas" },
                        new Activity { Id = "act12", Name = "Implementación de controles" },
                        new Activity { Id = "act13", Name = "Capacitación de personal" }
                    }
                }
            }
        }
    };

    private List<ClientGroup> clientGroups = new()
    {
        new ClientGroup
        {
            Id = "group1",
            Name = "Grupo Empresarial Norte",
            Companies = new List<string> { "Empresa Norte A", "Empresa Norte B", "Empresa Norte C" },
            Services = new List<Service>
            {
                new Service 
                { 
                    Id = "gserv1", 
                    Name = "Seguimiento Trimestral",
                    Activities = new List<Activity>
                    {
                        new Activity { Id = "gact1", Name = "Revisión de KPIs" },
                        new Activity { Id = "gact2", Name = "Informe trimestral" }
                    }
                },
                new Service 
                { 
                    Id = "gserv2", 
                    Name = "Asesoría Estratégica",
                    Activities = new List<Activity>
                    {
                        new Activity { Id = "gact3", Name = "Planificación anual" },
                        new Activity { Id = "gact4", Name = "Reuniones ejecutivas" }
                    }
                }
            }
        }
    };

    private string? assignmentType = null;
    private string? selectedEmployee = null;
    private string? selectedClient = null;
    private List<string> selectedServices = new();
    private List<string> selectedActivities = new();
    private List<SavedAssignment> savedAssignments = new();

    private IEntityWithServices? currentEntity => assignmentType == "client"
        ? companies.FirstOrDefault(c => c.Id == selectedClient)
        : clientGroups.FirstOrDefault(g => g.Id == selectedClient) as IEntityWithServices;

    private void SetAssignmentType(string type)
    {
        assignmentType = type;
        selectedClient = null;
        selectedServices.Clear();
        selectedActivities.Clear();
    }

    private void OnClientChanged()
    {
        selectedServices.Clear();
        selectedActivities.Clear();
    }

    private void ToggleService(string serviceId)
    {
        if (selectedServices.Contains(serviceId))
        {
            selectedServices.Remove(serviceId);
            // Remove activities of this service
            var service = currentEntity?.Services.FirstOrDefault(s => s.Id == serviceId);
            if (service != null)
            {
                foreach (var activity in service.Activities)
                {
                    selectedActivities.Remove(activity.Id);
                }
            }
        }
        else
        {
            selectedServices.Add(serviceId);
        }
    }

    private void ToggleActivity(string activityId)
    {
        if (selectedActivities.Contains(activityId))
        {
            selectedActivities.Remove(activityId);
        }
        else
        {
            selectedActivities.Add(activityId);
        }
    }

    private bool IsFormComplete()
    {
        return !string.IsNullOrEmpty(selectedEmployee) &&
               !string.IsNullOrEmpty(selectedClient) &&
               selectedServices.Any() &&
               selectedActivities.Any();
    }

    private void SaveAssignment()
    {
        if (!IsFormComplete()) return;

        var employee = employees.FirstOrDefault(e => e.Id == selectedEmployee);
        var entity = currentEntity;

        var serviceNames = entity?.Services
            .Where(s => selectedServices.Contains(s.Id))
            .Select(s => s.Name)
            .ToList() ?? new List<string>();

        var activityNames = new List<string>();
        if (entity != null)
        {
            foreach (var service in entity.Services)
            {
                foreach (var activity in service.Activities)
                {
                    if (selectedActivities.Contains(activity.Id))
                    {
                        activityNames.Add(activity.Name);
                    }
                }
            }
        }

        savedAssignments.Insert(0, new SavedAssignment
        {
            Id = Guid.NewGuid().ToString(),
            Employee = employee?.Name ?? "",
            ClientOrGroup = entity?.Name ?? "",
            Type = assignmentType ?? "",
            Services = serviceNames,
            Activities = activityNames,
            Date = DateTime.Now.ToString("dd/MM/yyyy")
        });

        ResetForm();
    }

    private void DeleteAssignment(string id)
    {
        savedAssignments.RemoveAll(a => a.Id == id);
    }

    private void ResetForm()
    {
        assignmentType = null;
        selectedEmployee = null;
        selectedClient = null;
        selectedServices.Clear();
        selectedActivities.Clear();
    }

    // Models
    public class Employee { public string Id { get; set; } = ""; public string Name { get; set; } = ""; }
    public class Activity { public string Id { get; set; } = ""; public string Name { get; set; } = ""; }
    public class Service 
    { 
        public string Id { get; set; } = ""; 
        public string Name { get; set; } = ""; 
        public List<Activity> Activities { get; set; } = new();
    }
    
    public interface IEntityWithServices 
    { 
        string Id { get; set; }
        string Name { get; set; }
        List<Service> Services { get; set; } 
    }
    
    public class Company : IEntityWithServices 
    { 
        public string Id { get; set; } = ""; 
        public string Name { get; set; } = ""; 
        public List<Service> Services { get; set; } = new();
    }
    
    public class ClientGroup : IEntityWithServices 
    { 
        public string Id { get; set; } = ""; 
        public string Name { get; set; } = ""; 
        public List<string> Companies { get; set; } = new();
        public List<Service> Services { get; set; } = new();
    }

    public class SavedAssignment
    {
        public string Id { get; set; } = "";
        public string Employee { get; set; } = "";
        public string ClientOrGroup { get; set; } = "";
        public string Type { get; set; } = "";
        public List<string> Services { get; set; } = new();
        public List<string> Activities { get; set; } = new();
        public string Date { get; set; } = "";
    }
}
