<div class="asignar-clientes-section">
    <div class="section-header">
        <h2>Asignar Clientes</h2>
        <p>Flujo guiado para asignar servicios y actividades</p>
    </div>

    <div class="flow-container">
        <!-- Step 1: Tipo de Asignación -->
        <div class="flow-step">
            <div class="step-header">
                <div class="step-number">1</div>
                <h3>Tipo de Asignación</h3>
            </div>

            <div class="type-options">
                <div class="type-option @(tipoAsignacion == "cliente" ? "active" : "")" 
                     @onclick='() => SetTipoAsignacion("cliente")'>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Asignar por Cliente</span>
                </div>

                <div class="type-option @(tipoAsignacion == "grupo" ? "active" : "")" 
                     @onclick='() => SetTipoAsignacion("grupo")'>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Asignar por Grupo</span>
                </div>
            </div>
        </div>

        <!-- Step 2: Selección de Empleado -->
        @if (!string.IsNullOrEmpty(tipoAsignacion))
        {
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h3>Selección de Empleado</h3>
                </div>

                <select class="flow-select" @bind="selectedEmpleado">
                    <option value="">Seleccionar empleado...</option>
                    @foreach (var emp in empleados)
                    {
                        <option value="@emp">@emp</option>
                    }
                </select>
            </div>
        }

        <!-- Step 3: Cliente o Grupo -->
        @if (!string.IsNullOrEmpty(selectedEmpleado))
        {
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <h3>@(tipoAsignacion == "cliente" ? "Seleccionar Cliente" : "Seleccionar Grupo/Empresa")</h3>
                </div>

                <select class="flow-select" @bind="selectedClienteOGrupo">
                    <option value="">@(tipoAsignacion == "cliente" ? "Seleccionar cliente..." : "Seleccionar grupo...")</option>
                    @if (tipoAsignacion == "cliente")
                    {
                        @foreach (var cliente in clientes)
                        {
                            <option value="@cliente">@cliente</option>
                        }
                    }
                    else
                    {
                        @foreach (var grupo in grupos)
                        {
                            <option value="@grupo">@grupo</option>
                        }
                    }
                </select>
            </div>
        }

        <!-- Step 4: Servicios -->
        @if (!string.IsNullOrEmpty(selectedClienteOGrupo))
        {
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <h3>Seleccionar Servicios</h3>
                </div>

                <div class="checkbox-grid">
                    @foreach (var servicio in servicios)
                    {
                        <label class="checkbox-item">
                            <input type="checkbox" 
                                   checked="@selectedServicios.Contains(servicio)" 
                                   @onchange="@(e => ToggleServicio(servicio))" />
                            <span>@servicio</span>
                        </label>
                    }
                </div>
            </div>
        }

        <!-- Step 5: Actividades por Servicio -->
        @if (selectedServicios.Any())
        {
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <h3>Seleccionar Actividades por Servicio</h3>
                </div>

                @foreach (var servicio in selectedServicios)
                {
                    <div class="service-activities">
                        <h4>@servicio</h4>
                        <div class="checkbox-grid">
                            @foreach (var actividad in GetActividadesPorServicio(servicio))
                            {
                                var key = $"{servicio}|{actividad}";
                                <label class="checkbox-item small">
                                    <input type="checkbox" 
                                           checked="@selectedActividades.Contains(key)" 
                                           @onchange="@(e => ToggleActividad(key))" />
                                    <span>@actividad</span>
                                </label>
                            }
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Guardar Button -->
        @if (CanSave())
        {
            <button class="save-assignment-button" @onclick="HandleSaveAssignment">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                <span>Guardar Asignación</span>
            </button>
        }
    </div>

    <!-- Listado de Asignaciones -->
    @if (asignaciones.Any())
    {
        <div class="assignments-list">
            <h3>Asignaciones Realizadas</h3>
            <div class="assignments-table">
                <table>
                    <thead>
                        <tr>
                            <th>Empleado</th>
                            <th>Cliente/Empresa</th>
                            <th>Servicios</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var (asignacion, index) in asignaciones.Select((a, i) => (a, i)))
                        {
                            <tr>
                                <td>@asignacion.Empleado</td>
                                <td>
                                    <span class="client-badge">@asignacion.ClienteOGrupo</span>
                                </td>
                                <td>
                                    <div class="services-pills">
                                        @foreach (var servicio in asignacion.Servicios.Take(2))
                                        {
                                            <span class="service-pill">@servicio</span>
                                        }
                                        @if (asignacion.Servicios.Count > 2)
                                        {
                                            <span class="service-pill more">+@(asignacion.Servicios.Count - 2)</span>
                                        }
                                    </div>
                                </td>
                                <td>@asignacion.Fecha</td>
                                <td>
                                    <div class="action-buttons-table">
                                        <button class="icon-button edit" title="Editar">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </button>
                                        <button class="icon-button delete" title="Eliminar" @onclick="() => DeleteAsignacion(index)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="message-toast">
            @message
        </div>
    }
</div>

@code {
    private string tipoAsignacion = "";
    private string selectedEmpleado = "";
    private string selectedClienteOGrupo = "";
    private List<string> selectedServicios = new List<string>();
    private List<string> selectedActividades = new List<string>();
    private string message = "";

    private List<string> empleados = new List<string> 
    { 
        "Karim Negrete", "Carmen Muñoz", "Gustavo Betanzos", 
        "Ana Torres", "Roberto Silva", "Laura Martínez" 
    };

    private List<string> clientes = new List<string>
    {
        "Cliente A", "Cliente B", "Cliente C", "Cliente D", "Cliente E"
    };

    private List<string> grupos = new List<string>
    {
        "Grupo Premium", "Grupo Estándar", "Grupo Empresarial", "Grupo Básico"
    };

    private List<string> servicios = new List<string>
    {
        "Consultoría", "Desarrollo", "Soporte", "Mantenimiento", "Capacitación"
    };

    private Dictionary<string, List<string>> actividadesPorServicio = new Dictionary<string, List<string>>
    {
        { "Consultoría", new List<string> { "Análisis de requisitos", "Planificación estratégica", "Auditoría", "Documentación" } },
        { "Desarrollo", new List<string> { "Frontend", "Backend", "Base de datos", "Testing", "Deployment" } },
        { "Soporte", new List<string> { "Soporte técnico", "Resolución de incidencias", "Atención al cliente", "Monitoreo" } },
        { "Mantenimiento", new List<string> { "Mantenimiento preventivo", "Actualizaciones", "Optimización", "Respaldos" } },
        { "Capacitación", new List<string> { "Capacitación inicial", "Talleres", "Documentación de usuario", "Webinars" } }
    };

    private class Asignacion
    {
        public string Empleado { get; set; }
        public string ClienteOGrupo { get; set; }
        public List<string> Servicios { get; set; }
        public string Fecha { get; set; }
    }

    private List<Asignacion> asignaciones = new List<Asignacion>();

    private void SetTipoAsignacion(string tipo)
    {
        tipoAsignacion = tipo;
        selectedEmpleado = "";
        selectedClienteOGrupo = "";
        selectedServicios.Clear();
        selectedActividades.Clear();
    }

    private List<string> GetActividadesPorServicio(string servicio)
    {
        return actividadesPorServicio.ContainsKey(servicio) 
            ? actividadesPorServicio[servicio] 
            : new List<string>();
    }

    private void ToggleServicio(string servicio)
    {
        if (selectedServicios.Contains(servicio))
        {
            selectedServicios.Remove(servicio);
            // Remove associated activities
            selectedActividades.RemoveAll(a => a.StartsWith($"{servicio}|"));
        }
        else
        {
            selectedServicios.Add(servicio);
        }
    }

    private void ToggleActividad(string key)
    {
        if (selectedActividades.Contains(key))
            selectedActividades.Remove(key);
        else
            selectedActividades.Add(key);
    }

    private bool CanSave()
    {
        return !string.IsNullOrEmpty(tipoAsignacion) &&
               !string.IsNullOrEmpty(selectedEmpleado) &&
               !string.IsNullOrEmpty(selectedClienteOGrupo) &&
               selectedServicios.Any() &&
               selectedActividades.Any();
    }

    private async Task HandleSaveAssignment()
    {
        asignaciones.Add(new Asignacion
        {
            Empleado = selectedEmpleado,
            ClienteOGrupo = selectedClienteOGrupo,
            Servicios = new List<string>(selectedServicios),
            Fecha = DateTime.Now.ToString("dd/MM/yyyy")
        });

        message = "Asignación guardada exitosamente";

        // Reset form
        tipoAsignacion = "";
        selectedEmpleado = "";
        selectedClienteOGrupo = "";
        selectedServicios.Clear();
        selectedActividades.Clear();

        await Task.Delay(3000);
        message = "";
    }

    private void DeleteAsignacion(int index)
    {
        asignaciones.RemoveAt(index);
    }
}
