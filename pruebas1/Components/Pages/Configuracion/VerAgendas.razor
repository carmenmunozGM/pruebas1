@using System.Diagnostics
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@using static System.Net.WebRequestMethods
@inject AreasService AreasService
@inject HttpClient Http

<div class="ver-agendas-section">
    <div class="section-header">
        <h2>Ver Agendas</h2>
        <p>Consulta las agendas de otros empleados</p>
    </div>

    <!-- Search Bar -->
    <div class="search-section">
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" 
                   @bind="searchName" 
                   @bind:event="oninput"
                   placeholder="Buscar por nombre..." />
        </div>
        <select class="area-filter" @bind="selectedArea">
            <option value="">Todas las áreas</option>
            @foreach (var area in areaList)
            {
                <option value="@area.Area">@area.Area</option>
            }
        </select>

    </div>

    <div class="agendas-grid">
        @foreach (var (employee, index) in filteredEmployees.Select((emp, idx) => (emp, idx)))
        {
            <div class="agenda-card">
                <div class="employee-info">
                    <div class="employee-avatar" style="background: @GetAvatarColor(index)">
                        @GetInitials(employee.NetName)
                    </div>
                    <div class="employee-details">
                        <h4>@employee.NetName - @employee.ClavePersonal</h4>
                        <p>@employee.Area - @employee.Puesto</p>

                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-box pending-stat">
                        <span class="stat-label">Pendientes</span>
                        <span class="stat-value">@employee.UpcomingTasks</span>
                    </div>
                    <div class="stat-box completed-stat">
                        <span class="stat-label">Completadas hoy</span>
                        <span class="stat-value">@employee.CompletedToday</span>
                    </div>
                </div>

                <button class="ver-button" @onclick="() => ShowAgenda(employee)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span>Ver Agenda</span>
                </button>
            </div>
        }
    </div>

    @if (selectedEmployee != null)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <div class="modal-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <h3>Agenda de @selectedEmployee.Name</h3>
                    </div>
                    <button class="close-button" @onclick="CloseModal">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="employee-summary">
                        <p class="summary-label">Información del empleado</p>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-key">Nombre</span>
                                <span class="summary-value">@selectedEmployee.Name</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-key">Rol</span>
                                <span class="summary-value">@selectedEmployee.Area</span>
                            </div>
                        </div>
                    </div>

                    <div class="tasks-section">
                        <p class="tasks-label">Tareas pendientes:</p>
                        @for (int i = 1; i <= 3; i++)
                        {
                            <div class="task-item">
                                <p class="task-title">Tarea @i</p>
                                <p class="task-description">Descripción de la tarea asignada</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    List<AreaDTO> areaList = new();
    List<EmpleadoDTO> empleadoList = new();
    private List<EmployeeInfo> employees = new();

    string? selectedArea;

    private EmployeeInfo selectedEmployee = null;
    private string searchName = "";

    protected override async Task OnInitializedAsync()
    {
        areaList = await AreasService.GetAreas();
        await CargarEmpleados();
    }

    private async Task CargarEmpleados()
    {
        var empleadosDto = await Http
            .GetFromJsonAsync<List<EmpleadoDTO>>(
                "https://redgm.site:9096/empleado"
                //"http://localhost:5231/empleado"
            )
            ?? new();

        employees = empleadosDto
        .OrderBy(e => e.ClavePersonal)
        .Select(e => new EmployeeInfo
        {
            Id = e.Id,
            ClavePersonal = e.ClavePersonal,
            Name = e.Nombre,
            NetName = e.NombreRed,
            Area = e.Area,
            Puesto = e.Puesto,
            UpcomingTasks = 0,
            CompletedToday = 0
        }).ToList();
    }

    private int ObtenerClaveArea(string area)
    {
        return area switch
        {
            "TECNOLOGIAS DE INFORMACION" => 7,
            _ => 0
        };
    }

    private class EmployeeInfo
    {
        public int Id { get; set; }
        public int ClavePersonal { get; set; }

        public string Name { get; set; } = string.Empty;
        public string NetName { get; set; } = string.Empty;

        public string Area { get; set; } = string.Empty;
        public string Puesto { get; set; } = string.Empty;

        public int UpcomingTasks { get; set; }
        public int CompletedToday { get; set; }
    }

    private string[] colors = new string[] 
    { 
        "#dd0203", "#f78701", "#f7e801", 
        "#2da549", "#4543ec", "#85119a" 
    };

    private string GetAvatarColor(int index)
    {
        return colors[index % colors.Length];
    }

    private string GetInitials(string name) 
    { 
        var parts = name.Split(' '); 
        return string.Join("", parts.Select(p => p.Substring(0, 1).ToUpper())); 
    }

    private void ShowAgenda(EmployeeInfo employee)
    {
        selectedEmployee = employee;
    }

    private void CloseModal()
    {
        selectedEmployee = null;
    }

    private List<string> areas = new List<string> { "Developer", "Designer", "Manager", "Sales", "Support", "Marketing" };

    private List<EmployeeInfo> filteredEmployees
    {
        get
        {
            return employees
                .Where(e =>
                    string.IsNullOrWhiteSpace(searchName) ||
                    e.Name.Contains(searchName, StringComparison.OrdinalIgnoreCase))
                .Where(e =>
                    string.IsNullOrEmpty(selectedArea) ||
                    e.Area.Equals(selectedArea, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }



}