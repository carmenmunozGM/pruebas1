@using System.Diagnostics
@using pruebas1.Entidades
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@using static System.Net.WebRequestMethods
@using System.Globalization
@inject AreasService AreasService
@inject HttpClient Http
@inject VerAgendasService VerAgendasService
@inject CalendarioService CalendarioService

<div class="ver-agendas-section">
    <div class="section-header">
        <h2>Ver Agendas</h2>
        <p>Consulta las agendas de otros empleados</p>
    </div>

    <!-- Search Bar -->
    <div class="search-section">
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" 
                   @bind="searchName" 
                   @bind:event="oninput"
                   placeholder="Buscar por nombre..." />
        </div>
        <select class="area-filter" @bind="selectedArea">
            <option value="">Todas las áreas</option>
            @foreach (var area in areaList)
            {
                <option value="@area.Area">@area.Area</option>
            }
        </select>
    </div>

    <div class="agendas-grid">
        @foreach (var (employee, index) in filteredEmployees.Select((emp, idx) => (emp, idx)))
        {
            <div class="agenda-card">
                <div class="employee-info">
                    <div class="employee-avatar" style="background: @GetAvatarColor(index)">
                        @GetInitials(employee.NetName)
                    </div>
                    <div class="employee-details">
                        <h4>@employee.NetName - @employee.ClavePersonal</h4>
                        <p>@employee.Area - @employee.Puesto</p>

                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-box pending-stat">
                        <span class="stat-label">Pendientes</span>
                        <span class="stat-value">@employee.UpcomingTasks</span>
                    </div>
                    <div class="stat-box completed-stat">
                        <span class="stat-label">Completadas hoy</span>
                        <span class="stat-value">@employee.CompletedToday</span>
                    </div>
                </div>

                <button class="ver-button" @onclick:stopPropagation="true"  @onclick="async () => await ShowAgenda(employee)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span>Ver Agenda</span>
                </button>
            </div>
        }
    </div>

    @if (selectedEmployee != null)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation="true">

                <!-- HEADER -->
                <div class="modal-header">
                    <div class="modal-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-icon lucide-calendar">
                            <path d="M8 2v4" />  <path d="M16 2v4" /> <rect width="18" height="18" x="3" y="4" rx="2" /> <path d="M3 10h18" />
                        </svg>
                        <h3>Agenda de @selectedEmployee.Name</h3>
                    </div>

                    <button class="close-button" @onclick="CloseModal" title="Cerrar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="close-icon">
                            <path d="M18 6 6 18" /> <path d="M6 6 18 18" />
                        </svg>
                    </button>
                </div>

                <!-- DATE BAR -->
                <div class="agenda-toolbar">
                    <div class="date-controls">
                        <button class="icon-btn"
                                title="Día anterior"
                                @onclick="PreviousDay">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                                <circle cx="12" cy="12" r="10" /><path d="m12 8-4 4 4 4" /><path d="M16 12H8" />
                            </svg>
                        </button>

                        <span class="current-date">
                            @SelectedDate.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-MX"))
                        </span>

                        <button class="icon-btn"
                                title="Día siguiente"
                                @onclick="NextDay">
                            <svg xmlns="http://www.w3.org/2000/svg"viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                                <circle cx="12" cy="12" r="10" /> <path d="m12 16 4-4-4-4" /> <path d="M8 12h8" />
                            </svg>
                        </button>
                    </div>

                    <button class="refresh-btn" @onclick="RefreshAgenda">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /> <path d="M3 3v5h5" /> <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /> <path d="M16 16h5v5" />
                        </svg>
                        Actualizar
                    </button>
                </div>

                <!-- BODY -->
                <div class="modal-body">

                    <!-- EMPLOYEE INFO -->
                    <div class="employee-summary">
                        <div class="summary-label">Empleado</div>

                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-key">Nombre</span>
                                <span class="summary-value">@selectedEmployee.Name</span>
                            </div>

                            <div class="summary-item">
                                <span class="summary-key">Puesto</span>
                                <span class="summary-value">@selectedEmployee.Puesto</span>
                            </div>
                        </div>
                    </div>
                    @if (EsDiaNoLaboral)
                    {
                        <div class="block dayoff-block">
                            <div class="dayoff-content">

                                <div class="dayoff-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         width="36" height="36"
                                         viewBox="0 0 24 24"
                                         fill="none"
                                         stroke="currentColor"
                                         stroke-width="2"
                                         stroke-linecap="round"
                                         stroke-linejoin="round"
                                         class="lucide lucide-octagon-minus">
                                        <path d="M2.586 16.726A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2h6.624a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586z" />
                                        <path d="M8 12h8" />
                                    </svg>
                                </div>

                                <h3 class="dayoff-title">
                                    Día inhábil
                                </h3>

                                <div class="dayoff-date">
                                    @SelectedDate.ToString(
                                    "dddd, d 'de' MMMM 'del' yyyy",
                                                        new System.Globalization.CultureInfo("es-MX")
                                                        )
                        </div>
                        <div class="dayoff-description">
                            @(MensajeDiaNoLaboral ?? "Domingo")
                        </div>

                    </div>
                </div>
                    }
                    else
                    {
                    <!-- TAREAS -->
                    <div class="block tasks-block">
                        <div class="block-header" @onclick="ToggleTasks">
                            <span class="block-title">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round"
                                     class="lucide lucide-square-check-big">
                                    <path d="M21 10.656V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.344" />
                                    <path d="m9 11 3 3L22 4" />
                                </svg>

                                <span>Tareas</span>
                            </span>
                            <span class=" block-actions">
                                <span class="tasks-count">@TotalPendientesDelDia pendiente(s)</span>
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round"
                                     class="chevron @(TasksCollapsed ? "" : "open")">
                                    <path d="m9 18 6-6-6-6" />
                                </svg>
                            </span>
                        </div>

                        @if (!TasksCollapsed)
                        {
                            <div class="tasks-section block-scroll">
                                @foreach (var task in TareasAgenda
                                                        .Where(t => GetFechaVisualizacion(t) == SelectedDate.Date))
                                {
                                    <div class="task-item @(task.completada ? "completed" : "")">
                                        <div>
                                            <div class="task-title">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="24" height="24" viewBox="0 0 24 24"
                                                     fill="none" stroke="currentColor"
                                                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                     class="lucide lucide-scroll-text-icon lucide-scroll-text">
                                                    <path d="M15 12h-5" />
                                                    <path d="M15 8h-5" />
                                                    <path d="M19 17V5a2 2 0 0 0-2-2H4" />
                                                    <path d="M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2a1 1 0 0 0 1 1h3" />
                                                </svg>

                                                <span>@task.titulo</span>
                                            </div>

                                            <small>@task.prioridadTitulo</small>
                                        </div>

                                        <button class="icon-btn" title="Ver tarea">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 width="18" height="18" viewBox="0 0 24 24"
                                                 fill="none" stroke="currentColor"
                                                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                 class="lucide lucide-eye">
                                                <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0" />
                                                <circle cx="12" cy="12" r="3" />
                                            </svg>
                                        </button>
                                    </div>
                                }

                                @if (EventosAgenda.Any())
                                {
                                    @foreach (var evento in EventosAgenda
                                                            .Where(e => GetFechaVisualizacion(e) == SelectedDate.Date))
                                    {
                                        <div class="task-item event @(evento.completada ? "completed" : "")">
                                            <div>
                                                <div class="task-title">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="24" height="24" viewBox="0 0 24 24"
                                                         fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                         class="lucide lucide-calendar-icon lucide-calendar">
                                                        <path d="M8 2v4" />
                                                        <path d="M16 2v4" />
                                                        <rect width="18" height="18" x="3" y="4" rx="2" />
                                                        <path d="M3 10h18" />
                                                    </svg>

                                                    <span>@evento.titulo</span>
                                                </div>

                                                <small>@evento.fechaInicio.ToString("dd/MM HH:mm")</small>
                                            </div>

                                            <button class="icon-btn" title="Ver evento">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="18" height="18" viewBox="0 0 24 24"
                                                     fill="none" stroke="currentColor"
                                                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                     class="lucide lucide-eye">
                                                    <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0" />
                                                    <circle cx="12" cy="12" r="3" />
                                                </svg>
                                            </button>
                                        </div>
                                    }

                                }
                            </div>
                        }
                    </div>

                    <!-- ORDENES DE TRABAJO -->
                    <div class="block orders-block">
                        <div class="block-header" @onclick="ToggleOrders">
                            <span class="block-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-notepad-text">
                                    <path d="M8 2v4" /> <path d="M12 2v4" /> <path d="M16 2v4" /> <rect width="16" height="18" x="4" y="4" rx="2" /> <path d="M8 10h6" /> <path d="M8 14h8" />
                                    <path d="M8 18h5" />
                                </svg>
                                <span>Órdenes de trabajo</span>
                            </span>

                            <span class="block-actions">
                                <span class="orders-count">@TotalOrdenes orden(es)</span>
                                <svg class="chevron @(OrdersCollapsed ? "" : "open")"
                                     xmlns="http://www.w3.org/2000/svg"
                                     width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6" />
                                </svg>
                            </span>
                        </div>

                        @if (!OrdersCollapsed)
                        {
                            <div class="orders-section block-scroll">
                                <div class="orders-grid">

                                    <!-- VENCIDAS -->
                                    <div>
                                        @foreach (var o in OrdenesVencidas)
                                        {
                                            <div class="order-item red">
                                                <div class="order-main">
                                                    <strong>@o.Numero</strong>
                                                    <small class="order-date">
                                                        @FormatoFechaOrden(o.Fecha)
                                                    </small>
                                                </div>
                                                <span>@(o.Tipo == "OT" ? "vencida" : "vencida")</span>

                                                <button class="icon-btn" title="Ver orden">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="18" height="18" viewBox="0 0 24 24"
                                                         fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                         class="lucide lucide-eye">
                                                        <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0" />
                                                        <circle cx="12" cy="12" r="3" />
                                                    </svg>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- PROXIMAS -->
                                    <div>
                                        @foreach (var o in OrdenesProximas)
                                        {
                                            <div class="order-item yellow">
                                                <div class="order-main">
                                                    <strong>@o.Numero</strong>
                                                    <small class="order-date">
                                                        @FormatoFechaOrden(o.Fecha)
                                                    </small>
                                                </div>
                                                <span>@(o.Tipo == "OT" ? "próxima" : "próxima")</span>

                                                <button class="icon-btn" title="Ver orden">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="18" height="18" viewBox="0 0 24 24"
                                                         fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                         class="lucide lucide-eye">
                                                        <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0" />
                                                        <circle cx="12" cy="12" r="3" />
                                                    </svg>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- HOY -->
                                    <div>
                                        @foreach (var o in OrdenesHoy)
                                        {
                                            <div class="order-item green">
                                                <div class="order-main">
                                                    <strong>@o.Numero</strong>
                                                    <small class="order-date">
                                                        @FormatoFechaOrden(o.Fecha)
                                                    </small>
                                                </div>
                                                <span>@(o.Tipo == "OT" ? "hoy" : "hoy")</span>

                                                <button class="icon-btn" title="Ver orden">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="18" height="18" viewBox="0 0 24 24"
                                                         fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                         class="lucide lucide-eye">
                                                        <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0" />
                                                        <circle cx="12" cy="12" r="3" />
                                                    </svg>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                </div>
                            </div>
                        }

                    </div>


                    <!--  AUTOEVALUACIÓN -->
                    <div class="block selfeval-block">
                        <div class="block-header" @onclick="() => SelfEvalCollapsed = !SelfEvalCollapsed">

                            <span class="block-title">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round"
                                     class="lucide lucide-star">
                                    <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z" />
                                </svg>
                                <span>Autoevaluación</span>
                            </span>

                            <span class="block-actions">
                                <span class="items-count">@AUPendiente tarea(s)</span>
                                <svg class="chevron @(SelfEvalCollapsed ? "" : "open")"
                                     xmlns="http://www.w3.org/2000/svg"
                                     width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6" />
                                </svg>
                            </span>
                        </div>

                        @if (!SelfEvalCollapsed)
                        {
                            <div class="selfeval-content block-scroll">
                                @foreach (var item in AutoEvalDelDia)
                                {
                                    <div class="selfeval-item">
                                        <span class="selfeval-text">
                                            ⭐ @item.Nombre
                                        </span>

                                        @if (item.Realizado)
                                        {
                                            <span class="selfeval-done">
                                                Hecho
                                            </span>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- SERVICIO A CLIENTE -->
                    <div class="block service-block">
                        <div class="block-header" @onclick="() => ServiceCollapsed = !ServiceCollapsed">
                            <span class="block-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                     class="lucide lucide-building-2">
                                    <path d="M10 12h4" />
                                    <path d="M10 8h4" />
                                    <path d="M14 21v-3a2 2 0 0 0-4 0v3" />
                                    <path d="M6 10H4a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2" />
                                    <path d="M6 21V5a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v16" />
                                </svg>
                                <span>Servicio a Cliente</span>
                            </span>
                            <span class="block-actions">
                                <span class="items-count">@SCPendiente pendiente(s)</span>
                                <svg class="chevron @(ServiceCollapsed ? "" : "open")"
                                     xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6" />
                                </svg>
                            </span>
                        </div>
                        @if (!ServiceCollapsed)
                        {
                            <div class="block-content block-scroll">
                                @foreach (var item in ServiciosDelDia)
                                {
                                    <div class="service-item @(item.Completada ? "completed" : "")">
                                        <span class="service-text">
                                            @item.Texto
                                        </span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    }
                </div>
            </div>
        </div>
    }


</div>

@code {
    AgendaCompletaDTO? agendaSeleccionada;
    bool cargandoAgenda = false;
    string? errorAgenda;

    List<AreaDTO> areaList = new();
    List<EmpleadoDTO> empleadoList = new();
    private List<EmployeeInfo> employees = new();

    string? selectedArea;

    private EmployeeInfo selectedEmployee = null;
    private string searchName = "";

    protected override async Task OnInitializedAsync()
    {
        areaList = await AreasService.GetAreas();
        await CargarEmpleados();
    }

    async Task RefreshAgenda()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task CargarEmpleados()
    {
        var empleadosDto = await Http
            .GetFromJsonAsync<List<EmpleadoDTO>>(
                "https://redgm.site:9096/empleado"
                //"http://localhost:5231/empleado"
            )
            ?? new();
        employees = empleadosDto
        .OrderBy(e => e.ClavePersonal)
        .Select(e => new EmployeeInfo
        {
            Id = e.Id,
            ClavePersonal = e.ClavePersonal,
            Name = e.Nombre,
            NetName = e.NombreRed,
            Area = e.Area,
            Puesto = e.Puesto,
            UpcomingTasks = 0,
            CompletedToday = 0
        }).ToList();
    }

    private class EmployeeInfo
    {
        public int Id { get; set; }
        public int ClavePersonal { get; set; }

        public string Name { get; set; } = string.Empty;
        public string NetName { get; set; } = string.Empty;

        public string Area { get; set; } = string.Empty;
        public string Puesto { get; set; } = string.Empty;

        public int UpcomingTasks { get; set; }
        public int CompletedToday { get; set; }
    }

    private string[] colors = new string[] 
    { 
        "#dd0203", "#f78701", "#f7e801", 
        "#2da549", "#4543ec", "#85119a" 
    };

    private string GetAvatarColor(int index)
    {
        return colors[index % colors.Length];
    }

    private string GetInitials(string name) 
    { 
        var parts = name.Split(' '); 
        return string.Join("", parts.Select(p => p.Substring(0, 1).ToUpper())); 
    }

    private async Task ShowAgenda(EmployeeInfo employee)
    {
        selectedEmployee = employee;
        cargandoAgenda = true;
        errorAgenda = null;

        await EvaluarDiaSeleccionado();

        if (EsDiaNoLaboral)
        {
            agendaSeleccionada = null;
            cargandoAgenda = false;
            await InvokeAsync(StateHasChanged);
            return;
        }

        try
        {
            agendaSeleccionada =
                await VerAgendasService.GetAgendaCompleta(employee.Id);
        }
        catch (Exception ex)
        {
            errorAgenda = ex.Message;
            Debug.WriteLine(ex.ToString());
            agendaSeleccionada = null;
        }
        finally
        {
            cargandoAgenda = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CloseModal()
    {
        Debug.WriteLine("CERRANDO MODAL");
        selectedEmployee = null;
    }

    private List<EmployeeInfo> filteredEmployees
    {
        get
        {
            return employees
                .Where(e =>
                    string.IsNullOrWhiteSpace(searchName) ||
                    e.Name.Contains(searchName, StringComparison.OrdinalIgnoreCase))
                .Where(e =>
                    string.IsNullOrEmpty(selectedArea) ||
                    e.Area.Equals(selectedArea, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    <!-- DATE BAR -->
    DateTime SelectedDate = DateTime.Today;

    void PreviousDay()
    {
        SelectedDate = SelectedDate.AddDays(-1);
        _ = ShowAgenda(selectedEmployee);
    }
    void NextDay()
    {
        SelectedDate = SelectedDate.AddDays(1);
        _ = ShowAgenda(selectedEmployee);
    }

    <!-- TAREAS -->
    bool TasksCollapsed = false;

    List<TareaApi> TareasAgenda =>
    agendaSeleccionada?.Tareas
        .Where(t => !t.esEvento)
        .OrderBy(t => t.fechaInicio)
        .ToList()
    ?? new();

    List<EventoApiDTO> EventosAgenda =>
    agendaSeleccionada?.Eventos
        .OrderBy(e => e.fechaInicio)
        .ToList()
    ?? new();

    List<TareaApi> TareasDelDia =>
    TareasAgenda
        .Where(t => GetFechaVisualizacion(t) == SelectedDate.Date)
        .ToList();

    List<EventoApiDTO> EventosDelDia =>
        EventosAgenda
            .Where(e => GetFechaVisualizacion(e) == SelectedDate.Date)
            .ToList();

    void ToggleTasks()
    {
        TasksCollapsed = !TasksCollapsed;
    }
    DateTime GetFechaVisualizacion(TareaApi t)
    {
        var hoy = DateTime.Today;

        if (t.completada && t.fechaCompletada.HasValue)
            return t.fechaCompletada.Value.Date;

        if (!t.completada && t.fechaFin.Date < hoy)
            return hoy;

        return t.fechaFin.Date;
    }
    DateTime GetFechaVisualizacion(EventoApiDTO e)
    {
        return e.fechaFin.Date;
    }
    class AgendaItemVM
    {
        public string Titulo { get; set; } = "";
        public DateTime Fecha { get; set; }
        public bool Completado { get; set; }
        public bool EsEvento { get; set; }
        public object Original { get; set; } = default!;
    }

    int TareasPendientesDelDia =>
    TareasAgenda.Count(t =>
        !t.completada &&
        GetFechaVisualizacion(t) == SelectedDate.Date);

    int EventosPendientesDelDia =>
    EventosAgenda.Count(e =>
        !e.completada &&
        GetFechaVisualizacion(e) == SelectedDate.Date);

    int TotalPendientesDelDia =>
    TareasPendientesDelDia + EventosPendientesDelDia;

    <!-- ORDENES DE TRABAJO -->
    bool OrdersCollapsed = false;

    class OrdenAgendaVM
    {
        public string Numero { get; set; } = "";
        public DateTime Fecha { get; set; }
        public string Tipo { get; set; } = "";
        public string Estado { get; set; } = "";
        public object Original { get; set; } = default!;
    }

    List<OrdenAgendaVM> OrdenesAgenda =>
    agendaSeleccionada == null
        ? new()
        : new List<OrdenAgendaVM>()
            // OT
            .Concat(
                agendaSeleccionada.OTHoy.Select(o => new OrdenAgendaVM
                {
                    Numero = o.strClave,
                    Fecha = o.fechaFinal.Date,
                    Tipo = "OT",
                    Estado = "hoy",
                    Original = o
                })
            )
            .Concat(
                agendaSeleccionada.OTProximas.Select(o => new OrdenAgendaVM
                {
                    Numero = o.strClave,
                    Fecha = o.fechaFinal.Date,
                    Tipo = "OT",
                    Estado = "proxima",
                    Original = o
                })
            )
            .Concat(
                agendaSeleccionada.OTVencidas.Select(o => new OrdenAgendaVM
                {
                    Numero = o.strClave,
                    Fecha = o.fechaFinal.Date,
                    Tipo = "OT",
                    Estado = "vencida",
                    Original = o
                })
            )
            // TRA
            .Concat(
                agendaSeleccionada.TRAHoy.Select(o => new OrdenAgendaVM
                {
                    Numero = o.numeroOrden,
                    Fecha = DateTime.Parse(o.fechaConclusionTramite),
                    Tipo = "TRA",
                    Estado = "hoy",
                    Original = o
                })
            )
            .Concat(
                agendaSeleccionada.TRAProximas.Select(o => new OrdenAgendaVM
                {
                    Numero = o.numeroOrden,
                    Fecha = DateTime.Parse(o.fechaConclusionTramite),
                    Tipo = "TRA",
                    Estado = "proxima",
                    Original = o
                })
            )
            .Concat(
                agendaSeleccionada.TRAVencidas.Select(o => new OrdenAgendaVM
                {
                    Numero = o.numeroOrden,
                    Fecha = DateTime.Parse(o.fechaConclusionTramite),
                    Tipo = "TRA",
                    Estado = "vencida",
                    Original = o
                })
            )
            .ToList();

    int TotalOrdenes => OrdenesAgenda.Count;

    IEnumerable<OrdenAgendaVM> OrdenesVencidas =>
        OrdenesAgenda.Where(o => o.Estado == "vencida");

    IEnumerable<OrdenAgendaVM> OrdenesProximas =>
        OrdenesAgenda.Where(o => o.Estado == "proxima");

    IEnumerable<OrdenAgendaVM> OrdenesHoy =>
        OrdenesAgenda.Where(o => o.Estado == "hoy");

    string FormatoFechaOrden(DateTime fecha)
    {
        return fecha.ToString("dd/MM/yyyy", new CultureInfo("es-MX"));
    }

    void ToggleOrders()
    {
        OrdersCollapsed = !OrdersCollapsed;
    }

    <!-- AUTOEVALUACION -->
    bool SelfEvalCollapsed = false;
    public class AutoEvalItemUI
    {
        public int IdTarea { get; set; }
        public string Nombre { get; set; } = "";
        public DateOnly Fecha { get; set; }
        public bool Realizado { get; set; }
    }

    List<AutoEvalItemUI> AutoEvalDelDia => ObtenerAutoevaluacionDelDia(
    agendaSeleccionada?.Autoevaluaciones,
    DateOnly.FromDateTime(SelectedDate)
);

    List<AutoEvalItemUI> ObtenerAutoevaluacionDelDia(
    List<AutoevaluacionDTO>? bloques,
    DateOnly diaSeleccionado)
    {
        if (bloques == null)
        return new();

        return bloques
            .SelectMany(b => b.Tareas)
            .SelectMany(t => t.Registros
                .Where(r => r.Fecha == diaSeleccionado)
                .Select(r => new AutoEvalItemUI
                {
                    IdTarea = t.IdTareaAU,
                    Nombre = t.Tarea,
                    Fecha = r.Fecha,
                    Realizado = r.Realizado
                })
            )
            .ToList();
    }

    int AUPendiente =>
    AutoEvalDelDia.Count(a =>
        !a.Realizado);

    <!-- SERVICIO A CLIENTE -->
    bool ServiceCollapsed = false;
    
    public class ServiceItemUI
    {
        public int Id { get; set; }
        public string Texto { get; set; } = "";
        public DateOnly Fecha { get; set; }
        public bool Completada { get; set; }
    }

    List<ServiceItemUI> ObtenerServiciosDelDia(
    List<ServicioClienteAgendaDTO>? servicios,
    DateOnly diaSeleccionado)
    {
        if (servicios == null)
            return new();

        return servicios
            .Where(s =>
                s.FechaConclusion != default &&
                DateOnly.FromDateTime(s.FechaConclusion) == diaSeleccionado
            )
            .Select(s => new ServiceItemUI
            {
                Id = s.IdHorasProgramaTrabajo,
                Texto = $"{s.NombreEmpresa} - {s.NombreServicio} - {s.NombreActividad}",
                Fecha = DateOnly.FromDateTime(s.FechaConclusion),
                Completada = s.Completada == true
            })
            .ToList();
    }

    List<ServiceItemUI> ServiciosDelDia => ObtenerServiciosDelDia(
    agendaSeleccionada?.Servicios,
    DateOnly.FromDateTime(SelectedDate)
    );

    int SCPendiente =>
    ServiciosDelDia.Count(s =>
        !s.Completada);

    <!-- DIAS INHABILES -->
    List<DiaNoLaboralDto> DiasNoLaborales = new();

    bool EsDiaNoLaboral = false;
    string? MensajeDiaNoLaboral;

    async Task EvaluarDiaSeleccionado()
    {
        EsDiaNoLaboral = false;
        MensajeDiaNoLaboral = null;

        // 1. Domingo
        if (SelectedDate.DayOfWeek == DayOfWeek.Sunday)
        {
            EsDiaNoLaboral = true;
            MensajeDiaNoLaboral = "Domingo — día no laborable";
            return;
        }

        // 2. Festivo / día inhábil desde backend
        var year = SelectedDate.Year;
        var month = SelectedDate.Month;

        // cache simple mensual
        if (!DiasNoLaborales.Any()
            || DiasNoLaborales.Any(d => d.DiaInhabil.Year != year || d.DiaInhabil.Month != month))
        {
            DiasNoLaborales = await CalendarioService.ObtenerDiasNoLaborales(year, month);
        }

        var diaInhabil = DiasNoLaborales
            .FirstOrDefault(d => d.DiaInhabil.Date == SelectedDate.Date);

        if (diaInhabil != null)
        {
            EsDiaNoLaboral = true;
            MensajeDiaNoLaboral = diaInhabil.Descripcion ?? "Día no laborable";
        }
    }


}