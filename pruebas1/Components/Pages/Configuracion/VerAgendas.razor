@using System.Diagnostics
@using System.Text.Json
@using pruebas1.Entidades
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@using static System.Net.WebRequestMethods
@using System.Globalization
@inject AreasService AreasService
@inject HttpClient Http
@inject VerAgendasService VerAgendasService
@inject CalendarioService CalendarioService
@inject SalasEmService SalasEmService
@inject OrdenTrabajoService OrdenTrabajoService
@inject OrdenTramiteService OrdenTramiteService
@inject EmpleadosService EmpleadosService
@inject PerfilesService PerfilesService

<div class="ver-agendas-section">
    <div class="section-header">
        <h2>Ver Agendas</h2>
        <p>Consulta las agendas de otros empleados</p>
    </div>

    <!-- Search Bar -->
    <div class="search-section">
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" 
                   @bind="searchName" 
                   @bind:event="oninput"
                   placeholder="Buscar por nombre..." />
        </div>
        @if (puedeVerFiltroArea)
        {
            <select class="area-filter" @bind="selectedArea">
                <option value="">Todas las √°reas</option>
                @foreach (var area in areaList)
                {
                    <option value="@area.Area">@area.Area</option>
                }
            </select>
        }
    </div>

    <div class="agendas-grid">
        @foreach (var (employee, index) in filteredEmployees.Select((emp, idx) => (emp, idx)))
        {
            <div class="agenda-card">
                <div class="employee-info">
                    <div class="employee-avatar" style="background: @GetAvatarColor(index)">
                        @GetInitials(employee.NetName)
                    </div>

                    <div class="employee-details">
                        <h4>@employee.NetName - @employee.ClavePersonal</h4>
                        <p>@employee.Area - @employee.Puesto</p>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-box pending-stat">
                        <span class="stat-label">Actividades Pendientes</span>
                        <span class="stat-value @GetPendienteClass(employee.ActividadesPendientes)">
                            @employee.ActividadesPendientes
                        </span>
                    </div>

                    <div class="stat-box completed-stat">
                        <span class="stat-label">Autoevaluaci√≥n Pendiente</span>
                        <span class="stat-value @GetPendienteClass(employee.AutoevaluacionesPendientes)">
                            @employee.AutoevaluacionesPendientes
                        </span>
                    </div>
                </div>

                <button class="ver-button"
                        @onclick:stopPropagation="true"
                        @onclick="async () => await ShowAgenda(employee)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span>Ver Agenda</span>
                </button>
            </div>
        }

    </div>

    @if (selectedEmployee != null)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation="true">

                <!-- HEADER -->
                <div class="modal-header">
                    <div class="modal-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-icon lucide-calendar">
                            <path d="M8 2v4" />  <path d="M16 2v4" /> <rect width="18" height="18" x="3" y="4" rx="2" /> <path d="M3 10h18" />
                        </svg>
                        <h3>Agenda de @selectedEmployee.Name</h3>
                    </div>

                    <button class="close-button" @onclick="CloseModal" title="Cerrar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="close-icon">
                            <path d="M18 6 6 18" /> <path d="M6 6 18 18" />
                        </svg>
                    </button>
                </div>

                <!-- DATE BAR -->
                <div class="agenda-toolbar">
                    <div class="date-controls">
                        <button class="icon-btn"
                                title="D√≠a anterior"
                                @onclick="PreviousDay">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                                <circle cx="12" cy="12" r="10" /><path d="m12 8-4 4 4 4" /><path d="M16 12H8" />
                            </svg>
                        </button>

                        <span class="current-date">
                            @SelectedDate.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-MX"))
                        </span>

                        <button class="icon-btn"
                                title="D√≠a siguiente"
                                @onclick="NextDay">
                            <svg xmlns="http://www.w3.org/2000/svg"viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                                <circle cx="12" cy="12" r="10" /> <path d="m12 16 4-4-4-4" /> <path d="M8 12h8" />
                            </svg>
                        </button>
                    </div>

                    <button class="refresh-btn" @onclick="RefreshAgenda">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /> <path d="M3 3v5h5" /> <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /> <path d="M16 16h5v5" />
                        </svg>
                        Actualizar
                    </button>
                </div>

                <!-- BODY -->
                <div class="modal-body">

                    <!-- EMPLOYEE INFO -->
                    <div class="employee-summary">
                        <div class="summary-label">Empleado</div>

                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-key">Nombre</span>
                                <span class="summary-value">@selectedEmployee.Name</span>
                            </div>

                            <div class="summary-item">
                                <span class="summary-key">Puesto</span>
                                <span class="summary-value">@selectedEmployee.Puesto</span>
                            </div>
                        </div>
                    </div>
                    @if (EsDiaNoLaboral)
                    {
                        <div class="block dayoff-block">
                            <div class="dayoff-content">

                                <div class="dayoff-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         width="36" height="36"
                                         viewBox="0 0 24 24"
                                         fill="none"
                                         stroke="currentColor"
                                         stroke-width="2"
                                         stroke-linecap="round"
                                         stroke-linejoin="round"
                                         class="lucide lucide-octagon-minus">
                                        <path d="M2.586 16.726A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2h6.624a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586z" />
                                        <path d="M8 12h8" />
                                    </svg>
                                </div>

                                <h3 class="dayoff-title">
                                    D√≠a inh√°bil
                                </h3>

                                <div class="dayoff-date">
                                    @SelectedDate.ToString(
                                    "dddd, d 'de' MMMM 'del' yyyy",
                                                        new System.Globalization.CultureInfo("es-MX")
                                                        )
                        </div>
                        <div class="dayoff-description">
                            @(MensajeDiaNoLaboral ?? "Domingo")
                        </div>

                    </div>
                </div>
                    }
                    else
                    {
                    <!-- TAREAS -->
                    <div class="block tasks-block">
                        <div class="block-header" @onclick="ToggleTasks">
                            <span class="block-title">
                                <span>üìã Tareas</span>
                            </span>
                            <span class=" block-actions">
                                <span class="tasks-count">@TotalPendientesDelDia pendiente(s)</span>
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round"
                                     class="chevron @(TasksCollapsed ? "" : "open")">
                                    <path d="m9 18 6-6-6-6" />
                                </svg>
                            </span>
                        </div>

                        @if (!TasksCollapsed)
                        {
                            <div class="tasks-section block-scroll">
                                @foreach (var task in TareasAgenda
                                                        .Where(t => GetFechaVisualizacion(t) == SelectedDate.Date))
                                {
                                    <div class="task-item @(task.completada ? "completed" : "")">
                                        <div>
                                            <div class="task-title">
                                                <span>üóíÔ∏è @task.titulo</span>
                                            </div>

                                            <small>@task.prioridadTitulo</small>
                                        </div>
                                            <button class="icon-btn" title="Ver actividad" @onclick="() => VerTarea(task)">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                     viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0" />
                                                    <circle cx="12" cy="12" r="3" />
                                                </svg>
                                            </button>
                                    </div>
                                }

                                @if (EventosAgenda.Any())
                                {
                                    @foreach (var evento in EventosAgenda
                                                            .Where(e => GetFechaVisualizacion(e) == SelectedDate.Date))
                                    {
                                        <div class="task-item event @(evento.completada ? "completed" : "")">
                                            <div>
                                                <div class="task-title">
                                                    <span>üìÖ @evento.titulo</span>
                                                </div>

                                                <small>@evento.fechaInicio.ToString("dd/MM HH:mm")</small>
                                            </div>
                                                <button class="icon-btn" title="Ver actividad" @onclick="() => VerEvento(evento)">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                         viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0" />
                                                        <circle cx="12" cy="12" r="3" />
                                                    </svg>
                                                </button>
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>

                    <!-- ORDENES DE TRABAJO -->
                    <div class="block orders-block">
                        <div class="block-header" @onclick="ToggleOrders">
                            <span class="block-title">
                                <span>üßæ √ìrdenes de trabajo</span>
                            </span>

                            <span class="block-actions">
                                <span class="orders-count">@TotalOrdenes orden(es)</span>
                                <svg class="chevron @(OrdersCollapsed ? "" : "open")"
                                     xmlns="http://www.w3.org/2000/svg"
                                     width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6" />
                                </svg>
                            </span>
                        </div>

                        @if (!OrdersCollapsed)
                        {
                            <div class="orders-section block-scroll">
                                <div class="orders-grid">

                                    <!-- VENCIDAS -->
                                    <div>
                                        @foreach (var o in OrdenesVencidas)
                                        {
                                            <div class="order-item red">
                                                <div class="order-main">
                                                    <strong>@o.Numero</strong>
                                                    <small class="order-date">
                                                        @FormatoFechaOrden(o.Fecha)
                                                    </small>
                                                </div>
                                                <span>@(o.Tipo == "OT" ? "vencida" : "vencida")</span>

                                                    <button class="icon-btn" @onclick="() => VerOrden(o)">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="18" height="18" viewBox="0 0 24 24"
                                                         fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                         class="lucide lucide-eye">
                                                        <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0" />
                                                        <circle cx="12" cy="12" r="3" />
                                                    </svg>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- PROXIMAS -->
                                    <div>
                                        @foreach (var o in OrdenesProximas)
                                        {
                                            <div class="order-item yellow">
                                                <div class="order-main">
                                                    <strong>@o.Numero</strong>
                                                    <small class="order-date">
                                                        @FormatoFechaOrden(o.Fecha)
                                                    </small>
                                                </div>
                                                <span>@(o.Tipo == "OT" ? "pr√≥xima" : "pr√≥xima")</span>

                                                    <button class="icon-btn" @onclick="() => VerOrden(o)">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="18" height="18" viewBox="0 0 24 24"
                                                         fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                         class="lucide lucide-eye">
                                                        <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0" />
                                                        <circle cx="12" cy="12" r="3" />
                                                    </svg>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- HOY -->
                                    <div>
                                        @foreach (var o in OrdenesHoy)
                                        {
                                            <div class="order-item green">
                                                <div class="order-main">
                                                    <strong>@o.Numero</strong>
                                                    <small class="order-date">
                                                        @FormatoFechaOrden(o.Fecha)
                                                    </small>
                                                </div>
                                                <span>@(o.Tipo == "OT" ? "hoy" : "hoy")</span>

                                                    <button class="icon-btn" @onclick="() => VerOrden(o)">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="18" height="18" viewBox="0 0 24 24"
                                                         fill="none" stroke="currentColor"
                                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                         class="lucide lucide-eye">
                                                        <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0" />
                                                        <circle cx="12" cy="12" r="3" />
                                                    </svg>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                </div>
                            </div>
                        }

                    </div>


                    <!--  AUTOEVALUACI√ìN -->
                    <div class="block selfeval-block">
                        <div class="block-header" @onclick="() => SelfEvalCollapsed = !SelfEvalCollapsed">

                            <span class="block-title">
                                <span>‚≠ê Autoevaluaci√≥n</span>
                            </span>

                            <span class="block-actions">
                                <span class="items-count">@AUPendiente tarea(s)</span>
                                <svg class="chevron @(SelfEvalCollapsed ? "" : "open")"
                                     xmlns="http://www.w3.org/2000/svg"
                                     width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6" />
                                </svg>
                            </span>
                        </div>

                        @if (!SelfEvalCollapsed)
                        {
                            <div class="selfeval-content block-scroll">
                                @foreach (var item in AutoEvalDelDia)
                                {
                                    <div class="selfeval-item">
                                        <span class="selfeval-text">
                                            ‚≠ê @item.Nombre
                                        </span>

                                        @if (item.Realizado)
                                        {
                                            <span class="selfeval-done">
                                                Hecho
                                            </span>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- SERVICIO A CLIENTE -->
                    <div class="block service-block">
                        <div class="block-header" @onclick="() => ServiceCollapsed = !ServiceCollapsed">
                            <span class="block-title">
                                <span>üè¢ Servicio a Cliente</span>
                            </span>
                            <span class="block-actions">
                                <span class="items-count">@SCPendiente pendiente(s)</span>
                                <svg class="chevron @(ServiceCollapsed ? "" : "open")"
                                     xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6" />
                                </svg>
                            </span>
                        </div>
                        @if (!ServiceCollapsed)
                        {
                            <div class="block-content block-scroll">
                                @foreach (var item in ServiciosDelDia)
                                {
                                    <div class="service-item @(item.Completada ? "completed" : "")">
                                        <span class="service-text">
                                            @item.Texto
                                        </span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- MODAL DE VER TAREAS O EVENTOS -->
    @if (MostrarModalDetalle && ActividadSeleccionada is not null)
    {
        <div class="vermodal-backdrop" @onclick="CerrarModal">
            <div class="vermodal-container modal-lg" @onclick:stopPropagation>

                <!-- HEADER -->
                <div class="vermodal-header">
                    <div>
                        <span class="vermodal-type">
                            @(ActividadSeleccionada.EsEvento ? "Evento" : "Tarea")
                        </span>
                        <h2 class="vermodal-title">
                            @ActividadSeleccionada.Titulo
                        </h2>
                    </div>
                    <button class="vermodal-close" @onclick="CerrarModal">‚úï</button>
                </div>

                <!-- BODY -->
                <div class="vermodal-body">

                    <!-- IZQUIERDA -->
                    <div class="vermodal-left">

                        <section class="vermodal-card">
                            <h4>Descripci√≥n</h4>
                            <p>@ActividadSeleccionada.Descripcion</p>
                        </section>
                        @if (ActividadSeleccionada.EsEvento)
                        {
                            <section class="vermodal-card">
                                <h4>Organizador</h4>
                                <p>@ActividadSeleccionada.Organizador</p>
                            </section>
                        }
                    <section class="vermodal-card">
                        <h4>
                            @(ActividadSeleccionada.EsEvento
                                                        ? "Participantes"
                                                        : "Subtareas")
                        </h4>
                        <ul class="modal-list">
                            @foreach (var item in
                                                        ActividadSeleccionada.EsEvento
                                                        ? ActividadSeleccionada.Participantes
                                                        : ActividadSeleccionada.SubTareas)
                                {
                                    <li>@item</li>
                                }
                            </ul>
                        </section>
                    </div>
                    <!-- DERECHA -->
                    <div class="vermodal-right">

                        <section class="vermodal-card">
                            <h4>Prioridad</h4>
                            <span class="verpriority ">
                                @ActividadSeleccionada.Prioridad
                            </span>
                        </section>
                        <section class="vermodal-card">
                            <h4>Horario</h4>

                            @if (ActividadSeleccionada.EsEvento)
                            {
                                <p>Inicio: @FormatearFechaHora(ActividadSeleccionada.FechaInicio)</p>
                                <p>T√©rmino: @FormatearFechaHora(ActividadSeleccionada.FechaFin)</p>
                            }
                            else
                            {
                                <p>Inicio: @FormatearFecha(ActividadSeleccionada.FechaInicio)</p>
                                <p>T√©rmino: @FormatearFecha(ActividadSeleccionada.FechaFin)</p>
                            }
                        </section>
                        @if (ActividadSeleccionada.EsEvento)
                        {
                            <section class="vermodal-card">
                                <h4>Ubicaci√≥n</h4>
                                <p>@ActividadSeleccionada.Ubicacion</p>
                            </section>
                        }
                    </div>

                </div>

            </div>
        </div>
    }

    <!-- MODAL DETALLES DE ORDEN-->
    @if (MostrarOrden && OrdenSeleccionada != null)
    {
        <div class="verot-backdrop" @onclick="CerrarOrden">

            <div class="verot-container modal-lg"
                 @onclick:stopPropagation>

                <!-- HEADER -->
                <div class="verot-header">
                    <div>
                        <span class="verot-type">
                            @(OrdenSeleccionada.Tipo == "OT"
                                                    ? "Orden de Trabajo"
                                                    : "Orden de Tr√°mite")
                    </span>

                        <h2 class="verot-title">
                            @OrdenSeleccionada.Numero
                        </h2>
                    </div>

                    <button class="verot-close" @onclick="CerrarOrden">‚úï</button>
                </div>

                <!-- BODY -->
                <div class="verot-body">
                @if (OrdenSeleccionada.Tipo == "OT")
                    {
                        @if (CargandoDetalle || DetalleOT == null)
                        {
                            <p>Cargando detalle...</p>
                        }
                        else
                        {
                            <div class="orden-grid">
                                <div class="orden-col">
                                    <p><b>N√∫mero:</b> @DetalleOT.strClave</p>
                                    <p><b>Autor:</b> @DetalleOT.nombreCompleto</p>
                                    <p><b>Objetivo:</b> @DetalleOT.strValor</p>
                                    <p><b>Objetivo otros:</b> @DetalleOT.strObjetivoOtro</p>
                                    <p><b>Fecha conclusi√≥n:</b> @FormatoFechaOrden(DetalleOT.fechaFinal)</p>
                                </div>

                                <div class="orden-col">
                                    <p><b>Fecha solicitud:</b> @FormatoFechaOrden(DetalleOT.dteFechaSolicitud)</p>
                                    <p><b>Cliente:</b> @DetalleOT.nombreCliente</p>
                                    <p><b>Estado:</b> @DetalleOT.estado</p>
                                </div>
                            </div>

                            <div class="orden-table">
                                <h4>Tareas</h4>

                                <table class="tabla-detalle">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Descripci√≥n</th>
                                            <th>Avance</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var tarea in DetalleOT.tareas)
                                        {
                                            <tr>
                                                <td>@tarea.strNombreTarea</td>
                                                <td>@tarea.strDescripcionAutor</td>
                                                <td>@tarea.avance</td>
                                                <td>
                                                    <button class="icon-btn"
                                                            @onclick="() => VerDetalleTareaOT(tarea)">
                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                             width="18" height="18" viewBox="0 0 24 24"
                                                             fill="none" stroke="currentColor"
                                                             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                             class="lucide lucide-eye">
                                                            <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0" />
                                                            <circle cx="12" cy="12" r="3" />
                                                        </svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        }

                                    </tbody>
                                </table>
                            </div>
                        }
                    }
                    else
                    {
                        @if (CargandoDetalle || DetalleTramite == null)
                        {
                            <p>Cargando detalle...</p>
                        }
                        else
                        {
                            <div class="orden-grid">
                                <div class="orden-col">
                                    <p><b>Fecha solicitud:</b> @DetalleTramite.fechaSolicitud</p>
                                    <p><b>Cliente:</b> @DetalleTramite.cliente</p>
                                    <p><b>Fecha conclusi√≥n:</b> @DetalleTramite.fechaConclusionTramite</p>
                                </div>

                                <div class="orden-col">
                                    <p><b>Solicitante:</b> @DetalleTramite.solicitanteInterno</p>
                                    <p><b>Nombre global:</b> @DetalleTramite.nombreGlobal</p>
                                    <p><b>N√∫mero orden:</b> @DetalleTramite.numeroOrden</p>
                                </div>
                            </div>

                            <div class="orden-table">
                                <h4>Tr√°mites individuales</h4>

                                <table class="tabla-detalle">
                                    <thead>
                                        <tr>
                                            <th>Clave</th>
                                            <th>Tr√°mite</th>
                                            <th>Encargado</th>
                                            <th>Tareas</th>
                                            <th>Detalle</th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        @foreach (var tramite in DetalleTramite.tramitesIndividuales)
                                        {
                                            <tr>
                                                <td>@tramite.clave</td>
                                                <td>@tramite.tramiteIndividual</td>
                                                <td>@tramite.personalEncargado</td>

                                                <!-- VER TAREAS -->
                                                <td>
                                                    <button class="icon-btn"
                                                            @onclick="() => VerTareasTramite(tramite)">
                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                             width="18" height="18" viewBox="0 0 24 24"
                                                             fill="none" stroke="currentColor"
                                                             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                             class="lucide lucide-eye">
                                                            <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0" />
                                                            <circle cx="12" cy="12" r="3" />
                                                        </svg>
                                                    </button>
                                                </td>

                                                <!-- VER DETALLE -->
                                                <td>
                                                    <button class="icon-btn"
                                                            @onclick="() => VerDetalleTramite(tramite)">
                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                             width="18" height="18" viewBox="0 0 24 24"
                                                             fill="none" stroke="currentColor"
                                                             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                             class="lucide lucide-eye">
                                                            <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0" />
                                                            <circle cx="12" cy="12" r="3" />
                                                        </svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        }

                                    </tbody>
                                </table>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    }
    @if (MostrarSubModal)
    {
        <div class="verot-backdrop submodal" @onclick="CerrarSubModal">

            <div class="verot-container modal-sm"
                 @onclick:stopPropagation="true">

                <!-- HEADER -->
                <div class="verot-header">
                    <h3>
                        @switch (TipoSubModal)
                        {
                            case "OT-TAREA":
                                if (SubModalData is TareaDTO tareaOT)
                                {
                                    <span>Detalle de la tarea @tareaOT.strNombreTarea</span>
                                }
                                break;

                            case "TRA-TAREAS":
                                if (SubModalData is TramiteIndividualDTO tramiteTareas)
                                {
                                    <span>Tareas @tramiteTareas.clave</span>
                                }
                                break;

                            case "TRA-DETALLE":
                                if (SubModalData is TramiteIndividualDTO tramiteDetalle)
                                {
                                    <span>Detalle @tramiteDetalle.clave</span>
                                }
                                break;
                        }
                    </h3>
                    <button class="verot-close" @onclick="CerrarSubModal">‚úï</button>
                </div>

                <!-- BODY -->
                <div class="verot-body submodal-body">
                    @switch (TipoSubModal)
                    {
                        case "OT-TAREA":
                            if (SubModalData is TareaDTO tarea)
                            {
                                <div class="submodal-section">
                                    <b>Nombre</b>
                                    <p>@tarea.strNombreTarea</p>
                                </div>

                                <div class="submodal-section">
                                    <b>Descripci√≥n</b>
                                    <p>@tarea.strDescripcionAutor</p>
                                </div>

                                <div class="submodal-section">
                                    <b>Observaci√≥n</b>
                                    <p>@tarea.strObservacion</p>
                                </div>
                            }
                            break;

                        case "TRA-TAREAS":

                            if (SubModalData is TramiteIndividualDTO tramiteTareas)
                            {
                                <table class="tabla-detalle">
                                    <thead>
                                        <tr>
                                            <th>Clave</th>
                                            <th>Tarea</th>
                                            <th>Encargado</th>
                                            <th>Fecha fin</th>
                                            <th>Avance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var t in tramiteTareas.tareas)
                                        {
                                            <tr>
                                                <td>@t.claveTarea</td>
                                                <td>@t.tarea</td>
                                                <td>@t.encargadoTarea</td>
                                                <td>@FormatoFechaOrden(DateTime.Parse(t.fechaConclusion))</td>
                                                <td>@t.avance</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <div class="empty-state">Sin tareas registradas</div>
                            }
                            break;

                        case "TRA-DETALLE":
                            <div class="submodal-grid">

                                @if (SubModalData is TramiteIndividualDTO tramiteDetalle)
                                {
                                    <div class="submodal-section">
                                        <span class="label">Encargado</span>
                                        <span class="value">@tramiteDetalle.personalEncargado</span>
                                    </div>

                                    <div class="submodal-section">
                                        <span class="label">Dependencia</span>
                                        <span class="value">@tramiteDetalle.dependencia</span>
                                    </div>

                                    <div class="submodal-section">
                                        <span class="label">Estado</span>
                                        <span class="value estado proceso">@tramiteDetalle.estadoTramite</span>
                                    </div>

                                    <div class="submodal-section full">
                                        <span class="label">Observaci√≥n</span>
                                        <span class="value">@tramiteDetalle.observacion</span>
                                    </div>
                                }
                            </div>
                            break;
                    }
                </div>

            </div>
        </div>
    }
</div>

@code {
    AgendaCompletaDTO? agendaSeleccionada;
    bool cargandoAgenda = false;
    string? errorAgenda;

    List<AreaDTO> areaList = new();
    List<EmpleadoDTO> empleadoList = new();
    List<SalasEm> Salas = new();
    private List<EmployeeInfo> employees = new();
    private bool cargando = true;

    string? selectedArea;

    private EmployeeInfo selectedEmployee = null;
    private string searchName = "";

    PermisosDTO? permisos;
    bool puedeVerFiltroArea = false;


    protected override async Task OnInitializedAsync()
    {
        areaList = await AreasService.GetAreas();
        await CargarEmpleados();
        Salas = await SalasEmService.GetSalas();
        empleadoList = await VerAgendasService.GetEmpleadosPendientes();
        cargando = false;

        try
        {
            permisos = await PerfilesService.GetPermisos();

            if (permisos != null)
            {
                puedeVerFiltroArea =
                    permisos.ClavePuesto == 11001 ||
                    permisos.ClavePuesto == 7202;
            }
        }
        catch
        {
            puedeVerFiltroArea = false;
        }
    }

    async Task RefreshAgenda()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task CargarEmpleados()
    {
        var empleadosDto = await EmpleadosService.GetPendientes();
        employees = empleadosDto
        .OrderBy(e => e.ClavePersonal)
        .Select(e => new EmployeeInfo
        {
            Id = e.Id,
            ClavePersonal = e.ClavePersonal,
            Name = e.Nombre,
            NetName = e.NombreRed,
            Area = e.Area,
            Puesto = e.Puesto,
            ActividadesPendientes = e.ActividadesPendientes,
            AutoevaluacionesPendientes = e.AutoevaluacionesPendientes
        }).ToList();
    }

    private class EmployeeInfo
    {
        public int Id { get; set; }
        public int ClavePersonal { get; set; }

        public string Name { get; set; } = string.Empty;
        public string NetName { get; set; } = string.Empty;

        public string Area { get; set; } = string.Empty;
        public string Puesto { get; set; } = string.Empty;

        public int ActividadesPendientes { get; set; }
        public int AutoevaluacionesPendientes { get; set; }
    }

    private string[] colors = new string[] 
    { 
        "#dd0203", "#f78701", "#f7e801", 
        "#2da549", "#4543ec", "#85119a" 
    };

    private string GetAvatarColor(int index)
    {
        return colors[index % colors.Length];
    }

    private string GetInitials(string name) 
    { 
        var parts = name.Split(' '); 
        return string.Join("", parts.Select(p => p.Substring(0, 1).ToUpper())); 
    }

    private async Task ShowAgenda(EmployeeInfo employee)
    {
        selectedEmployee = employee;
        cargandoAgenda = true;
        errorAgenda = null;

        await EvaluarDiaSeleccionado();

        if (EsDiaNoLaboral)
        {
            agendaSeleccionada = null;
            cargandoAgenda = false;
            await InvokeAsync(StateHasChanged);
            return;
        }
        try
        {
            agendaSeleccionada =
                await VerAgendasService.GetAgendaCompleta(employee.Id);
        }
        catch (Exception ex)
        {
            errorAgenda = ex.Message;
            Debug.WriteLine(ex.ToString());
            agendaSeleccionada = null;
        }
        finally
        {
            cargandoAgenda = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CloseModal()
    {
        Debug.WriteLine("CERRANDO MODAL");
        selectedEmployee = null;
    }

    private List<EmployeeInfo> filteredEmployees
    {
        get
        {
            return employees
                .Where(e =>
                    string.IsNullOrWhiteSpace(searchName) ||
                    e.Name.Contains(searchName, StringComparison.OrdinalIgnoreCase))
                .Where(e =>
                    string.IsNullOrEmpty(selectedArea) ||
                    e.Area.Equals(selectedArea, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    string GetPendienteClass(int cantidad)
    {
        if (cantidad == 0)
            return "stat-ok";

        if (cantidad <= 5)
            return "stat-warning";

        return "stat-danger";
    }

    <!-- DATE BAR -->
    DateTime SelectedDate = DateTime.Today;

    void PreviousDay()
    {
        SelectedDate = SelectedDate.AddDays(-1);
        _ = ShowAgenda(selectedEmployee);
    }
    void NextDay()
    {
        SelectedDate = SelectedDate.AddDays(1);
        _ = ShowAgenda(selectedEmployee);
    }

    <!-- TAREAS -->
    bool TasksCollapsed = false;

    List<TareaApi> TareasAgenda =>
    agendaSeleccionada?.Tareas
        .Where(t => !t.esEvento)
        .OrderBy(t => t.fechaInicio)
        .ToList()
    ?? new();

    List<EventoApiDTO> EventosAgenda =>
    agendaSeleccionada?.Eventos
        .OrderBy(e => e.fechaInicio)
        .ToList()
    ?? new();

    List<TareaApi> TareasDelDia =>
    TareasAgenda
        .Where(t => GetFechaVisualizacion(t) == SelectedDate.Date)
        .ToList();

    List<EventoApiDTO> EventosDelDia =>
        EventosAgenda
            .Where(e => GetFechaVisualizacion(e) == SelectedDate.Date)
            .ToList();

    void ToggleTasks()
    {
        TasksCollapsed = !TasksCollapsed;
    }
    DateTime GetFechaVisualizacion(TareaApi t)
    {
        var hoy = DateTime.Today;

        if (t.completada && t.fechaCompletada.HasValue)
            return t.fechaCompletada.Value.Date;

        if (!t.completada && t.fechaFin.Date < hoy)
            return hoy;

        return t.fechaFin.Date;
    }
    DateTime GetFechaVisualizacion(EventoApiDTO e)
    {
        return e.fechaFin.Date;
    }
    class AgendaItemVM
    {
        public string Titulo { get; set; } = "";
        public DateTime Fecha { get; set; }
        public bool Completado { get; set; }
        public bool EsEvento { get; set; }
        public object Original { get; set; } = default!;
    }

    int TareasPendientesDelDia =>
    TareasAgenda.Count(t =>
        !t.completada &&
        GetFechaVisualizacion(t) == SelectedDate.Date);

    int EventosPendientesDelDia =>
    EventosAgenda.Count(e =>
        !e.completada &&
        GetFechaVisualizacion(e) == SelectedDate.Date);

    int TotalPendientesDelDia =>
    TareasPendientesDelDia + EventosPendientesDelDia;

    string hoy = DateOnly.FromDateTime(DateTime.Today).ToString();

    int TareasPendientes =>
    TareasAgenda.Count(t =>
        !t.completada &&
        t.fechaFin == DateTime.Parse(hoy));

    int EventosPendientes =>
        EventosAgenda.Count(e =>
            !e.completada &&
            e.fechaFin == DateTime.Parse(hoy));

    int TotalPendientes =>
        TareasPendientes + EventosPendientes;

    <!-- ORDENES DE TRABAJO -->
    bool OrdersCollapsed = false;

    class OrdenAgendaVM
    {
        public int Id { get; set; }
        public string Numero { get; set; } = "";
        public DateTime Fecha { get; set; }
        public string Tipo { get; set; } = "";
        public string Estado { get; set; } = "";
        public object Original { get; set; } = default!;
    }

    List<OrdenAgendaVM> OrdenesAgenda =>
    agendaSeleccionada == null
        ? new()
        : new List<OrdenAgendaVM>()
            // OT
            .Concat(
                agendaSeleccionada.OTHoy.Select(o => new OrdenAgendaVM
                {
                    Id = o.id,
                    Numero = o.strClave,
                    Fecha = o.fechaFinal.Date,
                    Tipo = "OT",
                    Estado = "hoy",
                    Original = o
                })
            )
            .Concat(
                agendaSeleccionada.OTProximas.Select(o => new OrdenAgendaVM
                {
                    Id = o.id,
                    Numero = o.strClave,
                    Fecha = o.fechaFinal.Date,
                    Tipo = "OT",
                    Estado = "proxima",
                    Original = o
                })
            )
            .Concat(
                agendaSeleccionada.OTVencidas.Select(o => new OrdenAgendaVM
                {
                    Id = o.id,
                    Numero = o.strClave,
                    Fecha = o.fechaFinal.Date,
                    Tipo = "OT",
                    Estado = "vencida",
                    Original = o
                })
            )
            // TRA
            .Concat(
                agendaSeleccionada.TRAHoy.Select(o => new OrdenAgendaVM
                {
                    Id = o.idOrden,
                    Numero = o.numeroOrden,
                    Fecha = DateTime.Parse(o.fechaConclusionTramite),
                    Tipo = "TRA",
                    Estado = "hoy",
                    Original = o
                })
            )
            .Concat(
                agendaSeleccionada.TRAProximas.Select(o => new OrdenAgendaVM
                {
                    Id = o.idOrden,
                    Numero = o.numeroOrden,
                    Fecha = DateTime.Parse(o.fechaConclusionTramite),
                    Tipo = "TRA",
                    Estado = "proxima",
                    Original = o
                })
            )
            .Concat(
                agendaSeleccionada.TRAVencidas.Select(o => new OrdenAgendaVM
                {
                    Id = o.idOrden,
                    Numero = o.numeroOrden,
                    Fecha = DateTime.Parse(o.fechaConclusionTramite),
                    Tipo = "TRA",
                    Estado = "vencida",
                    Original = o
                })
            )
            .ToList();

    int TotalOrdenes => OrdenesAgenda.Count;

    IEnumerable<OrdenAgendaVM> OrdenesVencidas =>
        OrdenesAgenda.Where(o => o.Estado == "vencida");

    IEnumerable<OrdenAgendaVM> OrdenesProximas =>
        OrdenesAgenda.Where(o => o.Estado == "proxima");

    IEnumerable<OrdenAgendaVM> OrdenesHoy =>
        OrdenesAgenda.Where(o => o.Estado == "hoy");

    string FormatoFechaOrden(DateTime fecha)
    {
        return fecha.ToString("dd/MM/yyyy", new CultureInfo("es-MX"));
    }

    void ToggleOrders()
    {
        OrdersCollapsed = !OrdersCollapsed;
    }

    <!-- AUTOEVALUACION -->
    bool SelfEvalCollapsed = false;
    public class AutoEvalItemUI
    {
        public int IdTarea { get; set; }
        public string Nombre { get; set; } = "";
        public DateOnly Fecha { get; set; }
        public bool Realizado { get; set; }
    }

    List<AutoEvalItemUI> AutoEvalDelDia => ObtenerAutoevaluacionDelDia(
    agendaSeleccionada?.Autoevaluaciones,
    DateOnly.FromDateTime(SelectedDate));

    List<AutoEvalItemUI> ObtenerAutoevaluacionDelDia(
    List<AutoevaluacionDTO>? bloques,
    DateOnly diaSeleccionado)
    {
        if (bloques == null)
            return new();

        return bloques
            .SelectMany(b => b.Tareas)
            .SelectMany(t => t.Registros
                .Where(r => r.Fecha == diaSeleccionado)
                .Select(r => new AutoEvalItemUI
                {
                    IdTarea = t.IdTareaAU,
                    Nombre = t.Tarea,
                    Fecha = r.Fecha,
                    Realizado = r.Realizado
                })
            )
            .ToList();
    }

    int AUPendiente =>
    AutoEvalDelDia.Count(a =>
        !a.Realizado);

    List<AutoEvalItemUI> ObtenerAutoevaluacionPendiente(
    List<AutoevaluacionDTO>? bloques)
    {
        if (bloques == null)
            return new();
        return bloques
            .SelectMany(b => b.Tareas)
            .SelectMany(t => t.Registros
                .Where(r => r.Fecha == DateOnly.FromDateTime(DateTime.Now))
                .Select(r => new AutoEvalItemUI
                {
                    IdTarea = t.IdTareaAU,
                    Nombre = t.Tarea,
                    Fecha = r.Fecha,
                    Realizado = r.Realizado
                })
            )
            .ToList();
    }

    List<AutoEvalItemUI> AutoEvalPend => ObtenerAutoevaluacionPendiente(
    agendaSeleccionada?.Autoevaluaciones);

    int AUPendientes =>
    AutoEvalPend.Count(a =>
        !a.Realizado);

    <!-- SERVICIO A CLIENTE -->
    bool ServiceCollapsed = false;
    
    public class ServiceItemUI
    {
        public int Id { get; set; }
        public string Texto { get; set; } = "";
        public DateOnly FechaAsig { get; set; }
        public DateOnly Fecha { get; set; }
        public bool Completada { get; set; }
    }

    List<ServiceItemUI> ObtenerServiciosDelDia(
    List<ServicioClienteAgendaDTO>? servicios,
    DateOnly diaSeleccionado)
    {
        if (servicios == null)
            return new();

        return servicios
            .Where(s =>
                s.FechaConclusion != default &&
                DateOnly.FromDateTime(s.FechaAsignacion) <= diaSeleccionado &&
                DateOnly.FromDateTime(s.FechaConclusion) >= diaSeleccionado
            )
            .Select(s => new ServiceItemUI
            {
                Id = s.IdHorasProgramaTrabajo,
                Texto = $"{s.NombreEmpresa} - {s.NombreServicio} - {s.NombreActividad}",
                FechaAsig = DateOnly.FromDateTime(s.FechaAsignacion),
                Fecha = DateOnly.FromDateTime(s.FechaConclusion),
                Completada = s.Completada == true
            })
            .ToList();
    }

    List<ServiceItemUI> ServiciosDelDia => ObtenerServiciosDelDia(
    agendaSeleccionada?.Servicios,
    DateOnly.FromDateTime(SelectedDate)
    );

    int SCPendiente =>
    ServiciosDelDia.Count(s =>
        !s.Completada);

    <!-- DIAS INHABILES -->
    List<DiaNoLaboralDto> DiasNoLaborales = new();

    bool EsDiaNoLaboral = false;
    string? MensajeDiaNoLaboral;

    async Task EvaluarDiaSeleccionado()
    {
        EsDiaNoLaboral = false;
        MensajeDiaNoLaboral = null;

        if (SelectedDate.DayOfWeek == DayOfWeek.Sunday)
        {
            EsDiaNoLaboral = true;
            MensajeDiaNoLaboral = "Domingo ‚Äî d√≠a no laborable";
            return;
        }
        var year = SelectedDate.Year;
        var month = SelectedDate.Month;

        if (!DiasNoLaborales.Any()
            || DiasNoLaborales.Any(d => d.DiaInhabil.Year != year || d.DiaInhabil.Month != month))
        {
            DiasNoLaborales = await CalendarioService.ObtenerDiasNoLaborales(year, month);
        }

        var diaInhabil = DiasNoLaborales
            .FirstOrDefault(d => d.DiaInhabil.Date == SelectedDate.Date);

        if (diaInhabil != null)
        {
            EsDiaNoLaboral = true;
            MensajeDiaNoLaboral = diaInhabil.Descripcion ?? "D√≠a no laborable";
        }
    }

    <!--- MODAL DE VER EVENTO O TAREA --->
    bool MostrarModal = false;
    bool EsEvento = true;
    bool MostrarModalDetalle = false;
    ActividadDetalleVM? ActividadSeleccionada;


    string TipoActividad => EsEvento ? "Evento" : "Tarea";
    string TituloLista => EsEvento ? "Participantes" : "Subtareas";

    void AbrirModal()
    {
        MostrarModal = true;
    }

    void CerrarModal()
    {
        MostrarModalDetalle = false;
        ActividadSeleccionada = null;
    }

    string ResolverUbicacion(EventoApiDTO e)
    {
        if (e.idSala.HasValue)
        {
            var sala = Salas.FirstOrDefault(s => s.Id == e.idSala.Value);
            return sala?.Salas ?? "Sala no encontrada";
        }

        if (!string.IsNullOrWhiteSpace(e.ubicacion))
            return e.ubicacion;

        return "Sin ubicaci√≥n";
    }

    string ResolverPrioridad(int prioridadId)
    {
        return prioridadId switch
        {
            1 => "Alta",
            2 => "Media",
            3 => "Baja",
            _ => "Sin prioridad"
        };
    }

    string FormatearFecha(DateTime fecha)
    {
        return fecha.ToString("dd/MM/yyyy");
    }

    string FormatearFechaHora(DateTime fecha)
    {
        return fecha.ToString("dd/MM/yyyy HH:mm");
    }

    class ActividadDetalleVM
    {
        public bool EsEvento { get; set; }

        public string Titulo { get; set; } = "";
        public string Descripcion { get; set; } = "";

        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }

        public string Prioridad { get; set; } = "";

        // Evento
        public string? Ubicacion { get; set; }
        public string? Organizador { get; set; }
        public List<string> Participantes { get; set; } = new();

        // Tarea
        public List<string> SubTareas { get; set; } = new();
    }
    void VerTarea(TareaApi t)
    {
        ActividadSeleccionada = new ActividadDetalleVM
        {
            EsEvento = false,
            Titulo = t.titulo,
            Descripcion = t.descripcion,
            FechaInicio = t.fechaInicio,
            FechaFin = t.fechaFin,
            Prioridad = t.prioridadTitulo,
            SubTareas = t.subTareas?
                .OrderBy(s => s.orden)
                .Select(s => s.titulo)
                .ToList() ?? new()
        };

        MostrarModalDetalle = true;
    }
    void VerEvento(EventoApiDTO e)
    {
        ActividadSeleccionada = new ActividadDetalleVM
        {
            EsEvento = true,
            Titulo = e.titulo,
            Descripcion = e.descripcion,
            FechaInicio = e.fechaInicio,
            FechaFin = e.fechaFin,
            Prioridad = ResolverPrioridad(e.idPrioridad),
            Ubicacion = ResolverUbicacion(e),
            Organizador = e.nombreCreador,
            Participantes = e.participantes
                .Select(p => p.nombreEmpleado)
                .ToList()
        };
        MostrarModalDetalle = true;
    }

    <!--- MODAL DETALLE OT Y TRA --->
    bool MostrarOrden = false;
    OrdenAgendaVM? OrdenSeleccionada;
    OrdenTrabajoDTO? DetalleOT;
    OrdenTramiteDTO? DetalleTramite;
    bool CargandoDetalle = false;

    async Task VerOrden(OrdenAgendaVM orden)
    {
        OrdenSeleccionada = orden;
        MostrarOrden = true;
        CargandoDetalle = true;
        try
        {
            if (orden.Tipo == "OT")
            {
                DetalleOT = await OrdenTrabajoService.GetDetalle(orden.Id);
                DetalleTramite = null;
            }
            else
            {
                DetalleTramite = await OrdenTramiteService.GetDetalle(orden.Id);
                DetalleOT = null;
            }
        }
        finally
        {
            CargandoDetalle = false;
            StateHasChanged();
        }
    }

    void CerrarOrden()
    {
        MostrarOrden = false;
        OrdenSeleccionada = null;

        DetalleOT = null;
        DetalleTramite = null;
    }

    bool MostrarSubModal = false;
    string TipoSubModal = "";
    object? SubModalData;

    void VerDetalleTareaOT(object tarea)
    {
        TipoSubModal = "OT-TAREA";
        SubModalData = tarea;
        MostrarSubModal = true;
    }

    void VerTareasTramite(object tramite)
    {
        TipoSubModal = "TRA-TAREAS";
        SubModalData = tramite;
        MostrarSubModal = true;
    }

    void VerDetalleTramite(object detalle)
    {
        TipoSubModal = "TRA-DETALLE";
        SubModalData = detalle;
        MostrarSubModal = true;
    }

    void CerrarSubModal()
    {
        MostrarSubModal = false;
        TipoSubModal = "";
        SubModalData = null;
    }
}