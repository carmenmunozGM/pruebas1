@using System.Diagnostics
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@using static System.Net.WebRequestMethods
@using System.Globalization
@inject AreasService AreasService
@inject HttpClient Http
@inject VerAgendasService VerAgendasService

<div class="ver-agendas-section">
    <div class="section-header">
        <h2>Ver Agendas</h2>
        <p>Consulta las agendas de otros empleados</p>
    </div>

    <!-- Search Bar -->
    <div class="search-section">
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" 
                   @bind="searchName" 
                   @bind:event="oninput"
                   placeholder="Buscar por nombre..." />
        </div>
        <select class="area-filter" @bind="selectedArea">
            <option value="">Todas las √°reas</option>
            @foreach (var area in areaList)
            {
                <option value="@area.Area">@area.Area</option>
            }
        </select>

    </div>

    <div class="agendas-grid">
        @foreach (var (employee, index) in filteredEmployees.Select((emp, idx) => (emp, idx)))
        {
            <div class="agenda-card">
                <div class="employee-info">
                    <div class="employee-avatar" style="background: @GetAvatarColor(index)">
                        @GetInitials(employee.NetName)
                    </div>
                    <div class="employee-details">
                        <h4>@employee.NetName - @employee.ClavePersonal</h4>
                        <p>@employee.Area - @employee.Puesto</p>

                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-box pending-stat">
                        <span class="stat-label">Pendientes</span>
                        <span class="stat-value">@employee.UpcomingTasks</span>
                    </div>
                    <div class="stat-box completed-stat">
                        <span class="stat-label">Completadas hoy</span>
                        <span class="stat-value">@employee.CompletedToday</span>
                    </div>
                </div>

                <button class="ver-button" @onclick:stopPropagation="true"  @onclick="async () => await ShowAgenda(employee)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span>Ver Agenda</span>
                </button>
            </div>
        }
    </div>

    @if (selectedEmployee != null)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation="true">

                <!-- HEADER -->
                <div class="modal-header">
                    <div class="modal-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-icon lucide-calendar">
                            <path d="M8 2v4" />  <path d="M16 2v4" /> <rect width="18" height="18" x="3" y="4" rx="2" /> <path d="M3 10h18" />
                        </svg>
                        <h3>Agenda de @selectedEmployee.Name</h3>
                    </div>

                    <button class="close-button" @onclick="CloseModal" title="Cerrar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="close-icon">
                            <path d="M18 6 6 18" /> <path d="M6 6 18 18" />
                        </svg>
                    </button>
                </div>

                <!-- DATE BAR -->
                <div class="agenda-toolbar">
                    <div class="date-controls">
                        <button class="nav-btn"
                                title="D√≠a anterior"
                                @onclick="PreviousDay">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                                <circle cx="12" cy="12" r="10" /><path d="m12 8-4 4 4 4" /><path d="M16 12H8" />
                            </svg>
                        </button>

                        <span class="current-date">
                            @SelectedDate.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-MX"))
                        </span>

                        <button class="nav-btn"
                                title="D√≠a siguiente"
                                @onclick="NextDay">
                            <svg xmlns="http://www.w3.org/2000/svg"viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                                <circle cx="12" cy="12" r="10" /> <path d="m12 16 4-4-4-4" /> <path d="M8 12h8" />
                            </svg>
                        </button>
                    </div>

                    <button class="refresh-btn" @onclick="RefreshAgenda">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /> <path d="M3 3v5h5" /> <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /> <path d="M16 16h5v5" />
                        </svg>
                        Actualizar
                    </button>
                </div>

                <!-- BODY -->
                <div class="modal-body">

                    <!-- EMPLOYEE INFO -->
                    <div class="employee-card">
                        <div>
                            <span>Nombre</span>
                            <strong>@selectedEmployee.Name</strong>
                        </div>
                        <div>
                            <span>Puesto</span>
                            <strong>@selectedEmployee.Puesto</strong>
                        </div>
                    </div>

                    <!-- TAREAS -->
                    <div class="block pink">
                        <div class="block-header" @onclick="ToggleTasks">
                            <span>‚úî Tareas</span>
                            <span>@Tasks.Count pendiente(s)</span>
                        </div>

                        @if (!TasksCollapsed)
                        {
                            <div class="block-content">
                                @foreach (var task in Tasks)
                                {
                                    <div class="item">
                                        <div>
                                            <strong>@task.Title</strong>
                                            <p>@task.Description</p>
                                        </div>
                                        <button>üëÅ</button>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- ORDENES DE TRABAJO -->
                    <div class="block orange">
                        <div class="block-header" @onclick="ToggleOrders">
                            <span>üìã √ìrdenes de trabajo</span>
                            <span>@WorkOrders.Count orden(es)</span>
                        </div>

                        @if (!OrdersCollapsed)
                        {
                            <div class="orders-grid">
                                <div>
                                    @foreach (var o in WorkOrders.Where(x => x.Status == "vencida"))
                                    {
                                        <div class="order red">
                                            <strong>@o.Number</strong>
                                            <span>Vencida</span>
                                        </div>
                                    }
                                </div>

                                <div>
                                    @foreach (var o in WorkOrders.Where(x => x.Status == "proxima"))
                                    {
                                        <div class="order yellow">
                                            <strong>@o.Number</strong>
                                            <span>Pr√≥x.</span>
                                        </div>
                                    }
                                </div>

                                <div>
                                    @foreach (var o in WorkOrders.Where(x => x.Status == "hoy"))
                                    {
                                        <div class="order green">
                                            <strong>@o.Number</strong>
                                            <span>Hoy</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <!--  AUTOEVALUACI√ìN -->
                    <div class="block green">
                        <div class="block-header" @onclick="() => SelfEvalCollapsed = !SelfEvalCollapsed">
                            <span>‚≠ê Autoevaluaci√≥n</span>
                            <span>@SelfEvaluations.Count pendiente(s)</span>
                        </div>

                        @if (!SelfEvalCollapsed)
                        {
                            <div class="block-content">
                                @foreach (var item in SelfEvaluations)
                                {
                                    <div class="item">
                                        <span>‚≠ê</span>
                                        <p>@item.Description</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- SERVICIO A CLIENTE -->
                    <div class="block purple">
                        <div class="block-header" @onclick="() => ServiceCollapsed = !ServiceCollapsed">
                            <span>üë• Servicio a Cliente</span>
                            <span>@Services.Count pendiente(s)</span>
                        </div>

                        @if (!ServiceCollapsed)
                        {
                            <div class="block-content">
                                @foreach (var item in Services)
                                {
                                    <div class="item">
                                        <p>@item.Description</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>


                </div>
            </div>
        </div>
    }

</div>

@code {
    AgendaCompletaDTO? agendaSeleccionada;
    bool cargandoAgenda = false;
    string? errorAgenda;

    List<AreaDTO> areaList = new();
    List<EmpleadoDTO> empleadoList = new();
    private List<EmployeeInfo> employees = new();

    string? selectedArea;

    private EmployeeInfo selectedEmployee = null;
    private string searchName = "";

    protected override async Task OnInitializedAsync()
    {
        areaList = await AreasService.GetAreas();
        await CargarEmpleados();
    }

    async Task RefreshAgenda()
    {
        // Aqu√≠ luego filtras tareas, eventos u √≥rdenes
        await InvokeAsync(StateHasChanged);
    }


    private async Task CargarEmpleados()
    {
        var empleadosDto = await Http
            .GetFromJsonAsync<List<EmpleadoDTO>>(
                "https://redgm.site:9096/empleado"
                //"http://localhost:5231/empleado"
            )
            ?? new();

        employees = empleadosDto
        .OrderBy(e => e.ClavePersonal)
        .Select(e => new EmployeeInfo
        {
            Id = e.Id,
            ClavePersonal = e.ClavePersonal,
            Name = e.Nombre,
            NetName = e.NombreRed,
            Area = e.Area,
            Puesto = e.Puesto,
            UpcomingTasks = 0,
            CompletedToday = 0
        }).ToList();
    }

    private class EmployeeInfo
    {
        public int Id { get; set; }
        public int ClavePersonal { get; set; }

        public string Name { get; set; } = string.Empty;
        public string NetName { get; set; } = string.Empty;

        public string Area { get; set; } = string.Empty;
        public string Puesto { get; set; } = string.Empty;

        public int UpcomingTasks { get; set; }
        public int CompletedToday { get; set; }
    }

    private string[] colors = new string[] 
    { 
        "#dd0203", "#f78701", "#f7e801", 
        "#2da549", "#4543ec", "#85119a" 
    };

    private string GetAvatarColor(int index)
    {
        return colors[index % colors.Length];
    }

    private string GetInitials(string name) 
    { 
        var parts = name.Split(' '); 
        return string.Join("", parts.Select(p => p.Substring(0, 1).ToUpper())); 
    }

    private async Task ShowAgenda(EmployeeInfo employee)
    {
        selectedEmployee = employee;
        cargandoAgenda = true;
        errorAgenda = null;

        try
        {
            agendaSeleccionada =
                await VerAgendasService.GetAgendaCompleta(employee.Id);
        }
        catch (Exception ex)
        {
            errorAgenda = ex.Message;
            Debug.WriteLine(ex.ToString());
            agendaSeleccionada = null;
        }
        finally
        {
            cargandoAgenda = false;
            await InvokeAsync(StateHasChanged);
        }
    }


    private void CloseModal()
    {
        Debug.WriteLine("CERRANDO MODAL");
        selectedEmployee = null;
    }

    private List<EmployeeInfo> filteredEmployees
    {
        get
        {
            return employees
                .Where(e =>
                    string.IsNullOrWhiteSpace(searchName) ||
                    e.Name.Contains(searchName, StringComparison.OrdinalIgnoreCase))
                .Where(e =>
                    string.IsNullOrEmpty(selectedArea) ||
                    e.Area.Equals(selectedArea, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }


    <!-- DATE BAR -->
    DateTime SelectedDate = DateTime.Today;

    void PreviousDay()
    {
        SelectedDate = SelectedDate.AddDays(-1);
        RefreshAgenda();
    }
    void NextDay()
    {
        SelectedDate = SelectedDate.AddDays(1);
        RefreshAgenda();
    }

    <!-- TAREAS -->
    bool TasksCollapsed = false;

    class AgendaTask
    {
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }

    List<AgendaTask> Tasks = new()
    {
        new AgendaTask
        {
            Title = "Revisar reporte semanal",
            Description = "Validar cifras y enviar observaciones"
        },
        new AgendaTask
        {
            Title = "Actualizar agenda",
            Description = "Ajustar eventos conforme a cambios del cliente"
        }
    };

    void ToggleTasks()
    {
        TasksCollapsed = !TasksCollapsed;
    }
    <!-- ORDENES DE TRABAJO -->
    bool OrdersCollapsed = false;

    class WorkOrder
    {
        public string Number { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        // valores esperados: "vencida" | "proxima" | "hoy"
    }
    List<WorkOrder> WorkOrders = new()
    {
        new WorkOrder { Number = "OT-1023", Status = "vencida" },
        new WorkOrder { Number = "OT-1041", Status = "proxima" },
        new WorkOrder { Number = "OT-1042", Status = "hoy" },
        new WorkOrder { Number = "OT-1050", Status = "proxima" },
        new WorkOrder { Number = "OT-0999", Status = "vencida" }
    };

    void ToggleOrders()
    {
        OrdersCollapsed = !OrdersCollapsed;
    }

    <!-- AUTOEVALUACION -->
    bool SelfEvalCollapsed = false;
    record EvaluationItem(string Id, string Description);

    List<EvaluationItem> SelfEvaluations = new()
    {
        new("1", "Brind√© soluciones inteligentes a los problemas/necesidades de los usuarios finales"),
        new("2", "Realic√© una planeaci√≥n adecuada para ejecutar el proyecto."),
        new("3", "Desarroll√© los sistemas inform√°ticos, tomando en cuenta las pol√≠ticas y lineamientos establecidos."),
        new("4", "Realic√© las pruebas de funcionalidad para asegurar la calidad de los sistemas inform√°ticos y hace las correcciones necesarias."),
        new("5", "Di seguimiento a mi programa de trabajo y mantuve actualizado.")
    };

    <!-- SERVICIO A CLIENTE -->
    bool ServiceCollapsed = false;
    record ServiceItem(string Id, string Description);
    List<ServiceItem> Services = new()
    {
        new("1", "2366 ARKE SMO SA DE CV ‚Äì Servicios Contables ‚Äì Entrega de Informe Mensual")
    };
}