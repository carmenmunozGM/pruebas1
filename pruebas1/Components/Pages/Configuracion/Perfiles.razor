@using pruebas1.Components.DTOs
@using pruebas1.Servicios
@using static System.Net.WebRequestMethods
@inject AreasService AreasService
@inject PerfilesService PerfilesService
@inject HttpClient Http

<div class="perfiles-section">
    <div class="section-header">
        <h2>Perfiles</h2>
        <p>Gestiona los permisos y roles de los empleados</p>
    </div>

    <div class="search-section">
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text"
                   @bind="searchName"
                   @bind:event="oninput"
                   placeholder="Buscar por nombre..." />
        </div>
        <select class="area-filter" @bind="selectedArea">
            <option value="">Todas las Ã¡reas</option>
            @foreach (var area in areaList)
            {
                <option value="@area.Area">@area.Area</option>
            }
        </select>
    </div>

    <div class="perfiles-container">
        <table class="perfiles-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Puesto</th>
                    <th>Tipo de Usuario</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var (employee, index) in filteredEmployees.Select((emp, idx) => (emp, idx)))
                {
                    <tr>
                        <td>
                            <div class="employee-info">
                                <div class="employee-avatar" style="background: @GetAvatarColor(index)">
                                    @GetInitials(employee.Nombre)
                                </div>
                                <span>@employee.Nombre</span>
                            </div>
                        </td>
                        <td>@employee.Puesto</td>
                        <td>
                            <select class="user-type-select" @bind="employee.PerfilId">
                                @foreach (var perfil in perfilesList)
                                {
                                    <option value="@perfil.Id">@perfil.Descripcion</option>
                                }
                            </select>
                           
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="save-section">
            <button class="save-button" @onclick="HandleSave">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                <span>Guardar Cambios</span>
            </button>
        </div>
    </div>
    @if (!string.IsNullOrEmpty(message))
    {
        <div class="message-toast">
            @message
        </div>
    }
</div>

@code {
    string? selectedArea;
    List<AreaDTO> areaList = new();

    List<PerfilesDTO> perfilesList = new();

    List<EmpleadoPerfilDTO> empleadosList = new();
    List<EmployeeInfo> employees = new();

    private string message = "";
    private string searchName = "";

    string? selectedPerfil;

    protected override async Task OnInitializedAsync()
    {
        areaList = await AreasService.GetAreas();
        perfilesList = await PerfilesService.GetPerfiles();
        await CargarEmpleados();
    }

    private async Task CargarEmpleados()
    {
        var empleadosDto = await PerfilesService.GetEmpleadosPerfiles();

        employees = empleadosDto
            .OrderBy(e => e.Clave)
            .Select(e =>
            {
                var perfil = perfilesList.FirstOrDefault(p => p.Descripcion == e.Perfil);

                return new EmployeeInfo
                {
                    Clave = e.Clave,
                    Nombre = e.Nombre,
                    Area = e.Area,
                    Puesto = e.Puesto,
                    Perfil = e.Perfil,
                    PerfilId = perfil?.Id ?? 0,
                    PerfilOriginalId = perfil?.Id ?? 0
                };
            })
            .ToList();
    }

    private class EmployeeInfo
    {
        public int Clave { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public string Area { get; set; } = string.Empty;
        public string Puesto { get; set; } = string.Empty;
        public string Perfil { get; set; } = string.Empty;

        public int PerfilId { get; set; }
        public int PerfilOriginalId { get; set; }

        public bool Modificado => PerfilId != PerfilOriginalId;
    };

    private string[] colors = new string[] 
    { 
        "#dd0203", "#f78701", "#f7e801",
        "#2da549", "#4543ec", "#85119a"
    };

    private string GetAvatarColor(int index)
    {
        return colors[index % colors.Length];
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ');
        return string.Join("", parts.Select(p => p.Substring(0, 1).ToUpper()));
    }

    private List<EmployeeInfo> filteredEmployees
    {
        get
        {
            return employees
                .Where(e =>
                    string.IsNullOrWhiteSpace(searchName) ||
                    e.Nombre.Contains(searchName, StringComparison.OrdinalIgnoreCase))
                .Where(e =>
                    string.IsNullOrEmpty(selectedArea) ||
                    e.Area.Equals(selectedArea, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private async Task HandleSave()
    {
        var cambios = employees
            .Where(e => e.Modificado)
            .Select(e => new EditarPerfilDTO
            {
                ClavePersonal = e.Clave,
                IdPerfil = e.PerfilId
            })
            .ToList();

        if (!cambios.Any())
        {
            message = "No hay cambios";
            await InvokeAsync(StateHasChanged);

            await Task.Delay(2000);

            message = "";
            await InvokeAsync(StateHasChanged);
            return;
        }

        var ok = await PerfilesService.GuardarPerfiles(cambios);

        if (ok)
        {
            foreach (var e in employees)
                e.PerfilOriginalId = e.PerfilId;

            message = "Cambios guardados correctamente";
        }
        else
            message = "Error al guardar";

        await InvokeAsync(StateHasChanged);

        await Task.Delay(2000);

        message = "";
        await InvokeAsync(StateHasChanged);
    }

}
