@using System.Diagnostics
@using pruebas1.Servicios
@using pruebas1.Components.DTOs
@using static System.Net.WebRequestMethods
@inject AreasService AreasService
@inject HttpClient Http
@inject IJSRuntime JS


<div class="reportes-section">
    <div class="section-header">
        <h2>Reportes</h2>
        <p>Genera y descarga reportes de actividad</p>
    </div>

    <!-- Report Type Selection -->
    <div class="report-type-selector">
        <button class="type-button @(reportType == "autoevaluacion" ? "active" : "")"
                @onclick='() => reportType = "autoevaluacion"'>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span>Autoevaluaci√≥n</span>
        </button>

        <button class="type-button @(reportType == "clientes" ? "active" : "")"
                @onclick='() => reportType = "clientes"'>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>Clientes Asignados</span>
        </button>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text"
                   @bind="searchName"
                   @bind:event="oninput"
                   placeholder="Buscar por nombre..." />
        </div>

        <!-- SELECT MES - A√ëO (NUEVO) -->
        <select class="area-filter" @bind="selectedMonth">
            @foreach (var m in monthOptions)
            {
                <option value="@m.Value">@m.Text</option>
            }
        </select>

        <select class="area-filter" @bind="selectedArea">
            <option value="">Todas las √°reas</option>
            @foreach (var area in areaList)
            {
                <option value="@area.Area">@area.Area</option>
            }
        </select>
    </div>

    <!-- Report Content -->
    <div class="reportes-table-container">
        <table class="reportes-table">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>√Årea</th>
@*                     <th>@GetReportColumnName()</th> *@
                    <th class="text-right">Descargar</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in filteredUsers)
                {
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">
                                    @GetInitials(user.NetName)
                                </div>
                                <span class="user-name">@user.Name</span>
                            </div>
                        </td>
                        <td>
                            <span class="area-badge">@user.Area</span>
                        </td>
                   @*      <td>
                            <span class="activity-badge">@GetReportValue(user)</span>
                        </td> *@
                        <td class="text-right">
                            <button class="download-button" @onclick="() => HandleDownload(user)">

                                <svg class="excel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                </svg>
                                <span>Descargar Excel</span>
                                <svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="message-toast">
            <div class="toast-content">
                <strong>@message</strong>
                <p>El archivo Excel se descargar√° en breve</p>
            </div>
        </div>
    }
</div>

@code {
    List<AreaDTO> areaList = new();
    List<EmpleadoDTO> empleadoList = new();
    private List<UserInfo> employees = new();

    string? selectedArea;
    private string selectedMonth = "";

    private UserInfo selectedEmployee = null;
    private string searchName = "";

    private string message = "";
    private string reportType = "autoevaluacion";

    private List<MonthOption> monthOptions = new();

    protected override async Task OnInitializedAsync()
    {
        areaList = await AreasService.GetAreas();
        GenerarMeses();
        await CargarEmpleados();
    }

    private void GenerarMeses()
    {
        var cultura = new System.Globalization.CultureInfo("es-MX");
        var fechaBase = DateTime.Now;

        monthOptions = Enumerable.Range(0, 12)
            .Select(i =>
            {
                var fecha = fechaBase.AddMonths(-i);
                return new MonthOption
                {
                    Value = fecha.ToString("yyyy-MM"),
                    Text = cultura.TextInfo.ToTitleCase(
                        fecha.ToString("MMMM yyyy", cultura))
                };
            })
            .ToList();

        selectedMonth = monthOptions.First().Value;
    }

    private async Task CargarEmpleados()
    {
        var empleadosDto = await Http
            .GetFromJsonAsync<List<EmpleadoDTO>>(
                "https://redgm.site:9096/empleado"
            )
            ?? new();

        employees = empleadosDto
            .OrderBy(e => e.ClavePersonal)
            .Select(e => new UserInfo
            {
                Id = e.Id,
                ClavePersonal = e.ClavePersonal,
                Name = e.Nombre,
                NetName = e.NombreRed,
                Area = e.Area,
                Puesto = e.Puesto,
                Autoevaluaciones = 0,
                ProgramasTrabajo = 0,
                ClientesAsignados = 0
            }).ToList();
    }

    private int ObtenerClaveArea(string area)
    {
        return area switch
        {
            "TECNOLOGIAS DE INFORMACION" => 7,
            _ => 0
        };
    }

    private class UserInfo
    {
        public int Id { get; set; }
        public int ClavePersonal { get; set; }
        public string Name { get; set; } = string.Empty;
        public string NetName { get; set; } = string.Empty;
        public string Area { get; set; } = string.Empty;
        public string Puesto { get; set; } = string.Empty;
        public int Autoevaluaciones { get; set; }
        public int ProgramasTrabajo { get; set; }
        public int ClientesAsignados { get; set; }
    }

    private class MonthOption
    {
        public string Value { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ');
        return string.Join("", parts.Select(p => p.Substring(0, 1).ToUpper()));
    }

    private string GetReportColumnName()
    {
        return reportType switch
        {
            "autoevaluacion" => "Autoevaluaciones",
            "programa" => "Programas",
            "clientes" => "Clientes",
            _ => "Actividades"
        };
    }

    // private string GetReportValue(UserInfo user)
    // {
    //     var value = reportType switch
    //     {
    //         "autoevaluacion" => user.Autoevaluaciones,
    //         "programa" => user.ProgramasTrabajo,
    //         "clientes" => user.ClientesAsignados,
    //         _ => 0
    //     };

    //     return $"{value} registros";
    // }
    private async Task ShowMessage(string text)
    {
        message = text;
        StateHasChanged();

        await Task.Delay(2000);

        message = string.Empty;
        StateHasChanged();
    }

    private async Task HandleDownload(UserInfo user)
    {
        try
        {
            // üö´ Bloqueo si NO es autoevaluaci√≥n
            if (reportType != "autoevaluacion")
            {
                await ShowMessage("Este usuario no cuenta con reportes de clientes asignados");
                return;
            }

            // 1Ô∏è‚É£ Extraer a√±o y mes desde "yyyy-MM"
            var partes = selectedMonth.Split('-');
            int anio = int.Parse(partes[0]);
            int mes = int.Parse(partes[1]);

            // 2Ô∏è‚É£ Construir URL del endpoint (solo autoevaluaci√≥n)
            var url = $"api/Reportes/Autoevaluacion/{user.Id}/{anio}/{mes}";

            // 3Ô∏è‚É£ Llamada HTTP
            var response = await Http.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                await ShowMessage("Este usuario no cuenta con reportes de autoevaluaci√≥n");
                return;
            }

            var bytes = await response.Content.ReadAsByteArrayAsync();

            // 4Ô∏è‚É£ Descargar archivo usando JS
            var fileName = $"AE_{user.Name}_{anio}_{mes}.xlsx"
                .Replace(" ", "_");

            await JS.InvokeVoidAsync(
                "downloadFile",
                fileName,
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                bytes
            );

            await ShowMessage($"Descargando reporte de {user.Name}");
        }
        catch (Exception ex)
        {
            await ShowMessage("Error inesperado al descargar el reporte");
            Console.WriteLine(ex);
        }
    }


    private List<UserInfo> filteredUsers
    {
        get
        {
            return employees
                .Where(e =>
                    string.IsNullOrWhiteSpace(searchName) ||
                    e.Name.Contains(searchName, StringComparison.OrdinalIgnoreCase))
                .Where(e =>
                    string.IsNullOrEmpty(selectedArea) ||
                    e.Area.Equals(selectedArea, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }
}
